<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🤖 AI Lesson Planner | Geography Companion</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 30px;
            padding: 30px;
            min-height: 800px;
        }

        .input-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
        }

        .output-panel {
            background: #f1f8ff;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #d1ecf1;
        }

        .panel-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lesson-info-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .lesson-info-card h3 {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .lesson-content {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .ai-controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .control-group select,
        .control-group input,
        .control-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .control-group select:focus,
        .control-group input:focus,
        .control-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        .generate-button {
            width: 100%;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .generate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .generate-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .lesson-plan-output {
            background: white;
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            min-height: 600px;
            max-height: 800px;
            overflow-y: auto;
        }

        .lesson-plan-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .lesson-plan-section:last-child {
            border-bottom: none;
        }

        .lesson-plan-section h3 {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-button {
            position: fixed;
            top: 30px;
            left: 30px;
            background: rgba(255, 255, 255, 0.9);
            color: #495057;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .back-button:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .api-status {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #856404;
        }

        .success-status {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .error-status {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .export-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .export-button:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .export-button.print {
            background: #17a2b8;
        }

        .export-button.copy {
            background: #ffc107;
            color: #212529;
        }

        .advanced-settings {
            background: #e7f3ff;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid #b3d7ff;
        }

        .advanced-toggle {
            background: none;
            border: none;
            color: #007bff;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .advanced-content {
            display: none;
        }

        .advanced-content.show {
            display: block;
        }

        /* Tab System Styles */
        .output-tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: #007bff;
        }

        .tab-button.active#integrated-lesson-tab {
            background: #ff6b6b;
        }

        .tab-button.active#lesson-plan-tab {
            background: #007bff;
        }

        .tab-button.active#condensed-reading-tab {
            background: #28a745;
        }

        .tab-button:not(.active) {
            background: #6c757d;
        }

        .tab-button:not(.active):hover {
            background: #5a6268;
        }

        .integrated-lesson-btn {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            margin-bottom: 15px;
            font-size: 1.1rem;
            padding: 18px;
        }

        .integrated-lesson-btn:hover {
            background: linear-gradient(135deg, #ff5252, #ff6b6b);
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .condensed-reading-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            margin-top: 15px;
        }

        .condensed-reading-btn:hover {
            background: linear-gradient(135deg, #218838, #1e7e34);
            transform: translateY(-2px);
        }

        .reading-options {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .reading-options h4 {
            margin-bottom: 15px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <button onclick="goBack()" class="back-button">← Back to Lesson Companion</button>

    <div class="container">
        <div class="header">
            <h1>🤖 AI Lesson Planner</h1>
            <p>Generate Dynamic 50-Minute Lesson Plans with Advanced AI</p>
        </div>

        <div class="main-content">
            <!-- Input Panel -->
            <div class="input-panel">
                <div class="panel-title">
                    📚 Lesson Content Analysis
                </div>

                <!-- Lesson Selector -->
                <div class="lesson-info-card">
                    <h3>🎯 Select Your Lesson</h3>
                    <div class="control-group">
                        <label for="module-selector">Choose Module (1-32):</label>
                        <select id="module-selector">
                            <option value="">Loading modules...</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="lesson-selector">Choose Lesson:</label>
                        <select id="lesson-selector">
                            <option value="">Select a module first</option>
                        </select>
                    </div>
                    <button onclick="loadSelectedLesson()" class="generate-button" style="margin-top: 10px; padding: 10px 20px; font-size: 1rem;">
                        📖 Load This Lesson
                    </button>
                </div>

                <!-- Current Lesson Info -->
                <div class="lesson-info-card">
                    <h3>📋 Current Lesson</h3>
                    <div id="current-lesson-info">
                        <p><strong>Module:</strong> <span id="lesson-module">Loading...</span></p>
                        <p><strong>Lesson:</strong> <span id="lesson-title">Loading...</span></p>
                        <p><strong>Duration:</strong> <span id="lesson-duration">50 minutes</span></p>
                    </div>
                </div>

                <!-- Teacher's Guide Content -->
                <div class="lesson-info-card">
                    <h3>👨‍🏫 Teacher's Guide Content</h3>
                    <div id="teacher-content" class="lesson-content">
                        <p>Loading teacher's guide content...</p>
                    </div>
                </div>

                <!-- Student Reading Content -->
                <div class="lesson-info-card">
                    <h3>📖 Student Reading Content</h3>
                    <div id="student-content" class="lesson-content">
                        <p>Loading student reading content...</p>
                    </div>
                </div>

                <!-- AI Controls -->
                <div class="ai-controls">
                    <div class="api-status" id="api-status">
                        🔧 Configuring AI settings...
                    </div>

                    <div class="control-group">
                        <label for="ai-model">AI Model Selection</label>
                        <select id="ai-model">
                            <optgroup label="🚀 Latest Models (2025)">
                                <option value="gpt-5">GPT-5 (Best Performance)</option>
                                <option value="gpt-5-mini">GPT-5 Mini (Fast & Efficient)</option>
                                <option value="gpt-5-nano">GPT-5 Nano (Fastest)</option>
                                <option value="gpt-4.1">GPT-4.1 (Advanced Function Calling)</option>
                                <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
                                <option value="gpt-4.1-nano">GPT-4.1 Nano</option>
                            </optgroup>
                            <optgroup label="🔧 Previous Generation">
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            </optgroup>
                        </select>
                        <small style="color: #666; font-size: 0.9em; margin-top: 5px; display: block;">
                            💡 GPT-5 and GPT-4.1 are the latest models with enhanced reasoning and coding capabilities
                        </small>
                    </div>

                    <div class="control-group">
                        <label for="lesson-focus">Lesson Focus Area</label>
                        <select id="lesson-focus">
                            <option value="balanced">Balanced Approach</option>
                            <option value="interactive">Highly Interactive</option>
                            <option value="discussion">Discussion-Heavy</option>
                            <option value="hands-on">Hands-On Activities</option>
                            <option value="assessment">Assessment-Focused</option>
                            <option value="technology">Technology Integration</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="class-size">Estimated Class Size</label>
                        <input type="number" id="class-size" value="25" min="1" max="50" placeholder="25">
                    </div>

                    <!-- Advanced Settings -->
                    <div class="advanced-settings">
                        <button class="advanced-toggle" onclick="toggleAdvancedSettings()">
                            ⚙️ Advanced Settings
                        </button>
                        <div class="advanced-content" id="advanced-content">
                            <div class="control-group">
                                <label for="creativity-level">AI Creativity Level</label>
                                <select id="creativity-level">
                                    <option value="0.3">Conservative (0.3)</option>
                                    <option value="0.7" selected>Balanced (0.7)</option>
                                    <option value="1.0">Creative (1.0)</option>
                                </select>
                            </div>

                            <div class="control-group">
                                <label for="custom-prompt">Custom Instructions</label>
                                <textarea id="custom-prompt" rows="3" placeholder="Additional instructions for the AI (e.g., 'Focus on visual learners', 'Include group work', etc.)"></textarea>
                            </div>

                            <div class="control-group">
                                <label for="api-key">OpenAI API Key</label>
                                <input type="password" id="api-key" name="api-key" placeholder="sk-..." 
                                       value="" autocomplete="off" />
                                <small style="color: #6c757d; font-size: 0.8rem; margin-top: 5px; display: block;">
                                    Your API key is stored locally and never sent to our servers
                                </small>
                            </div>
                        </div>
                    </div>

                    <button onclick="generateIntegratedLesson()" class="generate-button integrated-lesson-btn" id="integrated-lesson-btn" 
                            style="background: linear-gradient(135deg, #ff6b6b, #ff8e8e); margin-bottom: 15px; font-size: 1.1rem; padding: 18px;">
                        🎯 Generate Complete Integrated Lesson
                        <div style="font-size: 0.9rem; margin-top: 5px; opacity: 0.9;">
                            Reading + Lesson Plan + Handouts (One-Click Solution)
                        </div>
                    </button>
                    
                    <div style="text-align: center; margin: 15px 0; color: #6c757d; font-weight: bold;">
                        OR Generate Components Separately:
                    </div>

                    <button onclick="generateLessonPlan()" class="generate-button" id="generate-btn">
                        🚀 Generate AI Lesson Plan
                    </button>
                    
                    <button onclick="generateCondensedReading()" class="generate-button condensed-reading-btn" id="condensed-reading-btn" 
                            style="background: linear-gradient(135deg, #28a745, #20c997); margin-top: 15px;">
                        📚 Generate Condensed Student Reading
                    </button>
                    
                    <div class="reading-options" id="reading-options" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; display: none;">
                        <h4 style="margin-bottom: 10px; color: #495057;">📖 Reading Generation Options</h4>
                        
                        <div class="control-group">
                            <label for="reading-complexity">Reading Complexity Level:</label>
                            <select id="reading-complexity" class="control">
                                <option value="simplified">Simplified (2 grades below)</option>
                                <option value="standard" selected>Standard (Grade appropriate)</option>
                                <option value="advanced">Advanced (1 grade above)</option>
                                <option value="all-levels">All Three Levels</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label for="reading-length">Target Reading Length:</label>
                            <select id="reading-length" class="control">
                                <option value="condensed" selected>Condensed (4-5 paragraphs)</option>
                                <option value="comprehensive">Comprehensive (6-8 paragraphs)</option>
                                <option value="detailed">Detailed (8-10 paragraphs)</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label for="reading-focus">Reading Focus:</label>
                            <select id="reading-focus" class="control">
                                <option value="balanced" selected>Balanced Overview</option>
                                <option value="geographic">Geographic Emphasis</option>
                                <option value="cultural">Cultural Emphasis</option>
                                <option value="historical">Historical Emphasis</option>
                                <option value="environmental">Environmental Emphasis</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="include-supports" checked style="margin-right: 8px;">
                                Include Comprehension Supports (pronunciation guides, margin questions, etc.)
                            </label>
                        </div>
                        
                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="include-assessment" checked style="margin-right: 8px;">
                                Include Assessment Integration (text-dependent questions, citation practice)
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Output Panel -->
            <div class="output-panel">
                <div class="output-tabs" style="display: flex; border-bottom: 2px solid #e9ecef; margin-bottom: 20px;">
                    <button class="tab-button active" onclick="switchTab('integrated-lesson')" id="integrated-lesson-tab" 
                            style="flex: 1; padding: 12px; border: none; background: #ff6b6b; color: white; cursor: pointer; border-radius: 8px 8px 0 0;">
                        🎯 Complete Lesson
                    </button>
                    <button class="tab-button" onclick="switchTab('lesson-plan')" id="lesson-plan-tab" 
                            style="flex: 1; padding: 12px; border: none; background: #6c757d; color: white; cursor: pointer; border-radius: 8px 8px 0 0; margin-left: 2px;">
                        📋 Lesson Plan Only
                    </button>
                    <button class="tab-button" onclick="switchTab('condensed-reading')" id="condensed-reading-tab"
                            style="flex: 1; padding: 12px; border: none; background: #6c757d; color: white; cursor: pointer; border-radius: 8px 8px 0 0; margin-left: 2px;">
                        📚 Reading Only
                    </button>
                </div>

                <!-- Integrated Lesson Tab Content -->
                <div class="tab-content active" id="integrated-lesson-content">
                    <div class="panel-title">
                        🎯 Complete Integrated Lesson Package
                    </div>

                    <div class="loading" id="integrated-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <h3>🔧 AI is building your complete lesson package...</h3>
                        <p>Generating reading materials, lesson plan, and handouts as one integrated document</p>
                    </div>

                    <div class="integrated-lesson-output" id="integrated-lesson-output">
                        <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                            <h3>🎯 Ready to Generate Complete Lesson</h3>
                            <p>Click "Generate Complete Integrated Lesson" to create a print-ready, comprehensive lesson package.</p>
                            
                            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: left;">
                                <h4 style="color: #495057; margin-bottom: 15px;">✨ Complete Package Includes:</h4>
                                <ul style="color: #6c757d; line-height: 1.8;">
                                    <li>📖 <strong>Condensed Student Reading</strong> with lesson-aligned annotations</li>
                                    <li>📋 <strong>Integrated Lesson Plan</strong> with reading references throughout</li>
                                    <li>📝 <strong>Student Handouts</strong> designed to work with the reading</li>
                                    <li>🔗 <strong>Seamless Transitions</strong> from reading to activities</li>
                                    <li>⏰ <strong>Unified Timing</strong> including reading time breakdown</li>
                                    <li>🎯 <strong>Text-Dependent Activities</strong> requiring evidence from reading</li>
                                    <li>📊 <strong>Integrated Assessment</strong> measuring both reading and content</li>
                                    <li>🖨️ <strong>Print-Ready Format</strong> with professional layout</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="export-buttons" id="integrated-export-buttons" style="display: none;">
                        <button onclick="printIntegratedLesson()" class="export-button print">🖨️ Print Complete Lesson</button>
                        <button onclick="copyIntegratedLesson()" class="export-button copy">📋 Copy Complete Lesson</button>
                        <button onclick="saveIntegratedLesson()" class="export-button">💾 Save Complete Lesson</button>
                        <button onclick="generateSmartPresentation()" class="export-button" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: bold;">🎨 Generate Smart Presentation</button>
                    </div>
                </div>

                <!-- Lesson Plan Tab Content -->
                <div class="tab-content" id="lesson-plan-content" style="display: none;">
                    <div class="panel-title">
                        🎯 Generated Lesson Plan
                    </div>

                    <div class="loading" id="loading">
                        <div class="loading-spinner"></div>
                        <h3>🤖 AI is crafting your lesson plan...</h3>
                        <p>Analyzing content and generating personalized activities</p>
                    </div>

                    <div class="lesson-plan-output" id="lesson-plan-output">
                        <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                            <h3>🚀 Ready to Generate</h3>
                            <p>Click "Generate AI Lesson Plan" to create a comprehensive 50-minute lesson plan tailored to your content.</p>
                            
                            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: left;">
                                <h4 style="color: #495057; margin-bottom: 15px;">✨ What You'll Get:</h4>
                                <ul style="color: #6c757d; line-height: 1.8;">
                                    <li>📅 <strong>Detailed timing breakdown</strong> (opening, activities, closure)</li>
                                    <li>🎯 <strong>Learning objectives</strong> aligned with content</li>
                                    <li>🗣️ <strong>Discussion questions</strong> and talking points</li>
                                    <li>🎨 <strong>Interactive activities</strong> and engagement strategies</li>
                                    <li>📝 <strong>Assessment opportunities</strong> throughout the lesson</li>
                                    <li>🎪 <strong>Differentiation strategies</strong> for various learning styles</li>
                                    <li>📚 <strong>Materials list</strong> and preparation notes</li>
                                    <li>🔗 <strong>Extensions and connections</strong> to other topics</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="export-buttons" id="export-buttons" style="display: none;">
                        <button onclick="printLessonPlan()" class="export-button print">🖨️ Print</button>
                        <button onclick="copyLessonPlan()" class="export-button copy">📋 Copy</button>
                        <button onclick="saveLessonPlan()" class="export-button">💾 Save</button>
                    </div>
                </div>

                <!-- Condensed Reading Tab Content -->
                <div class="tab-content" id="condensed-reading-content" style="display: none;">
                    <div class="panel-title">
                        📚 Generated Student Reading
                    </div>

                    <div class="loading" id="reading-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <h3>📖 AI is creating your condensed reading...</h3>
                        <p>Analyzing source materials and generating student-friendly content</p>
                    </div>

                    <div class="condensed-reading-output" id="condensed-reading-output">
                        <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                            <h3>📚 Ready to Generate</h3>
                            <p>Click "Generate Condensed Student Reading" to create curriculum-independent reading materials.</p>
                            
                            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: left;">
                                <h4 style="color: #495057; margin-bottom: 15px;">✨ What You'll Get:</h4>
                                <ul style="color: #6c757d; line-height: 1.8;">
                                    <li>📖 <strong>Condensed Reading</strong> (4-5 paragraphs, 150-200 words each)</li>
                                    <li>🎯 <strong>Multiple Complexity Levels</strong> (simplified, standard, advanced)</li>
                                    <li>📝 <strong>Comprehension Supports</strong> (pronunciation guides, margin questions)</li>
                                    <li>🔍 <strong>Text-Dependent Questions</strong> with paragraph references</li>
                                    <li>📚 <strong>Vocabulary Integration</strong> with context and definitions</li>
                                    <li>🗺️ <strong>Geographic Analysis Framework</strong> built into reading</li>
                                    <li>🌍 <strong>Cultural Sensitivity</strong> and contemporary connections</li>
                                    <li>📊 <strong>Assessment Integration</strong> with citation practice</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="export-buttons" id="reading-export-buttons" style="display: none;">
                        <button onclick="printCondensedReading()" class="export-button print">🖨️ Print Reading</button>
                        <button onclick="copyCondensedReading()" class="export-button copy">📋 Copy Reading</button>
                        <button onclick="saveCondensedReading()" class="export-button">💾 Save Reading</button>
                    </div>
                </div>

                <!-- Integrated Lesson Tab Content -->
                <div class="tab-content" id="integrated-lesson-content" style="display: none;">
                    <div class="panel-title">
                        🎯 Complete Integrated Lesson Package
                    </div>

                    <div class="loading" id="integrated-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <h3>🔧 AI is building your complete lesson...</h3>
                        <p>Integrating reading materials + lesson plan + handouts into one comprehensive package</p>
                        <div style="margin-top: 20px; padding: 15px; background: #fff5f5; border-radius: 10px; color: #721c24;">
                            <h4>🎯 Creating Your ONE-CLICK Solution:</h4>
                            <ul style="text-align: left; margin-top: 10px;">
                                <li>📚 Condensed student reading (curriculum-independent)</li>
                                <li>📝 Complete lesson plan (integrated with reading)</li>
                                <li>📄 Student handouts (text-dependent activities)</li>
                                <li>⏰ Unified timing guide (reading + activities)</li>
                                <li>✅ Assessment tools (reading + content integration)</li>
                                <li>🖨️ Print-ready format (no prep required)</li>
                            </ul>
                        </div>
                    </div>

                    <div class="integrated-lesson-output" id="integrated-lesson-output">
                        <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                            <h3>🎯 Ready to Create Complete Lesson</h3>
                            <p>Click "Generate Complete Integrated Lesson" to create a comprehensive, print-ready lesson package.</p>
                            
                            <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #fff5f5, #ffffff); border: 2px solid #ff6b6b; border-radius: 15px; text-align: left;">
                                <h4 style="color: #721c24; margin-bottom: 20px; text-align: center;">🎯 ONE-CLICK LESSON INTEGRATION</h4>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div style="background: #ffffff; padding: 15px; border-radius: 10px; border: 1px solid #ff6b6b;">
                                        <h5 style="color: #721c24; margin-bottom: 10px;">📚 Student Reading Section</h5>
                                        <ul style="color: #6c757d; font-size: 0.9rem; line-height: 1.6;">
                                            <li>Condensed, curriculum-independent content</li>
                                            <li>Paragraph numbering for lesson references</li>
                                            <li>Integrated vocabulary and supports</li>
                                            <li>Text-dependent question preparation</li>
                                        </ul>
                                    </div>
                                    <div style="background: #ffffff; padding: 15px; border-radius: 10px; border: 1px solid #ff6b6b;">
                                        <h5 style="color: #721c24; margin-bottom: 10px;">📝 Lesson Plan Section</h5>
                                        <ul style="color: #6c757d; font-size: 0.9rem; line-height: 1.6;">
                                            <li>Activities reference specific reading paragraphs</li>
                                            <li>Unified timing including reading time</li>
                                            <li>Text-dependent questions throughout</li>
                                            <li>Assessment aligned to reading + content</li>
                                        </ul>
                                    </div>
                                </div>

                                <div style="background: #fff8e6; padding: 15px; border-radius: 10px; border: 1px solid #ffc107;">
                                    <h5 style="color: #856404; margin-bottom: 10px;">📄 Complete Package Includes</h5>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                                        <div>
                                            <strong style="color: #721c24;">📖 Reading Materials</strong>
                                            <ul style="color: #6c757d; margin-top: 5px;">
                                                <li>Student reading text</li>
                                                <li>Vocabulary integration</li>
                                                <li>Comprehension supports</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <strong style="color: #721c24;">🚀 Lesson Components</strong>
                                            <ul style="color: #6c757d; margin-top: 5px;">
                                                <li>Hook activities</li>
                                                <li>Reading discussion</li>
                                                <li>Content activities</li>
                                                <li>Assessment tools</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <strong style="color: #721c24;">📋 Teacher Resources</strong>
                                            <ul style="color: #6c757d; margin-top: 5px;">
                                                <li>Student handouts</li>
                                                <li>Answer keys</li>
                                                <li>Implementation guide</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <div style="text-align: center; margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 10px; border: 1px solid #c3e6cb;">
                                    <h4 style="color: #155724; margin-bottom: 10px;">🎯 CURRICULUM INDEPENDENCE ACHIEVED</h4>
                                    <p style="color: #155724; margin: 0; font-weight: 500;">
                                        Print and teach immediately • No textbook required • Complete content package • Professional formatting
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="export-buttons" id="integrated-export-buttons" style="display: none;">
                        <button onclick="printIntegratedLesson()" class="export-button print">🖨️ Print Complete Lesson</button>
                        <button onclick="copyIntegratedLesson()" class="export-button copy">📋 Copy Lesson Package</button>
                        <button onclick="saveIntegratedLesson()" class="export-button">💾 Save Integrated Lesson</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentLessonData = null;
        let generatedLessonPlan = null;
        
        // Make currentLessonData available globally
        window.currentLessonData = currentLessonData;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentLessonData();
            loadUserSettings();
            checkAPIStatus();
            loadAllModules(); // Load modules for the selector
        });

        // Load all modules for the selector (like your main curriculum page does)
        async function loadAllModules() {
            try {
                console.log('🔄 Loading all modules for selector...');
                const response = await fetch('/api/modules');
                if (!response.ok) {
                    throw new Error(`Failed to fetch modules: ${response.status}`);
                }
                
                const modules = await response.json();
                console.log(`📚 Loaded ${modules.length} modules`);
                
                const moduleSelector = document.getElementById('module-selector');
                moduleSelector.innerHTML = '<option value="">Choose a module...</option>';
                
                // Sort modules by moduleNumber and populate selector
                modules.sort((a, b) => a.moduleNumber - b.moduleNumber);
                modules.forEach(module => {
                    const option = document.createElement('option');
                    option.value = module._id; // Use MongoDB _id
                    option.dataset.moduleNumber = module.moduleNumber;
                    option.textContent = `Module ${module.moduleNumber}: ${module.title}`;
                    moduleSelector.appendChild(option);
                });
                
                // Add event listener for module selection
                moduleSelector.addEventListener('change', loadLessonsForSelectedModule);
                
            } catch (error) {
                console.error('❌ Error loading modules:', error);
                const moduleSelector = document.getElementById('module-selector');
                moduleSelector.innerHTML = '<option value="">Error loading modules</option>';
            }
        }

        // Load lessons when a module is selected
        async function loadLessonsForSelectedModule() {
            const moduleSelector = document.getElementById('module-selector');
            const lessonSelector = document.getElementById('lesson-selector');
            const moduleId = moduleSelector.value;
            
            if (!moduleId) {
                lessonSelector.innerHTML = '<option value="">Select a module first</option>';
                return;
            }
            
            try {
                console.log(`🔍 Loading lessons for module: ${moduleId}`);
                const response = await fetch(`/api/modules/${moduleId}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch lessons: ${response.status}`);
                }
                
                const moduleData = await response.json();
                const lessons = moduleData.lessons || [];
                
                lessonSelector.innerHTML = '<option value="">Choose a lesson...</option>';
                
                // Sort lessons by lessonNumber and populate selector
                lessons.sort((a, b) => a.lessonNumber - b.lessonNumber);
                lessons.forEach(lesson => {
                    const option = document.createElement('option');
                    option.value = lesson.lessonNumber;
                    option.textContent = `Lesson ${lesson.lessonNumber}: ${lesson.title}`;
                    lessonSelector.appendChild(option);
                });
                
                console.log(`📖 Loaded ${lessons.length} lessons for this module`);
                
            } catch (error) {
                console.error('❌ Error loading lessons:', error);
                lessonSelector.innerHTML = '<option value="">Error loading lessons</option>';
            }
        }

        // Load the selected lesson
        function loadSelectedLesson() {
            const moduleSelector = document.getElementById('module-selector');
            const lessonSelector = document.getElementById('lesson-selector');
            
            const moduleId = moduleSelector.value;
            const moduleNumber = parseInt(moduleSelector.options[moduleSelector.selectedIndex]?.dataset?.moduleNumber);
            const lessonNumber = parseInt(lessonSelector.value);
            
            if (!moduleId || !moduleNumber || !lessonNumber) {
                alert('Please select both a module and a lesson first.');
                return;
            }
            
            console.log(`🎯 Loading selected lesson: Module ${moduleNumber}, Lesson ${lessonNumber}`);
            
            // Update URL to reflect selection (optional)
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('module', moduleNumber);
            newUrl.searchParams.set('lesson', lessonNumber);
            window.history.replaceState({}, '', newUrl);
            
            // Load the lesson data
            fetchLessonData(moduleNumber, lessonNumber);
        }

        // Load current lesson data from URL parameters or localStorage
        function loadCurrentLessonData() {
            try {
                // Try to get data from URL parameters first
                const urlParams = new URLSearchParams(window.location.search);
                const moduleNum = urlParams.get('module');
                const lessonNum = urlParams.get('lesson');

                if (moduleNum && lessonNum) {
                    // Validate and clean the parameters
                    const cleanModuleNum = parseInt(moduleNum);
                    let cleanLessonNum = lessonNum;
                    
                    // Check if lessonNum looks like a MongoDB ObjectId (24 hex characters)
                    if (/^[0-9a-fA-F]{24}$/.test(lessonNum)) {
                        console.log(`⚠️ Detected ObjectId-like lesson parameter: ${lessonNum}`);
                        console.log('� Converting to sequential lesson number based on module');
                        
                        // For now, default to lesson 1 since we don't have a mapping
                        cleanLessonNum = 1;
                        console.log(`📝 Using lesson number: ${cleanLessonNum}`);
                    } else {
                        cleanLessonNum = parseInt(lessonNum) || 1;
                    }
                    
                    if (isNaN(cleanModuleNum) || cleanModuleNum <= 0) {
                        console.error(`❌ Invalid module number: ${moduleNum}`);
                        displayErrorData();
                        return;
                    }
                    
                    console.log(`�🔍 Loading lesson data for Module ${cleanModuleNum}, Lesson ${cleanLessonNum}`);
                    // Fetch lesson data from the main system
                    fetchLessonData(cleanModuleNum, cleanLessonNum);
                } else {
                    // Fall back to localStorage or default
                    const savedLesson = localStorage.getItem('currentAILessonData');
                    if (savedLesson) {
                        console.log('📱 Loading lesson data from localStorage');
                        currentLessonData = JSON.parse(savedLesson);
                        window.currentLessonData = currentLessonData;
                        displayLessonData();
                    } else {
                        // Default placeholder data
                        console.log('⚠️ No lesson data found, showing placeholder');
                        displayPlaceholderData();
                    }
                }
            } catch (error) {
                console.error('❌ Error loading lesson data:', error);
                displayPlaceholderData();
            }
        }

        // Fetch lesson data from the server using the SAME approach as your main curriculum system
        async function fetchLessonData(moduleNum, lessonNum) {
            try {
                console.log(`🌐 Fetching modules to find Module ${moduleNum}...`);
                
                // Step 1: Get all modules (like your main curriculum-maps.html does)
                const modulesResponse = await fetch('/api/modules');
                if (!modulesResponse.ok) {
                    throw new Error(`Failed to fetch modules: ${modulesResponse.status}`);
                }
                
                const modules = await modulesResponse.json();
                console.log(`📚 Found ${modules.length} modules in the system`);
                
                // Step 2: Find the specific module by moduleNumber
                const targetModule = modules.find(m => m.moduleNumber === moduleNum);
                if (!targetModule) {
                    throw new Error(`Module ${moduleNum} not found. Available modules: ${modules.map(m => m.moduleNumber).join(', ')}`);
                }
                
                console.log(`✅ Found Module ${moduleNum}: ${targetModule.title}`);
                console.log(`🔍 Module ID: ${targetModule._id}`);
                
                // Step 3: Get lessons for this module using the MongoDB _id (like your main system)
                const lessonsResponse = await fetch(`/api/modules/${targetModule._id}`);
                if (!lessonsResponse.ok) {
                    throw new Error(`Failed to fetch lessons for module: ${lessonsResponse.status}`);
                }
                
                const moduleData = await lessonsResponse.json();
                const lessons = moduleData.lessons || [];
                
                console.log(`📖 Found ${lessons.length} lessons in Module ${moduleNum}`);
                
                // Step 4: Find the specific lesson by lessonNumber
                const targetLesson = lessons.find(l => l.lessonNumber === lessonNum);
                if (!targetLesson) {
                    // If specific lesson not found, use the first lesson as fallback
                    const fallbackLesson = lessons[0];
                    if (fallbackLesson) {
                        console.log(`⚠️ Lesson ${lessonNum} not found, using Lesson ${fallbackLesson.lessonNumber} as fallback`);
                        currentLessonData = formatLessonForAI(targetModule, fallbackLesson);
                        window.currentLessonData = currentLessonData;
                    } else {
                        throw new Error(`No lessons found in Module ${moduleNum}`);
                    }
                } else {
                    console.log(`✅ Found Lesson ${lessonNum}: ${targetLesson.title}`);
                    currentLessonData = formatLessonForAI(targetModule, targetLesson);
                    window.currentLessonData = currentLessonData;
                }
                
                console.log('📝 Formatted lesson data for AI:', currentLessonData);
                displayLessonData();
                
                // Save for future use
                localStorage.setItem('currentAILessonData', JSON.stringify(currentLessonData));
                
            } catch (error) {
                console.error('❌ Error fetching lesson data:', error);
                
                // Try to use localStorage data as fallback
                const savedLesson = localStorage.getItem('currentAILessonData');
                if (savedLesson) {
                    console.log('🔄 Using cached lesson data as fallback');
                    currentLessonData = JSON.parse(savedLesson);
                    window.currentLessonData = currentLessonData;
                    displayLessonData();
                    updateAPIStatus('warning', '⚠️ Using cached lesson data - some content may be outdated');
                } else {
                    // Show a helpful error message to the user
                    displayErrorData(error.message);
                }
            }
        }

        // Format lesson data from your MongoDB format to the AI planner format
        function formatLessonForAI(module, lesson) {
            // Debug: Log the actual lesson structure
            console.log('🔍 Raw lesson data structure:', lesson);
            console.log('🔍 Teacher content:', lesson.teacherContent);
            console.log('🔍 Student content:', lesson.studentContent);
            console.log('🔍 Vocabulary:', lesson.teacherContent?.vocabulary || lesson.vocabulary);
            
            return {
                moduleNumber: module.moduleNumber,
                moduleName: module.title,
                lessonNumber: lesson.lessonNumber,
                title: lesson.title,
                content: lesson.content || lesson.description || '',
                objectives: lesson.teacherContent?.objectives || lesson.objectives || [],
                materials: lesson.teacherContent?.materials || lesson.materials || [],
                procedures: lesson.teacherContent?.procedures || lesson.procedures || [],
                assessments: lesson.teacherContent?.assessments || lesson.assessments || [],
                vocabulary: lesson.teacherContent?.vocabulary || lesson.vocabulary || [],
                duration: lesson.duration || lesson.teacherContent?.duration || '45 minutes',
                // Include any additional content for richer AI generation
                studentContent: lesson.studentContent || {},
                teacherContent: lesson.teacherContent || {},
                geographicFocus: lesson.geographicFocus || '',
                standards: lesson.standards || [],
                concepts: lesson.concepts || []
            };
        }

        // Display lesson data in the interface
        function displayLessonData() {
            if (!currentLessonData) return;

            // Update lesson info
            document.getElementById('lesson-module').textContent = 
                `Module ${currentLessonData.moduleNumber}: ${currentLessonData.moduleName || 'Unknown Module'}`;
            document.getElementById('lesson-title').textContent = 
                `Lesson ${currentLessonData.lessonNumber}: ${currentLessonData.title || 'Unknown Lesson'}`;

            // Extract and display teacher content
            const teacherContent = extractTeacherContent(currentLessonData);
            document.getElementById('teacher-content').innerHTML = teacherContent;

            // Extract and display student content
            const studentContent = extractStudentContent(currentLessonData);
            document.getElementById('student-content').innerHTML = studentContent;

            updateAPIStatus('success', '✅ Lesson content loaded successfully');
            
            // Re-check API status now that we have lesson data
            checkAPIStatus();
        }

        // Extract teacher-focused content from lesson data
        function extractTeacherContent(lessonData) {
            let content = '';
            
            // Handle both direct properties and nested teacherContent structure
            const teacherData = lessonData.teacherContent || lessonData;
            const studentData = lessonData.studentContent || {};
            
            // Learning Objectives - handle both array and string formats
            if (teacherData.objectives) {
                const objectives = Array.isArray(teacherData.objectives) ? teacherData.objectives : [teacherData.objectives];
                if (objectives.length > 0 && objectives[0]) {
                    content += '<h4>📋 Learning Objectives:</h4><ul>';
                    objectives.forEach(obj => {
                        if (obj) content += `<li>${obj}</li>`;
                    });
                    content += '</ul>';
                }
            }

            // Materials Needed - handle both array and string formats
            if (teacherData.materials) {
                const materials = Array.isArray(teacherData.materials) ? teacherData.materials : [teacherData.materials];
                if (materials.length > 0 && materials[0]) {
                    content += '<h4>📦 Materials Needed:</h4><ul>';
                    materials.forEach(material => {
                        if (material) content += `<li>${material}</li>`;
                    });
                    content += '</ul>';
                }
            }

            // Teacher Notes (often contains rich content)
            if (teacherData.notes) {
                content += `<h4>📝 Teacher Notes:</h4><div class="lesson-content">${teacherData.notes}</div>`;
            }

            // Lesson Procedures
            if (teacherData.procedures && teacherData.procedures.length > 0) {
                content += '<h4>📝 Lesson Procedures:</h4><ol>';
                teacherData.procedures.forEach(procedure => {
                    content += `<li>${procedure}</li>`;
                });
                content += '</ol>';
            }

            // Assessment Methods
            if (teacherData.assessments && teacherData.assessments.length > 0) {
                content += '<h4>📊 Assessment Methods:</h4><ul>';
                teacherData.assessments.forEach(assessment => {
                    content += `<li>${assessment}</li>`;
                });
                content += '</ul>';
            }

            // Extensions
            if (teacherData.extensions) {
                content += `<h4>🎯 Extensions:</h4><div class="lesson-content">${teacherData.extensions}</div>`;
            }

            // Extract vocabulary from student reading content if teacher vocabulary is empty
            if (teacherData.vocabulary && teacherData.vocabulary.length > 0) {
                content += '<h4>📚 Key Vocabulary:</h4><div class="vocabulary-list">';
                teacherData.vocabulary.forEach(term => {
                    // Handle different vocabulary formats
                    if (typeof term === 'string') {
                        content += `<div class="vocab-item"><strong>${term}</strong></div>`;
                    } else if (term && typeof term === 'object') {
                        const termName = term.term || term.word || term.name || term.title || '';
                        const termDef = term.definition || term.def || term.meaning || term.description || '';
                        
                        if (termName && termDef) {
                            content += `<div class="vocab-item"><strong>${termName}:</strong> ${termDef}</div>`;
                        } else if (termName) {
                            content += `<div class="vocab-item"><strong>${termName}</strong></div>`;
                        }
                    }
                });
                content += '</div>';
            } else if (studentData.readings) {
                // Extract vocabulary from student readings if no explicit vocabulary
                // Make sure readings is a string before calling .match()
                const readingsText = typeof studentData.readings === 'string' ? studentData.readings : '';
                if (readingsText) {
                    const vocabMatches = readingsText.match(/\*\*([^*]+)\*\*/g);
                    if (vocabMatches && vocabMatches.length > 0) {
                        content += '<h4>📚 Key Terms (from reading):</h4><div class="vocabulary-list">';
                        vocabMatches.slice(0, 10).forEach(match => { // Limit to first 10 terms
                            const term = match.replace(/\*\*/g, '');
                            if (term.length > 2 && term.length < 50) { // Reasonable term length
                                content += `<div class="vocab-item"><strong>${term}</strong></div>`;
                            }
                        });
                        content += '</div>';
                    }
                }
            }

            return content || '<p>No detailed teacher content available</p>';
        }

        // Extract student reading content from lesson data
        function extractStudentContent(lessonData) {
            let content = '';

            // Try multiple sources for student content
            const studentData = lessonData.studentContent || {};
            const teacherData = lessonData.teacherContent || lessonData;

            // 1. Check for student readings (THIS IS THE KEY FIELD!)
            if (studentData.readings) {
                // Handle different reading formats - could be string, object, or array
                let readingContent = '';
                
                if (typeof studentData.readings === 'string') {
                    readingContent = studentData.readings;
                } else if (typeof studentData.readings === 'object') {
                    // If it's an object, try to extract content from common properties
                    readingContent = studentData.readings.content || 
                                   studentData.readings.text || 
                                   studentData.readings.reading || 
                                   JSON.stringify(studentData.readings, null, 2);
                } else {
                    readingContent = String(studentData.readings);
                }
                
                if (readingContent) {
                    content += `<h4>📖 Student Reading:</h4><div class="lesson-content">${readingContent}</div>`;
                }
            }
            
            // 2. Check for dedicated student content
            else if (studentData.content) {
                content += `<h4>📖 Student Reading:</h4><div class="lesson-content">${studentData.content}</div>`;
            }
            
            // 3. Use the main lesson content if no dedicated student content
            else if (lessonData.content) {
                content += `<h4>📖 Lesson Content:</h4><div class="lesson-content">${lessonData.content}</div>`;
            }
            
            // 4. Try to extract content from description
            else if (lessonData.description) {
                content += `<h4>📖 Lesson Overview:</h4><div class="lesson-content">${lessonData.description}</div>`;
            }

            // Add student activities if available
            if (studentData.activities) {
                content += `<h4>🎯 Student Activities:</h4><div class="lesson-content">${studentData.activities}</div>`;
            }

            // Add worksheets if available
            if (studentData.worksheets) {
                content += `<h4>📋 Worksheets:</h4><div class="lesson-content">${studentData.worksheets}</div>`;
            }

            // Add assignments if available
            if (studentData.assignments) {
                content += `<h4>� Assignments:</h4><div class="lesson-content">${studentData.assignments}</div>`;
            }

            // Check for geographic focus
            if (lessonData.geographicFocus) {
                content += `<h4>🌍 Geographic Focus:</h4><p>${lessonData.geographicFocus}</p>`;
            }

            // Add vocabulary for student reference - Handle multiple formats
            if (teacherData.vocabulary && teacherData.vocabulary.length > 0) {
                content += '<h4>📚 Key Terms to Know:</h4><div class="vocabulary-list">';
                teacherData.vocabulary.forEach(term => {
                    // Handle different vocabulary formats
                    if (typeof term === 'string') {
                        // Simple string format
                        content += `<div class="vocab-item"><strong>${term}</strong></div>`;
                    } else if (term && typeof term === 'object') {
                        // Object format - check various property names
                        const termName = term.term || term.word || term.name || term.title || '';
                        const termDef = term.definition || term.def || term.meaning || term.description || '';
                        
                        if (termName && termDef) {
                            content += `<div class="vocab-item"><strong>${termName}:</strong> ${termDef}</div>`;
                        } else if (termName) {
                            content += `<div class="vocab-item"><strong>${termName}</strong></div>`;
                        } else {
                            // If object has other properties, try to display them
                            const keys = Object.keys(term);
                            if (keys.length > 0) {
                                const key = keys[0];
                                const value = term[key];
                                if (value && value !== 'undefined') {
                                    content += `<div class="vocab-item"><strong>${key}:</strong> ${value}</div>`;
                                }
                            }
                        }
                    }
                });
                content += '</div>';
            }

            // If still no content, try to extract from any HTML structure
            if (!content && lessonData.content) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = lessonData.content;
                
                // Get main content sections
                const bigIdea = tempDiv.querySelector('.big-idea, [class*="big-idea"]');
                if (bigIdea) {
                    content += '<h4>The Big Idea:</h4>' + bigIdea.innerHTML;
                }

                const mainIdeas = tempDiv.querySelector('.main-ideas, [class*="main-ideas"]');
                if (mainIdeas) {
                    content += '<h4>Main Ideas:</h4>' + mainIdeas.innerHTML;
                }

                const keyTerms = tempDiv.querySelector('.key-terms, [class*="key-terms"]');
                if (keyTerms) {
                    content += '<h4>Key Terms and Places:</h4>' + keyTerms.innerHTML;
                }

                // If no specific sections found, use the whole content
                if (!content) {
                    content = tempDiv.textContent.substring(0, 1000) + (tempDiv.textContent.length > 1000 ? '...' : '');
                }
            }

            return content || '<p>No student reading content available</p>';
        }

        // Display placeholder data when no lesson is loaded
        function displayPlaceholderData() {
            document.getElementById('lesson-module').textContent = 'No module selected';
            document.getElementById('lesson-title').textContent = 'Please select a lesson from the main companion';
            document.getElementById('teacher-content').innerHTML = 
                '<p style="color: #6c757d;">Teacher guide content will appear here when a lesson is selected.</p>';
            document.getElementById('student-content').innerHTML = 
                '<p style="color: #6c757d;">Student reading content will appear here when a lesson is selected.</p>';
            
            updateAPIStatus('warning', '⚠️ No lesson selected. Please go back and select a lesson first.');
            setGenerationButtonsEnabled(false);
        }

        // Display error data
        function displayErrorData(customMessage = null) {
            const errorMessage = customMessage || 'Error loading lesson data. Please try again.';
            
            document.getElementById('lesson-module').textContent = 'Error';
            document.getElementById('lesson-title').textContent = 'Failed to Load Lesson';
            document.getElementById('teacher-content').innerHTML = 
                `<div style="color: #dc3545; padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px;">
                    <h4>❌ Error Loading Lesson Data</h4>
                    <p>${errorMessage}</p>
                    <p style="margin-top: 10px; font-size: 0.9em;">
                        <strong>Suggestions:</strong><br>
                        • Try going back and selecting a different lesson<br>
                        • Use Module 1, Lesson 1 or Module 2, Lesson 1 which have sample data<br>
                        • Contact your administrator if this problem persists
                    </p>
                </div>`;
            document.getElementById('student-content').innerHTML = 
                '<p style="color: #6c757d;">Student content not available due to loading error.</p>';
            
            updateAPIStatus('error', `❌ ${errorMessage}`);
            document.getElementById('generate-btn').disabled = true;
        }

        // Load user settings from localStorage
        function loadUserSettings() {
            const savedAPIKey = localStorage.getItem('openai_api_key');
            if (savedAPIKey) {
                document.getElementById('api-key').value = savedAPIKey;
            }

            const savedModel = localStorage.getItem('preferred_ai_model');
            if (savedModel) {
                document.getElementById('ai-model').value = savedModel;
            }

            const savedFocus = localStorage.getItem('preferred_lesson_focus');
            if (savedFocus) {
                document.getElementById('lesson-focus').value = savedFocus;
            }
        }

        // Save user settings to localStorage
        function saveUserSettings() {
            const apiKey = document.getElementById('api-key').value;
            if (apiKey) {
                localStorage.setItem('openai_api_key', apiKey);
            }

            localStorage.setItem('preferred_ai_model', document.getElementById('ai-model').value);
            localStorage.setItem('preferred_lesson_focus', document.getElementById('lesson-focus').value);
        }

        // Check API status and update UI
        function checkAPIStatus() {
            // First check if we have an API key from Railway environment
            fetch('/api/openai-key-status')
                .then(response => response.json())
                .then(data => {
                    if (data.hasKey) {
                        // Check if we have lesson data before enabling
                        if (currentLessonData) {
                            updateAPIStatus('success', '✅ Using OpenAI API key from server environment');
                            setGenerationButtonsEnabled(true);
                        } else {
                            updateAPIStatus('warning', '⚠️ Server API key available, waiting for lesson content...');
                            setGenerationButtonsEnabled(false);
                        }
                        // Hide the API key input section since we're using server key
                        const apiKeyGroup = document.getElementById('api-key').closest('.control-group');
                        if (apiKeyGroup) {
                            apiKeyGroup.style.display = 'none';
                        }
                        return;
                    } else {
                        // Fall back to local API key
                        checkLocalAPIKey();
                    }
                })
                .catch(error => {
                    console.log('No server API key available, checking local key');
                    checkLocalAPIKey();
                });
        }

        // Helper function to enable/disable generation buttons
        function setGenerationButtonsEnabled(enabled) {
            document.getElementById('generate-btn').disabled = !enabled;
            document.getElementById('condensed-reading-btn').disabled = !enabled;
            document.getElementById('integrated-lesson-btn').disabled = !enabled;
        }

        function checkLocalAPIKey() {
            const apiKey = document.getElementById('api-key').value;
            
            // If no lesson data, disable regardless of API key
            if (!currentLessonData) {
                updateAPIStatus('warning', '⚠️ No lesson content loaded');
                setGenerationButtonsEnabled(false);
                return;
            }
            
            if (!apiKey) {
                updateAPIStatus('warning', '⚠️ Please enter your OpenAI API key in Advanced Settings');
                setGenerationButtonsEnabled(false);
                return;
            }

            if (!apiKey.startsWith('sk-')) {
                updateAPIStatus('error', '❌ Invalid API key format. Should start with "sk-"');
                setGenerationButtonsEnabled(false);
                return;
            }

            updateAPIStatus('success', '✅ Ready to generate lesson plan and reading materials');
            setGenerationButtonsEnabled(true);
        }

        // Update API status display
        function updateAPIStatus(type, message) {
            const statusElement = document.getElementById('api-status');
            statusElement.className = 'api-status';
            statusElement.classList.add(type + '-status');
            statusElement.textContent = message;
        }

        // Toggle advanced settings
        function toggleAdvancedSettings() {
            const content = document.getElementById('advanced-content');
            content.classList.toggle('show');
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
                button.style.background = '#6c757d';
            });

            // Show selected tab content
            const selectedContent = document.getElementById(tabName + '-content');
            if (selectedContent) {
                selectedContent.style.display = 'block';
                selectedContent.classList.add('active');
            }

            // Activate selected tab button with appropriate color
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
                if (tabName === 'integrated-lesson') {
                    selectedTab.style.background = '#ff6b6b';
                } else if (tabName === 'lesson-plan') {
                    selectedTab.style.background = '#007bff';
                } else if (tabName === 'condensed-reading') {
                    selectedTab.style.background = '#28a745';
                }
            }
        }

        // Toggle reading options visibility
        function toggleReadingOptions() {
            const options = document.getElementById('reading-options');
            const isVisible = options.style.display !== 'none';
            options.style.display = isVisible ? 'none' : 'block';
        }

        // Generate condensed reading function
        async function generateCondensedReading() {
            console.log('📚 Starting condensed reading generation...');
            
            if (!currentLessonData) {
                alert('Please select a lesson first by going back to the lesson companion.');
                return;
            }

            console.log('📖 Current lesson data for reading:', currentLessonData);

            // Show reading options first time
            const options = document.getElementById('reading-options');
            if (options.style.display === 'none' || !options.style.display) {
                options.style.display = 'block';
                return;
            }

            // Save user settings
            saveUserSettings();

            // Switch to reading tab
            switchTab('condensed-reading');

            // Show loading state
            document.getElementById('reading-loading').style.display = 'block';
            document.getElementById('condensed-reading-output').innerHTML = '';
            document.getElementById('reading-export-buttons').style.display = 'none';

            // Disable button and show loading
            document.getElementById('condensed-reading-btn').disabled = true;
            document.getElementById('condensed-reading-btn').textContent = '📖 Generating Reading...';

            try {
                const prompt = buildCondensedReadingPrompt();
                console.log('📝 Built condensed reading prompt, length:', prompt.length);

                const generatedReading = await callOpenAIAPI(prompt);
                console.log('✅ Received condensed reading from AI');

                // Hide loading
                document.getElementById('reading-loading').style.display = 'none';

                // Display the generated reading
                displayGeneratedCondensedReading(generatedReading);

            } catch (error) {
                console.error('❌ Error generating condensed reading:', error);
                document.getElementById('reading-loading').style.display = 'none';
                
                document.getElementById('condensed-reading-output').innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 20px; border-radius: 8px; margin: 20px;">
                        <h3>❌ Error Generating Reading</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Please check your API settings and try again.</p>
                    </div>
                `;
            } finally {
                // Re-enable button
                document.getElementById('condensed-reading-btn').disabled = false;
                document.getElementById('condensed-reading-btn').textContent = '📚 Generate Condensed Student Reading';
            }
        }

        // Build the condensed reading prompt
        function buildCondensedReadingPrompt() {
            const complexity = document.getElementById('reading-complexity').value;
            const length = document.getElementById('reading-length').value;
            const focus = document.getElementById('reading-focus').value;
            const includeSupports = document.getElementById('include-supports').checked;
            const includeAssessment = document.getElementById('include-assessment').checked;

            const teacherContent = document.getElementById('teacher-content').textContent;
            const studentContent = document.getElementById('student-content').textContent;

            const focusDescriptions = {
                'balanced': 'balanced overview with equal attention to all aspects',
                'geographic': 'geographic emphasis with spatial thinking and environmental factors',
                'cultural': 'cultural emphasis with social structures and traditions',
                'historical': 'historical emphasis with chronology and cause-effect relationships',
                'environmental': 'environmental emphasis with human-environment interactions'
            };

            const lengthSpecs = {
                'condensed': '4-5 paragraphs, 150-200 words each',
                'comprehensive': '6-8 paragraphs, 175-225 words each',
                'detailed': '8-10 paragraphs, 200-250 words each'
            };

            return `# 📚 SOPHISTICATED CONDENSED READING GENERATOR

You are an expert educational content developer tasked with creating high-quality, curriculum-independent student reading materials. This reading must demonstrate educational sophistication while being accessible and engaging for 7th-grade students.

## 📖 SOURCE MATERIALS ANALYSIS

**LESSON CONTEXT:** Module ${currentLessonData.moduleNumber} - ${currentLessonData.title}
**READING FOCUS:** ${focusDescriptions[focus]}
**TARGET LENGTH:** ${lengthSpecs[length]}
**COMPLEXITY LEVEL:** ${complexity}

**TEACHER GUIDE CONTENT:**
${teacherContent || 'No teacher guide provided'}

**STUDENT CONTENT:**
${studentContent || 'No student content provided'}

**CORE VOCABULARY:** ${currentLessonData.vocabulary ? currentLessonData.vocabulary.map(v => v.term).join(', ') : 'None provided'}

---

## 🎯 CONDENSED READING GENERATION REQUIREMENTS

### 1. SOURCE MATERIAL ANALYSIS PROTOCOL
• **Identify main topics/themes** from source reading (3-7 major concepts)
• **Extract chronological or logical sequence** of information flow
• **Determine essential facts, dates, names, and concepts** that cannot be omitted
• **Locate specific examples and evidence** that support main ideas
• **Assess content volume** for optimal condensation ratio

### 2. CONDENSATION STRUCTURE REQUIREMENTS
• **Generate exactly ${length === 'condensed' ? '4-5' : length === 'comprehensive' ? '6-8' : '8-10'} paragraphs** from source material
• **Organize paragraphs logically:** Foundation/Background → Geographic/Contextual Factors → Peak/Main Characteristics → Achievements/Innovations → Decline/Change/Legacy
• **Maintain factual accuracy** while eliminating redundancy
• **Preserve discipline-specific vocabulary** and key terminology
• **Include concrete examples and evidence** for engagement
• **Create smooth transitions** showing relationships between concepts

### 3. PARAGRAPH DEVELOPMENT FRAMEWORK

**Paragraph 1 - Foundation/Background**
• Establish context (time, place, circumstances)
• Introduce main subject/civilization/concept/process
• Include key foundational elements or early developments
• Provide essential background knowledge
• End with transition to development

**Subsequent Paragraphs** (adapt based on ${focus} focus):
• Geographic factors and environmental influences
• Peak period characteristics and achievements
• Innovations, contributions, and significance
• Changes, challenges, and lasting impact

### 4. CONTENT PRESERVATION GUIDELINES
• **Maintain all proper nouns** (names, places, terms)
• **Preserve specific dates, numbers, measurements**
• **Include quoted material or key phrases**
• **Retain cause-and-effect relationships**
• **Keep comparative information** for scale and significance
• **Preserve cultural sensitivity** and appropriate terminology

### 5. READING LEVEL ADAPTATION
${complexity === 'simplified' ? `
**SIMPLIFIED VERSION REQUIREMENTS:**
• Use vocabulary 2 grade levels below target
• Create shorter, clearer sentences
• Provide context clues and embedded definitions
• Include parenthetical explanations for technical terms
• Maintain identical core content with linguistic simplification
` : complexity === 'advanced' ? `
**ADVANCED VERSION REQUIREMENTS:**
• Use vocabulary 1 grade level above target
• Include complex sentence structures
• Add supplementary details and connections
• Provide extended examples and analysis
• Include connections to broader implications
` : `
**STANDARD VERSION REQUIREMENTS:**
• Use grade-appropriate vocabulary and sentence structure
• Balance complexity with accessibility
• Include context clues for new terminology
• Maintain engaging but clear presentation
`}

${includeSupports ? `
### 6. COMPREHENSION SUPPORT FEATURES
• **Add descriptive paragraph headers** previewing main content
• **Bold key vocabulary terms** from lesson objectives
• **Include pronunciation guides** for unfamiliar names and terms
• **Generate "Before Reading" activation questions**
• **Include "During Reading" comprehension checkpoints** after each paragraph
• **Create "After Reading" synthesis prompts**
• **Add connection prompts** linking to contemporary issues
` : ''}

${includeAssessment ? `
### 7. ASSESSMENT INTEGRATION
• **Number all paragraphs and key sentences** for easy reference
• **Include margin annotations** connecting to lesson activities
• **Provide text-marking guides** with symbols for different information types
• **Add "Evidence Hunt" prompts** directing to supporting details
• **Include discussion question stems** requiring textual evidence
• **Create vocabulary-in-context exercises** using reading sentences
` : ''}

---

## 📋 REQUIRED READING FORMAT

# 📖 STUDENT READING: ${currentLessonData.title}

**Module ${currentLessonData.moduleNumber} | 7th Grade Geography | ${complexity.charAt(0).toUpperCase() + complexity.slice(1)} Level**

---

${includeSupports ? `
## 🎯 BEFORE READING
**Activation Questions:**
1. [Question connecting to prior knowledge]
2. [Question about geographic thinking]
3. [Question about cultural connections]

**Key Vocabulary Preview:** [List 5-8 essential terms with pronunciation]

---
` : ''}

## 📚 MAIN READING

### [Paragraph 1 Header] (${focus === 'geographic' ? 'Geographic Foundation' : focus === 'cultural' ? 'Cultural Background' : focus === 'historical' ? 'Historical Context' : focus === 'environmental' ? 'Environmental Setting' : 'Background and Setting'})

[Comprehensive paragraph establishing foundation - ${lengthSpecs[length].split(',')[1]}]

${includeSupports ? '[During Reading Question: Specific comprehension check]' : ''}

### [Paragraph 2 Header] (Geographic and Environmental Factors)

[Detailed paragraph on environmental influences - ${lengthSpecs[length].split(',')[1]}]

${includeSupports ? '[During Reading Question: Cause-effect analysis]' : ''}

### [Continue for all paragraphs...]

${includeAssessment ? `
---

## 🔍 TEXT-DEPENDENT QUESTIONS

**Paragraph-Specific Questions:**
1. [Question requiring citation from paragraph 1]
2. [Question requiring synthesis across paragraphs 2-3]
3. [Question requiring interpretation with evidence]

**Synthesis Questions:**
1. [Question requiring cross-paragraph analysis]
2. [Question connecting to contemporary issues]

**Evidence Practice:**
• Find and cite three examples of [specific concept]
• Compare information from paragraphs [X] and [Y]
• Use evidence from the reading to support the claim that...
` : ''}

${includeSupports ? `
---

## 💡 AFTER READING

**Comprehension Check:**
• Summarize each paragraph in one sentence
• Identify the main cause-and-effect relationships
• Connect three concepts from the reading to modern examples

**Discussion Starters:**
• How does this information help us understand...?
• What connections can you make between this and...?
• Why might this be important for understanding today's world?
` : ''}

---

**CONTENT SOPHISTICATION REQUIREMENT:** This condensed reading must demonstrate thorough analysis of source materials and maintain academic rigor while being accessible to 7th-grade students. Every paragraph should connect directly to lesson objectives and provide rich content for follow-up activities.

Create a reading that eliminates textbook dependency while maintaining educational sophistication and supporting diverse learning needs through ${complexity} complexity level and ${focus} focus.`;
        }

        // Display the generated condensed reading
        function displayGeneratedCondensedReading(reading) {
            const formattedReading = formatCondensedReading(reading);
            document.getElementById('condensed-reading-output').innerHTML = formattedReading;
            document.getElementById('reading-export-buttons').style.display = 'flex';
        }

        // Format the condensed reading with proper HTML structure
        function formatCondensedReading(readingText) {
            let formatted = readingText.replace(/\n/g, '<br>');
            
            // Format headers
            formatted = formatted.replace(/### (.*?)<br>/g, '<h3 style="color: #007bff; margin: 20px 0 10px 0; font-size: 1.3rem;">$1</h3>');
            formatted = formatted.replace(/## (.*?)<br>/g, '<h2 style="color: #495057; margin: 25px 0 15px 0; font-size: 1.5rem;">$1</h2>');
            formatted = formatted.replace(/# (.*?)<br>/g, '<h1 style="color: #007bff; margin: 30px 0 20px 0; font-size: 1.8rem; text-align: center; border-bottom: 2px solid #007bff; padding-bottom: 10px;">$1</h1>');
            
            // Format bold text
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong style="color: #495057;">$1</strong>');
            
            // Format bullet points
            formatted = formatted.replace(/(^|\<br\>)• /g, '$1<span style="color: #007bff;">•</span> ');
            
            // Format numbered lists
            formatted = formatted.replace(/(^|\<br\>)(\d+\.) /g, '$1<span style="color: #007bff; font-weight: bold;">$2</span> ');
            
            // Wrap in proper structure
            return `
                <div class="condensed-reading-content" style="max-width: 800px; margin: 0 auto; line-height: 1.8; font-size: 1.1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #28a745;">
                        <h2 style="color: #28a745; margin: 0;">📚 Generated Student Reading</h2>
                        <span style="background: #d4edda; padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; color: #155724; font-weight: bold;">
                            Curriculum Independent
                        </span>
                    </div>
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; border-left: 4px solid #28a745;">
                        ${formatted}
                    </div>
                </div>
            `;
        }

        // Export functions for condensed reading
        function printCondensedReading() {
            const content = document.getElementById('condensed-reading-output').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head><title>Student Reading - ${currentLessonData.title}</title></head>
                <body style="font-family: Arial, sans-serif; margin: 20px;">
                    ${content}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function copyCondensedReading() {
            const content = document.getElementById('condensed-reading-output').innerText;
            navigator.clipboard.writeText(content).then(() => {
                alert('📋 Student reading copied to clipboard!');
            });
        }

        function saveCondensedReading() {
            const content = document.getElementById('condensed-reading-output').innerHTML;
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `student-reading-${currentLessonData.title.replace(/\s+/g, '-').toLowerCase()}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Generate complete integrated lesson function
        async function generateIntegratedLesson() {
            console.log('🎯 Starting integrated lesson generation...');
            
            if (!currentLessonData) {
                alert('Please select a lesson first by going back to the lesson companion.');
                return;
            }

            console.log('📚 Current lesson data for integrated lesson:', currentLessonData);

            // Save user settings
            saveUserSettings();

            // Switch to integrated lesson tab
            switchTab('integrated-lesson');

            // Show loading state
            document.getElementById('integrated-loading').style.display = 'block';
            document.getElementById('integrated-lesson-output').innerHTML = '';
            document.getElementById('integrated-export-buttons').style.display = 'none';

            // Disable button and show loading
            document.getElementById('integrated-lesson-btn').disabled = true;
            document.getElementById('integrated-lesson-btn').innerHTML = `
                🔧 Generating Complete Lesson...
                <div style="font-size: 0.9rem; margin-top: 5px; opacity: 0.9;">
                    Building reading + lesson + handouts
                </div>
            `;

            try {
                const prompt = buildIntegratedLessonPrompt();
                console.log('📝 Built integrated lesson prompt, length:', prompt.length);

                const generatedLesson = await callOpenAIAPI(prompt);
                console.log('✅ Received integrated lesson from AI');
                
                // Validate the response
                if (!generatedLesson || typeof generatedLesson !== 'string') {
                    throw new Error('Invalid response from AI - no content received');
                }
                
                if (generatedLesson.length < 100) {
                    throw new Error('AI response too short - may be incomplete');
                }

                // Hide loading
                document.getElementById('integrated-loading').style.display = 'none';

                // Display the generated integrated lesson
                displayGeneratedIntegratedLesson(generatedLesson);

            } catch (error) {
                console.error('❌ Error generating integrated lesson:', error);
                document.getElementById('integrated-loading').style.display = 'none';
                
                document.getElementById('integrated-lesson-output').innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 20px; border-radius: 8px; margin: 20px;">
                        <h3>❌ Error Generating Integrated Lesson</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Please check your API settings and try again.</p>
                    </div>
                `;
            } finally {
                // Re-enable button
                document.getElementById('integrated-lesson-btn').disabled = false;
                document.getElementById('integrated-lesson-btn').innerHTML = `
                    🎯 Generate Complete Integrated Lesson
                    <div style="font-size: 0.9rem; margin-top: 5px; opacity: 0.9;">
                        Reading + Lesson Plan + Handouts (One-Click Solution)
                    </div>
                `;
            }
        }

        // Build the integrated lesson prompt
        function buildIntegratedLessonPrompt() {
            const lessonFocus = document.getElementById('lesson-focus').value;
            const classSize = document.getElementById('class-size').value;
            const customInstructions = document.getElementById('custom-prompt').value;
            const complexity = document.getElementById('reading-complexity').value;
            const length = document.getElementById('reading-length').value;
            const focus = document.getElementById('reading-focus').value;
            const includeSupports = document.getElementById('include-supports').checked;
            const includeAssessment = document.getElementById('include-assessment').checked;

            const teacherContent = document.getElementById('teacher-content').textContent;
            const studentContent = document.getElementById('student-content').textContent;

            const focusDescriptions = {
                'balanced': 'balanced mix of instruction, discussion, and activities',
                'interactive': 'highly interactive with frequent student participation',
                'discussion': 'discussion-heavy with socratic questioning',
                'hands-on': 'hands-on activities and experiential learning',
                'assessment': 'assessment-focused with multiple check-ins',
                'technology': 'technology integration and digital tools'
            };

            const readingFocusDescriptions = {
                'balanced': 'balanced overview with equal attention to all aspects',
                'geographic': 'geographic emphasis with spatial thinking and environmental factors',
                'cultural': 'cultural emphasis with social structures and traditions',
                'historical': 'historical emphasis with chronology and cause-effect relationships',
                'environmental': 'environmental emphasis with human-environment interactions'
            };

            const lengthSpecs = {
                'condensed': '4-5 paragraphs, 150-200 words each',
                'comprehensive': '6-8 paragraphs, 175-225 words each',
                'detailed': '8-10 paragraphs, 200-250 words each'
            };

            return `# 🎯 ONE-CLICK INTEGRATED LESSON GENERATOR

You are an expert educational content developer creating a complete, print-ready lesson package that eliminates all teacher preparation barriers. This integrated lesson must be immediately usable, professionally formatted, and curriculum-independent.

## 📚 SOURCE MATERIALS AND CONTEXT

**LESSON CONTEXT:** Module ${currentLessonData.moduleNumber} - ${currentLessonData.title}
**CLASS SIZE:** ${classSize} students
**LESSON FOCUS:** ${focusDescriptions[lessonFocus]}
**READING FOCUS:** ${readingFocusDescriptions[focus]}
**READING LENGTH:** ${lengthSpecs[length]}
**COMPLEXITY LEVEL:** ${complexity}
${customInstructions ? `**SPECIAL INSTRUCTIONS:** ${customInstructions}` : ''}

**TEACHER GUIDE CONTENT:**
${teacherContent || 'No teacher guide provided'}

**STUDENT CONTENT:**
${studentContent || 'No student content provided'}

**CORE VOCABULARY:** ${currentLessonData.vocabulary ? currentLessonData.vocabulary.map(v => v.term).join(', ') : 'None provided'}

---

## 🎯 COMPREHENSIVE LESSON COMPILATION PROTOCOL

### 1. DOCUMENT STRUCTURE INTEGRATION
• **Create single, continuous document** flowing seamlessly from reading to activities
• **Maintain consistent formatting** (fonts, spacing, headers, margins)
• **Use clear section dividers** with visual breaks between components
• **Include page numbers and section tabs** for navigation during instruction
• **Ensure printer-friendly layout** (1-inch margins, 12pt minimum fonts)

### 2. READING-TO-LESSON TRANSITION FRAMEWORK
• **Insert transition section** between reading and lesson plan including:
  - Reading Completion Checkpoint with quick comprehension questions
  - Vocabulary Review connecting reading terms to lesson activities
  - Activity Preview showing how reading content will be used
• **Cross-reference all paragraph numbers** from reading in lesson activities
• **Align reading annotations** with lesson activity requirements
• **Create seamless vocabulary integration** using exact terms from reading

### 3. UNIFIED HEADER SYSTEM
• **Standardize all headers** with lesson information:
  - 7th Grade Geography | Module ${currentLessonData.moduleNumber} | 50 Minutes | ${classSize} Students
  - ${currentLessonData.title}
  - Date line for teacher completion
• **Include reading time estimates** in lesson timing breakdown
• **Add "Materials Included" checklist** showing reading + handouts
• **Create teacher preparation summary** covering both reading and activities

### 4. INTEGRATED STANDARDS AND OBJECTIVES
• **Combine reading standards with content standards** in single objectives section
• **Reference specific reading paragraphs** in each learning objective
• **Align assessment criteria** to both reading comprehension and content mastery
• **Include text-dependent question stems** connecting to lesson essential questions
• **Cross-reference vocabulary tiers** with lesson activity requirements

### 5. SEAMLESS ACTIVITY INTEGRATION
• **Modify lesson opening** to reference specific reading paragraphs for activation
• **Insert reading time** into lesson pacing guide with paragraph breakdowns
• **Align all lesson activities** to use evidence from the condensed reading
• **Include reading citation requirements** in every activity description
• **Add "Reading Connection" notes** in margins of lesson activities

### 6. UNIFIED HANDOUT GENERATION
• **Combine all materials** into single printable packet:
  - Cover page with lesson information
  - Condensed reading (pages 2-X)
  - Lesson plan (pages X+1 to Y)
  - Student handouts (pages Y+1 to Z)
  - Answer keys (final pages)
• **Include handout reference numbers** in lesson plan activities
• **Create "Handout Distribution Guide"** showing when each page is used
• **Add page tabs or section markers** for quick teacher reference

### 7. COMPREHENSIVE PACING INTEGRATION
• **Create unified timing breakdown:**
  - Reading Time: X minutes (paragraph-by-paragraph breakdown)
  - Transition/Discussion: X minutes
  - Activity 1: X minutes (referencing reading paragraphs X-Y)
  - Activity 2: X minutes (referencing reading paragraphs Y-Z)
  - Assessment/Closure: X minutes
• **Include reading comprehension checkpoints** within lesson timing
• **Add flexible timing options** for different class periods (45, 50, 90 minutes)
• **Provide "if running behind" modifications** maintaining reading integration

### 8. DIFFERENTIATION UNIFICATION
• **Align reading levels** with lesson differentiation strategies
• **Create tiered handout versions** matching reading complexity levels
• **Include ELL supports** working across both reading and activities
• **Generate special needs modifications** for both reading and lesson components
• **Add advanced extension activities** deepening reading analysis

### 9. ASSESSMENT INTEGRATION PROTOCOL
• **Combine reading comprehension** with content assessment in single rubrics
• **Include text-dependent questions** throughout lesson activities
• **Create unified exit tickets** assessing both reading understanding and content mastery
• **Generate answer keys** referencing specific reading paragraphs
• **Add formative assessment checkpoints** monitoring both reading and content comprehension

### 10. TEACHER IMPLEMENTATION GUIDE
• **Create single preparation checklist** covering reading and lesson setup
• **Include "First Time Teaching" notes** for managing reading + activities
• **Add troubleshooting guide** for common reading/lesson integration issues
• **Provide substitute teacher instructions** covering both components
• **Include extension/homework options** building on reading content

### 11. PRINT-READY FORMATTING REQUIREMENTS
• **Use clear section headers** with appropriate hierarchy (# ## ###)
• **Include logical page breaks** between major sections:
  - Student Reading should start on new page
  - Lesson Plan should start on new page
  - Student Handouts should start on new page
  - Assessment Tools should start on new page
• **Format timing guides as tables** with proper | column | formatting
• **Structure content in paragraphs** avoiding overly long blocks
• **Include paragraph numbers** for reading sections (Paragraph 1, Paragraph 2, etc.)
• **Use consistent bullet point formatting** with • or - symbols
• **Create clear sub-headings** to break up content visually

---

## 📋 REQUIRED INTEGRATED LESSON FORMAT

Generate a CONCISE, professionally formatted lesson package following this EXACT structure:

# ${currentLessonData.title}
**Module ${currentLessonData.moduleNumber} | 7th Grade Geography | 50 Minutes | ${classSize} Students**

## � STUDENT READING (5-7 paragraphs max)
[Generate condensed reading with numbered paragraphs - NO introduction, just content]

## 🎯 LESSON OBJECTIVES
1. [One clear objective with reading integration]
2. [One geographic analysis objective]
3. [One cultural/historical connection objective]

## ⏰ LESSON TIMELINE
| Time | Activity | Reading Reference |
|------|----------|-------------------|
| 0-5 min | Hook & Preview | Paragraph 1 |
| 5-20 min | Guided Reading | Paragraphs 1-7 |
| 20-25 min | Discussion | Text evidence |
| 25-40 min | Activity | Paragraphs 3-5 |
| 40-50 min | Assessment | All paragraphs |

## 🚀 LESSON ACTIVITIES
**Opening Hook:** [Brief description referencing paragraph 1]
**Reading Strategy:** [How students will read the content]
**Main Activity:** [One focused activity using reading evidence]
**Assessment:** [Exit ticket with text-dependent question]

## 📝 STUDENT HANDOUT
[One focused handout requiring paragraph citations]

## ✅ ANSWER KEY
[Brief answers with paragraph references]

---
**CRITICAL REQUIREMENTS:**
- Keep total length under 2 pages when printed
- Eliminate all repetitive content
- No verbose explanations
- Focus on actionable content only
- Include paragraph numbers for all reading references

**CONTENT SOPHISTICATION REQUIREMENT:** Generate a complete, concise lesson package that teachers can print and use immediately. Focus on practical classroom application, not theoretical frameworks.

Generate the lesson following the exact format above.`;
        }

        // Display the generated integrated lesson
        function displayGeneratedIntegratedLesson(lesson) {
            try {
                const formattedLesson = formatIntegratedLesson(lesson);
                document.getElementById('integrated-lesson-output').innerHTML = formattedLesson;
                document.getElementById('integrated-export-buttons').style.display = 'flex';
                
                // Add PowerPoint generation button
                addPowerPointButton();
                
            } catch (error) {
                console.error('❌ Error formatting integrated lesson:', error);
                // Fallback to simple display
                document.getElementById('integrated-lesson-output').innerHTML = `
                    <div style="padding: 20px; background: #fff; border-radius: 8px; line-height: 1.6;">
                        <h2 style="color: #ff6b6b; margin-bottom: 20px;">🎯 Complete Integrated Lesson Package</h2>
                        <div style="white-space: pre-wrap; font-family: 'Times New Roman', serif;">${lesson}</div>
                    </div>
                `;
                document.getElementById('integrated-export-buttons').style.display = 'flex';
            }
        }

        // Add PowerPoint generation functionality
        function addPowerPointButton() {
            const exportButtons = document.getElementById('integrated-export-buttons');
            
            // Check if PowerPoint button already exists
            if (!document.getElementById('powerpoint-btn')) {
                const powerpointBtn = document.createElement('button');
                powerpointBtn.id = 'powerpoint-btn';
                powerpointBtn.className = 'export-button';
                powerpointBtn.style.background = 'linear-gradient(135deg, #d16ba5, #c777b9)';
                powerpointBtn.innerHTML = '� Generate Presentation';
                powerpointBtn.onclick = generatePowerPointPresentation;
                
                exportButtons.appendChild(powerpointBtn);
            }
        }

        // Get current lesson data for PowerPoint generation
        function getCurrentLessonData() {
            // First try the global variable
            if (window.currentLessonData) {
                console.log('🎯 Using window.currentLessonData:', window.currentLessonData);
                return window.currentLessonData;
            }
            
            // Second try the local variable
            if (typeof currentLessonData !== 'undefined' && currentLessonData) {
                console.log('🎯 Using local currentLessonData:', currentLessonData);
                return currentLessonData;
            }
            
            // Fallback: try to get from the displayed lesson info
            const moduleElement = document.querySelector('[data-module]');
            const lessonElement = document.querySelector('[data-lesson]');
            
            if (moduleElement && lessonElement) {
                console.log('🎯 Using DOM element data');
                return {
                    title: lessonElement.textContent || 'Selected Lesson',
                    moduleNumber: moduleElement.getAttribute('data-module') || '1',
                    moduleName: moduleElement.textContent || 'Geography Module'
                };
            }
            
            // Final fallback - generic data
            console.log('🎯 Using fallback data');
            return {
                title: 'Geography Lesson',
                moduleNumber: '1',
                moduleName: 'Geography Module'
            };
        }

        // Generate PowerPoint presentation
        async function generatePowerPointPresentation() {
            const button = document.getElementById('powerpoint-btn');
            button.innerHTML = '🔄 Creating Slides...';
            button.disabled = true;

            try {
                console.log('🎬 Starting PowerPoint generation...');
                
                const currentLessonData = getCurrentLessonData();
                console.log('📚 Current lesson data:', currentLessonData);
                
                const presentationPrompt = buildPresentationPrompt(currentLessonData);
                console.log('📝 Presentation prompt built, length:', presentationPrompt.length);
                
                // Use the common API function
                const presentation = await callOpenAIAPI(presentationPrompt);
                console.log('✅ Received presentation from AI');
                
                displayPowerPointPresentation(presentation);
                
                button.innerHTML = '🎬 Generate Presentation';
                button.disabled = false;

            } catch (error) {
                console.error('❌ Error generating presentation:', error);
                button.innerHTML = '❌ Error - Try Again';
                button.disabled = false;
                alert('Error generating presentation. Please check your API key and try again.');
            }
        }

        // Build presentation prompt
        function buildPresentationPrompt(lessonData) {
            // Get grade level safely with fallback
            const gradeLevelElement = document.getElementById('grade-level');
            const gradeLevel = gradeLevelElement ? gradeLevelElement.value : '7th Grade';
            
            return `Create a PowerPoint-style presentation for this geography lesson:

**LESSON TOPIC:** ${lessonData.title}
**MODULE:** ${lessonData.moduleNumber} - ${lessonData.moduleName}
**GRADE LEVEL:** ${gradeLevel}

**PRESENTATION REQUIREMENTS:**
- Create 8-12 slides maximum
- Each slide should have a clear title and 3-5 bullet points
- Include visual descriptions for images/maps that would enhance each slide
- Design for classroom projection and student engagement
- Include interactive discussion prompts
- End with assessment questions

**SLIDE STRUCTURE NEEDED:**
1. Title slide with lesson objectives
2. Hook/Engagement slide with compelling question or image
3. 4-6 content slides with key concepts
4. 1-2 activity slides with student engagement
5. 1 assessment slide with quick check questions
6. Closing slide with key takeaways

**FORMATTING:** Use this exact format for each slide:

---
## SLIDE [NUMBER]: [TITLE]

**Content:**
• [Bullet point 1]
• [Bullet point 2]
• [Bullet point 3]

**Visual Suggestion:** [Description of map, image, or graphic that would enhance this slide]

**Teacher Notes:** [Brief speaking points or discussion prompts]
---

Create an engaging, classroom-ready presentation that brings this geography topic to life!`;
        }

        // Display PowerPoint presentation
        function displayPowerPointPresentation(presentation) {
            // Create presentation viewer
            const presentationHTML = `
                <div style="max-width: 1000px; margin: 20px auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center;">
                        <h2 style="margin: 0; font-size: 24px;">🎬 PowerPoint Presentation Generated</h2>
                        <p style="margin: 10px 0 0 0; opacity: 0.9;">Ready for classroom use - copy to PowerPoint or present directly</p>
                    </div>
                    
                    <div style="padding: 30px; line-height: 1.6; font-family: Arial, sans-serif;">
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9ff; border-left: 4px solid #667eea; border-radius: 4px;">
                            <strong>📋 Instructions:</strong> Each slide is formatted for easy copying into PowerPoint. Visual suggestions are included for each slide to help you find appropriate images and graphics.
                        </div>
                        
                        <div style="white-space: pre-wrap; font-size: 14px; background: #fafafa; padding: 20px; border-radius: 8px; border: 1px solid #e1e5e9;">${presentation}</div>
                    </div>
                    
                    <div style="padding: 20px; background: #f8f9fa; border-top: 1px solid #e1e5e9; text-align: center;">
                        <button onclick="copyPresentationToClipboard()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin-right: 10px; font-weight: bold;">
                            📋 Copy All Slides
                        </button>
                        <button onclick="printPresentation()" style="background: linear-gradient(135deg, #43a047, #66bb6a); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            🖨️ Print Slides
                        </button>
                    </div>
                </div>
            `;

            // Show in a modal or new tab
            const presentationWindow = window.open('', '_blank');
            presentationWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>PowerPoint Presentation - Generated</title>
                    <style>
                        body { margin: 0; padding: 20px; background: #f0f2f5; font-family: Arial, sans-serif; }
                        @media print {
                            body { background: white; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${presentationHTML}
                    <script>
                        function copyPresentationToClipboard() {
                            const content = document.querySelector('div[style*="white-space: pre-wrap"]').textContent;
                            navigator.clipboard.writeText(content).then(() => {
                                alert('Presentation copied to clipboard! Paste into PowerPoint.');
                            });
                        }
                        
                        function printPresentation() {
                            window.print();
                        }
                    <\/script>
                </body>
                </html>
            `);
            presentationWindow.document.close();
        }

        // ========================================
        // SMART PRESENTATION SYSTEM (Gamma.ai Style)
        // ========================================

        // Generate Smart Presentation (Main Function)
        async function generateSmartPresentation() {
            console.log('🎨 Starting Smart Presentation generation...');
            
            // Check if we have lesson content
            const lessonContent = document.getElementById('integrated-lesson-output').innerHTML;
            if (!lessonContent || lessonContent.trim() === '') {
                alert('Please generate a complete lesson first before creating a smart presentation.');
                return;
            }

            try {
                // Show loading overlay
                showSmartPresentationLoading();
                
                // Step 1: Analyze lesson content and create slide structure
                console.log('📊 Analyzing lesson content...');
                const slideStructure = await analyzeContentForSlides(lessonContent);
                
                // Step 2: Generate visual recommendations for each slide
                console.log('🖼️ Planning visual content...');
                const visualPlan = await planSlideVisuals(slideStructure);
                
                // Step 3: Fetch images and create presentation
                console.log('🎯 Building smart presentation...');
                const smartPresentation = await buildSmartPresentation(slideStructure, visualPlan);
                
                // Step 4: Display the presentation
                displaySmartPresentation(smartPresentation);
                
            } catch (error) {
                console.error('❌ Error generating smart presentation:', error);
                hideSmartPresentationLoading();
                alert('Error generating smart presentation: ' + error.message);
            }
        }

        // Analyze lesson content and create intelligent slide structure
        async function analyzeContentForSlides(lessonContent) {
            const currentLessonData = getCurrentLessonData();
            
            const analysisPrompt = `Analyze this complete geography lesson and create an intelligent slide structure for a Gamma.ai style presentation:

LESSON CONTENT:
${lessonContent}

LESSON DETAILS:
- Topic: ${currentLessonData.title}
- Module: ${currentLessonData.moduleNumber} - ${currentLessonData.moduleName}

Create a slide-by-slide breakdown that follows presentation best practices:

REQUIREMENTS:
- 8-12 slides maximum for optimal engagement
- Each slide should have ONE clear focus
- Include engaging hooks, smooth transitions
- Balance content delivery with interactive elements
- Include visual suggestions for each slide
- Speaker notes for teaching guidance

FORMAT YOUR RESPONSE AS JSON:
{
  "presentationTitle": "Engaging title for the presentation",
  "totalSlides": 10,
  "slides": [
    {
      "slideNumber": 1,
      "slideType": "title",
      "title": "Slide title",
      "content": ["Key point 1", "Key point 2", "Key point 3"],
      "visualSuggestion": "Description of ideal visual (photo/map/diagram)",
      "speakerNotes": "Teaching notes and discussion prompts",
      "transition": "How to transition to next slide"
    }
  ]
}

SLIDE TYPES to use: "title", "hook", "content", "activity", "assessment", "conclusion"

Generate an engaging, pedagogically sound presentation structure.`;

            const response = await callOpenAIAPI(analysisPrompt);
            return JSON.parse(response);
        }

        // Plan visual content for each slide using visual intelligence
        async function planSlideVisuals(slideStructure) {
            console.log('🎨 Planning visuals for', slideStructure.slides.length, 'slides...');
            
            const visualPlan = {
                presentationId: Date.now(),
                slides: []
            };

            for (const slide of slideStructure.slides) {
                const visualInfo = await planSlideVisual(slide);
                visualPlan.slides.push({
                    slideNumber: slide.slideNumber,
                    visualType: visualInfo.type,
                    searchQuery: visualInfo.searchQuery,
                    mapRequired: visualInfo.mapRequired,
                    customGraphic: visualInfo.customGraphic
                });
            }

            return visualPlan;
        }

        // Plan visual for individual slide
        async function planSlideVisual(slide) {
            // Determine visual type based on slide content
            const content = slide.content.join(' ').toLowerCase();
            const visualSuggestion = slide.visualSuggestion.toLowerCase();
            
            let visualType = 'photo';
            let searchQuery = '';
            let mapRequired = false;
            let customGraphic = false;

            // Geographic content detection
            if (content.includes('map') || content.includes('location') || content.includes('region') || 
                content.includes('country') || content.includes('continent') || content.includes('geographic')) {
                visualType = 'map';
                mapRequired = true;
                searchQuery = extractLocationFromContent(content);
            }
            // Photo content detection
            else if (visualSuggestion.includes('photo') || visualSuggestion.includes('image')) {
                visualType = 'photo';
                searchQuery = generatePhotoSearchQuery(slide);
            }
            // Diagram content detection
            else if (visualSuggestion.includes('diagram') || visualSuggestion.includes('chart') || 
                     visualSuggestion.includes('graphic')) {
                visualType = 'custom';
                customGraphic = true;
                searchQuery = generateDiagramPrompt(slide);
            }
            else {
                // Default to relevant geography photo
                visualType = 'photo';
                searchQuery = generatePhotoSearchQuery(slide);
            }

            return {
                type: visualType,
                searchQuery: searchQuery,
                mapRequired: mapRequired,
                customGraphic: customGraphic
            };
        }

        // Extract location information from content
        function extractLocationFromContent(content) {
            const currentLessonData = getCurrentLessonData();
            // Use lesson title and module for location context
            return `${currentLessonData.title} ${currentLessonData.moduleName} geography map`;
        }

        // Generate photo search query for Unsplash
        function generatePhotoSearchQuery(slide) {
            const currentLessonData = getCurrentLessonData();
            const keywords = slide.content.join(' ');
            
            // Extract key geographic terms
            const geoTerms = extractGeographicTerms(keywords);
            return `${currentLessonData.moduleName} ${geoTerms} geography landscape`.replace(/\s+/g, ' ').trim();
        }

        // Extract geographic terms from content
        function extractGeographicTerms(content) {
            const geoKeywords = ['mountain', 'river', 'ocean', 'desert', 'forest', 'climate', 'culture', 
                               'population', 'city', 'rural', 'urban', 'agriculture', 'industry', 'trade'];
            
            const foundTerms = geoKeywords.filter(term => 
                content.toLowerCase().includes(term)
            );
            
            return foundTerms.slice(0, 3).join(' ');
        }

        // Build the complete smart presentation
        async function buildSmartPresentation(slideStructure, visualPlan) {
            console.log('🏗️ Building presentation with', slideStructure.slides.length, 'slides...');
            
            const presentation = {
                title: slideStructure.presentationTitle,
                totalSlides: slideStructure.totalSlides,
                slides: [],
                generatedAt: new Date().toISOString()
            };

            // Build each slide with content and visuals
            for (let i = 0; i < slideStructure.slides.length; i++) {
                const slide = slideStructure.slides[i];
                const visual = visualPlan.slides[i];
                
                console.log(`🔨 Building slide ${slide.slideNumber}: ${slide.title}`);
                
                // Fetch visual content based on type
                let visualContent = null;
                if (visual.visualType === 'photo') {
                    visualContent = await fetchUnsplashImage(visual.searchQuery);
                } else if (visual.visualType === 'map') {
                    visualContent = await generateMapboxMap(visual.searchQuery);
                } else if (visual.visualType === 'custom') {
                    visualContent = await generateCustomGraphic(visual.searchQuery);
                }

                presentation.slides.push({
                    ...slide,
                    visual: visualContent || getDefaultVisual(slide.slideType),
                    visualType: visual.visualType
                });
            }

            return presentation;
        }

        // Show loading overlay for smart presentation generation
        function showSmartPresentationLoading() {
            const loadingHTML = `
                <div id="smart-presentation-loading" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                    align-items: center; justify-content: center; color: white;
                ">
                    <div style="text-align: center; padding: 40px; background: #333; border-radius: 15px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🎨</div>
                        <h2>Generating Smart Presentation</h2>
                        <div id="loading-progress" style="margin: 20px 0;">
                            <div>📊 Analyzing lesson content...</div>
                        </div>
                        <div style="width: 300px; height: 4px; background: #555; border-radius: 2px; margin: 20px auto;">
                            <div id="progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 2px; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', loadingHTML);
            
            // Simulate progress updates
            setTimeout(() => updateLoadingProgress('🖼️ Planning visual content...', 25), 1000);
            setTimeout(() => updateLoadingProgress('🎯 Fetching images and maps...', 50), 3000);
            setTimeout(() => updateLoadingProgress('🏗️ Building presentation layout...', 75), 5000);
        }

        // Update loading progress
        function updateLoadingProgress(message, percentage) {
            const progressElement = document.getElementById('loading-progress');
            const progressBar = document.getElementById('progress-bar');
            
            if (progressElement) progressElement.innerHTML = `<div>${message}</div>`;
            if (progressBar) progressBar.style.width = percentage + '%';
        }

        // Hide loading overlay
        function hideSmartPresentationLoading() {
            const loading = document.getElementById('smart-presentation-loading');
            if (loading) loading.remove();
        }

        // ========================================
        // VISUAL API INTEGRATIONS
        // ========================================

        // Fetch image from Unsplash API
        async function fetchUnsplashImage(searchQuery) {
            try {
                console.log('📸 Fetching Unsplash image for:', searchQuery);
                
                const response = await fetch(`/api/unsplash-image?query=${encodeURIComponent(searchQuery)}`);
                if (!response.ok) throw new Error('Unsplash API error');
                
                const imageData = await response.json();
                return {
                    type: 'image',
                    url: imageData.url,
                    alt: imageData.alt || searchQuery,
                    credit: imageData.credit || 'Unsplash',
                    thumbnail: imageData.thumbnail
                };
            } catch (error) {
                console.warn('⚠️ Unsplash fetch failed:', error);
                return getDefaultVisual('photo');
            }
        }

        // Generate Mapbox map
        async function generateMapboxMap(locationQuery) {
            try {
                console.log('🗺️ Generating Mapbox map for:', locationQuery);
                
                const response = await fetch(`/api/mapbox-map?query=${encodeURIComponent(locationQuery)}`);
                if (!response.ok) throw new Error('Mapbox API error');
                
                const mapData = await response.json();
                return {
                    type: 'map',
                    url: mapData.staticUrl,
                    interactive: mapData.interactiveUrl,
                    coordinates: mapData.coordinates,
                    zoom: mapData.zoom
                };
            } catch (error) {
                console.warn('⚠️ Mapbox generation failed:', error);
                return getDefaultVisual('map');
            }
        }

        // Generate custom graphic using Stability AI
        async function generateCustomGraphic(promptText) {
            try {
                console.log('🎨 Generating custom graphic for:', promptText);
                
                const response = await fetch(`/api/generate-graphic`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: promptText })
                });
                
                if (!response.ok) throw new Error('Graphics generation error');
                
                const graphicData = await response.json();
                return {
                    type: 'custom',
                    url: graphicData.imageUrl,
                    prompt: promptText,
                    style: 'educational'
                };
            } catch (error) {
                console.warn('⚠️ Custom graphic generation failed:', error);
                return getDefaultVisual('diagram');
            }
        }

        // Get default visual for fallback
        function getDefaultVisual(slideType) {
            const defaults = {
                'title': { type: 'gradient', url: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', alt: 'Title background' },
                'photo': { type: 'placeholder', url: 'https://via.placeholder.com/800x450/4a90e2/ffffff?text=Geography+Image', alt: 'Geography placeholder' },
                'map': { type: 'placeholder', url: 'https://via.placeholder.com/800x450/2ecc71/ffffff?text=Map+Visualization', alt: 'Map placeholder' },
                'diagram': { type: 'placeholder', url: 'https://via.placeholder.com/800x450/e74c3c/ffffff?text=Diagram', alt: 'Diagram placeholder' },
                'default': { type: 'gradient', url: 'linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)', alt: 'Default background' }
            };
            
            return defaults[slideType] || defaults['default'];
        }

        // ========================================
        // SMART PRESENTATION DISPLAY SYSTEM
        // ========================================

        // Display the completed smart presentation
        function displaySmartPresentation(presentation) {
            console.log('🎉 Displaying smart presentation:', presentation.title);
            hideSmartPresentationLoading();
            
            const presentationHTML = generatePresentationHTML(presentation);
            
            // Open in new window
            const presentationWindow = window.open('', '_blank');
            presentationWindow.document.write(presentationHTML);
            presentationWindow.document.close();
            
            // Setup navigation controls
            setupPresentationControls(presentationWindow, presentation);
        }

        // Generate complete presentation HTML
        function generatePresentationHTML(presentation) {
            const slidesHTML = presentation.slides.map(slide => generateSlideHTML(slide)).join('');
            
            return `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${presentation.title}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            overflow: hidden;
        }
        
        .presentation-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        .slide {
            width: 100%;
            height: 100%;
            display: none;
            padding: 60px;
            background: white;
            position: relative;
            overflow: hidden;
        }
        
        .slide.active {
            display: flex;
            flex-direction: column;
        }
        
        .slide-header {
            margin-bottom: 40px;
        }
        
        .slide-title {
            font-size: 3.5em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
            line-height: 1.2;
        }
        
        .slide-content {
            flex: 1;
            display: flex;
            gap: 40px;
            align-items: center;
        }
        
        .content-text {
            flex: 1;
            font-size: 1.4em;
            line-height: 1.6;
            color: #34495e;
        }
        
        .content-text ul {
            list-style: none;
            padding: 0;
        }
        
        .content-text li {
            margin: 15px 0;
            padding: 15px 0;
            border-bottom: 1px solid #ecf0f1;
            font-size: 1.2em;
        }
        
        .content-text li::before {
            content: "▶";
            color: #3498db;
            margin-right: 15px;
            font-weight: bold;
        }
        
        .content-visual {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            max-height: 500px;
        }
        
        .content-visual img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .slide-title-type {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            justify-content: center;
            align-items: center;
        }
        
        .slide-title-type .slide-title {
            color: white;
            font-size: 4.5em;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .presentation-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 1000;
        }
        
        .control-btn {
            padding: 12px 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: rgba(0,0,0,0.9);
            transform: scale(1.05);
        }
        
        .slide-counter {
            position: fixed;
            top: 30px;
            right: 30px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
        }
        
        .speaker-notes {
            position: fixed;
            bottom: 80px;
            left: 30px;
            right: 30px;
            max-height: 100px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            color: #2c3e50;
            display: none;
            overflow-y: auto;
        }
        
        .speaker-notes.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="presentation-container">
        ${slidesHTML}
        
        <div class="slide-counter">
            <span id="current-slide">1</span> / <span id="total-slides">${presentation.totalSlides}</span>
        </div>
        
        <div class="presentation-controls">
            <button class="control-btn" onclick="previousSlide()">◀ Previous</button>
            <button class="control-btn" onclick="toggleNotes()">📝 Notes</button>
            <button class="control-btn" onclick="nextSlide()">Next ▶</button>
        </div>
        
        <div class="speaker-notes" id="speaker-notes"></div>
    </div>
    
    <script>
        let currentSlide = 1;
        const totalSlides = ${presentation.totalSlides};
        
        function showSlide(n) {
            document.querySelectorAll('.slide').forEach(slide => slide.classList.remove('active'));
            document.getElementById('slide-' + n).classList.add('active');
            document.getElementById('current-slide').textContent = n;
            
            // Update speaker notes
            const notes = slideNotes[n] || '';
            document.getElementById('speaker-notes').textContent = notes;
        }
        
        function nextSlide() {
            if (currentSlide < totalSlides) {
                currentSlide++;
                showSlide(currentSlide);
            }
        }
        
        function previousSlide() {
            if (currentSlide > 1) {
                currentSlide--;
                showSlide(currentSlide);
            }
        }
        
        function toggleNotes() {
            const notes = document.getElementById('speaker-notes');
            notes.classList.toggle('show');
        }
        
        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowRight' || e.key === ' ') nextSlide();
            if (e.key === 'ArrowLeft') previousSlide();
            if (e.key === 'n' || e.key === 'N') toggleNotes();
        });
        
        // Speaker notes data
        const slideNotes = {
            ${presentation.slides.map(slide => `${slide.slideNumber}: ${JSON.stringify(slide.speakerNotes || '')}`).join(',\n            ')}
        };
        
        // Initialize presentation
        showSlide(1);
    </script>
</body>
</html>
            `;
        }

        // Generate HTML for individual slide
        function generateSlideHTML(slide) {
            const isTitle = slide.slideType === 'title';
            const visualHTML = generateVisualHTML(slide.visual);
            
            if (isTitle) {
                return `
                    <div id="slide-${slide.slideNumber}" class="slide slide-title-type">
                        <h1 class="slide-title">${slide.title}</h1>
                        ${slide.content.length > 0 ? `<p style="font-size: 1.5em; margin-top: 30px; opacity: 0.9;">${slide.content.join(' • ')}</p>` : ''}
                    </div>
                `;
            }
            
            return `
                <div id="slide-${slide.slideNumber}" class="slide">
                    <div class="slide-header">
                        <h1 class="slide-title">${slide.title}</h1>
                    </div>
                    <div class="slide-content">
                        <div class="content-text">
                            <ul>
                                ${slide.content.map(point => `<li>${point}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="content-visual">
                            ${visualHTML}
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate visual HTML based on type
        function generateVisualHTML(visual) {
            if (!visual) return '<div style="color: #bdc3c7;">Visual content loading...</div>';
            
            switch (visual.type) {
                case 'image':
                    return `<img src="${visual.url}" alt="${visual.alt}" />`;
                case 'map':
                    return `<img src="${visual.url}" alt="Geographic map" style="border-radius: 10px;" />`;
                case 'custom':
                    return `<img src="${visual.url}" alt="Custom diagram" />`;
                case 'gradient':
                    return `<div style="width: 100%; height: 300px; background: ${visual.url}; border-radius: 15px;"></div>`;
                case 'placeholder':
                    return `<img src="${visual.url}" alt="${visual.alt}" />`;
                default:
                    return '<div style="color: #bdc3c7;">Visual content unavailable</div>';
            }
        }

        // Setup presentation controls (called after window opens)
        function setupPresentationControls(presentationWindow, presentation) {
            // Additional setup can be added here if needed
            console.log('🎮 Presentation controls ready');
        }

        // Format the integrated lesson with proper HTML structure and page breaks
        function formatIntegratedLesson(lessonText) {
            if (!lessonText || typeof lessonText !== 'string') {
                throw new Error('Invalid lesson text provided to formatter');
            }
            
            let formatted = lessonText.replace(/\n/g, '<br>');
            
            // Add page break classes for major sections
            formatted = formatted.replace(/# 📖 (.*?)<br>/g, '<div class="section-break"><h1 class="lesson-title">📖 $1</h1></div>');
            formatted = formatted.replace(/## 🚀 INTEGRATED LESSON PLAN<br>/g, '<div class="lesson-section"><h2>🚀 INTEGRATED LESSON PLAN</h2></div>');
            formatted = formatted.replace(/## 📝 STUDENT HANDOUTS<br>/g, '<div class="handout-section"><h2>📝 STUDENT HANDOUTS</h2></div>');
            formatted = formatted.replace(/## ✅ INTEGRATED ASSESSMENT TOOLS<br>/g, '<div class="page-break-before"><h2>✅ INTEGRATED ASSESSMENT TOOLS</h2></div>');
            
            // Format headers with different levels and page break controls
            formatted = formatted.replace(/### (.*?)<br>/g, '<h3 class="page-break-avoid" style="color: #ff6b6b; margin: 20px 0 10px 0; font-size: 1.3rem; border-left: 4px solid #ff6b6b; padding-left: 10px;">$1</h3>');
            formatted = formatted.replace(/## (.*?)<br>/g, '<h2 class="page-break-avoid" style="color: #495057; margin: 25px 0 15px 0; font-size: 1.5rem; border-bottom: 2px solid #e9ecef; padding-bottom: 5px;">$2</h2>');
            formatted = formatted.replace(/# (.*?)<br>/g, '<h1 class="lesson-header page-break-avoid" style="color: #ff6b6b; margin: 30px 0 20px 0; font-size: 1.8rem; text-align: center; border: 3px solid #ff6b6b; padding: 15px; border-radius: 10px; background: #fff5f5;">$1</h1>');
            
            // Format paragraphs with proper spacing and orphan/widow control
            formatted = formatted.replace(/Paragraph (\d+)<br>/g, '<div class="reading-paragraph"><strong>Paragraph $1</strong><br>');
            formatted = formatted.replace(/(.*?<\/strong><br>.*?)<br><br>/g, '$1</div><br>');
            
            // Format lesson at a glance section
            formatted = formatted.replace(/📋 LESSON AT A GLANCE<br>/g, '<div class="objectives-box"><h3>📋 LESSON AT A GLANCE</h3>');
            formatted = formatted.replace(/### Integrated Learning Objectives<br>(.*?)### Standards Alignment/gs, '<div class="content-box"><h4>Integrated Learning Objectives</h4>$1</div><h4>Standards Alignment</h4>');
            
            // Format timing guide as a proper table
            formatted = formatted.replace(/⏰ INTEGRATED TIMING GUIDE<br><br>\| Time \| Activity \| Reading Connection \|<br>\|------|----------|-------------------|<br>(.*?)<br><br>/gs, function(match, tableContent) {
                if (!tableContent) return match; // Safety check
                let tableRows = tableContent.split('<br>').filter(row => row.trim() && row.includes('|'));
                let tableHTML = '<div class="timing-table page-break-avoid"><h3>⏰ INTEGRATED TIMING GUIDE</h3><table><thead><tr><th>Time</th><th>Activity</th><th>Reading Connection</th></tr></thead><tbody>';
                
                tableRows.forEach(row => {
                    let cells = row.split('|').map(cell => cell.trim()).filter(cell => cell);
                    if (cells.length >= 3) {
                        tableHTML += `<tr><td>${cells[0]}</td><td>${cells[1]}</td><td>${cells[2]}</td></tr>`;
                    }
                });
                
                tableHTML += '</tbody></table></div>';
                return tableHTML;
            });
            
            // Format rubric tables
            formatted = formatted.replace(/\| Criteria \| Excellent \| Good \| Needs Work \|<br>\|----------|-----------|------|------------|<br>(.*?)<br><br>/gs, function(match, tableContent) {
                if (!tableContent) return match; // Safety check
                let tableRows = tableContent.split('<br>').filter(row => row.trim() && row.includes('|'));
                let tableHTML = '<div class="assessment-rubric page-break-avoid"><table><thead><tr><th>Criteria</th><th>Excellent</th><th>Good</th><th>Needs Work</th></tr></thead><tbody>';
                
                tableRows.forEach(row => {
                    let cells = row.split('|').map(cell => cell.trim()).filter(cell => cell);
                    if (cells.length >= 4) {
                        tableHTML += `<tr><td>${cells[0]}</td><td>${cells[1]}</td><td>${cells[2]}</td><td>${cells[3]}</td></tr>`;
                    }
                });
                
                tableHTML += '</tbody></table></div>';
                return tableHTML;
            });
            
            // Format vocabulary sections
            formatted = formatted.replace(/\*\*Key Terms from Reading:\*\* (.*?)<br>/g, '<div class="vocabulary-box"><strong>Key Terms from Reading:</strong> $1</div>');
            
            // Format implementation guides with page break avoidance
            formatted = formatted.replace(/### (15-Minute Preparation Checklist|First-Time Teaching Notes|Troubleshooting Guide|Substitute Teacher Instructions)<br>/g, '<div class="content-box page-break-avoid"><h4>$1</h4>');
            formatted = formatted.replace(/✅ QUALITY ASSURANCE VERIFICATION<br>/g, '<div class="page-break-avoid"><h3>✅ QUALITY ASSURANCE VERIFICATION</h3>');
            
            // Format bold text
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong style="color: #495057;">$1</strong>');
            
            // Format bullet points with proper structure
            formatted = formatted.replace(/(^|\<br\>)• /g, '$1<li style="margin: 4px 0;">');
            formatted = formatted.replace(/(^|\<br\>)- /g, '$1<li style="margin: 4px 0;">');
            
            // Format numbered lists
            formatted = formatted.replace(/(^|\<br\>)(\d+\.) /g, '$1<div class="numbered-item"><span style="color: #ff6b6b; font-weight: bold;">$2</span> ');
            
            // Format checkboxes
            formatted = formatted.replace(/- \[ \]/g, '<div class="checkbox-item"><input type="checkbox" style="margin-right: 8px;">');
            formatted = formatted.replace(/- \[x\]/g, '<div class="checkbox-item"><input type="checkbox" checked style="margin-right: 8px;">');
            
            // Clean up and structure the content properly
            formatted = formatted.replace(/<br><br>/g, '</p><p>');
            formatted = formatted.replace(/^<br>|<br>$/g, '');
            
            // Wrap in proper structure with print-friendly classes
            return `
                <div class="integrated-lesson-content" style="max-width: 900px; margin: 0 auto; line-height: 1.8; font-size: 1.1rem;">
                    <div class="lesson-header no-print" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #ff6b6b;">
                        <h2 style="color: #ff6b6b; margin: 0;">🎯 Complete Integrated Lesson Package</h2>
                        <span style="background: #fff5f5; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; color: #721c24; font-weight: bold; border: 2px solid #ff6b6b;">
                            Print-Ready • No Prep Required
                        </span>
                    </div>
                    <div class="lesson-content" style="background: linear-gradient(135deg, #fff5f5, #ffffff); padding: 30px; border-radius: 15px; border: 1px solid #ff6b6b;">
                        ${formatted}
                    </div>
                    <div class="no-print" style="margin-top: 20px; padding: 15px; background: #d1ecf1; border-left: 5px solid #bee5eb; border-radius: 5px;">
                        <h4 style="color: #0c5460; margin-bottom: 10px;">🖨️ Ready to Print Instructions:</h4>
                        <p style="color: #0c5460; margin: 0;">This complete lesson package is formatted for immediate classroom use. Simply print and teach - no additional preparation required!</p>
                    </div>
                </div>
            `;
        }

        // Export functions for integrated lesson
        function printIntegratedLesson() {
            const content = document.getElementById('integrated-lesson-output').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Complete Integrated Lesson - ${currentLessonData.title}</title>
                    <style>
                        /* Reset and Base Styles */
                        * { 
                            box-sizing: border-box; 
                            margin: 0; 
                            padding: 0; 
                        }
                        
                        body { 
                            font-family: 'Times New Roman', serif; 
                            font-size: 12pt; 
                            line-height: 1.5; 
                            color: #000;
                            background: white;
                        }

                        /* Print-Specific Layout */
                        @media print {
                            @page {
                                size: 8.5in 11in;
                                margin: 0.75in 0.75in 0.75in 0.75in;
                            }
                            
                            body { 
                                margin: 0; 
                                padding: 0;
                                font-size: 11pt;
                                line-height: 1.4;
                            }
                            
                            /* Page Break Controls */
                            .page-break-before { page-break-before: always; }
                            .page-break-after { page-break-after: always; }
                            .page-break-avoid { page-break-inside: avoid; }
                            
                            /* Section Breaks */
                            .section-break {
                                page-break-before: always;
                                margin-top: 0;
                            }
                            
                            /* Header Styles */
                            h1 { 
                                font-size: 16pt; 
                                font-weight: bold; 
                                margin: 0 0 12pt 0;
                                page-break-after: avoid;
                                text-align: center;
                                border-bottom: 2pt solid #000;
                                padding-bottom: 6pt;
                            }
                            
                            h2 { 
                                font-size: 14pt; 
                                font-weight: bold; 
                                margin: 18pt 0 8pt 0;
                                page-break-after: avoid;
                                border-left: 4pt solid #666;
                                padding-left: 8pt;
                            }
                            
                            h3 { 
                                font-size: 12pt; 
                                font-weight: bold; 
                                margin: 12pt 0 6pt 0;
                                page-break-after: avoid;
                            }
                            
                            h4 { 
                                font-size: 11pt; 
                                font-weight: bold; 
                                margin: 8pt 0 4pt 0;
                                page-break-after: avoid;
                            }
                            
                            /* Paragraph Styles */
                            p { 
                                margin: 0 0 8pt 0; 
                                text-align: justify;
                                orphans: 3;
                                widows: 3;
                            }
                            
                            /* List Styles */
                            ul, ol { 
                                margin: 6pt 0 6pt 24pt; 
                                page-break-inside: avoid;
                            }
                            
                            li { 
                                margin: 2pt 0; 
                                page-break-inside: avoid;
                            }
                            
                            /* Table Styles */
                            table { 
                                width: 100%; 
                                border-collapse: collapse; 
                                margin: 8pt 0;
                                page-break-inside: avoid;
                                font-size: 10pt;
                            }
                            
                            th, td { 
                                border: 1pt solid #000; 
                                padding: 4pt 6pt; 
                                text-align: left;
                                vertical-align: top;
                            }
                            
                            th { 
                                background: #f0f0f0; 
                                font-weight: bold;
                                page-break-after: avoid;
                            }
                            
                            /* Special Content Boxes */
                            .content-box {
                                border: 1pt solid #666;
                                padding: 8pt;
                                margin: 8pt 0;
                                page-break-inside: avoid;
                                background: #f9f9f9;
                            }
                            
                            /* Reading Section */
                            .reading-section {
                                page-break-before: always;
                                margin-top: 0;
                            }
                            
                            .reading-paragraph {
                                margin: 8pt 0;
                                padding: 6pt 0;
                                border-left: 2pt solid #ddd;
                                padding-left: 8pt;
                                page-break-inside: avoid;
                            }
                            
                            /* Lesson Plan Section */
                            .lesson-section {
                                page-break-before: always;
                                margin-top: 0;
                            }
                            
                            /* Handout Section */
                            .handout-section {
                                page-break-before: always;
                                margin-top: 0;
                            }
                            
                            /* Timing Guide */
                            .timing-table {
                                page-break-inside: avoid;
                                margin: 12pt 0;
                            }
                            
                            /* Hide screen-only elements */
                            .no-print { display: none !important; }
                            
                            /* Footer for each page */
                            .page-footer {
                                position: fixed;
                                bottom: 0.5in;
                                left: 0;
                                right: 0;
                                text-align: center;
                                font-size: 9pt;
                                color: #666;
                                border-top: 1pt solid #ccc;
                                padding-top: 4pt;
                            }
                        }
                        
                        /* Screen Styles */
                        @media screen {
                            body { 
                                max-width: 8.5in;
                                margin: 20px auto;
                                padding: 20px;
                                background: white;
                                box-shadow: 0 0 20px rgba(0,0,0,0.1);
                            }
                            
                            h1, h2, h3, h4 { color: #333; }
                            
                            .page-break-before { 
                                border-top: 2px dashed #ccc;
                                margin-top: 40px;
                                padding-top: 20px;
                            }
                        }
                        
                        /* Content-specific styles */
                        .lesson-header {
                            text-align: center;
                            margin-bottom: 20pt;
                            page-break-after: avoid;
                        }
                        
                        .lesson-title {
                            font-size: 18pt;
                            font-weight: bold;
                            margin-bottom: 6pt;
                        }
                        
                        .lesson-info {
                            font-size: 10pt;
                            color: #666;
                            margin-bottom: 4pt;
                        }
                        
                        .objectives-box {
                            border: 2pt solid #000;
                            padding: 12pt;
                            margin: 12pt 0;
                            page-break-inside: avoid;
                        }
                        
                        .vocabulary-box {
                            background: #f5f5f5;
                            border: 1pt solid #ccc;
                            padding: 8pt;
                            margin: 8pt 0;
                            page-break-inside: avoid;
                        }
                        
                        .assessment-rubric {
                            page-break-inside: avoid;
                            margin: 12pt 0;
                        }
                        
                        /* Remove background colors and gradients for print */
                        @media print {
                            * {
                                background: transparent !important;
                                color: black !important;
                                box-shadow: none !important;
                                text-shadow: none !important;
                            }
                            
                            .content-box, .vocabulary-box {
                                background: white !important;
                                border: 1pt solid #666 !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="page-footer no-print">
                        ${currentLessonData.title} - Complete Integrated Lesson Package
                    </div>
                    ${content}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function copyIntegratedLesson() {
            const content = document.getElementById('integrated-lesson-output').innerText;
            navigator.clipboard.writeText(content).then(() => {
                alert('📋 Complete integrated lesson copied to clipboard!');
            });
        }

        function saveIntegratedLesson() {
            const content = document.getElementById('integrated-lesson-output').innerHTML;
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `integrated-lesson-${currentLessonData.title.replace(/\s+/g, '-').toLowerCase()}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Main function to generate lesson plan
        async function generateLessonPlan() {
            console.log('🚀 Starting lesson plan generation...');
            
            if (!currentLessonData) {
                alert('Please select a lesson first by going back to the lesson companion.');
                return;
            }

            console.log('📚 Current lesson data:', currentLessonData);

            // Save user settings
            saveUserSettings();

            // Show loading state
            document.getElementById('loading').style.display = 'block';
            document.getElementById('lesson-plan-output').style.display = 'none';
            document.getElementById('generate-btn').disabled = true;
            document.getElementById('generate-btn').textContent = '🤖 Generating...';

            try {
                // Prepare the AI prompt
                const prompt = buildAIPrompt();
                console.log('📝 Built AI prompt, length:', prompt.length);
                
                // Call OpenAI API
                const lessonPlan = await callOpenAIAPI(prompt);
                console.log('✅ Received lesson plan from AI');
                
                // Display the generated lesson plan
                displayGeneratedLessonPlan(lessonPlan);
                
                updateAPIStatus('success', '✅ Lesson plan generated successfully!');
                
            } catch (error) {
                console.error('❌ Error generating lesson plan:', error);
                updateAPIStatus('error', '❌ Error generating lesson plan: ' + error.message);
                
                // Show error in output panel
                document.getElementById('lesson-plan-output').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <h3>❌ Generation Failed</h3>
                        <p>${error.message}</p>
                        <button onclick="generateLessonPlan()" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Try Again
                        </button>
                    </div>
                `;
            } finally {
                // Reset UI
                document.getElementById('loading').style.display = 'none';
                document.getElementById('lesson-plan-output').style.display = 'block';
                document.getElementById('generate-btn').disabled = false;
                document.getElementById('generate-btn').textContent = '🚀 Generate AI Lesson Plan';
            }
        }

        // Build the AI prompt based on current settings and content
        function buildAIPrompt() {
            const lessonFocus = document.getElementById('lesson-focus').value;
            const classSize = document.getElementById('class-size').value;
            const customInstructions = document.getElementById('custom-prompt').value;

            const teacherContent = document.getElementById('teacher-content').textContent;
            const studentContent = document.getElementById('student-content').textContent;

            const focusDescriptions = {
                'balanced': 'a balanced mix of instruction, discussion, and activities',
                'interactive': 'highly interactive with frequent student participation',
                'discussion': 'discussion-heavy with socratic questioning',
                'hands-on': 'hands-on activities and experiential learning',
                'assessment': 'assessment-focused with multiple check-ins',
                'technology': 'technology integration and digital tools'
            };

            return `# 🎯 SOPHISTICATED GEOGRAPHY LESSON PLAN GENERATOR

You are an expert 7th-grade geography teacher tasked with creating a comprehensive, research-based lesson plan that fully leverages the rich source materials provided. This lesson plan must demonstrate educational sophistication while remaining practical and immediately usable.

## 📚 SOURCE MATERIALS ANALYSIS

**LESSON CONTEXT:** Module ${currentLessonData.moduleNumber} - ${currentLessonData.title}
**CLASS SIZE:** ${classSize} students  
**FOCUS STYLE:** ${focusDescriptions[lessonFocus]}
${customInstructions ? `**SPECIAL INSTRUCTIONS:** ${customInstructions}` : ''}

**STUDENT READING CONTENT:**
${studentContent || 'No specific reading provided'}

**TEACHER GUIDE CONTENT:**
${teacherContent || 'No teacher guide provided'}

**CORE VOCABULARY:** ${currentLessonData.vocabulary ? currentLessonData.vocabulary.map(v => v.term).join(', ') : 'None provided'}

---

## 🎯 ENHANCED LESSON PLAN REQUIREMENTS

### 1. CONTENT INTEGRATION MASTERY

**READING MATERIAL UTILIZATION:**
- Extract specific page/section references for each activity
- Generate reading guides with paragraph numbers for student reference
- Create text-dependent questions requiring specific evidence citation
- Include reading strategies (chunking, annotation, graphic organizers)
- Provide sentence frames for discussing complex concepts

**VOCABULARY ENHANCEMENT:**
- Tier vocabulary: Essential (8), Important (5-7), Extension (3-5)
- Include pronunciation guides for difficult terms
- Generate diverse vocabulary activities (word maps, analogies, context clues)
- Create visual vocabulary cards with content connections
- Add cognates for Spanish-speaking ELL students

**GEOGRAPHIC LITERACY INTEGRATION:**
- Generate detailed map activities from reading content
- Include climate/resource comparison charts
- Create cause-and-effect organizers linking geography to culture
- Add modern country overlays connecting ancient to contemporary
- Include elevation and climate data from reading

### 2. ACTIVITY SOPHISTICATION

**READING COMPREHENSION DEPTH:**
- Generate close reading protocols for key passages
- Create comparison matrices from content
- Include timeline construction using specific dates
- Add evidence-based writing prompts requiring citations
- Generate discussion protocols for complex topics

**DIFFERENTIATED READING SUPPORT:**
- Create reading level alternatives for struggling readers
- Generate graphic organizers for each major reading section
- Provide background knowledge builders for unfamiliar concepts
- Add visual supports for abstract concepts
- Include audio script directions for accessibility

### 3. ASSESSMENT ALIGNMENT

**FORMATIVE ASSESSMENT INTEGRATION:**
- Generate text-dependent questions for each major section
- Create quick-check comprehension questions with paragraph references
- Include peer discussion protocols with accountability
- Add self-monitoring checklists for reading comprehension
- Generate exit tickets requiring synthesis across sections

**AUTHENTIC TASK CREATION:**
- Generate document-based questions using reading information
- Create role-playing scenarios based on content descriptions
- Include artifact analysis activities using text descriptions
- Add historical thinking prompts (cause/effect, change/continuity)
- Generate creative applications based on content

### 4. CULTURAL SENSITIVITY & ACCURACY

**INDIGENOUS PERSPECTIVE INTEGRATION:**
- Include contemporary connections to living communities
- Add respectful language protocols for indigenous cultures
- Generate activities connecting ancient and modern practices
- Include diverse perspectives on historical events
- Add resources for contemporary indigenous issues

### 5. CROSS-CURRICULAR ENHANCEMENT

**STEM CONNECTIONS:**
- Generate math activities using systems from reading
- Include astronomy connections with calendar/observatory information
- Create science links to environmental factors
- Add engineering challenges based on achievements
- Include data analysis of adaptations

---

## 📋 REQUIRED LESSON PLAN FORMAT

# 📋 SOPHISTICATED LESSON PLAN: ${currentLessonData.title}

**Module ${currentLessonData.moduleNumber} | ${classSize} Students | 50 Minutes**  
**Grade Level:** 7th Grade Geography  
**Focus:** Content-Rich Geographic Literacy

---

## 🎯 LESSON OVERVIEW

### Learning Objectives (Specific & Measurable)
By the end of this lesson, students will be able to:
1. [Specific objective requiring textual evidence and geographic analysis]
2. [Specific objective demonstrating cultural understanding]
3. [Specific objective showing cause-and-effect geographic thinking]

### Standards Alignment
- **National Geography Standards:** [Specific standards from content]
- **Common Core Reading:** [Informational text standards]
- **Common Core Writing:** [Evidence-based writing standards]

### Key Essential Questions
1. [Geographic thinking question based on content]
2. [Cultural understanding question requiring text evidence]
3. [Cause-and-effect question connecting geography to human activity]

---

## 📚 SOPHISTICATED CONTENT UTILIZATION

### Reading Material Integration
**Primary Source Sections:** [List specific sections/paragraphs to focus on]
**Key Passages for Close Reading:** [Quote 2-3 crucial passages with paragraph numbers]
**Text-Dependent Questions:**
1. [Question requiring specific evidence from paragraph X]
2. [Question requiring synthesis across sections Y and Z]
3. [Question requiring interpretation of specific content]

### Advanced Vocabulary Strategy
**ESSENTIAL TIER (8 terms):** [List with pronunciation guides and geographic significance]
**IMPORTANT TIER (5-7 terms):** [List with context clues from reading]
**EXTENSION TIER (3-5 terms):** [List with cognates and advanced applications]

**Vocabulary Activities:**
- [Text-based vocabulary strategy using specific content]
- [Visual vocabulary connections to geographic concepts]
- [Peer teaching protocol with academic language frames]

---

## 🗺️ GEOGRAPHIC LITERACY FOCUS

### Spatial Thinking Integration
[Specific mapping activities using content from reading with exact geographic references]

### Geographic Analysis Framework
**Cause & Effect Relationships:** [From reading content with specific examples]
**Human-Environment Interaction:** [Specific examples from text with evidence requirements]
**Movement & Trade Patterns:** [Based on reading descriptions with analysis tasks]

---

## 🚀 SOPHISTICATED LESSON ACTIVITIES

### CONTENT-RICH OPENING HOOK (8 minutes)
**Geographic Thinking Activation:**
[Engaging opener that connects directly to reading content with specific geographic concepts]

**Background Knowledge Bridge:**
[Strategy to connect prior geographic knowledge to today's complex reading]

**Text Complexity Preview:**
[How to orient students to sophisticated informational text structure]

### GUIDED READING INSTRUCTION (20 minutes)
**Multi-Layer Reading Protocol:**
- **Geographic Survey Read:** [Purpose and mapping strategy]
- **Evidence-Focused Read:** [Annotation strategy for geographic evidence]
- **Analysis Read:** [Synthesis strategy for geographic patterns]

**Text Chunking for Geographic Concepts:**
[How to break down complex geographic information systematically]

**Academic Annotation Guide:**
[Specific symbols for geographic evidence, cause-effect, human-environment interaction]

**Comprehension Monitoring:**
[Self-assessment tools for understanding complex geographic relationships]

### CONTENT-BASED ANALYSIS ACTIVITIES (15 minutes)
**Primary Activity:** [Sophisticated geographic analysis task using specific reading content]

**Evidence-Based Collaboration:** [How students cite sources in geographic discussions]

**Geographic Reasoning Requirements:** [Specific spatial thinking and analysis expectations]

**Cross-Cultural Analysis:** [How students analyze different cultural perspectives from text]

### SYNTHESIS & AUTHENTIC ASSESSMENT (7 minutes)
**Text-Dependent Geographic Discussion:** [Questions requiring reading evidence and spatial thinking]

**Geographic Literacy Assessment:** [Formative check requiring text evidence and geographic reasoning]

**Synthesis Exit Task:** [How students demonstrate understanding through geographic lens]

---

## 📊 SOPHISTICATED DIFFERENTIATION

### Reading Complexity Support
**Struggling Readers:**
- [Content-specific graphic organizer with geographic framework]
- [Tiered vocabulary with geographic context and visual supports]
- [Strategic reading partnerships with role assignments]

**English Language Learners:**
- [Geographic cognates for Spanish speakers with cultural connections]
- [Visual geographic supports for abstract concepts from reading]
- [Academic sentence frames for geographic discussions and analysis]

**Advanced Learners:**
- [Geographic research extensions connecting to contemporary issues]
- [Higher-order spatial analysis questions requiring synthesis]
- [Independent geographic inquiry opportunities]

### Cultural Responsiveness
[How lesson honors diverse geographic perspectives and connects to students' cultural geography]

---

## ✅ COMPREHENSIVE ASSESSMENT PLAN

### Geographic Literacy Assessment
1. **Text Annotation Quality:** [Evidence of geographic thinking in annotations]
2. **Spatial Reasoning:** [Quality of geographic analysis and evidence use]
3. **Cultural Understanding:** [Respectful and accurate cultural geographic analysis]

### Text-Dependent Geographic Questions
1. [Question requiring specific paragraph citation and geographic analysis]
2. [Question requiring synthesis across multiple sections with spatial thinking]
3. [Question requiring geographic inference based on textual evidence]

### Exit Synthesis (Geographic Literacy Focus)
[Specific question requiring students to cite geographic evidence and demonstrate spatial thinking]

---

## 🔗 SOPHISTICATED CONNECTIONS

### Cross-Curricular Geographic Integration
**Mathematics:** [Specific mathematical geographic concepts from reading with data analysis]
**Science:** [Environmental geography connections from text with inquiry tasks]
**Language Arts:** [Academic writing opportunities using geographic evidence]

### Contemporary Geographic Connections
[How ancient geographic content connects to modern spatial patterns - specific examples]

### Geographic Thinking Skills Development
[How this lesson develops specific spatial reasoning and geographic analysis abilities]

---

## 📋 ADVANCED MATERIALS & HANDOUTS

### Required Sophisticated Handouts
1. **Geographic Reading Guide:** [Section-by-section analysis with spatial thinking organizers]
2. **Tiered Vocabulary Handout:** [Geographic terms with pronunciation, context, and applications]
3. **Spatial Analysis Sheet:** [Graphic organizer for geographic reasoning and evidence]
4. **Text Evidence Tracker:** [Tool for recording geographic citations and spatial analysis]

### Technology Integration for Geographic Literacy
- [Specific digital geographic tools that enhance content comprehension]
- [QR codes linking to relevant geographic multimedia and primary sources]
- [Interactive maps and spatial analysis tools]

---

## 👨‍🏫 IMPLEMENTATION GUIDE FOR SOPHISTICATED CONTENT

### Advanced Preparation (20 minutes)
[Specific preparation steps for complex geographic content and materials]

### During-Lesson Geographic Literacy Monitoring
**Listen For:** [Specific geographic vocabulary and spatial reasoning in student responses]
**Watch For:** [Visual evidence of geographic thinking and cultural understanding]
**Intervention Strategies:** [If students struggle with complex geographic concepts]

### Geographic Misconceptions from Content
[Specific geographic misconceptions students often develop from this reading]

### Time Management for Content Complexity
**If Behind Schedule:** [Modifications that maintain geographic learning integrity]
**If Ahead:** [Geographic extension activities that deepen spatial thinking]

### Substitute Teacher Guide for Complex Content
[Detailed explanation of sophisticated geographic work students are engaging in]

---

## 🎯 SOPHISTICATED SUCCESS CRITERIA

### Geographic Literacy Evidence
Students demonstrate mastery through:
- [Accurate use of geographic vocabulary in context]
- [Quality of text-dependent geographic responses]
- [Sophistication of spatial analysis and reasoning]
- [Cultural sensitivity in geographic discussions]

### Lesson Sophistication Indicators
- All students engaged with complex geographic text and concepts
- Students citing specific evidence in spatial analysis
- Geographic thinking skills demonstrated through content analysis
- Academic geographic vocabulary used accurately and purposefully

---

**CONTENT SOPHISTICATION REQUIREMENT:** This lesson plan must demonstrate thorough analysis of the provided reading content and create activities that fully utilize its geographic educational potential. Every activity should connect directly to specific geographic information from the source materials, with paragraph references, spatial analysis requirements, and authentic geographic thinking tasks.

Make this lesson plan sophisticated enough to match the complexity of the geographic source materials while remaining practical and immediately implementable. Focus on developing advanced geographic literacy, spatial thinking, and cultural understanding through rich, content-specific activities that honor the depth of the source materials.`;
        }

        // Call OpenAI API
        async function callOpenAIAPI(prompt) {
            const model = document.getElementById('ai-model').value;
            const creativity = parseFloat(document.getElementById('creativity-level').value);

            // First try to use server-side API (Railway environment)
            try {
                const response = await fetch('/api/generate-lesson-plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        model: model,
                        temperature: creativity,
                        max_tokens: 4000
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.content;
                } else if (response.status === 503) {
                    // Server API not available, fall back to client-side
                    return await callOpenAIClientSide(prompt, model, creativity);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server request failed: ${response.status}`);
                }
            } catch (error) {
                console.log('Server API not available, trying client-side:', error.message);
                return await callOpenAIClientSide(prompt, model, creativity);
            }
        }

        // Fallback to client-side OpenAI API
        async function callOpenAIClientSide(prompt, model, creativity) {
            const apiKey = document.getElementById('api-key').value;
            
            if (!apiKey) {
                throw new Error('No API key available. Please contact your administrator or enter your own API key.');
            }

            // Helper function to determine correct token parameter based on model
            function getTokenParameter(model, maxTokens) {
                // GPT-5 and GPT-4.1 series use max_completion_tokens
                if (model.startsWith('gpt-5') || model.startsWith('gpt-4.1')) {
                    return { max_completion_tokens: maxTokens };
                }
                // Older models use max_tokens
                return { max_tokens: maxTokens };
            }

            const tokenParams = getTokenParameter(model, 4000);

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        {
                            role: 'system',
                            content: 'You are an expert geography teacher with 20+ years of experience creating engaging, standards-aligned lesson plans. You specialize in 7th-grade geography and understand how to make complex geographic concepts accessible and interesting for middle school students.'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    temperature: creativity,
                    ...tokenParams
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `API request failed: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Display the generated lesson plan
        function displayGeneratedLessonPlan(lessonPlan) {
            generatedLessonPlan = lessonPlan;
            
            // Parse and format the lesson plan
            const formattedPlan = formatLessonPlan(lessonPlan);
            
            document.getElementById('lesson-plan-output').innerHTML = formattedPlan;
            document.getElementById('export-buttons').style.display = 'flex';
        }

        // Format the lesson plan with proper HTML structure
        function formatLessonPlan(planText) {
            // Split by sections and format
            let formatted = planText.replace(/\n/g, '<br>');
            
            // Format headers
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<h3>$1</h3>');
            formatted = formatted.replace(/(\d+\.\s\*\*.*?\*\*)/g, '<h3>$1</h3>');
            
            // Format bullet points
            formatted = formatted.replace(/(^|\<br\>)-\s/g, '$1• ');
            
            // Wrap in proper structure
            return `
                <div class="lesson-plan-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #007bff;">
                        <h2 style="color: #007bff; margin: 0;">📋 Generated Lesson Plan</h2>
                        <span style="background: #e7f3ff; padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; color: #007bff; font-weight: bold;">
                            50 Minutes • ${document.getElementById('lesson-focus').value.charAt(0).toUpperCase() + document.getElementById('lesson-focus').value.slice(1)} Focus
                        </span>
                    </div>
                    <div style="line-height: 1.6;">
                        ${formatted}
                    </div>
                </div>
            `;
        }

        // Export functions
        function printLessonPlan() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Lesson Plan - ${currentLessonData.title}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                            h2, h3 { color: #007bff; }
                            .header { text-align: center; margin-bottom: 30px; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>🌍 Geography Lesson Plan</h1>
                            <p><strong>Module ${currentLessonData.moduleNumber}:</strong> ${currentLessonData.title}</p>
                            <p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                        ${document.getElementById('lesson-plan-output').innerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function copyLessonPlan() {
            const textContent = generatedLessonPlan || document.getElementById('lesson-plan-output').textContent;
            navigator.clipboard.writeText(textContent).then(() => {
                alert('✅ Lesson plan copied to clipboard!');
            }).catch(err => {
                console.error('Error copying to clipboard:', err);
                alert('❌ Failed to copy. Please select and copy manually.');
            });
        }

        function saveLessonPlan() {
            if (!generatedLessonPlan) return;
            
            const filename = `lesson-plan-${currentLessonData.moduleNumber}-${currentLessonData.lessonNumber}-${new Date().toISOString().split('T')[0]}.txt`;
            const blob = new Blob([generatedLessonPlan], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        // Navigation
        function goBack() {
            window.history.back();
        }

        // API key validation
        document.getElementById('api-key').addEventListener('input', function() {
            setTimeout(checkAPIStatus, 500);
        });

        // Auto-save API key
        document.getElementById('api-key').addEventListener('blur', function() {
            const apiKey = this.value;
            if (apiKey && apiKey.startsWith('sk-')) {
                localStorage.setItem('openai_api_key', apiKey);
            }
        });
    </script>
</body>
</html>
