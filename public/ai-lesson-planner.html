<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ AI Lesson Planner | Geography Companion</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
            min-height: 600px;
        }

        .input-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
        }

        .output-panel {
            background: #f1f8ff;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #d1ecf1;
        }

        .panel-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lesson-info-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .lesson-info-card h3 {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .lesson-content {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .ai-controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .control-group select,
        .control-group input,
        .control-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .control-group select:focus,
        .control-group input:focus,
        .control-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        .generate-button {
            width: 100%;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .generate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .generate-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .lesson-plan-output {
            background: white;
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            min-height: 400px;
        }

        .lesson-plan-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .lesson-plan-section:last-child {
            border-bottom: none;
        }

        .lesson-plan-section h3 {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-button {
            position: fixed;
            top: 30px;
            left: 30px;
            background: rgba(255, 255, 255, 0.9);
            color: #495057;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .back-button:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .api-status {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #856404;
        }

        .success-status {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .error-status {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .export-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .export-button:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .export-button.print {
            background: #17a2b8;
        }

        .export-button.copy {
            background: #ffc107;
            color: #212529;
        }

        .advanced-settings {
            background: #e7f3ff;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid #b3d7ff;
        }

        .advanced-toggle {
            background: none;
            border: none;
            color: #007bff;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .advanced-content {
            display: none;
        }

        .advanced-content.show {
            display: block;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <button onclick="goBack()" class="back-button">‚Üê Back to Lesson Companion</button>

    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Lesson Planner</h1>
            <p>Generate Dynamic 50-Minute Lesson Plans with Advanced AI</p>
        </div>

        <div class="main-content">
            <!-- Input Panel -->
            <div class="input-panel">
                <div class="panel-title">
                    üìö Lesson Content Analysis
                </div>

                <!-- Lesson Selector -->
                <div class="lesson-info-card">
                    <h3>üéØ Select Your Lesson</h3>
                    <div class="control-group">
                        <label for="module-selector">Choose Module (1-32):</label>
                        <select id="module-selector">
                            <option value="">Loading modules...</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="lesson-selector">Choose Lesson:</label>
                        <select id="lesson-selector">
                            <option value="">Select a module first</option>
                        </select>
                    </div>
                    <button onclick="loadSelectedLesson()" class="generate-button" style="margin-top: 10px; padding: 10px 20px; font-size: 1rem;">
                        üìñ Load This Lesson
                    </button>
                </div>

                <!-- Current Lesson Info -->
                <div class="lesson-info-card">
                    <h3>üìã Current Lesson</h3>
                    <div id="current-lesson-info">
                        <p><strong>Module:</strong> <span id="lesson-module">Loading...</span></p>
                        <p><strong>Lesson:</strong> <span id="lesson-title">Loading...</span></p>
                        <p><strong>Duration:</strong> <span id="lesson-duration">50 minutes</span></p>
                    </div>
                </div>

                <!-- Teacher's Guide Content -->
                <div class="lesson-info-card">
                    <h3>üë®‚Äçüè´ Teacher's Guide Content</h3>
                    <div id="teacher-content" class="lesson-content">
                        <p>Loading teacher's guide content...</p>
                    </div>
                </div>

                <!-- Student Reading Content -->
                <div class="lesson-info-card">
                    <h3>üìñ Student Reading Content</h3>
                    <div id="student-content" class="lesson-content">
                        <p>Loading student reading content...</p>
                    </div>
                </div>

                <!-- AI Controls -->
                <div class="ai-controls">
                    <div class="api-status" id="api-status">
                        üîß Configuring AI settings...
                    </div>

                    <div class="control-group">
                        <label for="ai-model">AI Model Selection</label>
                        <select id="ai-model">
                            <optgroup label="üöÄ Latest Models (2025)">
                                <option value="gpt-5">GPT-5 (Best Performance)</option>
                                <option value="gpt-5-mini">GPT-5 Mini (Fast & Efficient)</option>
                                <option value="gpt-5-nano">GPT-5 Nano (Fastest)</option>
                                <option value="gpt-4.1">GPT-4.1 (Advanced Function Calling)</option>
                                <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
                                <option value="gpt-4.1-nano">GPT-4.1 Nano</option>
                            </optgroup>
                            <optgroup label="üîß Previous Generation">
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            </optgroup>
                        </select>
                        <small style="color: #666; font-size: 0.9em; margin-top: 5px; display: block;">
                            üí° GPT-5 and GPT-4.1 are the latest models with enhanced reasoning and coding capabilities
                        </small>
                    </div>

                    <div class="control-group">
                        <label for="lesson-focus">Lesson Focus Area</label>
                        <select id="lesson-focus">
                            <option value="balanced">Balanced Approach</option>
                            <option value="interactive">Highly Interactive</option>
                            <option value="discussion">Discussion-Heavy</option>
                            <option value="hands-on">Hands-On Activities</option>
                            <option value="assessment">Assessment-Focused</option>
                            <option value="technology">Technology Integration</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="class-size">Estimated Class Size</label>
                        <input type="number" id="class-size" value="25" min="1" max="50" placeholder="25">
                    </div>

                    <!-- Advanced Settings -->
                    <div class="advanced-settings">
                        <button class="advanced-toggle" onclick="toggleAdvancedSettings()">
                            ‚öôÔ∏è Advanced Settings
                        </button>
                        <div class="advanced-content" id="advanced-content">
                            <div class="control-group">
                                <label for="creativity-level">AI Creativity Level</label>
                                <select id="creativity-level">
                                    <option value="0.3">Conservative (0.3)</option>
                                    <option value="0.7" selected>Balanced (0.7)</option>
                                    <option value="1.0">Creative (1.0)</option>
                                </select>
                            </div>

                            <div class="control-group">
                                <label for="custom-prompt">Custom Instructions</label>
                                <textarea id="custom-prompt" rows="3" placeholder="Additional instructions for the AI (e.g., 'Focus on visual learners', 'Include group work', etc.)"></textarea>
                            </div>

                            <div class="control-group">
                                <label for="api-key">OpenAI API Key</label>
                                <input type="password" id="api-key" name="api-key" placeholder="sk-..." 
                                       value="" autocomplete="off" />
                                <small style="color: #6c757d; font-size: 0.8rem; margin-top: 5px; display: block;">
                                    Your API key is stored locally and never sent to our servers
                                </small>
                            </div>
                        </div>
                    </div>

                    <button onclick="generateLessonPlan()" class="generate-button" id="generate-btn">
                        üöÄ Generate AI Lesson Plan
                    </button>
                </div>
            </div>

            <!-- Output Panel -->
            <div class="output-panel">
                <div class="panel-title">
                    üéØ Generated Lesson Plan
                </div>

                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <h3>ü§ñ AI is crafting your lesson plan...</h3>
                    <p>Analyzing content and generating personalized activities</p>
                </div>

                <div class="lesson-plan-output" id="lesson-plan-output">
                    <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                        <h3>üöÄ Ready to Generate</h3>
                        <p>Click "Generate AI Lesson Plan" to create a comprehensive 50-minute lesson plan tailored to your content.</p>
                        
                        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: left;">
                            <h4 style="color: #495057; margin-bottom: 15px;">‚ú® What You'll Get:</h4>
                            <ul style="color: #6c757d; line-height: 1.8;">
                                <li>üìÖ <strong>Detailed timing breakdown</strong> (opening, activities, closure)</li>
                                <li>üéØ <strong>Learning objectives</strong> aligned with content</li>
                                <li>üó£Ô∏è <strong>Discussion questions</strong> and talking points</li>
                                <li>üé® <strong>Interactive activities</strong> and engagement strategies</li>
                                <li>üìù <strong>Assessment opportunities</strong> throughout the lesson</li>
                                <li>üé™ <strong>Differentiation strategies</strong> for various learning styles</li>
                                <li>üìö <strong>Materials list</strong> and preparation notes</li>
                                <li>üîó <strong>Extensions and connections</strong> to other topics</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="export-buttons" id="export-buttons" style="display: none;">
                    <button onclick="printLessonPlan()" class="export-button print">üñ®Ô∏è Print</button>
                    <button onclick="copyLessonPlan()" class="export-button copy">üìã Copy</button>
                    <button onclick="saveLessonPlan()" class="export-button">üíæ Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentLessonData = null;
        let generatedLessonPlan = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentLessonData();
            loadUserSettings();
            checkAPIStatus();
            loadAllModules(); // Load modules for the selector
        });

        // Load all modules for the selector (like your main curriculum page does)
        async function loadAllModules() {
            try {
                console.log('üîÑ Loading all modules for selector...');
                const response = await fetch('/api/modules');
                if (!response.ok) {
                    throw new Error(`Failed to fetch modules: ${response.status}`);
                }
                
                const modules = await response.json();
                console.log(`üìö Loaded ${modules.length} modules`);
                
                const moduleSelector = document.getElementById('module-selector');
                moduleSelector.innerHTML = '<option value="">Choose a module...</option>';
                
                // Sort modules by moduleNumber and populate selector
                modules.sort((a, b) => a.moduleNumber - b.moduleNumber);
                modules.forEach(module => {
                    const option = document.createElement('option');
                    option.value = module._id; // Use MongoDB _id
                    option.dataset.moduleNumber = module.moduleNumber;
                    option.textContent = `Module ${module.moduleNumber}: ${module.title}`;
                    moduleSelector.appendChild(option);
                });
                
                // Add event listener for module selection
                moduleSelector.addEventListener('change', loadLessonsForSelectedModule);
                
            } catch (error) {
                console.error('‚ùå Error loading modules:', error);
                const moduleSelector = document.getElementById('module-selector');
                moduleSelector.innerHTML = '<option value="">Error loading modules</option>';
            }
        }

        // Load lessons when a module is selected
        async function loadLessonsForSelectedModule() {
            const moduleSelector = document.getElementById('module-selector');
            const lessonSelector = document.getElementById('lesson-selector');
            const moduleId = moduleSelector.value;
            
            if (!moduleId) {
                lessonSelector.innerHTML = '<option value="">Select a module first</option>';
                return;
            }
            
            try {
                console.log(`üîç Loading lessons for module: ${moduleId}`);
                const response = await fetch(`/api/modules/${moduleId}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch lessons: ${response.status}`);
                }
                
                const moduleData = await response.json();
                const lessons = moduleData.lessons || [];
                
                lessonSelector.innerHTML = '<option value="">Choose a lesson...</option>';
                
                // Sort lessons by lessonNumber and populate selector
                lessons.sort((a, b) => a.lessonNumber - b.lessonNumber);
                lessons.forEach(lesson => {
                    const option = document.createElement('option');
                    option.value = lesson.lessonNumber;
                    option.textContent = `Lesson ${lesson.lessonNumber}: ${lesson.title}`;
                    lessonSelector.appendChild(option);
                });
                
                console.log(`üìñ Loaded ${lessons.length} lessons for this module`);
                
            } catch (error) {
                console.error('‚ùå Error loading lessons:', error);
                lessonSelector.innerHTML = '<option value="">Error loading lessons</option>';
            }
        }

        // Load the selected lesson
        function loadSelectedLesson() {
            const moduleSelector = document.getElementById('module-selector');
            const lessonSelector = document.getElementById('lesson-selector');
            
            const moduleId = moduleSelector.value;
            const moduleNumber = parseInt(moduleSelector.options[moduleSelector.selectedIndex]?.dataset?.moduleNumber);
            const lessonNumber = parseInt(lessonSelector.value);
            
            if (!moduleId || !moduleNumber || !lessonNumber) {
                alert('Please select both a module and a lesson first.');
                return;
            }
            
            console.log(`üéØ Loading selected lesson: Module ${moduleNumber}, Lesson ${lessonNumber}`);
            
            // Update URL to reflect selection (optional)
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('module', moduleNumber);
            newUrl.searchParams.set('lesson', lessonNumber);
            window.history.replaceState({}, '', newUrl);
            
            // Load the lesson data
            fetchLessonData(moduleNumber, lessonNumber);
        }

        // Load current lesson data from URL parameters or localStorage
        function loadCurrentLessonData() {
            try {
                // Try to get data from URL parameters first
                const urlParams = new URLSearchParams(window.location.search);
                const moduleNum = urlParams.get('module');
                const lessonNum = urlParams.get('lesson');

                if (moduleNum && lessonNum) {
                    // Validate and clean the parameters
                    const cleanModuleNum = parseInt(moduleNum);
                    let cleanLessonNum = lessonNum;
                    
                    // Check if lessonNum looks like a MongoDB ObjectId (24 hex characters)
                    if (/^[0-9a-fA-F]{24}$/.test(lessonNum)) {
                        console.log(`‚ö†Ô∏è Detected ObjectId-like lesson parameter: ${lessonNum}`);
                        console.log('ÔøΩ Converting to sequential lesson number based on module');
                        
                        // For now, default to lesson 1 since we don't have a mapping
                        cleanLessonNum = 1;
                        console.log(`üìù Using lesson number: ${cleanLessonNum}`);
                    } else {
                        cleanLessonNum = parseInt(lessonNum) || 1;
                    }
                    
                    if (isNaN(cleanModuleNum) || cleanModuleNum <= 0) {
                        console.error(`‚ùå Invalid module number: ${moduleNum}`);
                        displayErrorData();
                        return;
                    }
                    
                    console.log(`ÔøΩüîç Loading lesson data for Module ${cleanModuleNum}, Lesson ${cleanLessonNum}`);
                    // Fetch lesson data from the main system
                    fetchLessonData(cleanModuleNum, cleanLessonNum);
                } else {
                    // Fall back to localStorage or default
                    const savedLesson = localStorage.getItem('currentAILessonData');
                    if (savedLesson) {
                        console.log('üì± Loading lesson data from localStorage');
                        currentLessonData = JSON.parse(savedLesson);
                        displayLessonData();
                    } else {
                        // Default placeholder data
                        console.log('‚ö†Ô∏è No lesson data found, showing placeholder');
                        displayPlaceholderData();
                    }
                }
            } catch (error) {
                console.error('‚ùå Error loading lesson data:', error);
                displayPlaceholderData();
            }
        }

        // Fetch lesson data from the server using the SAME approach as your main curriculum system
        async function fetchLessonData(moduleNum, lessonNum) {
            try {
                console.log(`üåê Fetching modules to find Module ${moduleNum}...`);
                
                // Step 1: Get all modules (like your main curriculum-maps.html does)
                const modulesResponse = await fetch('/api/modules');
                if (!modulesResponse.ok) {
                    throw new Error(`Failed to fetch modules: ${modulesResponse.status}`);
                }
                
                const modules = await modulesResponse.json();
                console.log(`üìö Found ${modules.length} modules in the system`);
                
                // Step 2: Find the specific module by moduleNumber
                const targetModule = modules.find(m => m.moduleNumber === moduleNum);
                if (!targetModule) {
                    throw new Error(`Module ${moduleNum} not found. Available modules: ${modules.map(m => m.moduleNumber).join(', ')}`);
                }
                
                console.log(`‚úÖ Found Module ${moduleNum}: ${targetModule.title}`);
                console.log(`üîç Module ID: ${targetModule._id}`);
                
                // Step 3: Get lessons for this module using the MongoDB _id (like your main system)
                const lessonsResponse = await fetch(`/api/modules/${targetModule._id}`);
                if (!lessonsResponse.ok) {
                    throw new Error(`Failed to fetch lessons for module: ${lessonsResponse.status}`);
                }
                
                const moduleData = await lessonsResponse.json();
                const lessons = moduleData.lessons || [];
                
                console.log(`üìñ Found ${lessons.length} lessons in Module ${moduleNum}`);
                
                // Step 4: Find the specific lesson by lessonNumber
                const targetLesson = lessons.find(l => l.lessonNumber === lessonNum);
                if (!targetLesson) {
                    // If specific lesson not found, use the first lesson as fallback
                    const fallbackLesson = lessons[0];
                    if (fallbackLesson) {
                        console.log(`‚ö†Ô∏è Lesson ${lessonNum} not found, using Lesson ${fallbackLesson.lessonNumber} as fallback`);
                        currentLessonData = formatLessonForAI(targetModule, fallbackLesson);
                    } else {
                        throw new Error(`No lessons found in Module ${moduleNum}`);
                    }
                } else {
                    console.log(`‚úÖ Found Lesson ${lessonNum}: ${targetLesson.title}`);
                    currentLessonData = formatLessonForAI(targetModule, targetLesson);
                }
                
                console.log('üìù Formatted lesson data for AI:', currentLessonData);
                displayLessonData();
                
                // Save for future use
                localStorage.setItem('currentAILessonData', JSON.stringify(currentLessonData));
                
            } catch (error) {
                console.error('‚ùå Error fetching lesson data:', error);
                
                // Try to use localStorage data as fallback
                const savedLesson = localStorage.getItem('currentAILessonData');
                if (savedLesson) {
                    console.log('üîÑ Using cached lesson data as fallback');
                    currentLessonData = JSON.parse(savedLesson);
                    displayLessonData();
                    updateAPIStatus('warning', '‚ö†Ô∏è Using cached lesson data - some content may be outdated');
                } else {
                    // Show a helpful error message to the user
                    displayErrorData(error.message);
                }
            }
        }

        // Format lesson data from your MongoDB format to the AI planner format
        function formatLessonForAI(module, lesson) {
            // Debug: Log the actual lesson structure
            console.log('üîç Raw lesson data structure:', lesson);
            console.log('üîç Teacher content:', lesson.teacherContent);
            console.log('üîç Student content:', lesson.studentContent);
            console.log('üîç Vocabulary:', lesson.teacherContent?.vocabulary || lesson.vocabulary);
            
            return {
                moduleNumber: module.moduleNumber,
                moduleName: module.title,
                lessonNumber: lesson.lessonNumber,
                title: lesson.title,
                content: lesson.content || lesson.description || '',
                objectives: lesson.teacherContent?.objectives || lesson.objectives || [],
                materials: lesson.teacherContent?.materials || lesson.materials || [],
                procedures: lesson.teacherContent?.procedures || lesson.procedures || [],
                assessments: lesson.teacherContent?.assessments || lesson.assessments || [],
                vocabulary: lesson.teacherContent?.vocabulary || lesson.vocabulary || [],
                duration: lesson.duration || lesson.teacherContent?.duration || '45 minutes',
                // Include any additional content for richer AI generation
                studentContent: lesson.studentContent || {},
                teacherContent: lesson.teacherContent || {},
                geographicFocus: lesson.geographicFocus || '',
                standards: lesson.standards || [],
                concepts: lesson.concepts || []
            };
        }

        // Display lesson data in the interface
        function displayLessonData() {
            if (!currentLessonData) return;

            // Update lesson info
            document.getElementById('lesson-module').textContent = 
                `Module ${currentLessonData.moduleNumber}: ${currentLessonData.moduleName || 'Unknown Module'}`;
            document.getElementById('lesson-title').textContent = 
                `Lesson ${currentLessonData.lessonNumber}: ${currentLessonData.title || 'Unknown Lesson'}`;

            // Extract and display teacher content
            const teacherContent = extractTeacherContent(currentLessonData);
            document.getElementById('teacher-content').innerHTML = teacherContent;

            // Extract and display student content
            const studentContent = extractStudentContent(currentLessonData);
            document.getElementById('student-content').innerHTML = studentContent;

            updateAPIStatus('success', '‚úÖ Lesson content loaded successfully');
            
            // Re-check API status now that we have lesson data
            checkAPIStatus();
        }

        // Extract teacher-focused content from lesson data
        function extractTeacherContent(lessonData) {
            let content = '';
            
            // Handle both direct properties and nested teacherContent structure
            const teacherData = lessonData.teacherContent || lessonData;
            const studentData = lessonData.studentContent || {};
            
            // Learning Objectives - handle both array and string formats
            if (teacherData.objectives) {
                const objectives = Array.isArray(teacherData.objectives) ? teacherData.objectives : [teacherData.objectives];
                if (objectives.length > 0 && objectives[0]) {
                    content += '<h4>üìã Learning Objectives:</h4><ul>';
                    objectives.forEach(obj => {
                        if (obj) content += `<li>${obj}</li>`;
                    });
                    content += '</ul>';
                }
            }

            // Materials Needed - handle both array and string formats
            if (teacherData.materials) {
                const materials = Array.isArray(teacherData.materials) ? teacherData.materials : [teacherData.materials];
                if (materials.length > 0 && materials[0]) {
                    content += '<h4>üì¶ Materials Needed:</h4><ul>';
                    materials.forEach(material => {
                        if (material) content += `<li>${material}</li>`;
                    });
                    content += '</ul>';
                }
            }

            // Teacher Notes (often contains rich content)
            if (teacherData.notes) {
                content += `<h4>üìù Teacher Notes:</h4><div class="lesson-content">${teacherData.notes}</div>`;
            }

            // Lesson Procedures
            if (teacherData.procedures && teacherData.procedures.length > 0) {
                content += '<h4>üìù Lesson Procedures:</h4><ol>';
                teacherData.procedures.forEach(procedure => {
                    content += `<li>${procedure}</li>`;
                });
                content += '</ol>';
            }

            // Assessment Methods
            if (teacherData.assessments && teacherData.assessments.length > 0) {
                content += '<h4>üìä Assessment Methods:</h4><ul>';
                teacherData.assessments.forEach(assessment => {
                    content += `<li>${assessment}</li>`;
                });
                content += '</ul>';
            }

            // Extensions
            if (teacherData.extensions) {
                content += `<h4>üéØ Extensions:</h4><div class="lesson-content">${teacherData.extensions}</div>`;
            }

            // Extract vocabulary from student reading content if teacher vocabulary is empty
            if (teacherData.vocabulary && teacherData.vocabulary.length > 0) {
                content += '<h4>üìö Key Vocabulary:</h4><div class="vocabulary-list">';
                teacherData.vocabulary.forEach(term => {
                    // Handle different vocabulary formats
                    if (typeof term === 'string') {
                        content += `<div class="vocab-item"><strong>${term}</strong></div>`;
                    } else if (term && typeof term === 'object') {
                        const termName = term.term || term.word || term.name || term.title || '';
                        const termDef = term.definition || term.def || term.meaning || term.description || '';
                        
                        if (termName && termDef) {
                            content += `<div class="vocab-item"><strong>${termName}:</strong> ${termDef}</div>`;
                        } else if (termName) {
                            content += `<div class="vocab-item"><strong>${termName}</strong></div>`;
                        }
                    }
                });
                content += '</div>';
            } else if (studentData.readings) {
                // Extract vocabulary from student readings if no explicit vocabulary
                // Make sure readings is a string before calling .match()
                const readingsText = typeof studentData.readings === 'string' ? studentData.readings : '';
                if (readingsText) {
                    const vocabMatches = readingsText.match(/\*\*([^*]+)\*\*/g);
                    if (vocabMatches && vocabMatches.length > 0) {
                        content += '<h4>üìö Key Terms (from reading):</h4><div class="vocabulary-list">';
                        vocabMatches.slice(0, 10).forEach(match => { // Limit to first 10 terms
                            const term = match.replace(/\*\*/g, '');
                            if (term.length > 2 && term.length < 50) { // Reasonable term length
                                content += `<div class="vocab-item"><strong>${term}</strong></div>`;
                            }
                        });
                        content += '</div>';
                    }
                }
            }

            return content || '<p>No detailed teacher content available</p>';
        }

        // Extract student reading content from lesson data
        function extractStudentContent(lessonData) {
            let content = '';

            // Try multiple sources for student content
            const studentData = lessonData.studentContent || {};
            const teacherData = lessonData.teacherContent || lessonData;

            // 1. Check for student readings (THIS IS THE KEY FIELD!)
            if (studentData.readings) {
                // Handle different reading formats - could be string, object, or array
                let readingContent = '';
                
                if (typeof studentData.readings === 'string') {
                    readingContent = studentData.readings;
                } else if (typeof studentData.readings === 'object') {
                    // If it's an object, try to extract content from common properties
                    readingContent = studentData.readings.content || 
                                   studentData.readings.text || 
                                   studentData.readings.reading || 
                                   JSON.stringify(studentData.readings, null, 2);
                } else {
                    readingContent = String(studentData.readings);
                }
                
                if (readingContent) {
                    content += `<h4>üìñ Student Reading:</h4><div class="lesson-content">${readingContent}</div>`;
                }
            }
            
            // 2. Check for dedicated student content
            else if (studentData.content) {
                content += `<h4>üìñ Student Reading:</h4><div class="lesson-content">${studentData.content}</div>`;
            }
            
            // 3. Use the main lesson content if no dedicated student content
            else if (lessonData.content) {
                content += `<h4>üìñ Lesson Content:</h4><div class="lesson-content">${lessonData.content}</div>`;
            }
            
            // 4. Try to extract content from description
            else if (lessonData.description) {
                content += `<h4>üìñ Lesson Overview:</h4><div class="lesson-content">${lessonData.description}</div>`;
            }

            // Add student activities if available
            if (studentData.activities) {
                content += `<h4>üéØ Student Activities:</h4><div class="lesson-content">${studentData.activities}</div>`;
            }

            // Add worksheets if available
            if (studentData.worksheets) {
                content += `<h4>üìã Worksheets:</h4><div class="lesson-content">${studentData.worksheets}</div>`;
            }

            // Add assignments if available
            if (studentData.assignments) {
                content += `<h4>ÔøΩ Assignments:</h4><div class="lesson-content">${studentData.assignments}</div>`;
            }

            // Check for geographic focus
            if (lessonData.geographicFocus) {
                content += `<h4>üåç Geographic Focus:</h4><p>${lessonData.geographicFocus}</p>`;
            }

            // Add vocabulary for student reference - Handle multiple formats
            if (teacherData.vocabulary && teacherData.vocabulary.length > 0) {
                content += '<h4>üìö Key Terms to Know:</h4><div class="vocabulary-list">';
                teacherData.vocabulary.forEach(term => {
                    // Handle different vocabulary formats
                    if (typeof term === 'string') {
                        // Simple string format
                        content += `<div class="vocab-item"><strong>${term}</strong></div>`;
                    } else if (term && typeof term === 'object') {
                        // Object format - check various property names
                        const termName = term.term || term.word || term.name || term.title || '';
                        const termDef = term.definition || term.def || term.meaning || term.description || '';
                        
                        if (termName && termDef) {
                            content += `<div class="vocab-item"><strong>${termName}:</strong> ${termDef}</div>`;
                        } else if (termName) {
                            content += `<div class="vocab-item"><strong>${termName}</strong></div>`;
                        } else {
                            // If object has other properties, try to display them
                            const keys = Object.keys(term);
                            if (keys.length > 0) {
                                const key = keys[0];
                                const value = term[key];
                                if (value && value !== 'undefined') {
                                    content += `<div class="vocab-item"><strong>${key}:</strong> ${value}</div>`;
                                }
                            }
                        }
                    }
                });
                content += '</div>';
            }

            // If still no content, try to extract from any HTML structure
            if (!content && lessonData.content) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = lessonData.content;
                
                // Get main content sections
                const bigIdea = tempDiv.querySelector('.big-idea, [class*="big-idea"]');
                if (bigIdea) {
                    content += '<h4>The Big Idea:</h4>' + bigIdea.innerHTML;
                }

                const mainIdeas = tempDiv.querySelector('.main-ideas, [class*="main-ideas"]');
                if (mainIdeas) {
                    content += '<h4>Main Ideas:</h4>' + mainIdeas.innerHTML;
                }

                const keyTerms = tempDiv.querySelector('.key-terms, [class*="key-terms"]');
                if (keyTerms) {
                    content += '<h4>Key Terms and Places:</h4>' + keyTerms.innerHTML;
                }

                // If no specific sections found, use the whole content
                if (!content) {
                    content = tempDiv.textContent.substring(0, 1000) + (tempDiv.textContent.length > 1000 ? '...' : '');
                }
            }

            return content || '<p>No student reading content available</p>';
        }

        // Display placeholder data when no lesson is loaded
        function displayPlaceholderData() {
            document.getElementById('lesson-module').textContent = 'No module selected';
            document.getElementById('lesson-title').textContent = 'Please select a lesson from the main companion';
            document.getElementById('teacher-content').innerHTML = 
                '<p style="color: #6c757d;">Teacher guide content will appear here when a lesson is selected.</p>';
            document.getElementById('student-content').innerHTML = 
                '<p style="color: #6c757d;">Student reading content will appear here when a lesson is selected.</p>';
            
            updateAPIStatus('warning', '‚ö†Ô∏è No lesson selected. Please go back and select a lesson first.');
            document.getElementById('generate-btn').disabled = true;
        }

        // Display error data
        function displayErrorData(customMessage = null) {
            const errorMessage = customMessage || 'Error loading lesson data. Please try again.';
            
            document.getElementById('lesson-module').textContent = 'Error';
            document.getElementById('lesson-title').textContent = 'Failed to Load Lesson';
            document.getElementById('teacher-content').innerHTML = 
                `<div style="color: #dc3545; padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px;">
                    <h4>‚ùå Error Loading Lesson Data</h4>
                    <p>${errorMessage}</p>
                    <p style="margin-top: 10px; font-size: 0.9em;">
                        <strong>Suggestions:</strong><br>
                        ‚Ä¢ Try going back and selecting a different lesson<br>
                        ‚Ä¢ Use Module 1, Lesson 1 or Module 2, Lesson 1 which have sample data<br>
                        ‚Ä¢ Contact your administrator if this problem persists
                    </p>
                </div>`;
            document.getElementById('student-content').innerHTML = 
                '<p style="color: #6c757d;">Student content not available due to loading error.</p>';
            
            updateAPIStatus('error', `‚ùå ${errorMessage}`);
            document.getElementById('generate-btn').disabled = true;
        }

        // Load user settings from localStorage
        function loadUserSettings() {
            const savedAPIKey = localStorage.getItem('openai_api_key');
            if (savedAPIKey) {
                document.getElementById('api-key').value = savedAPIKey;
            }

            const savedModel = localStorage.getItem('preferred_ai_model');
            if (savedModel) {
                document.getElementById('ai-model').value = savedModel;
            }

            const savedFocus = localStorage.getItem('preferred_lesson_focus');
            if (savedFocus) {
                document.getElementById('lesson-focus').value = savedFocus;
            }
        }

        // Save user settings to localStorage
        function saveUserSettings() {
            const apiKey = document.getElementById('api-key').value;
            if (apiKey) {
                localStorage.setItem('openai_api_key', apiKey);
            }

            localStorage.setItem('preferred_ai_model', document.getElementById('ai-model').value);
            localStorage.setItem('preferred_lesson_focus', document.getElementById('lesson-focus').value);
        }

        // Check API status and update UI
        function checkAPIStatus() {
            // First check if we have an API key from Railway environment
            fetch('/api/openai-key-status')
                .then(response => response.json())
                .then(data => {
                    if (data.hasKey) {
                        // Check if we have lesson data before enabling
                        if (currentLessonData) {
                            updateAPIStatus('success', '‚úÖ Using OpenAI API key from server environment');
                            document.getElementById('generate-btn').disabled = false;
                        } else {
                            updateAPIStatus('warning', '‚ö†Ô∏è Server API key available, waiting for lesson content...');
                            document.getElementById('generate-btn').disabled = true;
                        }
                        // Hide the API key input section since we're using server key
                        const apiKeyGroup = document.getElementById('api-key').closest('.control-group');
                        if (apiKeyGroup) {
                            apiKeyGroup.style.display = 'none';
                        }
                        return;
                    } else {
                        // Fall back to local API key
                        checkLocalAPIKey();
                    }
                })
                .catch(error => {
                    console.log('No server API key available, checking local key');
                    checkLocalAPIKey();
                });
        }

        function checkLocalAPIKey() {
            const apiKey = document.getElementById('api-key').value;
            
            // If no lesson data, disable regardless of API key
            if (!currentLessonData) {
                updateAPIStatus('warning', '‚ö†Ô∏è No lesson content loaded');
                document.getElementById('generate-btn').disabled = true;
                return;
            }
            
            if (!apiKey) {
                updateAPIStatus('warning', '‚ö†Ô∏è Please enter your OpenAI API key in Advanced Settings');
                document.getElementById('generate-btn').disabled = true;
                return;
            }

            if (!apiKey.startsWith('sk-')) {
                updateAPIStatus('error', '‚ùå Invalid API key format. Should start with "sk-"');
                document.getElementById('generate-btn').disabled = true;
                return;
            }

            updateAPIStatus('success', '‚úÖ Ready to generate lesson plan');
            document.getElementById('generate-btn').disabled = false;
        }

        // Update API status display
        function updateAPIStatus(type, message) {
            const statusElement = document.getElementById('api-status');
            statusElement.className = 'api-status';
            statusElement.classList.add(type + '-status');
            statusElement.textContent = message;
        }

        // Toggle advanced settings
        function toggleAdvancedSettings() {
            const content = document.getElementById('advanced-content');
            content.classList.toggle('show');
        }

        // Main function to generate lesson plan
        async function generateLessonPlan() {
            console.log('üöÄ Starting lesson plan generation...');
            
            if (!currentLessonData) {
                alert('Please select a lesson first by going back to the lesson companion.');
                return;
            }

            console.log('üìö Current lesson data:', currentLessonData);

            // Save user settings
            saveUserSettings();

            // Show loading state
            document.getElementById('loading').style.display = 'block';
            document.getElementById('lesson-plan-output').style.display = 'none';
            document.getElementById('generate-btn').disabled = true;
            document.getElementById('generate-btn').textContent = 'ü§ñ Generating...';

            try {
                // Prepare the AI prompt
                const prompt = buildAIPrompt();
                console.log('üìù Built AI prompt, length:', prompt.length);
                
                // Call OpenAI API
                const lessonPlan = await callOpenAIAPI(prompt);
                console.log('‚úÖ Received lesson plan from AI');
                
                // Display the generated lesson plan
                displayGeneratedLessonPlan(lessonPlan);
                
                updateAPIStatus('success', '‚úÖ Lesson plan generated successfully!');
                
            } catch (error) {
                console.error('‚ùå Error generating lesson plan:', error);
                updateAPIStatus('error', '‚ùå Error generating lesson plan: ' + error.message);
                
                // Show error in output panel
                document.getElementById('lesson-plan-output').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <h3>‚ùå Generation Failed</h3>
                        <p>${error.message}</p>
                        <button onclick="generateLessonPlan()" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Try Again
                        </button>
                    </div>
                `;
            } finally {
                // Reset UI
                document.getElementById('loading').style.display = 'none';
                document.getElementById('lesson-plan-output').style.display = 'block';
                document.getElementById('generate-btn').disabled = false;
                document.getElementById('generate-btn').textContent = 'üöÄ Generate AI Lesson Plan';
            }
        }

        // Build the AI prompt based on current settings and content
        function buildAIPrompt() {
            const lessonFocus = document.getElementById('lesson-focus').value;
            const classSize = document.getElementById('class-size').value;
            const customInstructions = document.getElementById('custom-prompt').value;

            const teacherContent = document.getElementById('teacher-content').textContent;
            const studentContent = document.getElementById('student-content').textContent;

            const focusDescriptions = {
                'balanced': 'a balanced mix of instruction, discussion, and activities',
                'interactive': 'highly interactive with frequent student participation',
                'discussion': 'discussion-heavy with socratic questioning',
                'hands-on': 'hands-on activities and experiential learning',
                'assessment': 'assessment-focused with multiple check-ins',
                'technology': 'technology integration and digital tools'
            };

            return `You are an expert geography teacher creating a detailed 50-minute lesson plan. 

LESSON CONTEXT:
- Module: ${currentLessonData.moduleNumber}
- Lesson: ${currentLessonData.title}
- Class Size: ${classSize} students
- Focus Style: ${focusDescriptions[lessonFocus]}
${customInstructions ? `- Special Instructions: ${customInstructions}` : ''}

AVAILABLE CONTENT TO USE:
${teacherContent}

${studentContent}

---

Create a PROFESSIONAL, CLEAN, and EASY-TO-FOLLOW 50-minute lesson plan that any teacher can implement successfully. Follow this EXACT format:

# üìö ${currentLessonData.title}
**Module ${currentLessonData.moduleNumber} | ${classSize} Students | 50 Minutes**

---

## ‚è∞ TIMING OVERVIEW
| Time | Activity | Purpose |
|------|----------|---------|
| 0-5 min | Opening Hook | Engage & Activate |
| 5-20 min | Main Instruction | Core Content |
| 20-35 min | Student Activities | Practice & Apply |
| 35-45 min | Assessment & Discussion | Check Understanding |
| 45-50 min | Closure & Preview | Wrap Up |

---

## üéØ LESSON ESSENTIALS

### Learning Objectives
Students will be able to:
- [Create 3-4 specific, measurable objectives]

### Key Vocabulary (5-8 terms)
- **Term 1**: Definition
- **Term 2**: Definition
[etc.]

### Essential Questions
1. [3-4 questions that drive the lesson]

---

## üì¶ MATERIALS & SETUP
**Required Materials:**
- [ ] [List each item with checkbox]
- [ ] 
**Setup Time:** [X] minutes
**Room Arrangement:** [Specific description]

---

## üöÄ DETAILED LESSON ACTIVITIES

### OPENING HOOK (5 minutes)
**Teacher Actions:**
- [Specific steps and exact words to say]
- [Materials to have ready]

**Student Expectations:**
- [What students should be doing]

**Transition:** "[Exact phrase to move to next section]"

### MAIN INSTRUCTION (15 minutes)
**Teacher Actions:**
- [Step-by-step instruction delivery]
- [Key points to emphasize]
- [Visual aids to use]

**Student Engagement:**
- [Specific questions to ask]
- [Ways students participate]

**Check for Understanding:**
- [2-3 quick assessment strategies]

### STUDENT ACTIVITIES (15 minutes)
**Primary Activity:**
- [Detailed instructions for main activity]
- [Group formation strategy]
- [Time warnings to give]

**Backup Activity:**
- [Alternative if technology fails or time runs short]

**Teacher Circulation:**
- [What to look for as you move around]
- [Questions to ask individual students]

### ASSESSMENT & DISCUSSION (10 minutes)
**Formative Assessment:**
- [Specific way to check learning]
- [Success criteria]

**Class Discussion:**
- [Discussion questions]
- [How to facilitate]

### CLOSURE (5 minutes)
**Wrap-Up Strategy:**
- [How to summarize key points]
- [Student reflection activity]

**Preview Next Lesson:**
- [How this connects to future learning]

---

## üìä DIFFERENTIATION & SUPPORT

### ELL Support
- [2-3 specific strategies]

### Special Needs Accommodations  
- [Modifications for different needs]

### Advanced Learners
- [Extension activities]

### Multiple Learning Styles
- **Visual:** [Specific supports]
- **Auditory:** [Specific supports]
- **Kinesthetic:** [Specific supports]

---

## ‚úÖ ASSESSMENT RUBRIC
| Criteria | Excellent | Good | Needs Work |
|----------|-----------|------|------------|
| [Skill 1] | [Description] | [Description] | [Description] |
| [Skill 2] | [Description] | [Description] | [Description] |

**Exit Ticket Question:** [One specific question to assess understanding]

---

## üîó CONNECTIONS & EXTENSIONS

### Cross-Curricular Links
- **Math:** [Specific connection]
- **Reading/Writing:** [Specific connection]
- **Science:** [If applicable]

### Real-World Applications
- [How this connects to current events or student lives]

### Extension Activities
- [For early finishers]
- [For homework or projects]

---

## üìù TEACHER NOTES & TIPS

### Key Teaching Points (Cannot Skip)
- [3-4 most important concepts]

### Common Student Misconceptions
- [What students often get wrong]
- [How to address it]

### Time Management Tips
- [If running behind...]
- [If ahead of schedule...]

### Technology Troubleshooting
- [Backup plans for tech issues]

---

**Prep Time Needed:** [X] minutes  
**Cleanup Time:** [X] minutes  
**Substitute Teacher Summary:** [2-3 sentences explaining the lesson for a sub]

Make this lesson plan practical, specific, and immediately usable. Include exact timing, specific materials, and concrete activities rather than vague suggestions.`;
        }

        // Call OpenAI API
        async function callOpenAIAPI(prompt) {
            const model = document.getElementById('ai-model').value;
            const creativity = parseFloat(document.getElementById('creativity-level').value);

            // First try to use server-side API (Railway environment)
            try {
                const response = await fetch('/api/generate-lesson-plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        model: model,
                        temperature: creativity,
                        max_tokens: 4000
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.content;
                } else if (response.status === 503) {
                    // Server API not available, fall back to client-side
                    return await callOpenAIClientSide(prompt, model, creativity);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server request failed: ${response.status}`);
                }
            } catch (error) {
                console.log('Server API not available, trying client-side:', error.message);
                return await callOpenAIClientSide(prompt, model, creativity);
            }
        }

        // Fallback to client-side OpenAI API
        async function callOpenAIClientSide(prompt, model, creativity) {
            const apiKey = document.getElementById('api-key').value;
            
            if (!apiKey) {
                throw new Error('No API key available. Please contact your administrator or enter your own API key.');
            }

            // Helper function to determine correct token parameter based on model
            function getTokenParameter(model, maxTokens) {
                // GPT-5 and GPT-4.1 series use max_completion_tokens
                if (model.startsWith('gpt-5') || model.startsWith('gpt-4.1')) {
                    return { max_completion_tokens: maxTokens };
                }
                // Older models use max_tokens
                return { max_tokens: maxTokens };
            }

            const tokenParams = getTokenParameter(model, 4000);

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        {
                            role: 'system',
                            content: 'You are an expert geography teacher with 20+ years of experience creating engaging, standards-aligned lesson plans. You specialize in 7th-grade geography and understand how to make complex geographic concepts accessible and interesting for middle school students.'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    temperature: creativity,
                    ...tokenParams
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `API request failed: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Display the generated lesson plan
        function displayGeneratedLessonPlan(lessonPlan) {
            generatedLessonPlan = lessonPlan;
            
            // Parse and format the lesson plan
            const formattedPlan = formatLessonPlan(lessonPlan);
            
            document.getElementById('lesson-plan-output').innerHTML = formattedPlan;
            document.getElementById('export-buttons').style.display = 'flex';
        }

        // Format the lesson plan with proper HTML structure
        function formatLessonPlan(planText) {
            // Split by sections and format
            let formatted = planText.replace(/\n/g, '<br>');
            
            // Format headers
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<h3>$1</h3>');
            formatted = formatted.replace(/(\d+\.\s\*\*.*?\*\*)/g, '<h3>$1</h3>');
            
            // Format bullet points
            formatted = formatted.replace(/(^|\<br\>)-\s/g, '$1‚Ä¢ ');
            
            // Wrap in proper structure
            return `
                <div class="lesson-plan-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #007bff;">
                        <h2 style="color: #007bff; margin: 0;">üìã Generated Lesson Plan</h2>
                        <span style="background: #e7f3ff; padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; color: #007bff; font-weight: bold;">
                            50 Minutes ‚Ä¢ ${document.getElementById('lesson-focus').value.charAt(0).toUpperCase() + document.getElementById('lesson-focus').value.slice(1)} Focus
                        </span>
                    </div>
                    <div style="line-height: 1.6;">
                        ${formatted}
                    </div>
                </div>
            `;
        }

        // Export functions
        function printLessonPlan() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Lesson Plan - ${currentLessonData.title}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                            h2, h3 { color: #007bff; }
                            .header { text-align: center; margin-bottom: 30px; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>üåç Geography Lesson Plan</h1>
                            <p><strong>Module ${currentLessonData.moduleNumber}:</strong> ${currentLessonData.title}</p>
                            <p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                        ${document.getElementById('lesson-plan-output').innerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function copyLessonPlan() {
            const textContent = generatedLessonPlan || document.getElementById('lesson-plan-output').textContent;
            navigator.clipboard.writeText(textContent).then(() => {
                alert('‚úÖ Lesson plan copied to clipboard!');
            }).catch(err => {
                console.error('Error copying to clipboard:', err);
                alert('‚ùå Failed to copy. Please select and copy manually.');
            });
        }

        function saveLessonPlan() {
            if (!generatedLessonPlan) return;
            
            const filename = `lesson-plan-${currentLessonData.moduleNumber}-${currentLessonData.lessonNumber}-${new Date().toISOString().split('T')[0]}.txt`;
            const blob = new Blob([generatedLessonPlan], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        // Navigation
        function goBack() {
            window.history.back();
        }

        // API key validation
        document.getElementById('api-key').addEventListener('input', function() {
            setTimeout(checkAPIStatus, 500);
        });

        // Auto-save API key
        document.getElementById('api-key').addEventListener('blur', function() {
            const apiKey = this.value;
            if (apiKey && apiKey.startsWith('sk-')) {
                localStorage.setItem('openai_api_key', apiKey);
            }
        });
    </script>
</body>
</html>
