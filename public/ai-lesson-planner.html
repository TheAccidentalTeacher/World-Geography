<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ AI Lesson Planner | Geography Companion</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 30px;
            padding: 30px;
            min-height: 800px;
        }

        .input-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
        }

        .output-panel {
            background: #f1f8ff;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #d1ecf1;
        }

        .panel-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lesson-info-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .lesson-info-card h3 {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .lesson-content {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .ai-controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .control-group select,
        .control-group input,
        .control-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .control-group select:focus,
        .control-group input:focus,
        .control-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        .generate-button {
            width: 100%;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .generate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .generate-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .lesson-plan-output {
            background: white;
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            min-height: 600px;
            max-height: 800px;
            overflow-y: auto;
        }

        .lesson-plan-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .lesson-plan-section:last-child {
            border-bottom: none;
        }

        .lesson-plan-section h3 {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-button {
            position: fixed;
            top: 30px;
            left: 30px;
            background: rgba(255, 255, 255, 0.9);
            color: #495057;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .back-button:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .api-status {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #856404;
        }

        .success-status {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .error-status {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .export-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .export-button:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .export-button.print {
            background: #17a2b8;
        }

        .export-button.copy {
            background: #ffc107;
            color: #212529;
        }

        .advanced-settings {
            background: #e7f3ff;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid #b3d7ff;
        }

        .advanced-toggle {
            background: none;
            border: none;
            color: #007bff;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .advanced-content {
            display: none;
        }

        .advanced-content.show {
            display: block;
        }

        /* Tab System Styles */
        .output-tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: #007bff;
        }

        .tab-button.active#integrated-lesson-tab {
            background: #ff6b6b;
        }

        .tab-button.active#lesson-plan-tab {
            background: #007bff;
        }

        .tab-button.active#condensed-reading-tab {
            background: #28a745;
        }

        .tab-button:not(.active) {
            background: #6c757d;
        }

        .tab-button:not(.active):hover {
            background: #5a6268;
        }

        .integrated-lesson-btn {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            margin-bottom: 15px;
            font-size: 1.1rem;
            padding: 18px;
        }

        .integrated-lesson-btn:hover {
            background: linear-gradient(135deg, #ff5252, #ff6b6b);
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .condensed-reading-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            margin-top: 15px;
        }

        .condensed-reading-btn:hover {
            background: linear-gradient(135deg, #218838, #1e7e34);
            transform: translateY(-2px);
        }

        .reading-options {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .reading-options h4 {
            margin-bottom: 15px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <button onclick="goBack()" class="back-button">‚Üê Back to Lesson Companion</button>

    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Lesson Planner</h1>
            <p>Generate Dynamic 50-Minute Lesson Plans with Advanced AI</p>
        </div>

        <div class="main-content">
            <!-- Input Panel -->
            <div class="input-panel">
                <div class="panel-title">
                    üìö Lesson Content Analysis
                </div>

                <!-- Lesson Selector -->
                <div class="lesson-info-card">
                    <h3>üéØ Select Your Lesson</h3>
                    <div class="control-group">
                        <label for="module-selector">Choose Module (1-32):</label>
                        <select id="module-selector">
                            <option value="">Loading modules...</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="lesson-selector">Choose Lesson:</label>
                        <select id="lesson-selector">
                            <option value="">Select a module first</option>
                        </select>
                    </div>
                    <button onclick="loadSelectedLesson()" class="generate-button" style="margin-top: 10px; padding: 10px 20px; font-size: 1rem;">
                        üìñ Load This Lesson
                    </button>
                </div>

                <!-- Current Lesson Info -->
                <div class="lesson-info-card">
                    <h3>üìã Current Lesson</h3>
                    <div id="current-lesson-info">
                        <p><strong>Module:</strong> <span id="lesson-module">Loading...</span></p>
                        <p><strong>Lesson:</strong> <span id="lesson-title">Loading...</span></p>
                        <p><strong>Duration:</strong> <span id="lesson-duration">50 minutes</span></p>
                    </div>
                </div>

                <!-- Teacher's Guide Content -->
                <div class="lesson-info-card">
                    <h3>üë®‚Äçüè´ Teacher's Guide Content</h3>
                    <div id="teacher-content" class="lesson-content">
                        <p>Loading teacher's guide content...</p>
                    </div>
                </div>

                <!-- Student Reading Content -->
                <div class="lesson-info-card">
                    <h3>üìñ Student Reading Content</h3>
                    <div id="student-content" class="lesson-content">
                        <p>Loading student reading content...</p>
                    </div>
                </div>

                <!-- AI Controls -->
                <div class="ai-controls">
                    <div class="api-status" id="api-status">
                        üîß Configuring AI settings...
                    </div>

                    <div class="control-group">
                        <label for="ai-model">AI Model Selection</label>
                        <select id="ai-model">
                            <optgroup label="üöÄ Latest Models (2025)">
                                <option value="gpt-5">GPT-5 (Best Performance)</option>
                                <option value="gpt-5-mini">GPT-5 Mini (Fast & Efficient)</option>
                                <option value="gpt-5-nano">GPT-5 Nano (Fastest)</option>
                                <option value="gpt-4.1">GPT-4.1 (Advanced Function Calling)</option>
                                <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
                                <option value="gpt-4.1-nano">GPT-4.1 Nano</option>
                            </optgroup>
                            <optgroup label="üîß Previous Generation">
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            </optgroup>
                        </select>
                        <small style="color: #666; font-size: 0.9em; margin-top: 5px; display: block;">
                            üí° GPT-5 and GPT-4.1 are the latest models with enhanced reasoning and coding capabilities
                        </small>
                    </div>

                    <div class="control-group">
                        <label for="lesson-focus">Lesson Focus Area</label>
                        <select id="lesson-focus">
                            <option value="balanced">Balanced Approach</option>
                            <option value="interactive">Highly Interactive</option>
                            <option value="discussion">Discussion-Heavy</option>
                            <option value="hands-on">Hands-On Activities</option>
                            <option value="assessment">Assessment-Focused</option>
                            <option value="technology">Technology Integration</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="class-size">Estimated Class Size</label>
                        <input type="number" id="class-size" value="25" min="1" max="50" placeholder="25">
                    </div>

                    <!-- Advanced Settings -->
                    <div class="advanced-settings">
                        <button class="advanced-toggle" onclick="toggleAdvancedSettings()">
                            ‚öôÔ∏è Advanced Settings
                        </button>
                        <div class="advanced-content" id="advanced-content">
                            <div class="control-group">
                                <label for="creativity-level">AI Creativity Level</label>
                                <select id="creativity-level">
                                    <option value="0.3">Conservative (0.3)</option>
                                    <option value="0.7" selected>Balanced (0.7)</option>
                                    <option value="1.0">Creative (1.0)</option>
                                </select>
                            </div>

                            <div class="control-group">
                                <label for="custom-prompt">Custom Instructions</label>
                                <textarea id="custom-prompt" rows="3" placeholder="Additional instructions for the AI (e.g., 'Focus on visual learners', 'Include group work', etc.)"></textarea>
                            </div>

                            <div class="control-group">
                                <label for="api-key">OpenAI API Key</label>
                                <form onsubmit="return false;">
                                    <input type="password" id="api-key" name="api-key" placeholder="sk-..." 
                                           value="" autocomplete="off" />
                                </form>
                                <small style="color: #6c757d; font-size: 0.8rem; margin-top: 5px; display: block;">
                                    Your API key is stored locally and never sent to our servers
                                </small>
                            </div>

                            <div class="control-group">
                                <label for="stability-api-key">üé® Stability AI API Key (for custom images)</label>
                                <form onsubmit="return false;">
                                    <input type="password" id="stability-api-key" name="stability-api-key" placeholder="sk-..." 
                                           value="" autocomplete="off" />
                                </form>
                                <small style="color: #6c757d; font-size: 0.8rem; margin-top: 5px; display: block;">
                                    Optional: For AI-generated custom images in presentations
                                </small>
                            </div>

                            <div class="control-group">
                                <label for="unsplash-api-key">üì∏ Unsplash API Key (for stock photos)</label>
                                <form onsubmit="return false;">
                                    <input type="password" id="unsplash-api-key" name="unsplash-api-key" placeholder="Access Key..." 
                                           value="" autocomplete="off" />
                                </form>
                                <small style="color: #6c757d; font-size: 0.8rem; margin-top: 5px; display: block;">
                                    Optional: For high-quality stock photos (free at <a href="https://unsplash.com/developers" target="_blank">unsplash.com/developers</a>)
                                </small>
                            </div>

                            <div class="control-group">
                                <label for="pexels-api-key">üñºÔ∏è Pexels API Key (alternative stock photos)</label>
                                <form onsubmit="return false;">
                                    <input type="password" id="pexels-api-key" name="pexels-api-key" placeholder="API Key..." 
                                           value="" autocomplete="off" />
                                </form>
                                <small style="color: #6c757d; font-size: 0.8rem; margin-top: 5px; display: block;">
                                    Optional: Alternative for stock photos (free at <a href="https://www.pexels.com/api/" target="_blank">pexels.com/api</a>)
                                </small>
                            </div>
                        </div>
                    </div>

                    <button onclick="generateIntegratedLesson()" class="generate-button integrated-lesson-btn" id="integrated-lesson-btn" 
                            style="background: linear-gradient(135deg, #ff6b6b, #ff8e8e); margin-bottom: 15px; font-size: 1.1rem; padding: 18px;">
                        üéØ Generate Complete Integrated Lesson
                        <div style="font-size: 0.9rem; margin-top: 5px; opacity: 0.9;">
                            Reading + Lesson Plan + Handouts (One-Click Solution)
                        </div>
                    </button>
                    
                    <div style="text-align: center; margin: 15px 0; color: #6c757d; font-weight: bold;">
                        OR Generate Components Separately:
                    </div>

                    <button onclick="generateLessonPlan()" class="generate-button" id="generate-btn">
                        üöÄ Generate AI Lesson Plan
                    </button>
                    
                    <button onclick="generateCondensedReading()" class="generate-button condensed-reading-btn" id="condensed-reading-btn" 
                            style="background: linear-gradient(135deg, #28a745, #20c997); margin-top: 15px;">
                        üìö Generate Condensed Student Reading
                    </button>
                    
                    <div class="reading-options" id="reading-options" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; display: none;">
                        <h4 style="margin-bottom: 10px; color: #495057;">üìñ Reading Generation Options</h4>
                        
                        <div class="control-group">
                            <label for="reading-complexity">Reading Complexity Level:</label>
                            <select id="reading-complexity" class="control">
                                <option value="simplified">Simplified (2 grades below)</option>
                                <option value="standard" selected>Standard (Grade appropriate)</option>
                                <option value="advanced">Advanced (1 grade above)</option>
                                <option value="all-levels">All Three Levels</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label for="reading-length">Target Reading Length:</label>
                            <select id="reading-length" class="control">
                                <option value="condensed" selected>Condensed (4-5 paragraphs)</option>
                                <option value="comprehensive">Comprehensive (6-8 paragraphs)</option>
                                <option value="detailed">Detailed (8-10 paragraphs)</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label for="reading-focus">Reading Focus:</label>
                            <select id="reading-focus" class="control">
                                <option value="balanced" selected>Balanced Overview</option>
                                <option value="geographic">Geographic Emphasis</option>
                                <option value="cultural">Cultural Emphasis</option>
                                <option value="historical">Historical Emphasis</option>
                                <option value="environmental">Environmental Emphasis</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="include-supports" checked style="margin-right: 8px;">
                                Include Comprehension Supports (pronunciation guides, margin questions, etc.)
                            </label>
                        </div>
                        
                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="include-assessment" checked style="margin-right: 8px;">
                                Include Assessment Integration (text-dependent questions, citation practice)
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Output Panel -->
            <div class="output-panel">
                <div class="output-tabs" style="display: flex; border-bottom: 2px solid #e9ecef; margin-bottom: 20px;">
                    <button class="tab-button active" onclick="switchTab('integrated-lesson')" id="integrated-lesson-tab" 
                            style="flex: 1; padding: 12px; border: none; background: #ff6b6b; color: white; cursor: pointer; border-radius: 8px 8px 0 0;">
                        üéØ Complete Lesson
                    </button>
                    <button class="tab-button" onclick="switchTab('lesson-plan')" id="lesson-plan-tab" 
                            style="flex: 1; padding: 12px; border: none; background: #6c757d; color: white; cursor: pointer; border-radius: 8px 8px 0 0; margin-left: 2px;">
                        üìã Lesson Plan Only
                    </button>
                    <button class="tab-button" onclick="switchTab('condensed-reading')" id="condensed-reading-tab"
                            style="flex: 1; padding: 12px; border: none; background: #6c757d; color: white; cursor: pointer; border-radius: 8px 8px 0 0; margin-left: 2px;">
                        üìö Reading Only
                    </button>
                </div>

                <!-- Integrated Lesson Tab Content -->
                <div class="tab-content active" id="integrated-lesson-content">
                    <div class="panel-title">
                        üéØ Complete Integrated Lesson Package
                    </div>

                    <div class="loading" id="integrated-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <h3>üîß AI is building your complete lesson package...</h3>
                        <p>Generating reading materials, lesson plan, and handouts as one integrated document</p>
                    </div>

                    <div class="integrated-lesson-output" id="integrated-lesson-output">
                        <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                            <h3>üéØ Ready to Generate Complete Lesson</h3>
                            <p>Click "Generate Complete Integrated Lesson" to create a print-ready, comprehensive lesson package.</p>
                            
                            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: left;">
                                <h4 style="color: #495057; margin-bottom: 15px;">‚ú® Complete Package Includes:</h4>
                                <ul style="color: #6c757d; line-height: 1.8;">
                                    <li>üìñ <strong>Condensed Student Reading</strong> with lesson-aligned annotations</li>
                                    <li>üìã <strong>Integrated Lesson Plan</strong> with reading references throughout</li>
                                    <li>üìù <strong>Student Handouts</strong> designed to work with the reading</li>
                                    <li>üîó <strong>Seamless Transitions</strong> from reading to activities</li>
                                    <li>‚è∞ <strong>Unified Timing</strong> including reading time breakdown</li>
                                    <li>üéØ <strong>Text-Dependent Activities</strong> requiring evidence from reading</li>
                                    <li>üìä <strong>Integrated Assessment</strong> measuring both reading and content</li>
                                    <li>üñ®Ô∏è <strong>Print-Ready Format</strong> with professional layout</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="export-buttons" id="integrated-export-buttons" style="display: none;">
                        <button onclick="printIntegratedLesson()" class="export-button print">üñ®Ô∏è Print Complete Lesson</button>
                        <button onclick="copyIntegratedLesson()" class="export-button copy">üìã Copy Complete Lesson</button>
                        <button onclick="saveIntegratedLesson()" class="export-button">üíæ Save Complete Lesson</button>
                        <button onclick="generateSmartPresentation(true)" class="export-button" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: bold;">üé® Generate Smart Presentation</button>
                    </div>
                </div>

                <!-- Lesson Plan Tab Content -->
                <div class="tab-content" id="lesson-plan-content" style="display: none;">
                    <div class="panel-title">
                        üéØ Generated Lesson Plan
                    </div>

                    <div class="loading" id="loading">
                        <div class="loading-spinner"></div>
                        <h3>ü§ñ AI is crafting your lesson plan...</h3>
                        <p>Analyzing content and generating personalized activities</p>
                    </div>

                    <div class="lesson-plan-output" id="lesson-plan-output">
                        <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                            <h3>üöÄ Ready to Generate</h3>
                            <p>Click "Generate AI Lesson Plan" to create a comprehensive 50-minute lesson plan tailored to your content.</p>
                            
                            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: left;">
                                <h4 style="color: #495057; margin-bottom: 15px;">‚ú® What You'll Get:</h4>
                                <ul style="color: #6c757d; line-height: 1.8;">
                                    <li>üìÖ <strong>Detailed timing breakdown</strong> (opening, activities, closure)</li>
                                    <li>üéØ <strong>Learning objectives</strong> aligned with content</li>
                                    <li>üó£Ô∏è <strong>Discussion questions</strong> and talking points</li>
                                    <li>üé® <strong>Interactive activities</strong> and engagement strategies</li>
                                    <li>üìù <strong>Assessment opportunities</strong> throughout the lesson</li>
                                    <li>üé™ <strong>Differentiation strategies</strong> for various learning styles</li>
                                    <li>üìö <strong>Materials list</strong> and preparation notes</li>
                                    <li>üîó <strong>Extensions and connections</strong> to other topics</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="export-buttons" id="export-buttons" style="display: none;">
                        <button onclick="printLessonPlan()" class="export-button print">üñ®Ô∏è Print</button>
                        <button onclick="copyLessonPlan()" class="export-button copy">üìã Copy</button>
                        <button onclick="saveLessonPlan()" class="export-button">üíæ Save</button>
                    </div>
                </div>

                <!-- Condensed Reading Tab Content -->
                <div class="tab-content" id="condensed-reading-content" style="display: none;">
                    <div class="panel-title">
                        üìö Generated Student Reading
                    </div>

                    <div class="loading" id="reading-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <h3>üìñ AI is creating your condensed reading...</h3>
                        <p>Analyzing source materials and generating student-friendly content</p>
                    </div>

                    <div class="condensed-reading-output" id="condensed-reading-output">
                        <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                            <h3>üìö Ready to Generate</h3>
                            <p>Click "Generate Condensed Student Reading" to create curriculum-independent reading materials.</p>
                            
                            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: left;">
                                <h4 style="color: #495057; margin-bottom: 15px;">‚ú® What You'll Get:</h4>
                                <ul style="color: #6c757d; line-height: 1.8;">
                                    <li>üìñ <strong>Condensed Reading</strong> (4-5 paragraphs, 150-200 words each)</li>
                                    <li>üéØ <strong>Multiple Complexity Levels</strong> (simplified, standard, advanced)</li>
                                    <li>üìù <strong>Comprehension Supports</strong> (pronunciation guides, margin questions)</li>
                                    <li>üîç <strong>Text-Dependent Questions</strong> with paragraph references</li>
                                    <li>üìö <strong>Vocabulary Integration</strong> with context and definitions</li>
                                    <li>üó∫Ô∏è <strong>Geographic Analysis Framework</strong> built into reading</li>
                                    <li>üåç <strong>Cultural Sensitivity</strong> and contemporary connections</li>
                                    <li>üìä <strong>Assessment Integration</strong> with citation practice</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="export-buttons" id="reading-export-buttons" style="display: none;">
                        <button onclick="printCondensedReading()" class="export-button print">üñ®Ô∏è Print Reading</button>
                        <button onclick="copyCondensedReading()" class="export-button copy">üìã Copy Reading</button>
                        <button onclick="saveCondensedReading()" class="export-button">üíæ Save Reading</button>
                    </div>
                </div>

                <!-- Integrated Lesson Tab Content -->
                <div class="tab-content" id="integrated-lesson-content" style="display: none;">
                    <div class="panel-title">
                        üéØ Complete Integrated Lesson Package
                    </div>

                    <div class="loading" id="integrated-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <h3>üîß AI is building your complete lesson...</h3>
                        <p>Integrating reading materials + lesson plan + handouts into one comprehensive package</p>
                        <div style="margin-top: 20px; padding: 15px; background: #fff5f5; border-radius: 10px; color: #721c24;">
                            <h4>üéØ Creating Your ONE-CLICK Solution:</h4>
                            <ul style="text-align: left; margin-top: 10px;">
                                <li>üìö Condensed student reading (curriculum-independent)</li>
                                <li>üìù Complete lesson plan (integrated with reading)</li>
                                <li>üìÑ Student handouts (text-dependent activities)</li>
                                <li>‚è∞ Unified timing guide (reading + activities)</li>
                                <li>‚úÖ Assessment tools (reading + content integration)</li>
                                <li>üñ®Ô∏è Print-ready format (no prep required)</li>
                            </ul>
                        </div>
                    </div>

                    <div class="export-buttons" id="integrated-export-buttons" style="display: none;">
                        <button onclick="printIntegratedLesson()" class="export-button print">üñ®Ô∏è Print Complete Lesson</button>
                        <button onclick="copyIntegratedLesson()" class="export-button copy">üìã Copy Lesson Package</button>
                        <button onclick="saveIntegratedLesson()" class="export-button">üíæ Save Integrated Lesson</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentLessonData = null;
        let generatedLessonPlan = null;
        
        // Make currentLessonData available globally
        window.currentLessonData = currentLessonData;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentLessonData();
            loadUserSettings();
            checkAPIStatus();
            loadAllModules(); // Load modules for the selector
        });

        // Load all modules for the selector (like your main curriculum page does)
        async function loadAllModules() {
            try {
                console.log('üîÑ Loading all modules for selector...');
                const response = await fetch('/api/modules');
                if (!response.ok) {
                    throw new Error(`Failed to fetch modules: ${response.status}`);
                }
                
                const modules = await response.json();
                console.log(`üìö Loaded ${modules.length} modules`);
                
                const moduleSelector = document.getElementById('module-selector');
                moduleSelector.innerHTML = '<option value="">Choose a module...</option>';
                
                // Sort modules by moduleNumber and populate selector
                modules.sort((a, b) => a.moduleNumber - b.moduleNumber);
                modules.forEach(module => {
                    const option = document.createElement('option');
                    option.value = module._id; // Use MongoDB _id
                    option.dataset.moduleNumber = module.moduleNumber;
                    option.textContent = `Module ${module.moduleNumber}: ${module.title}`;
                    moduleSelector.appendChild(option);
                });
                
                // Add event listener for module selection
                moduleSelector.addEventListener('change', loadLessonsForSelectedModule);
                
            } catch (error) {
                console.error('‚ùå Error loading modules:', error);
                const moduleSelector = document.getElementById('module-selector');
                moduleSelector.innerHTML = '<option value="">Error loading modules</option>';
            }
        }

        // Load lessons when a module is selected
        async function loadLessonsForSelectedModule() {
            const moduleSelector = document.getElementById('module-selector');
            const lessonSelector = document.getElementById('lesson-selector');
            const moduleId = moduleSelector.value;
            
            if (!moduleId) {
                lessonSelector.innerHTML = '<option value="">Select a module first</option>';
                return;
            }
            
            try {
                console.log(`üîç Loading lessons for module: ${moduleId}`);
                const response = await fetch(`/api/modules/${moduleId}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch lessons: ${response.status}`);
                }
                
                const moduleData = await response.json();
                const lessons = moduleData.lessons || [];
                
                lessonSelector.innerHTML = '<option value="">Choose a lesson...</option>';
                
                // Sort lessons by lessonNumber and populate selector
                lessons.sort((a, b) => a.lessonNumber - b.lessonNumber);
                lessons.forEach(lesson => {
                    const option = document.createElement('option');
                    option.value = lesson.lessonNumber;
                    option.textContent = `Lesson ${lesson.lessonNumber}: ${lesson.title}`;
                    lessonSelector.appendChild(option);
                });
                
                console.log(`üìñ Loaded ${lessons.length} lessons for this module`);
                
            } catch (error) {
                console.error('‚ùå Error loading lessons:', error);
                lessonSelector.innerHTML = '<option value="">Error loading lessons</option>';
            }
        }

        // Load the selected lesson
        function loadSelectedLesson() {
            const moduleSelector = document.getElementById('module-selector');
            const lessonSelector = document.getElementById('lesson-selector');
            
            const moduleId = moduleSelector.value;
            const moduleNumber = parseInt(moduleSelector.options[moduleSelector.selectedIndex]?.dataset?.moduleNumber);
            const lessonNumber = parseInt(lessonSelector.value);
            
            if (!moduleId || !moduleNumber || !lessonNumber) {
                alert('Please select both a module and a lesson first.');
                return;
            }
            
            console.log(`üéØ Loading selected lesson: Module ${moduleNumber}, Lesson ${lessonNumber}`);
            
            // Update URL to reflect selection (optional)
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('module', moduleNumber);
            newUrl.searchParams.set('lesson', lessonNumber);
            window.history.replaceState({}, '', newUrl);
            
            // Load the lesson data
            fetchLessonData(moduleNumber, lessonNumber);
        }

        // Load current lesson data from URL parameters or localStorage
        function loadCurrentLessonData() {
            try {
                // Try to get data from URL parameters first
                const urlParams = new URLSearchParams(window.location.search);
                const moduleNum = urlParams.get('module');
                const lessonNum = urlParams.get('lesson');

                if (moduleNum && lessonNum) {
                    // Validate and clean the parameters
                    const cleanModuleNum = parseInt(moduleNum);
                    let cleanLessonNum = lessonNum;
                    
                    // Check if lessonNum looks like a MongoDB ObjectId (24 hex characters)
                    if (/^[0-9a-fA-F]{24}$/.test(lessonNum)) {
                        console.log(`‚ö†Ô∏è Detected ObjectId-like lesson parameter: ${lessonNum}`);
                        console.log('ÔøΩ Converting to sequential lesson number based on module');
                        
                        // For now, default to lesson 1 since we don't have a mapping
                        cleanLessonNum = 1;
                        console.log(`üìù Using lesson number: ${cleanLessonNum}`);
                    } else {
                        cleanLessonNum = parseInt(lessonNum) || 1;
                    }
                    
                    if (isNaN(cleanModuleNum) || cleanModuleNum <= 0) {
                        console.error(`‚ùå Invalid module number: ${moduleNum}`);
                        displayErrorData();
                        return;
                    }
                    
                    console.log(`ÔøΩüîç Loading lesson data for Module ${cleanModuleNum}, Lesson ${cleanLessonNum}`);
                    // Fetch lesson data from the main system
                    fetchLessonData(cleanModuleNum, cleanLessonNum);
                } else {
                    // Fall back to localStorage or default
                    const savedLesson = localStorage.getItem('currentAILessonData');
                    if (savedLesson) {
                        console.log('üì± Loading lesson data from localStorage');
                        currentLessonData = JSON.parse(savedLesson);
                        window.currentLessonData = currentLessonData;
                        displayLessonData();
                    } else {
                        // Default placeholder data
                        console.log('‚ö†Ô∏è No lesson data found, showing placeholder');
                        displayPlaceholderData();
                    }
                }
            } catch (error) {
                console.error('‚ùå Error loading lesson data:', error);
                displayPlaceholderData();
            }
        }

        // Fetch lesson data from the server using the SAME approach as your main curriculum system
        async function fetchLessonData(moduleNum, lessonNum) {
            try {
                console.log(`üåê Fetching modules to find Module ${moduleNum}...`);
                
                // Step 1: Get all modules (like your main curriculum-maps.html does)
                const modulesResponse = await fetch('/api/modules');
                if (!modulesResponse.ok) {
                    throw new Error(`Failed to fetch modules: ${modulesResponse.status}`);
                }
                
                const modules = await modulesResponse.json();
                console.log(`üìö Found ${modules.length} modules in the system`);
                
                // Step 2: Find the specific module by moduleNumber
                const targetModule = modules.find(m => m.moduleNumber === moduleNum);
                if (!targetModule) {
                    throw new Error(`Module ${moduleNum} not found. Available modules: ${modules.map(m => m.moduleNumber).join(', ')}`);
                }
                
                console.log(`‚úÖ Found Module ${moduleNum}: ${targetModule.title}`);
                console.log(`üîç Module ID: ${targetModule._id}`);
                
                // Step 3: Get lessons for this module using the MongoDB _id (like your main system)
                const lessonsResponse = await fetch(`/api/modules/${targetModule._id}`);
                if (!lessonsResponse.ok) {
                    throw new Error(`Failed to fetch lessons for module: ${lessonsResponse.status}`);
                }
                
                const moduleData = await lessonsResponse.json();
                const lessons = moduleData.lessons || [];
                
                console.log(`üìñ Found ${lessons.length} lessons in Module ${moduleNum}`);
                
                // Step 4: Find the specific lesson by lessonNumber
                const targetLesson = lessons.find(l => l.lessonNumber === lessonNum);
                if (!targetLesson) {
                    // If specific lesson not found, use the first lesson as fallback
                    const fallbackLesson = lessons[0];
                    if (fallbackLesson) {
                        console.log(`‚ö†Ô∏è Lesson ${lessonNum} not found, using Lesson ${fallbackLesson.lessonNumber} as fallback`);
                        currentLessonData = formatLessonForAI(targetModule, fallbackLesson);
                        window.currentLessonData = currentLessonData;
                    } else {
                        throw new Error(`No lessons found in Module ${moduleNum}`);
                    }
                } else {
                    console.log(`‚úÖ Found Lesson ${lessonNum}: ${targetLesson.title}`);
                    currentLessonData = formatLessonForAI(targetModule, targetLesson);
                    window.currentLessonData = currentLessonData;
                }
                
                console.log('üìù Formatted lesson data for AI:', currentLessonData);
                displayLessonData();
                
                // Save for future use
                localStorage.setItem('currentAILessonData', JSON.stringify(currentLessonData));
                
            } catch (error) {
                console.error('‚ùå Error fetching lesson data:', error);
                
                // Try to use localStorage data as fallback
                const savedLesson = localStorage.getItem('currentAILessonData');
                if (savedLesson) {
                    console.log('üîÑ Using cached lesson data as fallback');
                    currentLessonData = JSON.parse(savedLesson);
                    window.currentLessonData = currentLessonData;
                    displayLessonData();
                    updateAPIStatus('warning', '‚ö†Ô∏è Using cached lesson data - some content may be outdated');
                } else {
                    // Show a helpful error message to the user
                    displayErrorData(error.message);
                }
            }
        }

        // Format lesson data from your MongoDB format to the AI planner format
        function formatLessonForAI(module, lesson) {
            // Debug: Log the actual lesson structure
            console.log('üîç Raw lesson data structure:', lesson);
            console.log('üîç Teacher content:', lesson.teacherContent);
            console.log('üîç Student content:', lesson.studentContent);
            console.log('üîç Vocabulary:', lesson.teacherContent?.vocabulary || lesson.vocabulary);
            
            return {
                moduleNumber: module.moduleNumber,
                moduleName: module.title,
                lessonNumber: lesson.lessonNumber,
                title: lesson.title,
                content: lesson.content || lesson.description || '',
                objectives: lesson.teacherContent?.objectives || lesson.objectives || [],
                materials: lesson.teacherContent?.materials || lesson.materials || [],
                procedures: lesson.teacherContent?.procedures || lesson.procedures || [],
                assessments: lesson.teacherContent?.assessments || lesson.assessments || [],
                vocabulary: lesson.teacherContent?.vocabulary || lesson.vocabulary || [],
                duration: lesson.duration || lesson.teacherContent?.duration || '45 minutes',
                // Include any additional content for richer AI generation
                studentContent: lesson.studentContent || {},
                teacherContent: lesson.teacherContent || {},
                geographicFocus: lesson.geographicFocus || '',
                standards: lesson.standards || [],
                concepts: lesson.concepts || []
            };
        }

        // Display lesson data in the interface
        function displayLessonData() {
            if (!currentLessonData) return;

            // Update lesson info
            document.getElementById('lesson-module').textContent = 
                `Module ${currentLessonData.moduleNumber}: ${currentLessonData.moduleName || 'Unknown Module'}`;
            document.getElementById('lesson-title').textContent = 
                `Lesson ${currentLessonData.lessonNumber}: ${currentLessonData.title || 'Unknown Lesson'}`;

            // Extract and display teacher content
            const teacherContent = extractTeacherContent(currentLessonData);
            document.getElementById('teacher-content').innerHTML = teacherContent;

            // Extract and display student content
            const studentContent = extractStudentContent(currentLessonData);
            document.getElementById('student-content').innerHTML = studentContent;

            updateAPIStatus('success', '‚úÖ Lesson content loaded successfully');
            
            // Re-check API status now that we have lesson data
            checkAPIStatus();
        }

        // Extract teacher-focused content from lesson data
        function extractTeacherContent(lessonData) {
            let content = '';
            
            // Handle both direct properties and nested teacherContent structure
            const teacherData = lessonData.teacherContent || lessonData;
            const studentData = lessonData.studentContent || {};
            
            // Learning Objectives - handle both array and string formats
            if (teacherData.objectives) {
                const objectives = Array.isArray(teacherData.objectives) ? teacherData.objectives : [teacherData.objectives];
                if (objectives.length > 0 && objectives[0]) {
                    content += '<h4>üìã Learning Objectives:</h4><ul>';
                    objectives.forEach(obj => {
                        if (obj) content += `<li>${obj}</li>`;
                    });
                    content += '</ul>';
                }
            }

            // Materials Needed - handle both array and string formats
            if (teacherData.materials) {
                const materials = Array.isArray(teacherData.materials) ? teacherData.materials : [teacherData.materials];
                if (materials.length > 0 && materials[0]) {
                    content += '<h4>üì¶ Materials Needed:</h4><ul>';
                    materials.forEach(material => {
                        if (material) content += `<li>${material}</li>`;
                    });
                    content += '</ul>';
                }
            }

            // Teacher Notes (often contains rich content)
            if (teacherData.notes) {
                content += `<h4>üìù Teacher Notes:</h4><div class="lesson-content">${teacherData.notes}</div>`;
            }

            // Lesson Procedures
            if (teacherData.procedures && teacherData.procedures.length > 0) {
                content += '<h4>üìù Lesson Procedures:</h4><ol>';
                teacherData.procedures.forEach(procedure => {
                    content += `<li>${procedure}</li>`;
                });
                content += '</ol>';
            }

            // Assessment Methods
            if (teacherData.assessments && teacherData.assessments.length > 0) {
                content += '<h4>üìä Assessment Methods:</h4><ul>';
                teacherData.assessments.forEach(assessment => {
                    content += `<li>${assessment}</li>`;
                });
                content += '</ul>';
            }

            // Extensions
            if (teacherData.extensions) {
                content += `<h4>üéØ Extensions:</h4><div class="lesson-content">${teacherData.extensions}</div>`;
            }

            // Extract vocabulary from student reading content if teacher vocabulary is empty
            if (teacherData.vocabulary && teacherData.vocabulary.length > 0) {
                content += '<h4>üìö Key Vocabulary:</h4><div class="vocabulary-list">';
                teacherData.vocabulary.forEach(term => {
                    // Handle different vocabulary formats
                    if (typeof term === 'string') {
                        content += `<div class="vocab-item"><strong>${term}</strong></div>`;
                    } else if (term && typeof term === 'object') {
                        const termName = term.term || term.word || term.name || term.title || '';
                        const termDef = term.definition || term.def || term.meaning || term.description || '';
                        
                        if (termName && termDef) {
                            content += `<div class="vocab-item"><strong>${termName}:</strong> ${termDef}</div>`;
                        } else if (termName) {
                            content += `<div class="vocab-item"><strong>${termName}</strong></div>`;
                        }
                    }
                });
                content += '</div>';
            } else if (studentData.readings) {
                // Extract vocabulary from student readings if no explicit vocabulary
                // Make sure readings is a string before calling .match()
                const readingsText = typeof studentData.readings === 'string' ? studentData.readings : '';
                if (readingsText) {
                    const vocabMatches = readingsText.match(/\*\*([^*]+)\*\*/g);
                    if (vocabMatches && vocabMatches.length > 0) {
                        content += '<h4>üìö Key Terms (from reading):</h4><div class="vocabulary-list">';
                        vocabMatches.slice(0, 10).forEach(match => { // Limit to first 10 terms
                            const term = match.replace(/\*\*/g, '');
                            if (term.length > 2 && term.length < 50) { // Reasonable term length
                                content += `<div class="vocab-item"><strong>${term}</strong></div>`;
                            }
                        });
                        content += '</div>';
                    }
                }
            }

            return content || '<p>No detailed teacher content available</p>';
        }

        // Extract student reading content from lesson data
        function extractStudentContent(lessonData) {
            let content = '';

            // Try multiple sources for student content
            const studentData = lessonData.studentContent || {};
            const teacherData = lessonData.teacherContent || lessonData;

            // 1. Check for student readings (THIS IS THE KEY FIELD!)
            if (studentData.readings) {
                // Handle different reading formats - could be string, object, or array
                let readingContent = '';
                
                if (typeof studentData.readings === 'string') {
                    readingContent = studentData.readings;
                } else if (typeof studentData.readings === 'object') {
                    // If it's an object, try to extract content from common properties
                    readingContent = studentData.readings.content || 
                                   studentData.readings.text || 
                                   studentData.readings.reading || 
                                   JSON.stringify(studentData.readings, null, 2);
                } else {
                    readingContent = String(studentData.readings);
                }
                
                if (readingContent) {
                    content += `<h4>üìñ Student Reading:</h4><div class="lesson-content">${readingContent}</div>`;
                }
            }
            
            // 2. Check for dedicated student content
            else if (studentData.content) {
                content += `<h4>üìñ Student Reading:</h4><div class="lesson-content">${studentData.content}</div>`;
            }
            
            // 3. Use the main lesson content if no dedicated student content
            else if (lessonData.content) {
                content += `<h4>üìñ Lesson Content:</h4><div class="lesson-content">${lessonData.content}</div>`;
            }
            
            // 4. Try to extract content from description
            else if (lessonData.description) {
                content += `<h4>üìñ Lesson Overview:</h4><div class="lesson-content">${lessonData.description}</div>`;
            }

            // Add student activities if available
            if (studentData.activities) {
                content += `<h4>üéØ Student Activities:</h4><div class="lesson-content">${studentData.activities}</div>`;
            }

            // Add worksheets if available
            if (studentData.worksheets) {
                content += `<h4>üìã Worksheets:</h4><div class="lesson-content">${studentData.worksheets}</div>`;
            }

            // Add assignments if available
            if (studentData.assignments) {
                content += `<h4>ÔøΩ Assignments:</h4><div class="lesson-content">${studentData.assignments}</div>`;
            }

            // Check for geographic focus
            if (lessonData.geographicFocus) {
                content += `<h4>üåç Geographic Focus:</h4><p>${lessonData.geographicFocus}</p>`;
            }

            // Add vocabulary for student reference - Handle multiple formats
            if (teacherData.vocabulary && teacherData.vocabulary.length > 0) {
                content += '<h4>üìö Key Terms to Know:</h4><div class="vocabulary-list">';
                teacherData.vocabulary.forEach(term => {
                    // Handle different vocabulary formats
                    if (typeof term === 'string') {
                        // Simple string format
                        content += `<div class="vocab-item"><strong>${term}</strong></div>`;
                    } else if (term && typeof term === 'object') {
                        // Object format - check various property names
                        const termName = term.term || term.word || term.name || term.title || '';
                        const termDef = term.definition || term.def || term.meaning || term.description || '';
                        
                        if (termName && termDef) {
                            content += `<div class="vocab-item"><strong>${termName}:</strong> ${termDef}</div>`;
                        } else if (termName) {
                            content += `<div class="vocab-item"><strong>${termName}</strong></div>`;
                        } else {
                            // If object has other properties, try to display them
                            const keys = Object.keys(term);
                            if (keys.length > 0) {
                                const key = keys[0];
                                const value = term[key];
                                if (value && value !== 'undefined') {
                                    content += `<div class="vocab-item"><strong>${key}:</strong> ${value}</div>`;
                                }
                            }
                        }
                    }
                });
                content += '</div>';
            }

            // If still no content, try to extract from any HTML structure
            if (!content && lessonData.content) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = lessonData.content;
                
                // Get main content sections
                const bigIdea = tempDiv.querySelector('.big-idea, [class*="big-idea"]');
                if (bigIdea) {
                    content += '<h4>The Big Idea:</h4>' + bigIdea.innerHTML;
                }

                const mainIdeas = tempDiv.querySelector('.main-ideas, [class*="main-ideas"]');
                if (mainIdeas) {
                    content += '<h4>Main Ideas:</h4>' + mainIdeas.innerHTML;
                }

                const keyTerms = tempDiv.querySelector('.key-terms, [class*="key-terms"]');
                if (keyTerms) {
                    content += '<h4>Key Terms and Places:</h4>' + keyTerms.innerHTML;
                }

                // If no specific sections found, use the whole content
                if (!content) {
                    content = tempDiv.textContent.substring(0, 1000) + (tempDiv.textContent.length > 1000 ? '...' : '');
                }
            }

            return content || '<p>No student reading content available</p>';
        }

        // Display placeholder data when no lesson is loaded
        function displayPlaceholderData() {
            document.getElementById('lesson-module').textContent = 'No module selected';
            document.getElementById('lesson-title').textContent = 'Please select a lesson from the main companion';
            document.getElementById('teacher-content').innerHTML = 
                '<p style="color: #6c757d;">Teacher guide content will appear here when a lesson is selected.</p>';
            document.getElementById('student-content').innerHTML = 
                '<p style="color: #6c757d;">Student reading content will appear here when a lesson is selected.</p>';
            
            updateAPIStatus('warning', '‚ö†Ô∏è No lesson selected. Please go back and select a lesson first.');
            setGenerationButtonsEnabled(false);
        }

        // Display error data
        function displayErrorData(customMessage = null) {
            const errorMessage = customMessage || 'Error loading lesson data. Please try again.';
            
            document.getElementById('lesson-module').textContent = 'Error';
            document.getElementById('lesson-title').textContent = 'Failed to Load Lesson';
            document.getElementById('teacher-content').innerHTML = 
                `<div style="color: #dc3545; padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px;">
                    <h4>‚ùå Error Loading Lesson Data</h4>
                    <p>${errorMessage}</p>
                    <p style="margin-top: 10px; font-size: 0.9em;">
                        <strong>Suggestions:</strong><br>
                        ‚Ä¢ Try going back and selecting a different lesson<br>
                        ‚Ä¢ Use Module 1, Lesson 1 or Module 2, Lesson 1 which have sample data<br>
                        ‚Ä¢ Contact your administrator if this problem persists
                    </p>
                </div>`;
            document.getElementById('student-content').innerHTML = 
                '<p style="color: #6c757d;">Student content not available due to loading error.</p>';
            
            updateAPIStatus('error', `‚ùå ${errorMessage}`);
            document.getElementById('generate-btn').disabled = true;
        }

        // Load user settings from localStorage
        function loadUserSettings() {
            const savedAPIKey = localStorage.getItem('openai_api_key');
            if (savedAPIKey) {
                document.getElementById('api-key').value = savedAPIKey;
            }

            const savedModel = localStorage.getItem('preferred_ai_model');
            if (savedModel) {
                document.getElementById('ai-model').value = savedModel;
            }

            const savedFocus = localStorage.getItem('preferred_lesson_focus');
            if (savedFocus) {
                document.getElementById('lesson-focus').value = savedFocus;
            }
        }

        // Save user settings to localStorage
        function saveUserSettings() {
            const apiKey = document.getElementById('api-key').value;
            if (apiKey) {
                localStorage.setItem('openai_api_key', apiKey);
            }

            localStorage.setItem('preferred_ai_model', document.getElementById('ai-model').value);
            localStorage.setItem('preferred_lesson_focus', document.getElementById('lesson-focus').value);
        }

        // Check API status and update UI
        function checkAPIStatus() {
            // First check if we have an API key from Railway environment
            fetch('/api/openai-key-status')
                .then(response => response.json())
                .then(data => {
                    if (data.hasKey) {
                        // Check if we have lesson data before enabling
                        if (currentLessonData) {
                            updateAPIStatus('success', '‚úÖ Using OpenAI API key from server environment');
                            setGenerationButtonsEnabled(true);
                        } else {
                            updateAPIStatus('warning', '‚ö†Ô∏è Server API key available, waiting for lesson content...');
                            setGenerationButtonsEnabled(false);
                        }
                        // Hide the API key input section since we're using server key
                        const apiKeyGroup = document.getElementById('api-key').closest('.control-group');
                        if (apiKeyGroup) {
                            apiKeyGroup.style.display = 'none';
                        }
                        return;
                    } else {
                        // Fall back to local API key
                        checkLocalAPIKey();
                    }
                })
                .catch(error => {
                    console.log('No server API key available, checking local key');
                    checkLocalAPIKey();
                });
        }

        // Helper function to enable/disable generation buttons
        function setGenerationButtonsEnabled(enabled) {
            document.getElementById('generate-btn').disabled = !enabled;
            document.getElementById('condensed-reading-btn').disabled = !enabled;
            document.getElementById('integrated-lesson-btn').disabled = !enabled;
        }

        function checkLocalAPIKey() {
            const apiKey = document.getElementById('api-key').value;
            
            // If no lesson data, disable regardless of API key
            if (!currentLessonData) {
                updateAPIStatus('warning', '‚ö†Ô∏è No lesson content loaded');
                setGenerationButtonsEnabled(false);
                return;
            }
            
            if (!apiKey) {
                updateAPIStatus('warning', '‚ö†Ô∏è Please enter your OpenAI API key in Advanced Settings');
                setGenerationButtonsEnabled(false);
                return;
            }

            if (!apiKey.startsWith('sk-')) {
                updateAPIStatus('error', '‚ùå Invalid API key format. Should start with "sk-"');
                setGenerationButtonsEnabled(false);
                return;
            }

            updateAPIStatus('success', '‚úÖ Ready to generate lesson plan and reading materials');
            setGenerationButtonsEnabled(true);
        }

        // Update API status display
        function updateAPIStatus(type, message) {
            const statusElement = document.getElementById('api-status');
            statusElement.className = 'api-status';
            statusElement.classList.add(type + '-status');
            statusElement.textContent = message;
        }

        // Toggle advanced settings
        function toggleAdvancedSettings() {
            const content = document.getElementById('advanced-content');
            content.classList.toggle('show');
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
                button.style.background = '#6c757d';
            });

            // Show selected tab content
            const selectedContent = document.getElementById(tabName + '-content');
            if (selectedContent) {
                selectedContent.style.display = 'block';
                selectedContent.classList.add('active');
            }

            // Activate selected tab button with appropriate color
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
                if (tabName === 'integrated-lesson') {
                    selectedTab.style.background = '#ff6b6b';
                } else if (tabName === 'lesson-plan') {
                    selectedTab.style.background = '#007bff';
                } else if (tabName === 'condensed-reading') {
                    selectedTab.style.background = '#28a745';
                }
            }
        }

        // Toggle reading options visibility
        function toggleReadingOptions() {
            const options = document.getElementById('reading-options');
            const isVisible = options.style.display !== 'none';
            options.style.display = isVisible ? 'none' : 'block';
        }

        // Generate condensed reading function
        async function generateCondensedReading() {
            console.log('üìö Starting condensed reading generation...');
            
            if (!currentLessonData) {
                alert('Please select a lesson first by going back to the lesson companion.');
                return;
            }

            console.log('üìñ Current lesson data for reading:', currentLessonData);

            // Show reading options first time
            const options = document.getElementById('reading-options');
            if (options.style.display === 'none' || !options.style.display) {
                options.style.display = 'block';
                return;
            }

            // Save user settings
            saveUserSettings();

            // Switch to reading tab
            switchTab('condensed-reading');

            // Show loading state
            document.getElementById('reading-loading').style.display = 'block';
            document.getElementById('condensed-reading-output').innerHTML = '';
            document.getElementById('reading-export-buttons').style.display = 'none';

            // Disable button and show loading
            document.getElementById('condensed-reading-btn').disabled = true;
            document.getElementById('condensed-reading-btn').textContent = 'üìñ Generating Reading...';

            try {
                const prompt = buildCondensedReadingPrompt();
                console.log('üìù Built condensed reading prompt, length:', prompt.length);

                const generatedReading = await callOpenAIAPI(prompt);
                console.log('‚úÖ Received condensed reading from AI');

                // Hide loading
                document.getElementById('reading-loading').style.display = 'none';

                // Display the generated reading
                displayGeneratedCondensedReading(generatedReading);

            } catch (error) {
                console.error('‚ùå Error generating condensed reading:', error);
                document.getElementById('reading-loading').style.display = 'none';
                
                document.getElementById('condensed-reading-output').innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 20px; border-radius: 8px; margin: 20px;">
                        <h3>‚ùå Error Generating Reading</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Please check your API settings and try again.</p>
                    </div>
                `;
            } finally {
                // Re-enable button
                document.getElementById('condensed-reading-btn').disabled = false;
                document.getElementById('condensed-reading-btn').textContent = 'üìö Generate Condensed Student Reading';
            }
        }

        // Build the condensed reading prompt
        function buildCondensedReadingPrompt() {
            const complexity = document.getElementById('reading-complexity').value;
            const length = document.getElementById('reading-length').value;
            const focus = document.getElementById('reading-focus').value;
            const includeSupports = document.getElementById('include-supports').checked;
            const includeAssessment = document.getElementById('include-assessment').checked;

            const teacherContent = document.getElementById('teacher-content').textContent;
            const studentContent = document.getElementById('student-content').textContent;

            const focusDescriptions = {
                'balanced': 'balanced overview with equal attention to all aspects',
                'geographic': 'geographic emphasis with spatial thinking and environmental factors',
                'cultural': 'cultural emphasis with social structures and traditions',
                'historical': 'historical emphasis with chronology and cause-effect relationships',
                'environmental': 'environmental emphasis with human-environment interactions'
            };

            const lengthSpecs = {
                'condensed': '4-5 paragraphs, 150-200 words each',
                'comprehensive': '6-8 paragraphs, 175-225 words each',
                'detailed': '8-10 paragraphs, 200-250 words each'
            };

            return `# üìö SOPHISTICATED CONDENSED READING GENERATOR

You are an expert educational content developer tasked with creating high-quality, curriculum-independent student reading materials. This reading must demonstrate educational sophistication while being accessible and engaging for 7th-grade students.

## üìñ SOURCE MATERIALS ANALYSIS

**LESSON CONTEXT:** Module ${currentLessonData.moduleNumber} - ${currentLessonData.title}
**READING FOCUS:** ${focusDescriptions[focus]}
**TARGET LENGTH:** ${lengthSpecs[length]}
**COMPLEXITY LEVEL:** ${complexity}

**TEACHER GUIDE CONTENT:**
${teacherContent || 'No teacher guide provided'}

**STUDENT CONTENT:**
${studentContent || 'No student content provided'}

**CORE VOCABULARY:** ${currentLessonData.vocabulary ? currentLessonData.vocabulary.map(v => v.term).join(', ') : 'None provided'}

---

## üéØ CONDENSED READING GENERATION REQUIREMENTS

### 1. SOURCE MATERIAL ANALYSIS PROTOCOL
‚Ä¢ **Identify main topics/themes** from source reading (3-7 major concepts)
‚Ä¢ **Extract chronological or logical sequence** of information flow
‚Ä¢ **Determine essential facts, dates, names, and concepts** that cannot be omitted
‚Ä¢ **Locate specific examples and evidence** that support main ideas
‚Ä¢ **Assess content volume** for optimal condensation ratio

### 2. CONDENSATION STRUCTURE REQUIREMENTS
‚Ä¢ **Generate exactly ${length === 'condensed' ? '4-5' : length === 'comprehensive' ? '6-8' : '8-10'} paragraphs** from source material
‚Ä¢ **Organize paragraphs logically:** Foundation/Background ‚Üí Geographic/Contextual Factors ‚Üí Peak/Main Characteristics ‚Üí Achievements/Innovations ‚Üí Decline/Change/Legacy
‚Ä¢ **Maintain factual accuracy** while eliminating redundancy
‚Ä¢ **Preserve discipline-specific vocabulary** and key terminology
‚Ä¢ **Include concrete examples and evidence** for engagement
‚Ä¢ **Create smooth transitions** showing relationships between concepts

### 3. PARAGRAPH DEVELOPMENT FRAMEWORK

**Paragraph 1 - Foundation/Background**
‚Ä¢ Establish context (time, place, circumstances)
‚Ä¢ Introduce main subject/civilization/concept/process
‚Ä¢ Include key foundational elements or early developments
‚Ä¢ Provide essential background knowledge
‚Ä¢ End with transition to development

**Subsequent Paragraphs** (adapt based on ${focus} focus):
‚Ä¢ Geographic factors and environmental influences
‚Ä¢ Peak period characteristics and achievements
‚Ä¢ Innovations, contributions, and significance
‚Ä¢ Changes, challenges, and lasting impact

### 4. CONTENT PRESERVATION GUIDELINES
‚Ä¢ **Maintain all proper nouns** (names, places, terms)
‚Ä¢ **Preserve specific dates, numbers, measurements**
‚Ä¢ **Include quoted material or key phrases**
‚Ä¢ **Retain cause-and-effect relationships**
‚Ä¢ **Keep comparative information** for scale and significance
‚Ä¢ **Preserve cultural sensitivity** and appropriate terminology

### 5. READING LEVEL ADAPTATION
${complexity === 'simplified' ? `
**SIMPLIFIED VERSION REQUIREMENTS:**
‚Ä¢ Use vocabulary 2 grade levels below target
‚Ä¢ Create shorter, clearer sentences
‚Ä¢ Provide context clues and embedded definitions
‚Ä¢ Include parenthetical explanations for technical terms
‚Ä¢ Maintain identical core content with linguistic simplification
` : complexity === 'advanced' ? `
**ADVANCED VERSION REQUIREMENTS:**
‚Ä¢ Use vocabulary 1 grade level above target
‚Ä¢ Include complex sentence structures
‚Ä¢ Add supplementary details and connections
‚Ä¢ Provide extended examples and analysis
‚Ä¢ Include connections to broader implications
` : `
**STANDARD VERSION REQUIREMENTS:**
‚Ä¢ Use grade-appropriate vocabulary and sentence structure
‚Ä¢ Balance complexity with accessibility
‚Ä¢ Include context clues for new terminology
‚Ä¢ Maintain engaging but clear presentation
`}

${includeSupports ? `
### 6. COMPREHENSION SUPPORT FEATURES
‚Ä¢ **Add descriptive paragraph headers** previewing main content
‚Ä¢ **Bold key vocabulary terms** from lesson objectives
‚Ä¢ **Include pronunciation guides** for unfamiliar names and terms
‚Ä¢ **Generate "Before Reading" activation questions**
‚Ä¢ **Include "During Reading" comprehension checkpoints** after each paragraph
‚Ä¢ **Create "After Reading" synthesis prompts**
‚Ä¢ **Add connection prompts** linking to contemporary issues
` : ''}

${includeAssessment ? `
### 7. ASSESSMENT INTEGRATION
‚Ä¢ **Number all paragraphs and key sentences** for easy reference
‚Ä¢ **Include margin annotations** connecting to lesson activities
‚Ä¢ **Provide text-marking guides** with symbols for different information types
‚Ä¢ **Add "Evidence Hunt" prompts** directing to supporting details
‚Ä¢ **Include discussion question stems** requiring textual evidence
‚Ä¢ **Create vocabulary-in-context exercises** using reading sentences
` : ''}

---

## üìã REQUIRED READING FORMAT

# üìñ STUDENT READING: ${currentLessonData.title}

**Module ${currentLessonData.moduleNumber} | 7th Grade Geography | ${complexity.charAt(0).toUpperCase() + complexity.slice(1)} Level**

---

${includeSupports ? `
## üéØ BEFORE READING
**Activation Questions:**
1. [Question connecting to prior knowledge]
2. [Question about geographic thinking]
3. [Question about cultural connections]

**Key Vocabulary Preview:** [List 5-8 essential terms with pronunciation]

---
` : ''}

## üìö MAIN READING

### [Paragraph 1 Header] (${focus === 'geographic' ? 'Geographic Foundation' : focus === 'cultural' ? 'Cultural Background' : focus === 'historical' ? 'Historical Context' : focus === 'environmental' ? 'Environmental Setting' : 'Background and Setting'})

[Comprehensive paragraph establishing foundation - ${lengthSpecs[length].split(',')[1]}]

${includeSupports ? '[During Reading Question: Specific comprehension check]' : ''}

### [Paragraph 2 Header] (Geographic and Environmental Factors)

[Detailed paragraph on environmental influences - ${lengthSpecs[length].split(',')[1]}]

${includeSupports ? '[During Reading Question: Cause-effect analysis]' : ''}

### [Continue for all paragraphs...]

${includeAssessment ? `
---

## üîç TEXT-DEPENDENT QUESTIONS

**Paragraph-Specific Questions:**
1. [Question requiring citation from paragraph 1]
2. [Question requiring synthesis across paragraphs 2-3]
3. [Question requiring interpretation with evidence]

**Synthesis Questions:**
1. [Question requiring cross-paragraph analysis]
2. [Question connecting to contemporary issues]

**Evidence Practice:**
‚Ä¢ Find and cite three examples of [specific concept]
‚Ä¢ Compare information from paragraphs [X] and [Y]
‚Ä¢ Use evidence from the reading to support the claim that...
` : ''}

${includeSupports ? `
---

## üí° AFTER READING

**Comprehension Check:**
‚Ä¢ Summarize each paragraph in one sentence
‚Ä¢ Identify the main cause-and-effect relationships
‚Ä¢ Connect three concepts from the reading to modern examples

**Discussion Starters:**
‚Ä¢ How does this information help us understand...?
‚Ä¢ What connections can you make between this and...?
‚Ä¢ Why might this be important for understanding today's world?
` : ''}

---

**CONTENT SOPHISTICATION REQUIREMENT:** This condensed reading must demonstrate thorough analysis of source materials and maintain academic rigor while being accessible to 7th-grade students. Every paragraph should connect directly to lesson objectives and provide rich content for follow-up activities.

Create a reading that eliminates textbook dependency while maintaining educational sophistication and supporting diverse learning needs through ${complexity} complexity level and ${focus} focus.`;
        }

        // Display the generated condensed reading
        function displayGeneratedCondensedReading(reading) {
            const formattedReading = formatCondensedReading(reading);
            document.getElementById('condensed-reading-output').innerHTML = formattedReading;
            document.getElementById('reading-export-buttons').style.display = 'flex';
        }

        // Format the condensed reading with proper HTML structure
        function formatCondensedReading(readingText) {
            let formatted = readingText.replace(/\n/g, '<br>');
            
            // Format headers
            formatted = formatted.replace(/### (.*?)<br>/g, '<h3 style="color: #007bff; margin: 20px 0 10px 0; font-size: 1.3rem;">$1</h3>');
            formatted = formatted.replace(/## (.*?)<br>/g, '<h2 style="color: #495057; margin: 25px 0 15px 0; font-size: 1.5rem;">$1</h2>');
            formatted = formatted.replace(/# (.*?)<br>/g, '<h1 style="color: #007bff; margin: 30px 0 20px 0; font-size: 1.8rem; text-align: center; border-bottom: 2px solid #007bff; padding-bottom: 10px;">$1</h1>');
            
            // Format bold text
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong style="color: #495057;">$1</strong>');
            
            // Format bullet points
            formatted = formatted.replace(/(^|\<br\>)‚Ä¢ /g, '$1<span style="color: #007bff;">‚Ä¢</span> ');
            
            // Format numbered lists
            formatted = formatted.replace(/(^|\<br\>)(\d+\.) /g, '$1<span style="color: #007bff; font-weight: bold;">$2</span> ');
            
            // Wrap in proper structure
            return `
                <div class="condensed-reading-content" style="max-width: 800px; margin: 0 auto; line-height: 1.8; font-size: 1.1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #28a745;">
                        <h2 style="color: #28a745; margin: 0;">üìö Generated Student Reading</h2>
                        <span style="background: #d4edda; padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; color: #155724; font-weight: bold;">
                            Curriculum Independent
                        </span>
                    </div>
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; border-left: 4px solid #28a745;">
                        ${formatted}
                    </div>
                </div>
            `;
        }

        // Export functions for condensed reading
        function printCondensedReading() {
            const content = document.getElementById('condensed-reading-output').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head><title>Student Reading - ${currentLessonData.title}</title></head>
                <body style="font-family: Arial, sans-serif; margin: 20px;">
                    ${content}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function copyCondensedReading() {
            const content = document.getElementById('condensed-reading-output').innerText;
            navigator.clipboard.writeText(content).then(() => {
                alert('üìã Student reading copied to clipboard!');
            });
        }

        function saveCondensedReading() {
            const content = document.getElementById('condensed-reading-output').innerHTML;
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `student-reading-${currentLessonData.title.replace(/\s+/g, '-').toLowerCase()}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Generate complete integrated lesson function
        async function generateIntegratedLesson() {
            console.log('üéØ Starting integrated lesson generation...');
            
            if (!currentLessonData) {
                alert('Please select a lesson first by going back to the lesson companion.');
                return;
            }

            console.log('üìö Current lesson data for integrated lesson:', currentLessonData);

            // Save user settings
            saveUserSettings();

            // Switch to integrated lesson tab
            switchTab('integrated-lesson');

            // Show loading state
            document.getElementById('integrated-loading').style.display = 'block';
            document.getElementById('integrated-lesson-output').innerHTML = '';
            document.getElementById('integrated-export-buttons').style.display = 'none';

            // Disable button and show loading
            document.getElementById('integrated-lesson-btn').disabled = true;
            document.getElementById('integrated-lesson-btn').innerHTML = `
                üîß Generating Complete Lesson...
                <div style="font-size: 0.9rem; margin-top: 5px; opacity: 0.9;">
                    Building reading + lesson + handouts
                </div>
            `;

            try {
                const prompt = buildIntegratedLessonPrompt();
                console.log('üìù Built integrated lesson prompt, length:', prompt.length);

                const generatedLesson = await callOpenAIAPI(prompt);
                console.log('‚úÖ Received integrated lesson from AI');
                
                // Validate the response
                if (!generatedLesson || typeof generatedLesson !== 'string') {
                    throw new Error('Invalid response from AI - no content received');
                }
                
                if (generatedLesson.length < 100) {
                    throw new Error('AI response too short - may be incomplete');
                }

                // Hide loading
                document.getElementById('integrated-loading').style.display = 'none';

                // Display the generated integrated lesson
                displayGeneratedIntegratedLesson(generatedLesson);

            } catch (error) {
                console.error('‚ùå Error generating integrated lesson:', error);
                document.getElementById('integrated-loading').style.display = 'none';
                
                document.getElementById('integrated-lesson-output').innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 20px; border-radius: 8px; margin: 20px;">
                        <h3>‚ùå Error Generating Integrated Lesson</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Please check your API settings and try again.</p>
                    </div>
                `;
            } finally {
                // Re-enable button
                document.getElementById('integrated-lesson-btn').disabled = false;
                document.getElementById('integrated-lesson-btn').innerHTML = `
                    üéØ Generate Complete Integrated Lesson
                    <div style="font-size: 0.9rem; margin-top: 5px; opacity: 0.9;">
                        Reading + Lesson Plan + Handouts (One-Click Solution)
                    </div>
                `;
            }
        }

        // Build the integrated lesson prompt
        function buildIntegratedLessonPrompt() {
            const lessonFocus = document.getElementById('lesson-focus').value;
            const classSize = document.getElementById('class-size').value;
            const customInstructions = document.getElementById('custom-prompt').value;
            const complexity = document.getElementById('reading-complexity').value;
            const length = document.getElementById('reading-length').value;
            const focus = document.getElementById('reading-focus').value;
            const includeSupports = document.getElementById('include-supports').checked;
            const includeAssessment = document.getElementById('include-assessment').checked;

            const teacherContent = document.getElementById('teacher-content').textContent;
            const studentContent = document.getElementById('student-content').textContent;

            const focusDescriptions = {
                'balanced': 'balanced mix of instruction, discussion, and activities',
                'interactive': 'highly interactive with frequent student participation',
                'discussion': 'discussion-heavy with socratic questioning',
                'hands-on': 'hands-on activities and experiential learning',
                'assessment': 'assessment-focused with multiple check-ins',
                'technology': 'technology integration and digital tools'
            };

            const readingFocusDescriptions = {
                'balanced': 'balanced overview with equal attention to all aspects',
                'geographic': 'geographic emphasis with spatial thinking and environmental factors',
                'cultural': 'cultural emphasis with social structures and traditions',
                'historical': 'historical emphasis with chronology and cause-effect relationships',
                'environmental': 'environmental emphasis with human-environment interactions'
            };

            const lengthSpecs = {
                'condensed': '4-5 paragraphs, 150-200 words each',
                'comprehensive': '6-8 paragraphs, 175-225 words each',
                'detailed': '8-10 paragraphs, 200-250 words each'
            };

            return `# üéØ ONE-CLICK INTEGRATED LESSON GENERATOR

You are an expert educational content developer creating a complete, print-ready lesson package that eliminates all teacher preparation barriers. This integrated lesson must be immediately usable, professionally formatted, and curriculum-independent.

## üìö SOURCE MATERIALS AND CONTEXT

**LESSON CONTEXT:** Module ${currentLessonData.moduleNumber} - ${currentLessonData.title}
**CLASS SIZE:** ${classSize} students
**LESSON FOCUS:** ${focusDescriptions[lessonFocus]}
**READING FOCUS:** ${readingFocusDescriptions[focus]}
**READING LENGTH:** ${lengthSpecs[length]}
**COMPLEXITY LEVEL:** ${complexity}
${customInstructions ? `**SPECIAL INSTRUCTIONS:** ${customInstructions}` : ''}

**TEACHER GUIDE CONTENT:**
${teacherContent || 'No teacher guide provided'}

**STUDENT CONTENT:**
${studentContent || 'No student content provided'}

**CORE VOCABULARY:** ${currentLessonData.vocabulary ? currentLessonData.vocabulary.map(v => v.term).join(', ') : 'None provided'}

---

## üéØ COMPREHENSIVE LESSON COMPILATION PROTOCOL

### 1. DOCUMENT STRUCTURE INTEGRATION
‚Ä¢ **Create single, continuous document** flowing seamlessly from reading to activities
‚Ä¢ **Maintain consistent formatting** (fonts, spacing, headers, margins)
‚Ä¢ **Use clear section dividers** with visual breaks between components
‚Ä¢ **Include page numbers and section tabs** for navigation during instruction
‚Ä¢ **Ensure printer-friendly layout** (1-inch margins, 12pt minimum fonts)

### 2. READING-TO-LESSON TRANSITION FRAMEWORK
‚Ä¢ **Insert transition section** between reading and lesson plan including:
  - Reading Completion Checkpoint with quick comprehension questions
  - Vocabulary Review connecting reading terms to lesson activities
  - Activity Preview showing how reading content will be used
‚Ä¢ **Cross-reference all paragraph numbers** from reading in lesson activities
‚Ä¢ **Align reading annotations** with lesson activity requirements
‚Ä¢ **Create seamless vocabulary integration** using exact terms from reading

### 3. UNIFIED HEADER SYSTEM
‚Ä¢ **Standardize all headers** with lesson information:
  - 7th Grade Geography | Module ${currentLessonData.moduleNumber} | 50 Minutes | ${classSize} Students
  - ${currentLessonData.title}
  - Date line for teacher completion
‚Ä¢ **Include reading time estimates** in lesson timing breakdown
‚Ä¢ **Add "Materials Included" checklist** showing reading + handouts
‚Ä¢ **Create teacher preparation summary** covering both reading and activities

### 4. INTEGRATED STANDARDS AND OBJECTIVES
‚Ä¢ **Combine reading standards with content standards** in single objectives section
‚Ä¢ **Reference specific reading paragraphs** in each learning objective
‚Ä¢ **Align assessment criteria** to both reading comprehension and content mastery
‚Ä¢ **Include text-dependent question stems** connecting to lesson essential questions
‚Ä¢ **Cross-reference vocabulary tiers** with lesson activity requirements

### 5. SEAMLESS ACTIVITY INTEGRATION
‚Ä¢ **Modify lesson opening** to reference specific reading paragraphs for activation
‚Ä¢ **Insert reading time** into lesson pacing guide with paragraph breakdowns
‚Ä¢ **Align all lesson activities** to use evidence from the condensed reading
‚Ä¢ **Include reading citation requirements** in every activity description
‚Ä¢ **Add "Reading Connection" notes** in margins of lesson activities

### 6. UNIFIED HANDOUT GENERATION
‚Ä¢ **Combine all materials** into single printable packet:
  - Cover page with lesson information
  - Condensed reading (pages 2-X)
  - Lesson plan (pages X+1 to Y)
  - Student handouts (pages Y+1 to Z)
  - Answer keys (final pages)
‚Ä¢ **Include handout reference numbers** in lesson plan activities
‚Ä¢ **Create "Handout Distribution Guide"** showing when each page is used
‚Ä¢ **Add page tabs or section markers** for quick teacher reference

### 7. COMPREHENSIVE PACING INTEGRATION
‚Ä¢ **Create unified timing breakdown:**
  - Reading Time: X minutes (paragraph-by-paragraph breakdown)
  - Transition/Discussion: X minutes
  - Activity 1: X minutes (referencing reading paragraphs X-Y)
  - Activity 2: X minutes (referencing reading paragraphs Y-Z)
  - Assessment/Closure: X minutes
‚Ä¢ **Include reading comprehension checkpoints** within lesson timing
‚Ä¢ **Add flexible timing options** for different class periods (45, 50, 90 minutes)
‚Ä¢ **Provide "if running behind" modifications** maintaining reading integration

### 8. DIFFERENTIATION UNIFICATION
‚Ä¢ **Align reading levels** with lesson differentiation strategies
‚Ä¢ **Create tiered handout versions** matching reading complexity levels
‚Ä¢ **Include ELL supports** working across both reading and activities
‚Ä¢ **Generate special needs modifications** for both reading and lesson components
‚Ä¢ **Add advanced extension activities** deepening reading analysis

### 9. ASSESSMENT INTEGRATION PROTOCOL
‚Ä¢ **Combine reading comprehension** with content assessment in single rubrics
‚Ä¢ **Include text-dependent questions** throughout lesson activities
‚Ä¢ **Create unified exit tickets** assessing both reading understanding and content mastery
‚Ä¢ **Generate answer keys** referencing specific reading paragraphs
‚Ä¢ **Add formative assessment checkpoints** monitoring both reading and content comprehension

### 10. TEACHER IMPLEMENTATION GUIDE
‚Ä¢ **Create single preparation checklist** covering reading and lesson setup
‚Ä¢ **Include "First Time Teaching" notes** for managing reading + activities
‚Ä¢ **Add troubleshooting guide** for common reading/lesson integration issues
‚Ä¢ **Provide substitute teacher instructions** covering both components
‚Ä¢ **Include extension/homework options** building on reading content

### 11. PRINT-READY FORMATTING REQUIREMENTS
‚Ä¢ **Use clear section headers** with appropriate hierarchy (# ## ###)
‚Ä¢ **Include logical page breaks** between major sections:
  - Student Reading should start on new page
  - Lesson Plan should start on new page
  - Student Handouts should start on new page
  - Assessment Tools should start on new page
‚Ä¢ **Format timing guides as tables** with proper | column | formatting
‚Ä¢ **Structure content in paragraphs** avoiding overly long blocks
‚Ä¢ **Include paragraph numbers** for reading sections (Paragraph 1, Paragraph 2, etc.)
‚Ä¢ **Use consistent bullet point formatting** with ‚Ä¢ or - symbols
‚Ä¢ **Create clear sub-headings** to break up content visually

---

## üìã REQUIRED INTEGRATED LESSON FORMAT

Generate a CONCISE, professionally formatted lesson package following this EXACT structure:

# ${currentLessonData.title}
**Module ${currentLessonData.moduleNumber} | 7th Grade Geography | 50 Minutes | ${classSize} Students**

## ÔøΩ STUDENT READING (5-7 paragraphs max)
[Generate condensed reading with numbered paragraphs - NO introduction, just content]

## üéØ LESSON OBJECTIVES
1. [One clear objective with reading integration]
2. [One geographic analysis objective]
3. [One cultural/historical connection objective]

## ‚è∞ LESSON TIMELINE
| Time | Activity | Reading Reference |
|------|----------|-------------------|
| 0-5 min | Hook & Preview | Paragraph 1 |
| 5-20 min | Guided Reading | Paragraphs 1-7 |
| 20-25 min | Discussion | Text evidence |
| 25-40 min | Activity | Paragraphs 3-5 |
| 40-50 min | Assessment | All paragraphs |

## üöÄ LESSON ACTIVITIES
**Opening Hook:** [Brief description referencing paragraph 1]
**Reading Strategy:** [How students will read the content]
**Main Activity:** [One focused activity using reading evidence]
**Assessment:** [Exit ticket with text-dependent question]

## üìù STUDENT HANDOUT
[One focused handout requiring paragraph citations]

## ‚úÖ ANSWER KEY
[Brief answers with paragraph references]

---
**CRITICAL REQUIREMENTS:**
- Keep total length under 2 pages when printed
- Eliminate all repetitive content
- No verbose explanations
- Focus on actionable content only
- Include paragraph numbers for all reading references

**CONTENT SOPHISTICATION REQUIREMENT:** Generate a complete, concise lesson package that teachers can print and use immediately. Focus on practical classroom application, not theoretical frameworks.

Generate the lesson following the exact format above.`;
        }

        // Display the generated integrated lesson
        function displayGeneratedIntegratedLesson(lesson) {
            try {
                const formattedLesson = formatIntegratedLesson(lesson);
                document.getElementById('integrated-lesson-output').innerHTML = formattedLesson;
                document.getElementById('integrated-export-buttons').style.display = 'flex';
                
                // Add PowerPoint generation button
                addPowerPointButton();
                
            } catch (error) {
                console.error('‚ùå Error formatting integrated lesson:', error);
                // Fallback to simple display
                document.getElementById('integrated-lesson-output').innerHTML = `
                    <div style="padding: 20px; background: #fff; border-radius: 8px; line-height: 1.6;">
                        <h2 style="color: #ff6b6b; margin-bottom: 20px;">üéØ Complete Integrated Lesson Package</h2>
                        <div style="white-space: pre-wrap; font-family: 'Times New Roman', serif;">${lesson}</div>
                    </div>
                `;
                document.getElementById('integrated-export-buttons').style.display = 'flex';
            }
        }

        // Add PowerPoint generation functionality
        function addPowerPointButton() {
            const exportButtons = document.getElementById('integrated-export-buttons');
            
            // Check if PowerPoint button already exists
            if (!document.getElementById('powerpoint-btn')) {
                const powerpointBtn = document.createElement('button');
                powerpointBtn.id = 'powerpoint-btn';
                powerpointBtn.className = 'export-button';
                powerpointBtn.style.background = 'linear-gradient(135deg, #d16ba5, #c777b9)';
                powerpointBtn.innerHTML = 'ÔøΩ Generate Presentation';
                powerpointBtn.onclick = generatePowerPointPresentation;
                
                exportButtons.appendChild(powerpointBtn);
            }
        }

        // Get current lesson data for PowerPoint generation
        function getCurrentLessonData() {
            // First try the global variable
            if (window.currentLessonData) {
                console.log('üéØ Using window.currentLessonData:', window.currentLessonData);
                return window.currentLessonData;
            }
            
            // Second try the local variable
            if (typeof currentLessonData !== 'undefined' && currentLessonData) {
                console.log('üéØ Using local currentLessonData:', currentLessonData);
                return currentLessonData;
            }
            
            // Fallback: try to get from the displayed lesson info
            const moduleElement = document.querySelector('[data-module]');
            const lessonElement = document.querySelector('[data-lesson]');
            
            if (moduleElement && lessonElement) {
                console.log('üéØ Using DOM element data');
                return {
                    title: lessonElement.textContent || 'Selected Lesson',
                    moduleNumber: moduleElement.getAttribute('data-module') || '1',
                    moduleName: moduleElement.textContent || 'Geography Module'
                };
            }
            
            // Final fallback - generic data
            console.log('üéØ Using fallback data');
            return {
                title: 'Geography Lesson',
                moduleNumber: '1',
                moduleName: 'Geography Module'
            };
        }

        // Generate PowerPoint presentation
        async function generatePowerPointPresentation() {
            const button = document.getElementById('powerpoint-btn');
            button.innerHTML = 'üîÑ Creating Slides...';
            button.disabled = true;

            try {
                console.log('üé¨ Starting PowerPoint generation...');
                
                const currentLessonData = getCurrentLessonData();
                console.log('üìö Current lesson data:', currentLessonData);
                
                const presentationPrompt = buildPresentationPrompt(currentLessonData);
                console.log('üìù Presentation prompt built, length:', presentationPrompt.length);
                
                // Use the common API function
                const presentation = await callOpenAIAPI(presentationPrompt);
                console.log('‚úÖ Received presentation from AI');
                
                displayPowerPointPresentation(presentation);
                
                button.innerHTML = 'üé¨ Generate Presentation';
                button.disabled = false;

            } catch (error) {
                console.error('‚ùå Error generating presentation:', error);
                button.innerHTML = '‚ùå Error - Try Again';
                button.disabled = false;
                alert('Error generating presentation. Please check your API key and try again.');
            }
        }

        // Build presentation prompt
        function buildPresentationPrompt(lessonData) {
            // Get grade level safely with fallback
            const gradeLevelElement = document.getElementById('grade-level');
            const gradeLevel = gradeLevelElement ? gradeLevelElement.value : '7th Grade';
            
            return `Create a PowerPoint-style presentation for this geography lesson:

**LESSON TOPIC:** ${lessonData.title}
**MODULE:** ${lessonData.moduleNumber} - ${lessonData.moduleName}
**GRADE LEVEL:** ${gradeLevel}

**PRESENTATION REQUIREMENTS:**
- Create 8-12 slides maximum
- Each slide should have a clear title and 3-5 bullet points
- Include visual descriptions for images/maps that would enhance each slide
- Design for classroom projection and student engagement
- Include interactive discussion prompts
- End with assessment questions

**SLIDE STRUCTURE NEEDED:**
1. Title slide with lesson objectives
2. Hook/Engagement slide with compelling question or image
3. 4-6 content slides with key concepts
4. 1-2 activity slides with student engagement
5. 1 assessment slide with quick check questions
6. Closing slide with key takeaways

**FORMATTING:** Use this exact format for each slide:

---
## SLIDE [NUMBER]: [TITLE]

**Content:**
‚Ä¢ [Bullet point 1]
‚Ä¢ [Bullet point 2]
‚Ä¢ [Bullet point 3]

**Visual Suggestion:** [Description of map, image, or graphic that would enhance this slide]

**Teacher Notes:** [Brief speaking points or discussion prompts]
---

Create an engaging, classroom-ready presentation that brings this geography topic to life!`;
        }

        // Display PowerPoint presentation
        function displayPowerPointPresentation(presentation) {
            // Create presentation viewer
            const presentationHTML = `
                <div style="max-width: 1000px; margin: 20px auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center;">
                        <h2 style="margin: 0; font-size: 24px;">üé¨ PowerPoint Presentation Generated</h2>
                        <p style="margin: 10px 0 0 0; opacity: 0.9;">Ready for classroom use - copy to PowerPoint or present directly</p>
                    </div>
                    
                    <div style="padding: 30px; line-height: 1.6; font-family: Arial, sans-serif;">
                        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9ff; border-left: 4px solid #667eea; border-radius: 4px;">
                            <strong>üìã Instructions:</strong> Each slide is formatted for easy copying into PowerPoint. Visual suggestions are included for each slide to help you find appropriate images and graphics.
                        </div>
                        
                        <div style="white-space: pre-wrap; font-size: 14px; background: #fafafa; padding: 20px; border-radius: 8px; border: 1px solid #e1e5e9;">${presentation}</div>
                    </div>
                    
                    <div style="padding: 20px; background: #f8f9fa; border-top: 1px solid #e1e5e9; text-align: center;">
                        <button onclick="copyPresentationToClipboard()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin-right: 10px; font-weight: bold;">
                            üìã Copy All Slides
                        </button>
                        <button onclick="printPresentation()" style="background: linear-gradient(135deg, #43a047, #66bb6a); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            üñ®Ô∏è Print Slides
                        </button>
                    </div>
                </div>
            `;

            // Show in a modal or new tab
            const presentationWindow = window.open('', '_blank');
            presentationWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>PowerPoint Presentation - Generated</title>
                    <style>
                        body { margin: 0; padding: 20px; background: #f0f2f5; font-family: Arial, sans-serif; }
                        @media print {
                            body { background: white; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${presentationHTML}
                    <${'script'}>
                        function copyPresentationToClipboard() {
                            const content = document.querySelector('div[style*="white-space: pre-wrap"]').textContent;
                            navigator.clipboard.writeText(content).then(() => {
                                alert('Presentation copied to clipboard! Paste into PowerPoint.');
                            });
                        }
                        
                        function printPresentation() {
                            window.print();
                        }
                    <\/script>
                </body>
                </html>
            `);
            presentationWindow.document.close();
        }

        // Advanced Smart Presentation System - Gamma.ai Quality
        async function generateSmartPresentation(userTriggered = false) {
            console.log('üé® Starting Advanced Smart Presentation generation...');
            console.trace('üîç Function call stack:');
            
            // SAFETY CHECK: Only allow if explicitly triggered by user
            if (!userTriggered) {
                console.warn('üö´ Presentation generation blocked - must be user triggered');
                return;
            }
            
            // Check if lesson content exists and is substantial
            const lessonOutput = document.getElementById('integrated-lesson-output');
            if (!lessonOutput || !lessonOutput.innerHTML.trim()) {
                alert('Please generate a complete lesson first before creating a smart presentation.');
                return;
            }
            
            // More robust check for actual generated content
            const content = lessonOutput.innerHTML.trim();
            if (content.includes('Ready to Generate') || content.includes('Ready to Create') || content.length < 500) {
                alert('Please generate a complete lesson first before creating a smart presentation.');
                return;
            }

            try {
                // Show progress using existing function
                const outputDiv = document.getElementById('integrated-lesson-output');
                outputDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px;">
                            <h2 style="margin: 0;">üé® Generating Advanced Presentation</h2>
                            <p style="margin: 10px 0 0 0; opacity: 0.9;">Analyzing lesson content and creating detailed slide prompts...</p>
                        </div>
                        <div style="display: flex; justify-content: center; gap: 10px;">
                            <div style="width: 12px; height: 12px; background: #667eea; border-radius: 50%; animation: bounce 1.4s ease-in-out 0s infinite both;"></div>
                            <div style="width: 12px; height: 12px; background: #667eea; border-radius: 50%; animation: bounce 1.4s ease-in-out 0.16s infinite both;"></div>
                            <div style="width: 12px; height: 12px; background: #667eea; border-radius: 50%; animation: bounce 1.4s ease-in-out 0.32s infinite both;"></div>
                        </div>
                    </div>
                    <style>
                        @keyframes bounce {
                            0%, 80%, 100% { transform: scale(0); }
                            40% { transform: scale(1); }
                        }
                    </style>
                `;
                
                // Step 1: Analyze lesson content and generate detailed slide prompts
                const slidePrompts = await generateDetailedSlidePrompts();
                
                // Step 2: Display prompts for user review and editing
                displaySlidePrompts(slidePrompts.slides, slidePrompts.title);
                
            } catch (error) {
                console.error('‚ùå Error generating advanced presentation:', error);
                const outputDiv = document.getElementById('integrated-lesson-output');
                outputDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="background: #dc3545; color: white; padding: 20px; border-radius: 8px;">
                            <h3>‚ùå Error Creating Presentation</h3>
                            <p>${error.message}</p>
                            <button onclick="location.reload()" style="background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                                Try Again
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Generate detailed slide prompts (200-400 words each)
        async function generateDetailedSlidePrompts() {
            const lessonContent = extractLessonForAdvancedPresentation();
            
            const prompt = buildAdvancedPresentationPrompt(lessonContent);
            
            // Call OpenAI for detailed slide analysis
            const response = await callOpenAIForSlideGeneration(prompt);
            
            const slides = parseSlidePrompts(response);
            
            return {
                title: lessonContent.title || 'Geography Presentation',
                slides: slides
            };
        }

        // Extract comprehensive lesson content for analysis
        function extractLessonForAdvancedPresentation() {
            const currentLesson = getCurrentLessonData();
            const lessonHTML = document.getElementById('integrated-lesson-output').innerHTML;
            
            // Extract rich content with structure
            const cleanText = lessonHTML.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
            
            return {
                title: currentLesson.title || 'Geography Lesson',
                module: currentLesson.moduleName || 'Geography Module',
                content: cleanText,
                studentReading: extractStudentReadingContent(lessonHTML),
                teacherNotes: extractTeacherNotesContent(lessonHTML),
                vocabulary: currentLesson.vocabulary || [],
                lessonObjectives: extractLearningObjectives(lessonHTML)
            };
        }

        // Build comprehensive prompt for slide generation
        function buildAdvancedPresentationPrompt(lessonContent) {
            return `# üé® ADVANCED PRESENTATION GENERATOR - Gamma.ai Quality

You are an expert presentation designer specializing in creating visually stunning, educationally sophisticated geography presentations. Your task is to analyze the lesson content and create 8-15 detailed slide prompts that will rival the quality of Gamma.ai presentations.

## üìö LESSON CONTENT ANALYSIS

**Lesson Title:** ${lessonContent.title}
**Module:** ${lessonContent.module}

**Student Reading Content (PRIMARY FOCUS):**
${lessonContent.studentReading}

**Teacher Notes:**
${lessonContent.teacherNotes}

**Learning Objectives:**
${lessonContent.lessonObjectives}

**Key Vocabulary:**
${lessonContent.vocabulary.map(v => `${v.term}: ${v.definition}`).join('\n')}

---

## üéØ SLIDE GENERATION REQUIREMENTS

### CONTENT DEPTH
- Each slide prompt must be 200-400 words
- Focus primarily on student reading content
- Create engaging, educational narratives
- Include specific geographic details and examples

### VISUAL THEME SELECTION
- Analyze the lesson topic and select ONE cohesive visual theme for the entire presentation
- Theme should reflect the geographic/cultural content (e.g., "Ancient Chinese Architecture" for dynasties, "Desert Landscapes" for Middle East, etc.)
- Provide specific visual direction for consistency

### SLIDE STRUCTURE
Generate 8-15 slides with the following types:
1. **Title Slide** - Compelling introduction with theme
2. **Overview/Hook Slides** - Engage students with the topic
3. **Content Slides** - Deep dive into reading material (MAJORITY)
4. **Visual Exploration Slides** - Geographic features, maps, imagery
5. **Cultural Connection Slides** - Human geography elements
6. **Synthesis/Conclusion Slides** - Tie concepts together

### IMAGE INTEGRATION REQUIREMENTS
For each slide, provide:
- **Stability AI Prompt:** Detailed description for custom illustration (geography, culture, concepts)
- **Stock Photo Search:** Specific terms for Unsplash/Pexels (real places, artifacts, people)
- **Visual Layout:** How images should be integrated with text

### STYLE SPECIFICATIONS
- Choose color palette that matches geographic theme
- Specify typography that enhances the cultural connection
- Provide layout guidance (text placement, image positioning)
- Ensure professional, educational aesthetic

---

## üìã REQUIRED OUTPUT FORMAT

For each slide, provide this exact structure:

**SLIDE [NUMBER]: [Title]**

**Content Prompt (250-400 words):**
[Detailed educational content that will appear on the slide - rich, engaging, specific to the reading material]

**Visual Theme:**
[How this slide fits the overall presentation theme]

**Stability AI Image Prompt:**
[Detailed prompt for custom illustration - be specific about style, composition, colors, geographic elements]

**Stock Photo Keywords:**
[Specific search terms for real photography - places, objects, people]

**Layout Direction:**
[How to arrange text and images - positioning, sizing, visual hierarchy]

**Style Notes:**
[Color scheme, typography, cultural design elements that match the theme]

---

## üé® EXAMPLE SLIDE FORMAT

**SLIDE 3: The Yellow River's Geographic Impact**

**Content Prompt (347 words):**
The Yellow River, known as China's "Mother River," has shaped Chinese civilization for over 4,000 years through its unique geographic characteristics. Flowing 3,395 miles from the Tibetan Plateau to the Bohai Sea, this river carries more sediment than any other river in the world - earning its distinctive yellow color from the loess soil it picks up in the Loess Plateau region.

This geographic feature created both opportunities and challenges for early Chinese settlers. The river's annual flooding deposited nutrient-rich silt across the North China Plain, creating some of the world's most fertile agricultural land. This allowed early Chinese civilizations to develop sophisticated farming techniques and support large populations, leading to the rise of powerful dynasties.

However, the Yellow River's tendency to change course dramatically - sometimes by hundreds of miles - earned it the nickname "China's Sorrow." These catastrophic floods could destroy entire cities and farmlands, forcing massive population migrations and contributing to the fall of dynasties when they failed to manage the waterways effectively.

The geographic isolation created by the river, combined with other natural barriers like the Gobi Desert and Himalayan Mountains, allowed Chinese culture to develop distinctively. Unlike civilizations that developed along more stable rivers like the Nile, Chinese societies had to become experts in water management and flood control, leading to innovations in engineering and government administration that would define Chinese civilization for millennia.

**Visual Theme:**
Ancient Chinese landscape with traditional architectural elements reflecting water management and agricultural development

**Stability AI Image Prompt:**
Create a sweeping landscape illustration showing the Yellow River winding through terraced farmlands in ancient China, with traditional Chinese architecture (pagodas, bridges) visible in the distance. Use warm earth tones - yellows, browns, and golds - to reflect the river's sediment. Include agricultural terraces, small villages, and mountains in the background. Style should be artistic but educational, combining realistic geography with cultural elements. Soft, natural lighting suggesting dawn or dusk.

**Stock Photo Keywords:**
"Yellow River China aerial", "Chinese terraced farmland", "ancient Chinese irrigation", "loess plateau China"

**Layout Direction:**
Large landscape image spanning 60% of slide width on the right, with text in elegant columns on the left. Use warm color overlay to unify image and text areas.

**Style Notes:**
Earth tone palette (yellow ochre, burnt sienna, warm browns), traditional Chinese-inspired typography for headers, subtle geometric patterns reminiscent of Chinese art as background elements.

---

Generate slides following this exact format. Focus on making each slide educationally rich, visually compelling, and thematically consistent. The goal is to create presentation content that rivals Gamma.ai in quality and educational impact.`;
        }

        // Extract content from lesson for presentation
        function extractLessonForPresentation() {
            const currentLesson = getCurrentLessonData();
            const lessonHTML = document.getElementById('integrated-lesson-output').innerHTML;
            
            // Simple content extraction
            const title = currentLesson.title || 'Geography Lesson';
            const module = currentLesson.moduleName || 'Geography Module';
            
            // Extract text content and create simple slides
            const textContent = lessonHTML.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
            const sentences = textContent.split(/[.!?]+/).filter(s => s.trim().length > 10);
            
            const slides = [
                {
                    type: 'title',
                    title: title,
                    subtitle: module,
                    content: []
                },
                {
                    type: 'content',
                    title: 'Learning Focus',
                    content: sentences.slice(0, 4)
                },
                {
                    type: 'content',
                    title: 'Key Concepts',
                    content: sentences.slice(4, 8)
                },
                {
                    type: 'conclusion',
                    title: 'Lesson Summary',
                    content: ['Review the material', 'Complete activities', 'Prepare for assessment']
                }
            ];
            
            return { title, slides };
        }

        // Advanced content extraction functions
        function extractStudentReadingContent(lessonHTML) {
            // Look for reading sections in the lesson
            const readingMatch = lessonHTML.match(/STUDENT READING[\s\S]*?(?=LESSON PLAN|HANDOUTS|$)/i);
            if (readingMatch) {
                return readingMatch[0].replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
            }
            
            // Fallback to general content
            return lessonHTML.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim().substring(0, 2000);
        }

        function extractTeacherNotesContent(lessonHTML) {
            const notesMatch = lessonHTML.match(/TEACHER[^:]*:[\s\S]*?(?=STUDENT|ASSESSMENT|$)/i);
            if (notesMatch) {
                return notesMatch[0].replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
            }
            return 'No specific teacher notes found.';
        }

        function extractLearningObjectives(lessonHTML) {
            const objectivesMatch = lessonHTML.match(/OBJECTIVES?[\s\S]*?(?=MATERIALS|PROCEDURE|$)/i);
            if (objectivesMatch) {
                return objectivesMatch[0].replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
            }
            return 'Students will explore geographic concepts and their real-world applications.';
        }

        // Call OpenAI for advanced slide generation
        async function callOpenAIForSlideGeneration(prompt) {
            const model = document.getElementById('ai-model').value || 'gpt-4';
            const creativity = 0.7; // Good balance for educational content
            
            try {
                // Try server-side first
                const response = await fetch('/api/generate-lesson-plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        model: model,
                        temperature: creativity,
                        max_tokens: 6000 // More tokens for detailed slide content
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.content;
                } else {
                    // Fallback to client-side
                    return await callOpenAIClientSideForSlides(prompt, model, creativity);
                }
            } catch (error) {
                console.log('Server API not available, trying client-side:', error.message);
                return await callOpenAIClientSideForSlides(prompt, model, creativity);
            }
        }

        // Client-side OpenAI call for slides
        async function callOpenAIClientSideForSlides(prompt, model, creativity) {
            const apiKey = document.getElementById('api-key').value;
            
            if (!apiKey) {
                throw new Error('No API key available. Please enter your OpenAI API key.');
            }

            const tokenParams = model.startsWith('gpt-5') || model.startsWith('gpt-4.1') 
                ? { max_completion_tokens: 6000 } 
                : { max_tokens: 6000 };

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        {
                            role: 'system',
                            content: 'You are an expert presentation designer and geography educator with 20+ years of experience creating visually stunning, educationally sophisticated presentations that rival tools like Gamma.ai. You specialize in analyzing lesson content and generating detailed slide prompts that combine rich educational content with specific visual direction.'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    temperature: creativity,
                    ...tokenParams
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `API request failed: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Parse the AI response into structured slide data
        function parseSlidePrompts(aiResponse) {
            const slides = [];
            const slideBlocks = aiResponse.split(/\*\*SLIDE \d+:/);
            
            slideBlocks.forEach((block, index) => {
                if (index === 0) return; // Skip the intro text
                
                const lines = block.trim().split('\n');
                const title = lines[0].replace(/\*\*/g, '').trim();
                
                let slide = {
                    id: `slide-${index}`,
                    title: title,
                    contentPrompt: '',
                    visualTheme: '',
                    stabilityPrompt: '',
                    stockKeywords: '',
                    layoutDirection: '',
                    styleNotes: ''
                };

                let currentSection = '';
                let content = '';

                lines.forEach(line => {
                    const trimmed = line.trim();
                    if (trimmed.includes('Content Prompt')) {
                        currentSection = 'content';
                        content = '';
                    } else if (trimmed.includes('Visual Theme')) {
                        if (currentSection === 'content') slide.contentPrompt = content.trim();
                        currentSection = 'theme';
                        content = '';
                    } else if (trimmed.includes('Stability AI')) {
                        if (currentSection === 'theme') slide.visualTheme = content.trim();
                        currentSection = 'stability';
                        content = '';
                    } else if (trimmed.includes('Stock Photo')) {
                        if (currentSection === 'stability') slide.stabilityPrompt = content.trim();
                        currentSection = 'stock';
                        content = '';
                    } else if (trimmed.includes('Layout Direction')) {
                        if (currentSection === 'stock') slide.stockKeywords = content.trim();
                        currentSection = 'layout';
                        content = '';
                    } else if (trimmed.includes('Style Notes')) {
                        if (currentSection === 'layout') slide.layoutDirection = content.trim();
                        currentSection = 'style';
                        content = '';
                    } else if (trimmed && !trimmed.includes('**')) {
                        content += (content ? ' ' : '') + trimmed;
                    }
                });

                // Don't forget the last section
                if (currentSection === 'style') slide.styleNotes = content.trim();

                if (slide.title && slide.contentPrompt) {
                    slides.push(slide);
                }
            });

            return slides;
        }

        // Display slide prompts for user review and editing
        function displaySlidePrompts(slides, presentationTitle) {
            const outputDiv = document.getElementById('integrated-lesson-output');
            
            let html = `
                <div style="max-width: 1000px; margin: 0 auto; padding: 20px; font-family: 'Segoe UI', sans-serif;">
                    <div style="text-align: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px;">
                        <h1 style="margin: 0; font-size: 28px; font-weight: 600;">üìö Advanced Presentation System</h1>
                        <h2 style="margin: 10px 0 0 0; font-size: 20px; opacity: 0.9;">${presentationTitle}</h2>
                        <p style="margin: 10px 0 0 0; opacity: 0.8;">Review and enhance your detailed slide prompts below</p>
                    </div>

                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; color: #495057;">üéØ Presentation Overview</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #28a745;">
                                <strong>Total Slides:</strong> ${slides.length}
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #007bff;">
                                <strong>Content Depth:</strong> 200-400 words per slide
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107;">
                                <strong>Visual Quality:</strong> Gamma.ai standard
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <button onclick="enhanceAllSlides()" style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; margin-right: 10px; cursor: pointer;">
                            ‚ú® Enhance All Slides with AI
                        </button>
                        <button onclick="generateVisualPresentation()" style="background: linear-gradient(45deg, #28a745, #20c997); color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; margin-right: 10px; cursor: pointer;">
                            üé® Generate Visual Presentation
                        </button>
                        <button onclick="exportPresentationOptions()" style="background: linear-gradient(45deg, #fd7e14, #ffc107); color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                            üì• Export Options
                        </button>
                    </div>
            `;

            slides.forEach((slide, index) => {
                html += `
                    <div id="slide-container-${index}" style="background: white; border: 2px solid #e9ecef; border-radius: 12px; margin-bottom: 25px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="background: linear-gradient(90deg, #495057, #6c757d); color: white; padding: 15px;">
                            <h3 style="margin: 0; display: flex; align-items: center; justify-content: space-between;">
                                <span>üìÑ Slide ${index + 1}: ${slide.title}</span>
                                <button onclick="enhanceSlide(${index})" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                    ‚ú® Enhance
                                </button>
                            </h3>
                        </div>
                        
                        <div style="padding: 20px;">
                            <div style="display: grid; gap: 20px;">
                                <div>
                                    <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 8px;">üìù Content Prompt (200-400 words):</label>
                                    <textarea id="content-${index}" style="width: 100%; min-height: 120px; padding: 12px; border: 2px solid #e9ecef; border-radius: 6px; font-family: inherit; resize: vertical;" onchange="updateSlideData(${index}, 'contentPrompt', this.value)">${slide.contentPrompt}</textarea>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 8px;">üé® Visual Theme:</label>
                                        <textarea id="theme-${index}" style="width: 100%; min-height: 80px; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-family: inherit; resize: vertical;" onchange="updateSlideData(${index}, 'visualTheme', this.value)">${slide.visualTheme}</textarea>
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 8px;">üñºÔ∏è Layout Direction:</label>
                                        <textarea id="layout-${index}" style="width: 100%; min-height: 80px; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-family: inherit; resize: vertical;" onchange="updateSlideData(${index}, 'layoutDirection', this.value)">${slide.layoutDirection}</textarea>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 8px;">ü§ñ Stability AI Prompt:</label>
                                        <textarea id="stability-${index}" style="width: 100%; min-height: 80px; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-family: inherit; resize: vertical;" onchange="updateSlideData(${index}, 'stabilityPrompt', this.value)">${slide.stabilityPrompt}</textarea>
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 8px;">üì∑ Stock Photo Keywords:</label>
                                        <textarea id="stock-${index}" style="width: 100%; min-height: 80px; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-family: inherit; resize: vertical;" onchange="updateSlideData(${index}, 'stockKeywords', this.value)">${slide.stockKeywords}</textarea>
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-weight: 600; color: #495057; margin-bottom: 8px;">üí° Style Notes:</label>
                                    <textarea id="style-${index}" style="width: 100%; min-height: 60px; padding: 10px; border: 2px solid #e9ecef; border-radius: 6px; font-family: inherit; resize: vertical;" onchange="updateSlideData(${index}, 'styleNotes', this.value)">${slide.styleNotes}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                    <div style="text-align: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <p style="margin: 0 0 15px 0; color: #6c757d; font-style: italic;">Ready to create your professional presentation?</p>
                        <button onclick="generateVisualPresentation()" style="background: linear-gradient(45deg, #28a745, #20c997); color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            üöÄ Generate Complete Presentation
                        </button>
                    </div>
                </div>
            `;

            outputDiv.innerHTML = html;
            
            // Store slide data globally for other functions
            window.currentSlideData = slides;
            window.currentPresentationTitle = presentationTitle;
        }

        // Update slide data when user edits
        function updateSlideData(slideIndex, property, value) {
            if (window.currentSlideData && window.currentSlideData[slideIndex]) {
                window.currentSlideData[slideIndex][property] = value;
            }
        }

        // Enhance individual slide
        async function enhanceSlide(slideIndex) {
            const slide = window.currentSlideData[slideIndex];
            if (!slide) return;

            const button = document.querySelector(`#slide-container-${slideIndex} button`);
            const originalText = button.innerHTML;
            button.innerHTML = '‚è≥ Enhancing...';
            button.disabled = true;

            try {
                const enhancementPrompt = `
Enhance this slide for a professional geography presentation:

Current Slide: ${slide.title}
Current Content: ${slide.contentPrompt}

Please improve the content to be:
- 200-400 words of rich, detailed content
- Educationally engaging with specific examples
- Professionally written for teacher presentation
- Include relevant geographic facts and connections
- Maintain academic rigor while being accessible

Return ONLY the enhanced content prompt, no extra formatting.
                `;

                const enhancedContent = await callOpenAIForSlideGeneration(enhancementPrompt);
                
                // Update the slide data and UI
                slide.contentPrompt = enhancedContent.trim();
                document.getElementById(`content-${slideIndex}`).value = enhancedContent.trim();
                
                button.innerHTML = '‚úÖ Enhanced!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Enhancement error:', error);
                button.innerHTML = '‚ùå Error';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
            }
        }

        // Enhance all slides with AI
        async function enhanceAllSlides() {
            if (!window.currentSlideData || window.currentSlideData.length === 0) {
                alert('No slides to enhance!');
                return;
            }

            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '‚è≥ Enhancing All Slides...';
            button.disabled = true;

            try {
                const promises = window.currentSlideData.map(async (slide, index) => {
                    try {
                        const enhancementPrompt = `
Enhance this slide for a professional geography presentation:

Slide Title: ${slide.title}
Current Content: ${slide.contentPrompt}

Please improve ALL aspects:

1. Content Prompt: Make it 200-400 words of rich, detailed content with specific examples and geographic connections
2. Visual Theme: Suggest a cohesive visual style that fits the content
3. Stability AI Prompt: Create a detailed prompt for custom illustrations
4. Stock Photo Keywords: List 5-7 relevant search terms
5. Layout Direction: Specify how content should be arranged
6. Style Notes: Add professional styling suggestions

Return in this exact format:
CONTENT: [enhanced content prompt]
THEME: [visual theme description]
STABILITY: [AI image prompt]
STOCK: [keyword1, keyword2, keyword3, keyword4, keyword5]
LAYOUT: [layout instructions]
STYLE: [style notes]
                        `;

                        const response = await callOpenAIForSlideGeneration(enhancementPrompt);
                        
                        // Parse the response
                        const lines = response.split('\n');
                        lines.forEach(line => {
                            const trimmed = line.trim();
                            if (trimmed.startsWith('CONTENT:')) {
                                slide.contentPrompt = trimmed.substring(8).trim();
                            } else if (trimmed.startsWith('THEME:')) {
                                slide.visualTheme = trimmed.substring(6).trim();
                            } else if (trimmed.startsWith('STABILITY:')) {
                                slide.stabilityPrompt = trimmed.substring(10).trim();
                            } else if (trimmed.startsWith('STOCK:')) {
                                slide.stockKeywords = trimmed.substring(6).trim();
                            } else if (trimmed.startsWith('LAYOUT:')) {
                                slide.layoutDirection = trimmed.substring(7).trim();
                            } else if (trimmed.startsWith('STYLE:')) {
                                slide.styleNotes = trimmed.substring(6).trim();
                            }
                        });

                        // Update the UI
                        document.getElementById(`content-${index}`).value = slide.contentPrompt;
                        document.getElementById(`theme-${index}`).value = slide.visualTheme;
                        document.getElementById(`stability-${index}`).value = slide.stabilityPrompt;
                        document.getElementById(`stock-${index}`).value = slide.stockKeywords;
                        document.getElementById(`layout-${index}`).value = slide.layoutDirection;
                        document.getElementById(`style-${index}`).value = slide.styleNotes;

                        return true;
                    } catch (error) {
                        console.error(`Error enhancing slide ${index}:`, error);
                        return false;
                    }
                });

                const results = await Promise.all(promises);
                const successCount = results.filter(r => r).length;
                
                button.innerHTML = `‚úÖ Enhanced ${successCount}/${window.currentSlideData.length} Slides!`;
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 3000);

            } catch (error) {
                console.error('Error enhancing slides:', error);
                button.innerHTML = '‚ùå Enhancement Error';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
            }
        }

        // Generate the visual presentation
        async function generateVisualPresentation() {
            if (!window.currentSlideData || window.currentSlideData.length === 0) {
                alert('No slide data available! Please generate slide prompts first.');
                return;
            }

            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = 'üé® Generating Presentation...';
            button.disabled = true;

            try {
                // Show loading interface
                showVisualGenerationProgress();

                // Generate images for each slide
                const slidesWithImages = await Promise.all(window.currentSlideData.map(async (slide, index) => {
                    try {
                        updateProgressStatus(`Generating visuals for slide ${index + 1}...`);
                        
                        // Try to get custom illustration first
                        let customImage = null;
                        if (slide.stabilityPrompt && slide.stabilityPrompt.trim()) {
                            customImage = await generateStabilityAIImage(slide.stabilityPrompt);
                        }

                        // Get stock photos as fallback or complement
                        let stockImages = [];
                        if (slide.stockKeywords && slide.stockKeywords.trim()) {
                            stockImages = await searchStockPhotos(slide.stockKeywords);
                        }

                        return {
                            ...slide,
                            customImage: customImage,
                            stockImages: stockImages.slice(0, 3) // Keep top 3 options
                        };
                    } catch (error) {
                        console.error(`Error generating images for slide ${index}:`, error);
                        return {
                            ...slide,
                            customImage: null,
                            stockImages: []
                        };
                    }
                }));

                updateProgressStatus('Rendering final presentation...');
                
                // Display the final presentation
                displayFinalPresentation(slidesWithImages);

                button.innerHTML = '‚úÖ Presentation Generated!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Error generating presentation:', error);
                button.innerHTML = '‚ùå Generation Error';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
            }
        }

        // Show progress for visual generation
        function showVisualGenerationProgress() {
            const outputDiv = document.getElementById('integrated-lesson-output');
            outputDiv.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto; padding: 40px; text-align: center;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px;">
                        <h2 style="margin: 0; font-size: 24px;">üé® Generating Your Professional Presentation</h2>
                        <p style="margin: 10px 0 0 0; opacity: 0.9;">Creating Gamma.ai-quality visuals and layouts...</p>
                    </div>
                    
                    <div id="progress-status" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <p style="margin: 0; font-size: 16px; color: #495057;">Initializing image generation...</p>
                    </div>
                    
                    <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
                        <div style="width: 12px; height: 12px; background: #667eea; border-radius: 50%; animation: bounce 1.4s ease-in-out 0s infinite both;"></div>
                        <div style="width: 12px; height: 12px; background: #667eea; border-radius: 50%; animation: bounce 1.4s ease-in-out 0.16s infinite both;"></div>
                        <div style="width: 12px; height: 12px; background: #667eea; border-radius: 50%; animation: bounce 1.4s ease-in-out 0.32s infinite both;"></div>
                    </div>
                </div>
                
                <style>
                    @keyframes bounce {
                        0%, 80%, 100% { transform: scale(0); }
                        40% { transform: scale(1); }
                    }
                </style>
            `;
        }

        // Update progress status
        function updateProgressStatus(message) {
            const statusDiv = document.getElementById('progress-status');
            if (statusDiv) {
                statusDiv.innerHTML = `<p style="margin: 0; font-size: 16px; color: #495057;">${message}</p>`;
            }
        }

        // Generate image using Stability AI via Railway backend
        async function generateStabilityAIImage(prompt) {
            try {
                console.log('üé® Generating custom image via Stability AI:', prompt);
                
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        provider: 'stability',
                        width: 800,
                        height: 600
                    })
                });

                if (!response.ok) {
                    console.warn('Stability AI not available, falling back to stock photos');
                    return null;
                }

                const data = await response.json();
                console.log('‚úÖ Generated custom image successfully');
                
                return {
                    url: data.imageUrl,
                    prompt: prompt,
                    source: 'stability-ai'
                };
            } catch (error) {
                console.error('Stability AI error:', error);
                return null;
            }
        }

        // Search for stock photos via Railway backend
        async function searchStockPhotos(keywords) {
            try {
                console.log('üì∑ Searching stock photos for:', keywords);
                
                const response = await fetch('/api/search-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: keywords,
                        providers: ['unsplash', 'pexels'],
                        count: 3,
                        width: 800,
                        height: 600
                    })
                });

                if (!response.ok) {
                    console.warn('Stock photo search not available');
                    return [];
                }

                const data = await response.json();
                console.log(`‚úÖ Found ${data.images.length} stock photos`);
                
                return data.images.map(img => ({
                    url: img.url,
                    source: img.provider,
                    description: img.description || keywords,
                    photographer: img.photographer
                }));
            } catch (error) {
                console.error('Stock photo search error:', error);
                return [];
            }
        }

        // Search Unsplash for high-quality photos
        async function searchUnsplashPhotos(keywords, apiKey) {
            try {
                const searchTerms = keywords.split(',').map(k => k.trim()).join(',');
                const response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(searchTerms)}&per_page=3&orientation=landscape&client_id=${apiKey}`);
                
                if (!response.ok) {
                    throw new Error(`Unsplash API error: ${response.status}`);
                }
                
                const data = await response.json();
                return data.results.map(photo => ({
                    url: photo.urls.regular,
                    source: 'unsplash',
                    description: photo.alt_description || searchTerms,
                    attribution: `Photo by ${photo.user.name} on Unsplash`
                }));
            } catch (error) {
                console.error('Unsplash search error:', error);
                return [];
            }
        }

        // Search Pexels for stock photos
        async function searchPexelsPhotos(keywords, apiKey) {
            try {
                const searchTerms = keywords.split(',').map(k => k.trim()).join(' ');
                const response = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(searchTerms)}&per_page=3&orientation=landscape`, {
                    headers: {
                        'Authorization': apiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Pexels API error: ${response.status}`);
                }
                
                const data = await response.json();
                return data.photos.map(photo => ({
                    url: photo.src.large,
                    source: 'pexels',
                    description: photo.alt || searchTerms,
                    attribution: `Photo by ${photo.photographer} on Pexels`
                }));
            } catch (error) {
                console.error('Pexels search error:', error);
                return [];
            }
        }

        // Fallback: Use Pixabay free API or other free services
        async function searchFreeStockPhotos(keywords) {
            try {
                // You can use Pixabay's free API here
                const searchTerms = keywords.split(',').map(k => k.trim()).join('+');
                
                // For now, return empty array to avoid placeholder images
                // Users should provide API keys for real images
                console.log('No API keys provided. Please add Unsplash or Pexels API keys for real images.');
                return [];
                
            } catch (error) {
                console.error('Free stock photo search error:', error);
                return [];
            }
        }

        // Display the final presentation
        function displayFinalPresentation(slidesWithImages) {
            const outputDiv = document.getElementById('integrated-lesson-output');
            
            let html = `
                <div style="max-width: 1200px; margin: 0 auto; padding: 20px; font-family: 'Segoe UI', sans-serif;">
                    <div style="text-align: center; margin-bottom: 30px; padding: 30px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border-radius: 12px;">
                        <h1 style="margin: 0; font-size: 32px; font-weight: 700;">üéØ Professional Geography Presentation</h1>
                        <h2 style="margin: 10px 0 0 0; font-size: 22px; opacity: 0.9;">${window.currentPresentationTitle}</h2>
                        <p style="margin: 15px 0 0 0; opacity: 0.8; font-size: 16px;">${slidesWithImages.length} slides ‚Ä¢ Gamma.ai quality ‚Ä¢ Ready for classroom use</p>
                    </div>

                    <div style="display: grid; gap: 20px; margin-bottom: 30px;">
                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="exportToPDF()" style="background: linear-gradient(45deg, #dc3545, #fd7e14); color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                                üìÑ Export to PDF
                            </button>
                            <button onclick="exportToPNG()" style="background: linear-gradient(45deg, #6610f2, #6f42c1); color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                                üñºÔ∏è Export as Images
                            </button>
                            <button onclick="exportToDOCX()" style="background: linear-gradient(45deg, #0d6efd, #0dcaf0); color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                                üìù Export to DOCX
                            </button>
                            <button onclick="editPresentation()" style="background: linear-gradient(45deg, #ffc107, #fd7e14); color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                                ‚úèÔ∏è Edit Presentation
                            </button>
                        </div>
                    </div>
            `;

            slidesWithImages.forEach((slide, index) => {
                const primaryImage = slide.customImage || (slide.stockImages && slide.stockImages[0]);
                
                html += `
                    <div style="background: white; border: 1px solid #e9ecef; border-radius: 12px; margin-bottom: 25px; overflow: hidden; box-shadow: 0 6px 12px rgba(0,0,0,0.1);">
                        <div style="background: linear-gradient(90deg, #495057, #6c757d); color: white; padding: 20px;">
                            <h2 style="margin: 0; font-size: 24px; font-weight: 600;">Slide ${index + 1}: ${slide.title}</h2>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; min-height: 400px;">
                            <div style="padding: 30px; background: #f8f9fa;">
                                <div style="background: white; padding: 25px; border-radius: 8px; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                                    <div style="font-size: 16px; line-height: 1.6; color: #333;">
                                        ${slide.contentPrompt.split('\n').map(p => p.trim() ? `<p style="margin: 0 0 15px 0;">${p.trim()}</p>` : '').join('')}
                                    </div>
                                    
                                    ${slide.visualTheme ? `
                                        <div style="margin-top: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 6px; border-left: 4px solid #667eea;">
                                            <strong style="color: #667eea;">Visual Theme:</strong> ${slide.visualTheme}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div style="background: #ffffff; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;">
                                ${primaryImage ? `
                                    <img src="${primaryImage.url}" alt="${slide.title}" style="max-width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                                    <p style="margin: 15px 0 0 0; font-size: 12px; color: #6c757d; text-align: center;">${primaryImage.source === 'placeholder' ? 'Generated Image Placeholder' : 'Professional Image'}</p>
                                ` : `
                                    <div style="width: 100%; height: 250px; background: linear-gradient(135deg, #e9ecef, #f8f9fa); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #6c757d;">
                                        <span style="font-size: 18px;">üìä Visual Content</span>
                                    </div>
                                `}
                                
                                ${slide.stockImages && slide.stockImages.length > 1 ? `
                                    <div style="margin-top: 15px; display: flex; gap: 10px; opacity: 0.7;">
                                        ${slide.stockImages.slice(1, 3).map(img => `
                                            <img src="${img.url}" alt="Alternative" style="width: 60px; height: 45px; object-fit: cover; border-radius: 4px; cursor: pointer;" onclick="swapSlideImage(${index}, '${img.url}')">
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${slide.layoutDirection || slide.styleNotes ? `
                            <div style="padding: 20px; background: #f8f9fa; border-top: 1px solid #e9ecef;">
                                ${slide.layoutDirection ? `<p style="margin: 0 0 10px 0; font-size: 14px;"><strong>Layout:</strong> ${slide.layoutDirection}</p>` : ''}
                                ${slide.styleNotes ? `<p style="margin: 0; font-size: 14px;"><strong>Style Notes:</strong> ${slide.styleNotes}</p>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            html += `
                    <div style="text-align: center; margin-top: 40px; padding: 30px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px;">
                        <h3 style="margin: 0 0 15px 0; color: #495057;">üéâ Your Professional Presentation is Ready!</h3>
                        <p style="margin: 0 0 20px 0; color: #6c757d;">Export in your preferred format or continue editing</p>
                        <button onclick="generateNewPresentation()" style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                            üîÑ Create New Presentation
                        </button>
                    </div>
                </div>
            `;

            outputDiv.innerHTML = html;
        }

        // Export and utility functions
        function exportToPDF() {
            alert('PDF export functionality would be implemented here');
        }

        function exportToPNG() {
            alert('PNG export functionality would be implemented here');
        }

        function exportToDOCX() {
            alert('DOCX export functionality would be implemented here');
        }

        function exportPresentationOptions() {
            alert('Export options panel would be implemented here');
        }

        function editPresentation() {
            if (window.currentSlideData && window.currentPresentationTitle) {
                displaySlidePrompts(window.currentSlideData, window.currentPresentationTitle);
            }
        }

        function generateNewPresentation() {
            // Reset and start over
            window.currentSlideData = null;
            window.currentPresentationTitle = null;
            document.getElementById('integrated-lesson-output').innerHTML = '';
        }

        function swapSlideImage(slideIndex, newImageUrl) {
            // Functionality to swap the primary image
            const slide = window.currentSlideData[slideIndex];
            if (slide && slide.stockImages) {
                const newPrimary = slide.stockImages.find(img => img.url === newImageUrl);
                if (newPrimary) {
                    const oldPrimary = slide.customImage || slide.stockImages[0];
                    slide.customImage = newPrimary;
                    // Re-render the presentation
                    displayFinalPresentation(window.currentSlideData);
                }
            }
        }

        // Create and display the presentation
        function createAndDisplayPresentation(data) {
            const html = buildSimplePresentation(data);
            const newWindow = window.open('', '_blank', 'width=1200,height=800');
            
            if (newWindow) {
                newWindow.document.write(html);
                newWindow.document.close();
                newWindow.focus();
            } else {
                alert('Please allow pop-ups to view the presentation');
            }
        }

        // Build simple, working presentation HTML
        function buildSimplePresentation(data) {
            const slidesHTML = data.slides.map((slide, index) => {
                const slideId = `slide-${index + 1}`;
                const activeClass = index === 0 ? ' active' : '';
                
                if (slide.type === 'title') {
                    return `
                        <div id="${slideId}" class="slide title-slide${activeClass}">
                            <h1>${slide.title}</h1>
                            <h2>${slide.subtitle}</h2>
                        </div>
                    `;
                }
                
                const contentList = slide.content.map(item => `<li>${item}</li>`).join('');
                return `
                    <div id="${slideId}" class="slide content-slide${activeClass}">
                        <h1>${slide.title}</h1>
                        <ul>${contentList}</ul>
                    </div>
                `;
            }).join('');

            return `<!DOCTYPE html>
<html>
<head>
    <title>${data.title} - Presentation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh; overflow: hidden; 
        }
        .container { 
            width: 100%; height: 100%; 
            display: flex; align-items: center; justify-content: center; 
        }
        .slide { 
            width: 90%; max-width: 1000px; height: 80%; 
            background: white; border-radius: 20px; 
            padding: 60px; display: none; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .slide.active { display: flex; flex-direction: column; justify-content: center; }
        .title-slide { text-align: center; }
        .title-slide h1 { font-size: 4rem; color: #2d3748; margin-bottom: 20px; }
        .title-slide h2 { font-size: 2rem; color: #4a5568; }
        .content-slide h1 { font-size: 3rem; color: #2d3748; margin-bottom: 40px; }
        .content-slide ul { list-style: none; }
        .content-slide li { 
            font-size: 1.5rem; margin: 20px 0; padding: 15px 0; 
            border-bottom: 2px solid #e2e8f0; color: #2d3748;
        }
        .controls { 
            position: fixed; bottom: 30px; left: 50%; 
            transform: translateX(-50%); display: flex; gap: 20px; 
        }
        .btn { 
            padding: 15px 30px; background: rgba(255,255,255,0.9); 
            border: none; border-radius: 30px; cursor: pointer; 
            font-size: 16px; font-weight: 600; 
        }
        .btn:hover { background: white; }
        .counter { 
            position: fixed; top: 30px; right: 30px; 
            background: rgba(255,255,255,0.9); padding: 15px 25px; 
            border-radius: 20px; font-weight: 600; 
        }
    </style>
</head>
<body>
    <div class="container">
        ${slidesHTML}
        <div class="counter">
            <span id="current">1</span> / <span id="total">${data.slides.length}</span>
        </div>
        <div class="controls">
            <button class="btn" onclick="previousSlide()">‚Üê Previous</button>
            <button class="btn" onclick="nextSlide()">Next ‚Üí</button>
            <button class="btn" onclick="window.close()">Close</button>
        </div>
    </div>
    <${'script'}>
        let currentSlide = 1;
        const totalSlides = ${data.slides.length};
        
        function showSlide(n) {
            document.querySelectorAll('.slide').forEach(s => s.classList.remove('active'));
            document.getElementById('slide-' + n).classList.add('active');
            document.getElementById('current').textContent = n;
            currentSlide = n;
        }
        
        function nextSlide() {
            if (currentSlide < totalSlides) showSlide(currentSlide + 1);
        }
        
        function previousSlide() {
            if (currentSlide > 1) showSlide(currentSlide - 1);
        }
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowRight' || e.key === ' ') nextSlide();
            if (e.key === 'ArrowLeft') previousSlide();
            if (e.key === 'Escape') window.close();
        });
    </${'script'}>
</body>
</html>`;
        }

        // Loading functions
        function showPresentationLoading() {
            const loadingHTML = `
                <div id="presentation-loading" style="
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                    align-items: center; justify-content: center; color: white;
                ">
                    <div style="text-align: center; padding: 40px; background: rgba(255,255,255,0.1); border-radius: 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üé®</div>
                        <h2>Creating Your Presentation</h2>
                        <p>Analyzing lesson content...</p>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', loadingHTML);
        }

        function hidePresentationLoading() {
            const loading = document.getElementById('presentation-loading');
            if (loading) loading.remove();
        }

        // Format the integrated lesson with proper HTML structure and page breaks
        function formatIntegratedLesson(lessonText) {
            if (!lessonText || typeof lessonText !== 'string') {
                throw new Error('Invalid lesson text provided to formatter');
            }
            
            let formatted = lessonText.replace(/\n/g, '<br>');
            
            // Add page break classes for major sections
            formatted = formatted.replace(/# üìñ (.*?)<br>/g, '<div class="section-break"><h1 class="lesson-title">üìñ $1</h1></div>');
            formatted = formatted.replace(/## üöÄ INTEGRATED LESSON PLAN<br>/g, '<div class="lesson-section"><h2>üöÄ INTEGRATED LESSON PLAN</h2></div>');
            formatted = formatted.replace(/## üìù STUDENT HANDOUTS<br>/g, '<div class="handout-section"><h2>üìù STUDENT HANDOUTS</h2></div>');
            formatted = formatted.replace(/## ‚úÖ INTEGRATED ASSESSMENT TOOLS<br>/g, '<div class="page-break-before"><h2>‚úÖ INTEGRATED ASSESSMENT TOOLS</h2></div>');
            
            // Format headers with different levels and page break controls
            formatted = formatted.replace(/### (.*?)<br>/g, '<h3 class="page-break-avoid" style="color: #ff6b6b; margin: 20px 0 10px 0; font-size: 1.3rem; border-left: 4px solid #ff6b6b; padding-left: 10px;">$1</h3>');
            formatted = formatted.replace(/## (.*?)<br>/g, '<h2 class="page-break-avoid" style="color: #495057; margin: 25px 0 15px 0; font-size: 1.5rem; border-bottom: 2px solid #e9ecef; padding-bottom: 5px;">$2</h2>');
            formatted = formatted.replace(/# (.*?)<br>/g, '<h1 class="lesson-header page-break-avoid" style="color: #ff6b6b; margin: 30px 0 20px 0; font-size: 1.8rem; text-align: center; border: 3px solid #ff6b6b; padding: 15px; border-radius: 10px; background: #fff5f5;">$1</h1>');
            
            // Format paragraphs with proper spacing and orphan/widow control
            formatted = formatted.replace(/Paragraph (\d+)<br>/g, '<div class="reading-paragraph"><strong>Paragraph $1</strong><br>');
            formatted = formatted.replace(/(.*?<\/strong><br>.*?)<br><br>/g, '$1</div><br>');
            
            // Format lesson at a glance section
            formatted = formatted.replace(/üìã LESSON AT A GLANCE<br>/g, '<div class="objectives-box"><h3>üìã LESSON AT A GLANCE</h3>');
            formatted = formatted.replace(/### Integrated Learning Objectives<br>(.*?)### Standards Alignment/gs, '<div class="content-box"><h4>Integrated Learning Objectives</h4>$1</div><h4>Standards Alignment</h4>');
            
            // Format timing guide as a proper table
            formatted = formatted.replace(/‚è∞ INTEGRATED TIMING GUIDE<br><br>\| Time \| Activity \| Reading Connection \|<br>\|------|----------|-------------------|<br>(.*?)<br><br>/gs, function(match, tableContent) {
                if (!tableContent) return match; // Safety check
                let tableRows = tableContent.split('<br>').filter(row => row.trim() && row.includes('|'));
                let tableHTML = '<div class="timing-table page-break-avoid"><h3>‚è∞ INTEGRATED TIMING GUIDE</h3><table><thead><tr><th>Time</th><th>Activity</th><th>Reading Connection</th></tr></thead><tbody>';
                
                tableRows.forEach(row => {
                    let cells = row.split('|').map(cell => cell.trim()).filter(cell => cell);
                    if (cells.length >= 3) {
                        tableHTML += `<tr><td>${cells[0]}</td><td>${cells[1]}</td><td>${cells[2]}</td></tr>`;
                    }
                });
                
                tableHTML += '</tbody></table></div>';
                return tableHTML;
            });
            
            // Format rubric tables
            formatted = formatted.replace(/\| Criteria \| Excellent \| Good \| Needs Work \|<br>\|----------|-----------|------|------------|<br>(.*?)<br><br>/gs, function(match, tableContent) {
                if (!tableContent) return match; // Safety check
                let tableRows = tableContent.split('<br>').filter(row => row.trim() && row.includes('|'));
                let tableHTML = '<div class="assessment-rubric page-break-avoid"><table><thead><tr><th>Criteria</th><th>Excellent</th><th>Good</th><th>Needs Work</th></tr></thead><tbody>';
                
                tableRows.forEach(row => {
                    let cells = row.split('|').map(cell => cell.trim()).filter(cell => cell);
                    if (cells.length >= 4) {
                        tableHTML += `<tr><td>${cells[0]}</td><td>${cells[1]}</td><td>${cells[2]}</td><td>${cells[3]}</td></tr>`;
                    }
                });
                
                tableHTML += '</tbody></table></div>';
                return tableHTML;
            });
            
            // Format vocabulary sections
            formatted = formatted.replace(/\*\*Key Terms from Reading:\*\* (.*?)<br>/g, '<div class="vocabulary-box"><strong>Key Terms from Reading:</strong> $1</div>');
            
            // Format implementation guides with page break avoidance
            formatted = formatted.replace(/### (15-Minute Preparation Checklist|First-Time Teaching Notes|Troubleshooting Guide|Substitute Teacher Instructions)<br>/g, '<div class="content-box page-break-avoid"><h4>$1</h4>');
            formatted = formatted.replace(/‚úÖ QUALITY ASSURANCE VERIFICATION<br>/g, '<div class="page-break-avoid"><h3>‚úÖ QUALITY ASSURANCE VERIFICATION</h3>');
            
            // Format bold text
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong style="color: #495057;">$1</strong>');
            
            // Format bullet points with proper structure
            formatted = formatted.replace(/(^|\<br\>)‚Ä¢ /g, '$1<li style="margin: 4px 0;">');
            formatted = formatted.replace(/(^|\<br\>)- /g, '$1<li style="margin: 4px 0;">');
            
            // Format numbered lists
            formatted = formatted.replace(/(^|\<br\>)(\d+\.) /g, '$1<div class="numbered-item"><span style="color: #ff6b6b; font-weight: bold;">$2</span> ');
            
            // Format checkboxes
            formatted = formatted.replace(/- \[ \]/g, '<div class="checkbox-item"><input type="checkbox" style="margin-right: 8px;">');
            formatted = formatted.replace(/- \[x\]/g, '<div class="checkbox-item"><input type="checkbox" checked style="margin-right: 8px;">');
            
            // Clean up and structure the content properly
            formatted = formatted.replace(/<br><br>/g, '</p><p>');
            formatted = formatted.replace(/^<br>|<br>$/g, '');
            
            // Wrap in proper structure with print-friendly classes
            return `
                <div class="integrated-lesson-content" style="max-width: 900px; margin: 0 auto; line-height: 1.8; font-size: 1.1rem;">
                    <div class="lesson-header no-print" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 3px solid #ff6b6b;">
                        <h2 style="color: #ff6b6b; margin: 0;">üéØ Complete Integrated Lesson Package</h2>
                        <span style="background: #fff5f5; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; color: #721c24; font-weight: bold; border: 2px solid #ff6b6b;">
                            Print-Ready ‚Ä¢ No Prep Required
                        </span>
                    </div>
                    <div class="lesson-content" style="background: linear-gradient(135deg, #fff5f5, #ffffff); padding: 30px; border-radius: 15px; border: 1px solid #ff6b6b;">
                        ${formatted}
                    </div>
                    <div class="no-print" style="margin-top: 20px; padding: 15px; background: #d1ecf1; border-left: 5px solid #bee5eb; border-radius: 5px;">
                        <h4 style="color: #0c5460; margin-bottom: 10px;">üñ®Ô∏è Ready to Print Instructions:</h4>
                        <p style="color: #0c5460; margin: 0;">This complete lesson package is formatted for immediate classroom use. Simply print and teach - no additional preparation required!</p>
                    </div>
                </div>
            `;
        }

        // Export functions for integrated lesson
        function printIntegratedLesson() {
            const content = document.getElementById('integrated-lesson-output').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Complete Integrated Lesson - ${currentLessonData.title}</title>
                    <style>
                        /* Reset and Base Styles */
                        * { 
                            box-sizing: border-box; 
                            margin: 0; 
                            padding: 0; 
                        }
                        
                        body { 
                            font-family: 'Times New Roman', serif; 
                            font-size: 12pt; 
                            line-height: 1.5; 
                            color: #000;
                            background: white;
                        }

                        /* Print-Specific Layout */
                        @media print {
                            @page {
                                size: 8.5in 11in;
                                margin: 0.75in 0.75in 0.75in 0.75in;
                            }
                            
                            body { 
                                margin: 0; 
                                padding: 0;
                                font-size: 11pt;
                                line-height: 1.4;
                            }
                            
                            /* Page Break Controls */
                            .page-break-before { page-break-before: always; }
                            .page-break-after { page-break-after: always; }
                            .page-break-avoid { page-break-inside: avoid; }
                            
                            /* Section Breaks */
                            .section-break {
                                page-break-before: always;
                                margin-top: 0;
                            }
                            
                            /* Header Styles */
                            h1 { 
                                font-size: 16pt; 
                                font-weight: bold; 
                                margin: 0 0 12pt 0;
                                page-break-after: avoid;
                                text-align: center;
                                border-bottom: 2pt solid #000;
                                padding-bottom: 6pt;
                            }
                            
                            h2 { 
                                font-size: 14pt; 
                                font-weight: bold; 
                                margin: 18pt 0 8pt 0;
                                page-break-after: avoid;
                                border-left: 4pt solid #666;
                                padding-left: 8pt;
                            }
                            
                            h3 { 
                                font-size: 12pt; 
                                font-weight: bold; 
                                margin: 12pt 0 6pt 0;
                                page-break-after: avoid;
                            }
                            
                            h4 { 
                                font-size: 11pt; 
                                font-weight: bold; 
                                margin: 8pt 0 4pt 0;
                                page-break-after: avoid;
                            }
                            
                            /* Paragraph Styles */
                            p { 
                                margin: 0 0 8pt 0; 
                                text-align: justify;
                                orphans: 3;
                                widows: 3;
                            }
                            
                            /* List Styles */
                            ul, ol { 
                                margin: 6pt 0 6pt 24pt; 
                                page-break-inside: avoid;
                            }
                            
                            li { 
                                margin: 2pt 0; 
                                page-break-inside: avoid;
                            }
                            
                            /* Table Styles */
                            table { 
                                width: 100%; 
                                border-collapse: collapse; 
                                margin: 8pt 0;
                                page-break-inside: avoid;
                                font-size: 10pt;
                            }
                            
                            th, td { 
                                border: 1pt solid #000; 
                                padding: 4pt 6pt; 
                                text-align: left;
                                vertical-align: top;
                            }
                            
                            th { 
                                background: #f0f0f0; 
                                font-weight: bold;
                                page-break-after: avoid;
                            }
                            
                            /* Special Content Boxes */
                            .content-box {
                                border: 1pt solid #666;
                                padding: 8pt;
                                margin: 8pt 0;
                                page-break-inside: avoid;
                                background: #f9f9f9;
                            }
                            
                            /* Reading Section */
                            .reading-section {
                                page-break-before: always;
                                margin-top: 0;
                            }
                            
                            .reading-paragraph {
                                margin: 8pt 0;
                                padding: 6pt 0;
                                border-left: 2pt solid #ddd;
                                padding-left: 8pt;
                                page-break-inside: avoid;
                            }
                            
                            /* Lesson Plan Section */
                            .lesson-section {
                                page-break-before: always;
                                margin-top: 0;
                            }
                            
                            /* Handout Section */
                            .handout-section {
                                page-break-before: always;
                                margin-top: 0;
                            }
                            
                            /* Timing Guide */
                            .timing-table {
                                page-break-inside: avoid;
                                margin: 12pt 0;
                            }
                            
                            /* Hide screen-only elements */
                            .no-print { display: none !important; }
                            
                            /* Footer for each page */
                            .page-footer {
                                position: fixed;
                                bottom: 0.5in;
                                left: 0;
                                right: 0;
                                text-align: center;
                                font-size: 9pt;
                                color: #666;
                                border-top: 1pt solid #ccc;
                                padding-top: 4pt;
                            }
                        }
                        
                        /* Screen Styles */
                        @media screen {
                            body { 
                                max-width: 8.5in;
                                margin: 20px auto;
                                padding: 20px;
                                background: white;
                                box-shadow: 0 0 20px rgba(0,0,0,0.1);
                            }
                            
                            h1, h2, h3, h4 { color: #333; }
                            
                            .page-break-before { 
                                border-top: 2px dashed #ccc;
                                margin-top: 40px;
                                padding-top: 20px;
                            }
                        }
                        
                        /* Content-specific styles */
                        .lesson-header {
                            text-align: center;
                            margin-bottom: 20pt;
                            page-break-after: avoid;
                        }
                        
                        .lesson-title {
                            font-size: 18pt;
                            font-weight: bold;
                            margin-bottom: 6pt;
                        }
                        
                        .lesson-info {
                            font-size: 10pt;
                            color: #666;
                            margin-bottom: 4pt;
                        }
                        
                        .objectives-box {
                            border: 2pt solid #000;
                            padding: 12pt;
                            margin: 12pt 0;
                            page-break-inside: avoid;
                        }
                        
                        .vocabulary-box {
                            background: #f5f5f5;
                            border: 1pt solid #ccc;
                            padding: 8pt;
                            margin: 8pt 0;
                            page-break-inside: avoid;
                        }
                        
                        .assessment-rubric {
                            page-break-inside: avoid;
                            margin: 12pt 0;
                        }
                        
                        /* Remove background colors and gradients for print */
                        @media print {
                            * {
                                background: transparent !important;
                                color: black !important;
                                box-shadow: none !important;
                                text-shadow: none !important;
                            }
                            
                            .content-box, .vocabulary-box {
                                background: white !important;
                                border: 1pt solid #666 !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="page-footer no-print">
                        ${currentLessonData.title} - Complete Integrated Lesson Package
                    </div>
                    ${content}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function copyIntegratedLesson() {
            const content = document.getElementById('integrated-lesson-output').innerText;
            navigator.clipboard.writeText(content).then(() => {
                alert('üìã Complete integrated lesson copied to clipboard!');
            });
        }

        function saveIntegratedLesson() {
            const content = document.getElementById('integrated-lesson-output').innerHTML;
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `integrated-lesson-${currentLessonData.title.replace(/\s+/g, '-').toLowerCase()}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Main function to generate lesson plan
        async function generateLessonPlan() {
            console.log('üöÄ Starting lesson plan generation...');
            
            if (!currentLessonData) {
                alert('Please select a lesson first by going back to the lesson companion.');
                return;
            }

            console.log('üìö Current lesson data:', currentLessonData);

            // Save user settings
            saveUserSettings();

            // Show loading state
            document.getElementById('loading').style.display = 'block';
            document.getElementById('lesson-plan-output').style.display = 'none';
            document.getElementById('generate-btn').disabled = true;
            document.getElementById('generate-btn').textContent = 'ü§ñ Generating...';

            try {
                // Prepare the AI prompt
                const prompt = buildAIPrompt();
                console.log('üìù Built AI prompt, length:', prompt.length);
                
                // Call OpenAI API
                const lessonPlan = await callOpenAIAPI(prompt);
                console.log('‚úÖ Received lesson plan from AI');
                
                // Display the generated lesson plan
                displayGeneratedLessonPlan(lessonPlan);
                
                updateAPIStatus('success', '‚úÖ Lesson plan generated successfully!');
                
            } catch (error) {
                console.error('‚ùå Error generating lesson plan:', error);
                updateAPIStatus('error', '‚ùå Error generating lesson plan: ' + error.message);
                
                // Show error in output panel
                document.getElementById('lesson-plan-output').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <h3>‚ùå Generation Failed</h3>
                        <p>${error.message}</p>
                        <button onclick="generateLessonPlan()" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Try Again
                        </button>
                    </div>
                `;
            } finally {
                // Reset UI
                document.getElementById('loading').style.display = 'none';
                document.getElementById('lesson-plan-output').style.display = 'block';
                document.getElementById('generate-btn').disabled = false;
                document.getElementById('generate-btn').textContent = 'üöÄ Generate AI Lesson Plan';
            }
        }

        // Build the AI prompt based on current settings and content
        function buildAIPrompt() {
            const lessonFocus = document.getElementById('lesson-focus').value;
            const classSize = document.getElementById('class-size').value;
            const customInstructions = document.getElementById('custom-prompt').value;

            const teacherContent = document.getElementById('teacher-content').textContent;
            const studentContent = document.getElementById('student-content').textContent;

            const focusDescriptions = {
                'balanced': 'a balanced mix of instruction, discussion, and activities',
                'interactive': 'highly interactive with frequent student participation',
                'discussion': 'discussion-heavy with socratic questioning',
                'hands-on': 'hands-on activities and experiential learning',
                'assessment': 'assessment-focused with multiple check-ins',
                'technology': 'technology integration and digital tools'
            };

            return `# üéØ SOPHISTICATED GEOGRAPHY LESSON PLAN GENERATOR

You are an expert 7th-grade geography teacher tasked with creating a comprehensive, research-based lesson plan that fully leverages the rich source materials provided. This lesson plan must demonstrate educational sophistication while remaining practical and immediately usable.

## üìö SOURCE MATERIALS ANALYSIS

**LESSON CONTEXT:** Module ${currentLessonData.moduleNumber} - ${currentLessonData.title}
**CLASS SIZE:** ${classSize} students  
**FOCUS STYLE:** ${focusDescriptions[lessonFocus]}
${customInstructions ? `**SPECIAL INSTRUCTIONS:** ${customInstructions}` : ''}

**STUDENT READING CONTENT:**
${studentContent || 'No specific reading provided'}

**TEACHER GUIDE CONTENT:**
${teacherContent || 'No teacher guide provided'}

**CORE VOCABULARY:** ${currentLessonData.vocabulary ? currentLessonData.vocabulary.map(v => v.term).join(', ') : 'None provided'}

---

## üéØ ENHANCED LESSON PLAN REQUIREMENTS

### 1. CONTENT INTEGRATION MASTERY

**READING MATERIAL UTILIZATION:**
- Extract specific page/section references for each activity
- Generate reading guides with paragraph numbers for student reference
- Create text-dependent questions requiring specific evidence citation
- Include reading strategies (chunking, annotation, graphic organizers)
- Provide sentence frames for discussing complex concepts

**VOCABULARY ENHANCEMENT:**
- Tier vocabulary: Essential (8), Important (5-7), Extension (3-5)
- Include pronunciation guides for difficult terms
- Generate diverse vocabulary activities (word maps, analogies, context clues)
- Create visual vocabulary cards with content connections
- Add cognates for Spanish-speaking ELL students

**GEOGRAPHIC LITERACY INTEGRATION:**
- Generate detailed map activities from reading content
- Include climate/resource comparison charts
- Create cause-and-effect organizers linking geography to culture
- Add modern country overlays connecting ancient to contemporary
- Include elevation and climate data from reading

### 2. ACTIVITY SOPHISTICATION

**READING COMPREHENSION DEPTH:**
- Generate close reading protocols for key passages
- Create comparison matrices from content
- Include timeline construction using specific dates
- Add evidence-based writing prompts requiring citations
- Generate discussion protocols for complex topics

**DIFFERENTIATED READING SUPPORT:**
- Create reading level alternatives for struggling readers
- Generate graphic organizers for each major reading section
- Provide background knowledge builders for unfamiliar concepts
- Add visual supports for abstract concepts
- Include audio script directions for accessibility

### 3. ASSESSMENT ALIGNMENT

**FORMATIVE ASSESSMENT INTEGRATION:**
- Generate text-dependent questions for each major section
- Create quick-check comprehension questions with paragraph references
- Include peer discussion protocols with accountability
- Add self-monitoring checklists for reading comprehension
- Generate exit tickets requiring synthesis across sections

**AUTHENTIC TASK CREATION:**
- Generate document-based questions using reading information
- Create role-playing scenarios based on content descriptions
- Include artifact analysis activities using text descriptions
- Add historical thinking prompts (cause/effect, change/continuity)
- Generate creative applications based on content

### 4. CULTURAL SENSITIVITY & ACCURACY

**INDIGENOUS PERSPECTIVE INTEGRATION:**
- Include contemporary connections to living communities
- Add respectful language protocols for indigenous cultures
- Generate activities connecting ancient and modern practices
- Include diverse perspectives on historical events
- Add resources for contemporary indigenous issues

### 5. CROSS-CURRICULAR ENHANCEMENT

**STEM CONNECTIONS:**
- Generate math activities using systems from reading
- Include astronomy connections with calendar/observatory information
- Create science links to environmental factors
- Add engineering challenges based on achievements
- Include data analysis of adaptations

---

## üìã REQUIRED LESSON PLAN FORMAT

# üìã SOPHISTICATED LESSON PLAN: ${currentLessonData.title}

**Module ${currentLessonData.moduleNumber} | ${classSize} Students | 50 Minutes**  
**Grade Level:** 7th Grade Geography  
**Focus:** Content-Rich Geographic Literacy

---

## üéØ LESSON OVERVIEW

### Learning Objectives (Specific & Measurable)
By the end of this lesson, students will be able to:
1. [Specific objective requiring textual evidence and geographic analysis]
2. [Specific objective demonstrating cultural understanding]
3. [Specific objective showing cause-and-effect geographic thinking]

### Standards Alignment
- **National Geography Standards:** [Specific standards from content]
- **Common Core Reading:** [Informational text standards]
- **Common Core Writing:** [Evidence-based writing standards]

### Key Essential Questions
1. [Geographic thinking question based on content]
2. [Cultural understanding question requiring text evidence]
3. [Cause-and-effect question connecting geography to human activity]

---

## üìö SOPHISTICATED CONTENT UTILIZATION

### Reading Material Integration
**Primary Source Sections:** [List specific sections/paragraphs to focus on]
**Key Passages for Close Reading:** [Quote 2-3 crucial passages with paragraph numbers]
**Text-Dependent Questions:**
1. [Question requiring specific evidence from paragraph X]
2. [Question requiring synthesis across sections Y and Z]
3. [Question requiring interpretation of specific content]

### Advanced Vocabulary Strategy
**ESSENTIAL TIER (8 terms):** [List with pronunciation guides and geographic significance]
**IMPORTANT TIER (5-7 terms):** [List with context clues from reading]
**EXTENSION TIER (3-5 terms):** [List with cognates and advanced applications]

**Vocabulary Activities:**
- [Text-based vocabulary strategy using specific content]
- [Visual vocabulary connections to geographic concepts]
- [Peer teaching protocol with academic language frames]

---

## üó∫Ô∏è GEOGRAPHIC LITERACY FOCUS

### Spatial Thinking Integration
[Specific mapping activities using content from reading with exact geographic references]

### Geographic Analysis Framework
**Cause & Effect Relationships:** [From reading content with specific examples]
**Human-Environment Interaction:** [Specific examples from text with evidence requirements]
**Movement & Trade Patterns:** [Based on reading descriptions with analysis tasks]

---

## üöÄ SOPHISTICATED LESSON ACTIVITIES

### CONTENT-RICH OPENING HOOK (8 minutes)
**Geographic Thinking Activation:**
[Engaging opener that connects directly to reading content with specific geographic concepts]

**Background Knowledge Bridge:**
[Strategy to connect prior geographic knowledge to today's complex reading]

**Text Complexity Preview:**
[How to orient students to sophisticated informational text structure]

### GUIDED READING INSTRUCTION (20 minutes)
**Multi-Layer Reading Protocol:**
- **Geographic Survey Read:** [Purpose and mapping strategy]
- **Evidence-Focused Read:** [Annotation strategy for geographic evidence]
- **Analysis Read:** [Synthesis strategy for geographic patterns]

**Text Chunking for Geographic Concepts:**
[How to break down complex geographic information systematically]

**Academic Annotation Guide:**
[Specific symbols for geographic evidence, cause-effect, human-environment interaction]

**Comprehension Monitoring:**
[Self-assessment tools for understanding complex geographic relationships]

### CONTENT-BASED ANALYSIS ACTIVITIES (15 minutes)
**Primary Activity:** [Sophisticated geographic analysis task using specific reading content]

**Evidence-Based Collaboration:** [How students cite sources in geographic discussions]

**Geographic Reasoning Requirements:** [Specific spatial thinking and analysis expectations]

**Cross-Cultural Analysis:** [How students analyze different cultural perspectives from text]

### SYNTHESIS & AUTHENTIC ASSESSMENT (7 minutes)
**Text-Dependent Geographic Discussion:** [Questions requiring reading evidence and spatial thinking]

**Geographic Literacy Assessment:** [Formative check requiring text evidence and geographic reasoning]

**Synthesis Exit Task:** [How students demonstrate understanding through geographic lens]

---

## üìä SOPHISTICATED DIFFERENTIATION

### Reading Complexity Support
**Struggling Readers:**
- [Content-specific graphic organizer with geographic framework]
- [Tiered vocabulary with geographic context and visual supports]
- [Strategic reading partnerships with role assignments]

**English Language Learners:**
- [Geographic cognates for Spanish speakers with cultural connections]
- [Visual geographic supports for abstract concepts from reading]
- [Academic sentence frames for geographic discussions and analysis]

**Advanced Learners:**
- [Geographic research extensions connecting to contemporary issues]
- [Higher-order spatial analysis questions requiring synthesis]
- [Independent geographic inquiry opportunities]

### Cultural Responsiveness
[How lesson honors diverse geographic perspectives and connects to students' cultural geography]

---

## ‚úÖ COMPREHENSIVE ASSESSMENT PLAN

### Geographic Literacy Assessment
1. **Text Annotation Quality:** [Evidence of geographic thinking in annotations]
2. **Spatial Reasoning:** [Quality of geographic analysis and evidence use]
3. **Cultural Understanding:** [Respectful and accurate cultural geographic analysis]

### Text-Dependent Geographic Questions
1. [Question requiring specific paragraph citation and geographic analysis]
2. [Question requiring synthesis across multiple sections with spatial thinking]
3. [Question requiring geographic inference based on textual evidence]

### Exit Synthesis (Geographic Literacy Focus)
[Specific question requiring students to cite geographic evidence and demonstrate spatial thinking]

---

## üîó SOPHISTICATED CONNECTIONS

### Cross-Curricular Geographic Integration
**Mathematics:** [Specific mathematical geographic concepts from reading with data analysis]
**Science:** [Environmental geography connections from text with inquiry tasks]
**Language Arts:** [Academic writing opportunities using geographic evidence]

### Contemporary Geographic Connections
[How ancient geographic content connects to modern spatial patterns - specific examples]

### Geographic Thinking Skills Development
[How this lesson develops specific spatial reasoning and geographic analysis abilities]

---

## üìã ADVANCED MATERIALS & HANDOUTS

### Required Sophisticated Handouts
1. **Geographic Reading Guide:** [Section-by-section analysis with spatial thinking organizers]
2. **Tiered Vocabulary Handout:** [Geographic terms with pronunciation, context, and applications]
3. **Spatial Analysis Sheet:** [Graphic organizer for geographic reasoning and evidence]
4. **Text Evidence Tracker:** [Tool for recording geographic citations and spatial analysis]

### Technology Integration for Geographic Literacy
- [Specific digital geographic tools that enhance content comprehension]
- [QR codes linking to relevant geographic multimedia and primary sources]
- [Interactive maps and spatial analysis tools]

---

## üë®‚Äçüè´ IMPLEMENTATION GUIDE FOR SOPHISTICATED CONTENT

### Advanced Preparation (20 minutes)
[Specific preparation steps for complex geographic content and materials]

### During-Lesson Geographic Literacy Monitoring
**Listen For:** [Specific geographic vocabulary and spatial reasoning in student responses]
**Watch For:** [Visual evidence of geographic thinking and cultural understanding]
**Intervention Strategies:** [If students struggle with complex geographic concepts]

### Geographic Misconceptions from Content
[Specific geographic misconceptions students often develop from this reading]

### Time Management for Content Complexity
**If Behind Schedule:** [Modifications that maintain geographic learning integrity]
**If Ahead:** [Geographic extension activities that deepen spatial thinking]

### Substitute Teacher Guide for Complex Content
[Detailed explanation of sophisticated geographic work students are engaging in]

---

## üéØ SOPHISTICATED SUCCESS CRITERIA

### Geographic Literacy Evidence
Students demonstrate mastery through:
- [Accurate use of geographic vocabulary in context]
- [Quality of text-dependent geographic responses]
- [Sophistication of spatial analysis and reasoning]
- [Cultural sensitivity in geographic discussions]

### Lesson Sophistication Indicators
- All students engaged with complex geographic text and concepts
- Students citing specific evidence in spatial analysis
- Geographic thinking skills demonstrated through content analysis
- Academic geographic vocabulary used accurately and purposefully

---

**CONTENT SOPHISTICATION REQUIREMENT:** This lesson plan must demonstrate thorough analysis of the provided reading content and create activities that fully utilize its geographic educational potential. Every activity should connect directly to specific geographic information from the source materials, with paragraph references, spatial analysis requirements, and authentic geographic thinking tasks.

Make this lesson plan sophisticated enough to match the complexity of the geographic source materials while remaining practical and immediately implementable. Focus on developing advanced geographic literacy, spatial thinking, and cultural understanding through rich, content-specific activities that honor the depth of the source materials.`;
        }

        // Call OpenAI API
        async function callOpenAIAPI(prompt) {
            const model = document.getElementById('ai-model').value;
            const creativity = parseFloat(document.getElementById('creativity-level').value);

            // First try to use server-side API (Railway environment)
            try {
                const response = await fetch('/api/generate-lesson-plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        model: model,
                        temperature: creativity,
                        max_tokens: 4000
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.content;
                } else if (response.status === 503) {
                    // Server API not available, fall back to client-side
                    return await callOpenAIClientSide(prompt, model, creativity);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server request failed: ${response.status}`);
                }
            } catch (error) {
                console.log('Server API not available, trying client-side:', error.message);
                return await callOpenAIClientSide(prompt, model, creativity);
            }
        }

        // Fallback to client-side OpenAI API
        async function callOpenAIClientSide(prompt, model, creativity) {
            const apiKey = document.getElementById('api-key').value;
            
            if (!apiKey) {
                throw new Error('No API key available. Please contact your administrator or enter your own API key.');
            }

            // Helper function to determine correct token parameter based on model
            function getTokenParameter(model, maxTokens) {
                // GPT-5 and GPT-4.1 series use max_completion_tokens
                if (model.startsWith('gpt-5') || model.startsWith('gpt-4.1')) {
                    return { max_completion_tokens: maxTokens };
                }
                // Older models use max_tokens
                return { max_tokens: maxTokens };
            }

            const tokenParams = getTokenParameter(model, 4000);

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        {
                            role: 'system',
                            content: 'You are an expert geography teacher with 20+ years of experience creating engaging, standards-aligned lesson plans. You specialize in 7th-grade geography and understand how to make complex geographic concepts accessible and interesting for middle school students.'
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    temperature: creativity,
                    ...tokenParams
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `API request failed: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Display the generated lesson plan
        function displayGeneratedLessonPlan(lessonPlan) {
            generatedLessonPlan = lessonPlan;
            
            // Parse and format the lesson plan
            const formattedPlan = formatLessonPlan(lessonPlan);
            
            document.getElementById('lesson-plan-output').innerHTML = formattedPlan;
            document.getElementById('export-buttons').style.display = 'flex';
        }

        // Format the lesson plan with proper HTML structure
        function formatLessonPlan(planText) {
            // Split by sections and format
            let formatted = planText.replace(/\n/g, '<br>');
            
            // Format headers
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<h3>$1</h3>');
            formatted = formatted.replace(/(\d+\.\s\*\*.*?\*\*)/g, '<h3>$1</h3>');
            
            // Format bullet points
            formatted = formatted.replace(/(^|\<br\>)-\s/g, '$1‚Ä¢ ');
            
            // Wrap in proper structure
            return `
                <div class="lesson-plan-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #007bff;">
                        <h2 style="color: #007bff; margin: 0;">üìã Generated Lesson Plan</h2>
                        <span style="background: #e7f3ff; padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; color: #007bff; font-weight: bold;">
                            50 Minutes ‚Ä¢ ${document.getElementById('lesson-focus').value.charAt(0).toUpperCase() + document.getElementById('lesson-focus').value.slice(1)} Focus
                        </span>
                    </div>
                    <div style="line-height: 1.6;">
                        ${formatted}
                    </div>
                </div>
            `;
        }

        // Export functions
        function printLessonPlan() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Lesson Plan - ${currentLessonData.title}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                            h2, h3 { color: #007bff; }
                            .header { text-align: center; margin-bottom: 30px; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>üåç Geography Lesson Plan</h1>
                            <p><strong>Module ${currentLessonData.moduleNumber}:</strong> ${currentLessonData.title}</p>
                            <p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                        ${document.getElementById('lesson-plan-output').innerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function copyLessonPlan() {
            const textContent = generatedLessonPlan || document.getElementById('lesson-plan-output').textContent;
            navigator.clipboard.writeText(textContent).then(() => {
                alert('‚úÖ Lesson plan copied to clipboard!');
            }).catch(err => {
                console.error('Error copying to clipboard:', err);
                alert('‚ùå Failed to copy. Please select and copy manually.');
            });
        }

        function saveLessonPlan() {
            if (!generatedLessonPlan) return;
            
            const filename = `lesson-plan-${currentLessonData.moduleNumber}-${currentLessonData.lessonNumber}-${new Date().toISOString().split('T')[0]}.txt`;
            const blob = new Blob([generatedLessonPlan], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        // Navigation
        function goBack() {
            window.history.back();
        }

        // API key validation
        document.getElementById('api-key').addEventListener('input', function() {
            setTimeout(checkAPIStatus, 500);
        });

        // Auto-save API key
        document.getElementById('api-key').addEventListener('blur', function() {
            const apiKey = this.value;
            if (apiKey && apiKey.startsWith('sk-')) {
                localStorage.setItem('openai_api_key', apiKey);
            }
        });
    </script>
</body>
</html>
