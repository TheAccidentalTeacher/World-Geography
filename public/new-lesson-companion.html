<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="img-src 'self' data: blob: https://*.tile.openstreetmap.org https://server.arcgisonline.com https://*.tile.opentopomap.org https://*.tile.openstreetmap.fr https://earthquake.usgs.gov https://*.esri.com https://unpkg.com/*;">
    <meta name="cache-control" content="no-cache, no-store, must-revalidate">
    <title>Geography Lesson Companion</title>
    
    <!-- Leaflet for Enhanced Maps - No API Keys Required! -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3c72 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .navigation {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .lesson-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .lesson-selector label {
            font-weight: 600;
            color: #495057;
        }

        .lesson-selector select {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            min-width: 120px;
        }

        .lesson-selector button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .lesson-selector button:hover {
            background: #0056b3;
        }

        .content-area {
            display: flex;
            min-height: calc(100vh - 200px);
        }

        .sidebar {
            width: 720px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 25px;
            overflow-y: auto;
            height: fit-content;
        }

        .main-content {
            flex: 1;
            padding: 30px 50px;
            overflow-y: auto;
            max-width: calc(100% - 720px);
            display: flex;
            flex-direction: column;
            min-height: 100%;
        }

        .lesson-info {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        }

        .lesson-info h3 {
            color: #2c5aa0;
            margin-bottom: 15px;
            font-size: 1.1rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 8px;
        }

        .lesson-info ul {
            list-style: none;
        }

        .lesson-info li {
            background: #f8f9fa;
            margin: 8px 0;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            font-size: 0.9rem;
        }

        .lesson-info .vocab-term {
            background: #e7f3ff;
            border-left-color: #17a2b8;
            font-weight: 600;
        }

        .lesson-reading {
            background: white;
            line-height: 1.8;
            flex: 1;
            min-height: 100%;
            display: flex;
            flex-direction: column;
        }

        .lesson-content-wrapper {
            flex: 1;
            padding-bottom: 40px;
        }

        .supplementary-content {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            border: 1px solid #dee2e6;
        }

        .content-section {
            margin-bottom: 35px;
        }

        .content-section:last-child {
            margin-bottom: 0;
        }

        .content-section h3 {
            color: #2c5aa0;
            font-size: 1.4rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .key-terms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .term-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #17a2b8;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .term-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .connections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .connection-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: flex-start;
            gap: 15px;
            transition: transform 0.2s ease;
        }

        .connection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .subject-icon {
            font-size: 1.8rem;
            min-width: 40px;
        }

        .activities-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .activity-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: flex-start;
            gap: 15px;
            transition: transform 0.2s ease;
        }

        .activity-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .activity-icon {
            font-size: 1.5rem;
            min-width: 35px;
        }

        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .resource-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #6f42c1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .resource-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .resource-card h4 {
            color: #2c5aa0;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .resource-card p {
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .reflection-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .reflection-section h3 {
            color: white;
            border-bottom-color: rgba(255,255,255,0.3);
        }

        .reflection-questions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }

        .question-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid rgba(255,255,255,0.5);
        }

        .question-item p {
            margin: 0;
            color: white;
        }

        .question-item strong {
            color: #ffd700;
        }

        /* ENHANCED SIDEBAR STYLING - PHASE 1 & 2 */
        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .tab-button {
            flex: 1;
            min-width: 90px;
            padding: 10px 8px;
            border: none;
            background: #f8f9fa;
            color: #6c757d;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab-button.active {
            background: #007bff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,123,255,0.3);
        }

        .tab-button:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }

        /* VOCABULARY TAB STYLING */
        .vocabulary-cards-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .vocab-card {
            background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%);
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .vocab-card:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(255,193,7,0.3);
        }

        .vocab-term {
            font-weight: 600;
            color: #2c5aa0;
            margin-bottom: 5px;
        }

        .vocab-definition {
            font-size: 0.85rem;
            color: #6c757d;
            line-height: 1.4;
        }

        /* BLOOKET STYLING */
        .blooket-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .blooket-game-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .blooket-game-card h4 {
            color: #1976d2;
            margin: 0 0 10px 0;
            font-size: 0.95rem;
        }

        .blooket-launch-btn {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .blooket-launch-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(76,175,80,0.3);
        }

        /* AI LOOKUP STYLING */
        .ai-lookup-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .lookup-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .lookup-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .lookup-btn {
            background: linear-gradient(135deg, #6f42c1 0%, #5a2d91 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .lookup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(111,66,193,0.3);
        }

        .definition-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            border-left: 4px solid #6f42c1;
            display: none;
        }

        .definition-display.show {
            display: block;
        }

        /* AI TOOLS TAB STYLING */
        .ai-tool-card {
            background: linear-gradient(135deg, #f0f4ff 0%, #ffffff 100%);
            border: 1px solid #4dabf7;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .ai-tool-card h4 {
            color: #1971c2;
            margin: 0 0 8px 0;
        }

        .ai-tool-card p {
            color: #6c757d;
            font-size: 0.85rem;
            margin: 0 0 15px 0;
        }

        .ai-input {
            width: 100%;
            min-height: 60px;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            resize: vertical;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .ai-input:focus {
            outline: none;
            border-color: #4dabf7;
            box-shadow: 0 0 0 3px rgba(77,171,247,0.1);
        }

        .ai-action-btn {
            background: linear-gradient(135deg, #4dabf7 0%, #339af0 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .ai-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(77,171,247,0.3);
        }

        .ai-result {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #4dabf7;
            display: none;
        }

        .ai-result.show {
            display: block;
        }

        /* CONNECTIONS TAB STYLING */
        .connection-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #28a745;
        }

        .connection-card h4 {
            color: #2c5aa0;
            margin: 0 0 10px 0;
        }

        .cross-curricular-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .subject-connection-card {
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
            border: 1px solid #ffc9c9;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .subject-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .subject-connection-card h4 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: #2c5aa0;
        }

        /* PHASE 2 PLACEHOLDER STYLING */
        .phase-2-placeholder {
            opacity: 0.7;
            position: relative;
        }

        .coming-soon {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .placeholder-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            text-align: center;
        }

        .placeholder-card h4 {
            color: #6c757d;
            margin: 0 0 8px 0;
        }

        .placeholder-card p {
            color: #adb5bd;
            font-size: 0.85rem;
            margin: 0 0 12px 0;
        }

        .placeholder-btn {
            background: #dee2e6;
            color: #6c757d;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: not-allowed;
            font-size: 0.85rem;
        }

        /* RESPONSIVE ADJUSTMENTS */
        @media (max-width: 768px) {
            .tab-buttons {
                flex-direction: column;
            }
            
            .tab-button {
                flex: none;
                width: 100%;
            }
            
            .cross-curricular-grid {
                grid-template-columns: 1fr;
            }
        }

        .lesson-reading h1 {
            color: #2c5aa0;
            font-size: 2.2rem;
            margin-bottom: 30px;
            border-bottom: 3px solid #007bff;
            padding-bottom: 15px;
        }

        .lesson-reading h2 {
            color: #495057;
            font-size: 1.6rem;
            margin: 30px 0 15px;
            padding: 10px 0;
            border-left: 4px solid #17a2b8;
            padding-left: 15px;
            background: #f8f9fa;
        }

        .lesson-reading h3 {
            color: #6c757d;
            font-size: 1.3rem;
            margin: 25px 0 12px;
            font-weight: 600;
        }

        .lesson-reading p {
            margin-bottom: 18px;
            color: #495057;
            font-size: 1.1rem;
            line-height: 1.7;
            max-width: 800px;
        }

        .lesson-reading ul {
            margin: 15px 0;
            padding-left: 20px;
        }

        .lesson-reading li {
            margin: 10px 0;
            color: #495057;
            line-height: 1.6;
        }

        .lesson-reading strong {
            color: #2c5aa0;
            font-weight: 600;
        }

        .big-idea {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .main-ideas {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .key-terms {
            background: #f0f8f0;
            border: 1px solid #c3e6c3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .assessment {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-button {
            background: #e9ecef;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.8rem;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 90px;
        }

        .tab-button.active {
            background: #007bff;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Tablet responsive design */
        @media (max-width: 1200px) and (min-width: 769px) {
            .sidebar {
                width: 480px;
            }
            
            .main-content {
                max-width: calc(100% - 480px);
            }
        }

        @media (max-width: 768px) {
            .content-area {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
            
            .navigation {
                flex-direction: column;
                align-items: stretch;
            }
            
            .lesson-selector {
                justify-content: center;
            }
        }

        /* Cross-Curricular Section Styles */
        .cross-curricular-section {
            margin-top: 3rem;
            padding: 2rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        }
        
        .cross-curricular-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #2d3748;
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid #e2e8f0;
        }
        
        .cross-curricular-title .icon {
            font-size: 2rem;
        }
        
        .subject-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .subject-tab {
            padding: 0.75rem 1.5rem;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #4a5568;
        }
        
        .subject-tab:hover {
            background: #edf2f7;
            transform: translateY(-1px);
        }
        
        .subject-tab.active {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }
        
        .subject-content {
            display: none;
        }
        
        .subject-content.active {
            display: block;
        }
        
        .cross-curricular-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .activity-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .activity-card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }
        
        .activity-card h3 {
            color: #2d3748;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .activity-content {
            color: #4a5568;
            line-height: 1.8;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-content ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        
        .activity-content ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        
        .activity-content li {
            margin-bottom: 0.5rem;
        }
        
        .activity-content h4 {
            color: #2d3748;
            margin: 1rem 0 0.5rem 0;
            font-size: 1.1rem;
        }
        
        .activity-content strong {
            color: #2d3748;
            font-weight: 600;
        }
        
        .print-section {
            text-align: center;
            padding-top: 1rem;
            border-top: 2px solid #e2e8f0;
        }
        
        .print-button {
            background: #48bb78;
            color: white;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .print-button:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }
        
        /* Substitute Guide Button Styles */
        .substitute-guide-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }
        
        .substitute-print-button {
            background: #e53e3e;
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
        }
        
        .substitute-print-button:hover {
            background: #c53030;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(229, 62, 62, 0.4);
        }
        
        .substitute-description {
            margin: 0.75rem 0 0 0;
            color: white;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .loading-message {
            color: #718096;
            font-style: italic;
        }
        
        
        /* Calendar System Styles */
        .calendar-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            border: 1px solid #e9ecef;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
        }
        
        .calendar-header h3 {
            margin: 0;
            color: #2c5aa0;
            font-size: 1.4rem;
        }
        
        .calendar-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .calendar-nav {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }
        
        .calendar-nav:hover {
            background: #0056b3;
        }
        
        .date-range {
            font-weight: 600;
            color: #495057;
            font-size: 1.1rem;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 15px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 8px;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 80px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .calendar-day:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .calendar-day.weekend {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .calendar-day.holiday {
            background: #ffe6e6;
            color: #dc3545;
        }
        
        .calendar-day.orientation {
            background: #e3f2fd;
            color: #1976d2;
            border-color: #2196f3;
        }
        
        .calendar-day.available {
            background: #e8f5e8;
            border-color: #28a745;
        }
        
        .calendar-day.assigned {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .calendar-day.completed {
            background: #d1ecf1;
            border-color: #17a2b8;
        }
        
        .calendar-day.simulation {
            background: #e2e3e5;
            border-color: #6c757d;
        }
        
        .day-number {
            font-weight: bold;
            color: #495057;
        }
        
        .day-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
        }
        
        .lesson-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        .lesson-checkbox {
            position: absolute;
            top: 4px;
            right: 4px;
            transform: scale(1.2);
        }
        
        .calendar-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .legend-color.available { background: #e8f5e8; }
        .legend-color.assigned { background: #fff3cd; }
        .legend-color.completed { background: #d1ecf1; }
        .legend-color.holiday { background: #ffe6e6; }
        .legend-color.orientation { background: #e3f2fd; }
        .legend-color.simulation { background: #e2e3e5; }

        @media print {
            /* Hide navigation elements */
            .navigation, .sidebar, .subject-tabs, .print-section, .header {
                display: none !important;
            }
            
            /* Reset page styles for printing */
            body {
                background: white !important;
                color: black !important;
                font-family: Arial, sans-serif !important;
                margin: 0 !important;
                padding: 20px !important;
            }
            
            .container {
                background: white !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                max-width: none !important;
            }
            
            /* Cross-curricular section print styles */
            .cross-curricular-section {
                page-break-before: always;
                background: white !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .cross-curricular-title {
                font-size: 24px !important;
                margin-bottom: 20px !important;
                color: black !important;
                border-bottom: 2px solid black !important;
                padding-bottom: 10px !important;
            }
            
            /* Activity cards for printing */
            .cross-curricular-grid {
                display: block !important;
                grid-template-columns: none !important;
                gap: 0 !important;
            }
            
            .activity-card {
                background: white !important;
                border: 1px solid #ccc !important;
                border-radius: 0 !important;
                margin-bottom: 20px !important;
                padding: 15px !important;
                page-break-inside: avoid;
                box-shadow: none !important;
            }
            
            .activity-card h3 {
                font-size: 18px !important;
                margin-bottom: 10px !important;
                color: black !important;
            }
            
            .activity-content {
                color: black !important;
                line-height: 1.6 !important;
                max-height: none !important;
                overflow: visible !important;
            }
            
            .activity-content h4 {
                font-size: 16px !important;
                color: black !important;
                margin: 15px 0 8px 0 !important;
            }
            
            .activity-content ul, .activity-content ol {
                margin: 10px 0 !important;
                padding-left: 20px !important;
            }
            
            .activity-content li {
                margin-bottom: 8px !important;
                line-height: 1.4 !important;
            }
            
            .activity-content p {
                margin: 10px 0 !important;
                line-height: 1.5 !important;
            }
            
            .activity-content strong {
                font-weight: bold !important;
                color: black !important;
            }
            
            /* Print title styles */
            .print-title {
                font-size: 28px !important;
                font-weight: bold !important;
                margin-bottom: 20px !important;
                text-align: center !important;
                color: black !important;
                border-bottom: 3px solid black !important;
                padding-bottom: 15px !important;
            }
            
            /* Hide elements that shouldn't print */
            .loading-message {
                display: none !important;
            }
            
            /* Ensure proper page breaks */
            .activity-card:nth-child(2) {
                page-break-before: auto;
            }
            
            /* Footer for each page */
            @page {
                margin: 1in;
                @bottom-center {
                    content: "Geography Cross-Curricular Lesson - Page " counter(page);
                }
            }
        }
        
        /* Enhanced Maps Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Map Controls Panel Animations */
        @keyframes slideIn {
            from { 
                transform: translateX(100%);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from { 
                transform: translateX(0);
                opacity: 1;
            }
            to { 
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Fullscreen Map Styles */
        .map-fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            border-radius: 0 !important;
            border: none !important;
        }
        
        .map-fullscreen #enhanced-map {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Control Toggle Buttons */
        .map-control-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .map-control-toggle:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.05);
        }
        
        .map-fullscreen-toggle {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .map-fullscreen-toggle:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.05);
        }
        
        /* Map overlay transition styles */
        .map-overlay {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .map-overlay.hidden {
            animation: slideOut 0.4s ease-out forwards;
        }
        
        .map-overlay.visible {
            animation: slideIn 0.4s ease-out forwards;
        }
        
        @media (max-width: 768px) {
            .cross-curricular-grid {
                grid-template-columns: 1fr;
            }
            
            .subject-tabs {
                flex-direction: column;
            }
            
            .subject-tab {
                text-align: center;
            }
        }

        /* Enhanced Map Lesson Integration Styles */
        #map-skills-panel, #geographic-focus-panel, #map-activities-panel {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        #map-skills-panel {
            border-left-color: #28a745;
        }

        #geographic-focus-panel {
            border-left-color: #ffc107;
        }

        #map-activities-panel {
            border-left-color: #17a2b8;
        }

        .lesson-skill-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .lesson-skill-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .activity-card {
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .activity-card:hover {
            transform: translateY(-1px);
            border-color: #007bff !important;
        }

        .focus-area-tag {
            transition: transform 0.2s ease;
        }

        .focus-area-tag:hover {
            transform: scale(1.05);
        }

        /* Activity Modal Enhancements */
        #activity-modal {
            animation: modalSlideIn 0.3s ease;
        }

        #activity-backdrop {
            animation: backdropFadeIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        @keyframes backdropFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* EPIC LOAD ACTIVITIES ANIMATIONS */
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes successPulse {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(86, 171, 47, 0.7);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(86, 171, 47, 0.3);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 0 0 20px rgba(86, 171, 47, 0);
            }
        }

        @keyframes particleExplosion {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translate(
                    calc(cos(var(--angle)) * 150px),
                    calc(sin(var(--angle)) * 150px)
                ) scale(0.3);
                opacity: 0;
            }
        }

        @keyframes floatSparkle {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            50% {
                transform: translateY(-30px) scale(1.2);
                opacity: 0.8;
            }
            100% {
                transform: translateY(-60px) scale(0.8);
                opacity: 0;
            }
        }

        @keyframes panelReveal {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            60% {
                opacity: 1;
                transform: translateY(-5px) scale(1.02);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes cardSparkle {
            0% {
                transform: scale(1) rotate(0deg);
                filter: brightness(1);
            }
            50% {
                transform: scale(1.03) rotate(1deg);
                filter: brightness(1.1);
            }
            100% {
                transform: scale(1) rotate(0deg);
                filter: brightness(1);
            }
        }

        /* Enhanced Activity Button Hover Effects */
        #loadLessonActivities {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #loadLessonActivities:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(253, 126, 20, 0.4);
        }

        #loadLessonActivities:active {
            transform: translateY(0) scale(0.98);
        }

        /* Cool ripple effect for activity cards */
        .activity-card-cool {
            position: relative;
            overflow: hidden;
        }

        .activity-card-cool::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(23, 162, 184, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
            z-index: 1;
        }

        .activity-card-cool:hover::before {
            width: 300px;
            height: 300px;
        }

        @keyframes cardReveal {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes iconBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        /* Button ripple effect */
        .button-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        @keyframes slideInOut {
            0% {
                opacity: 0;
                transform: translateX(100%);
            }
            20%, 80% {
                opacity: 1;
                transform: translateX(0);
            }
            100% {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* Physical Feature Marker Styles */
        .physical-feature-marker {
            background: rgba(23, 162, 184, 0.9);
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            animation: markerPulse 2s infinite;
        }

        .regional-feature-marker {
            background: rgba(40, 167, 69, 0.9);
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            animation: markerGlow 3s infinite;
        }

        .climate-marker {
            background: rgba(255, 193, 7, 0.9);
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            animation: markerPulse 2s infinite;
        }

        .climate-zone-marker {
            background: rgba(253, 126, 20, 0.9);
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            animation: markerGlow 3s infinite;
        }

        @keyframes markerPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
        }

        @keyframes markerGlow {
            0%, 100% {
                box-shadow: 0 0 5px rgba(40, 167, 69, 0.5);
            }
            50% {
                box-shadow: 0 0 15px rgba(40, 167, 69, 0.8);
            }
        }

        @keyframes skillReveal {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.8) rotate(-5deg);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1) rotate(0deg);
            }
        }

        @keyframes skillIconFloat {
            0%, 100% { 
                transform: translateY(0) scale(1); 
            }
            50% { 
                transform: translateY(-5px) scale(1.1); 
            }
        }

        .skill-card-cool:hover .skill-glow {
            opacity: 1 !important;
        }

        /* Interactive Elements */
        .exploration-checklist label {
            display: block;
            padding: 5px;
            margin: 3px 0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .exploration-checklist label:hover {
            background-color: rgba(0,123,255,0.1);
            border-radius: 3px;
        }

        .exploration-checklist input[type="checkbox"] {
            margin-right: 8px;
        }

        /* Responsive Design for Map Panels */
        @media (max-width: 768px) {
            #lesson-skills-list {
                grid-template-columns: 1fr;
            }
            
            #lesson-activities-list {
                grid-template-columns: 1fr;
            }
            
            #focus-areas-list {
                justify-content: center;
            }
            
            #activity-modal {
                margin: 10px;
                max-width: calc(100vw - 20px);
                max-height: calc(100vh - 20px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌍 Geography Lesson Companion</h1>
            <p>Interactive Teacher & Student Resources</p>
        </div>

        <!-- Dynamic 2-Week Calendar System -->
        <div class="calendar-section" id="calendar-section">
            <div class="calendar-header">
                <h3>📅 2-Week Lesson Calendar</h3>
                <div class="calendar-controls">
                    <button onclick="moveCalendar(-14)" class="calendar-nav">⬅️ Previous 2 Weeks</button>
                    <span id="calendar-date-range" class="date-range">Loading...</span>
                    <button onclick="moveCalendar(14)" class="calendar-nav">Next 2 Weeks ➡️</button>
                </div>
            </div>
            
            <div class="calendar-grid" id="calendar-grid">
                <!-- Calendar will be dynamically generated here -->
            </div>
            
            <div class="calendar-legend">
                <div class="legend-item"><span class="legend-color available"></span> Available for lessons</div>
                <div class="legend-item"><span class="legend-color assigned"></span> Lesson assigned</div>
                <div class="legend-item"><span class="legend-color completed"></span> Lesson completed</div>
                <div class="legend-item"><span class="legend-color holiday"></span> No school</div>
                <div class="legend-item"><span class="legend-color orientation"></span> Orientation</div>
                <div class="legend-item"><span class="legend-color simulation"></span> Simulation day</div>
            </div>
            
            <div class="calendar-management" style="margin-top: 15px; text-align: center; padding-top: 15px; border-top: 1px solid #e9ecef;">
                <button onclick="autoAssignLessons()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; margin: 0 5px; cursor: pointer; font-weight: 600;">
                    🚀 Auto-Assign Next 10 Lessons
                </button>
                <button onclick="clearAllAssignments()" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; margin: 0 5px; cursor: pointer; font-weight: 600;">
                    🗑️ Clear All Assignments
                </button>
                <span id="assignment-status" style="margin-left: 15px; font-weight: 600; color: #495057;"></span>
            </div>
        </div>

        <div class="navigation">
            <div class="lesson-selector">
                <label for="moduleSelect">Module:</label>
                <select id="moduleSelect">
                    <option value="">Loading modules...</option>
                </select>
                
                <label for="lessonSelect">Lesson:</label>
                <select id="lessonSelect">
                    <option value="">Select module first</option>
                </select>
                
                <button onclick="loadLesson()">Load Lesson</button>
            </div>
            
            <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                <div style="display: flex; gap: 8px; align-items: center; margin-right: 15px;">
                    <span style="font-weight: 600; color: #495057; font-size: 0.9rem;">Quarterly Simulations:</span>
                    <a href="/geographic-detective-academy.html" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 6px; text-decoration: none; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 4px; font-size: 0.85rem;">
                        🕵️ Q1: Detective Academy
                    </a>
                    <a href="/international-trade-empire.html" style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 6px; text-decoration: none; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 4px; font-size: 0.85rem; opacity: 0.7;" title="Coming Soon">
                        🌍 Q2: Trade Empire
                    </a>
                    <a href="/disaster-response-agency.html" style="background: #ffc107; color: #212529; border: none; padding: 8px 12px; border-radius: 6px; text-decoration: none; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 4px; font-size: 0.85rem; opacity: 0.7;" title="Coming Soon">
                        🌪️ Q3: Disaster Response
                    </a>
                    <a href="/future-earth-2050.html" style="background: #6f42c1; color: white; border: none; padding: 8px 12px; border-radius: 6px; text-decoration: none; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 4px; font-size: 0.85rem; opacity: 0.7;" title="Coming Soon">
                        🚀 Q4: Future Earth
                    </a>
                </div>
                <button onclick="previousLesson()" id="prevBtn" disabled>← Previous</button>
                <button onclick="nextLesson()" id="nextBtn" style="margin-left: 10px;">Next →</button>
            </div>
        </div>

        <div class="content-area">
            <div class="sidebar">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="showTab('teacher')">Teacher Guide</button>
                    <button class="tab-button" onclick="showTab('vocabulary')">📚 Vocabulary</button>
                    <button class="tab-button" onclick="showTab('maps')">🗺️ Enhanced Maps</button>
                    <button class="tab-button" onclick="showTab('ai-tools')">🤖 AI Tools</button>
                    <button class="tab-button" onclick="showTab('connections')">🔗 Connections</button>
                </div>

                <!-- AI GEOGRAPHY HUB LINK -->
                <div style="margin: 15px 0; text-align: center;">
                    <a href="/ai-geography-hub" target="_blank" style="
                        display: inline-block;
                        background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
                        color: white;
                        padding: 12px 20px;
                        border-radius: 25px;
                        text-decoration: none;
                        font-weight: bold;
                        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
                        transition: all 0.3s;
                        border: 2px solid transparent;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 107, 107, 0.4)'" 
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255, 107, 107, 0.3)'">
                        🚀 Open AI Geography Hub
                    </a>
                    <p style="font-size: 0.8rem; color: #666; margin-top: 8px;">
                        Advanced AI tools for content creation & research
                    </p>
                </div>

                <!-- PHASE 1: TEACHER GUIDE TAB -->
                <div id="teacher-tab" class="tab-content active">
                    <div class="lesson-info">
                        <h3>📋 Lesson Overview</h3>
                        <ul>
                            <li><strong>Module:</strong> <span id="module-title">Select a lesson</span></li>
                            <li><strong>Lesson:</strong> <span id="lesson-title">No lesson selected</span></li>
                            <li><strong>Time:</strong> <span id="time-estimate">45 minutes</span></li>
                        </ul>
                    </div>

                    <div class="lesson-info">
                        <h3>📋 Learning Objectives</h3>
                        <ul id="objectives-list">
                            <li class="loading">Loading objectives...</li>
                        </ul>
                    </div>

                    <div class="lesson-info">
                        <h3>📚 Materials Needed</h3>
                        <ul id="materials-list">
                            <li class="loading">Loading materials...</li>
                        </ul>
                    </div>

                    <div class="lesson-info">
                        <h3>🔧 Teaching Procedures</h3>
                        <ul id="procedures-list">
                            <li class="loading">Loading procedures...</li>
                        </ul>
                    </div>

                    <div class="lesson-info">
                        <h3>📝 Assessment Methods</h3>
                        <ul id="assessments-list">
                            <li class="loading">Loading assessments...</li>
                        </ul>
                    </div>

                    <div class="lesson-info">
                        <h3>🎯 Student Activities</h3>
                        <ul id="activities-list">
                            <li class="loading">Loading activities...</li>
                        </ul>
                    </div>

                    <div class="lesson-info">
                        <h3>📚 Key Vocabulary</h3>
                        <div id="vocabulary-container">
                            <p class="loading">Loading vocabulary terms...</p>
                        </div>
                    </div>
                    
                    <!-- Substitute Guide Print Button -->
                    <div class="substitute-guide-section">
                        <button onclick="printSubstituteGuide()" class="substitute-print-button">
                            🖨️ Print Substitute Teacher Guide
                        </button>
                        <p class="substitute-description">Complete lesson plan with student reading and teacher instructions</p>
                    </div>
                </div>

                <!-- PHASE 1: VOCABULARY TAB - FULLY IMPLEMENTED -->
                <div id="vocabulary-tab" class="tab-content">
                    <div class="lesson-info">
                        <h3>📖 Lesson Vocabulary</h3>
                        <div id="vocabulary-cards" class="vocabulary-cards-container">
                            <div class="loading">Loading vocabulary terms...</div>
                        </div>
                    </div>

                    <div class="lesson-info">
                        <h3>🎮 Blooket Games</h3>
                        <div class="blooket-section">
                            <div class="blooket-game-card">
                                <h4>Geography Vocabulary Challenge</h4>
                                <button onclick="launchBlooketGame('vocabulary')" class="blooket-launch-btn">
                                    🚀 Launch Vocab Game
                                </button>
                            </div>
                            <div class="blooket-game-card">
                                <h4>Geographic Terms Quiz</h4>
                                <button onclick="launchBlooketGame('terms')" class="blooket-launch-btn">
                                    🎯 Launch Terms Quiz
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="lesson-info">
                        <h3>🔍 AI Definition Lookup</h3>
                        <div class="ai-lookup-section">
                            <input type="text" id="lookup-input" placeholder="Enter geographic term..." class="lookup-input">
                            <button onclick="lookupDefinition()" class="lookup-btn">
                                🤖 Get AI Definition
                            </button>
                            <div id="definition-display" class="definition-display"></div>
                        </div>
                    </div>
                </div>

                <!-- PHASE 1: AI TOOLS TAB - FULLY IMPLEMENTED -->
                <div id="ai-tools-tab" class="tab-content">
                    <div class="lesson-info">
                        <h3>🤖 AI-Powered Learning</h3>
                        <div class="ai-tool-card">
                            <h4>📝 Concept Explainer</h4>
                            <p>AI explains complex geographic concepts in simple terms</p>
                            <textarea id="concept-input" placeholder="Enter a geographic concept you'd like explained..." class="ai-input"></textarea>
                            <button onclick="explainConcept()" class="ai-action-btn">
                                ✨ Explain This Concept
                            </button>
                            <div id="concept-result" class="ai-result"></div>
                        </div>

                        <div class="ai-tool-card">
                            <h4>🌍 Real-World Connections</h4>
                            <p>Find current events and examples related to this lesson</p>
                            <button onclick="findConnections()" class="ai-action-btn">
                                🔗 Find Current Examples
                            </button>
                            <div id="connections-result" class="ai-result"></div>
                        </div>

                        <div class="ai-tool-card">
                            <h4>❓ Question Generator</h4>
                            <p>Generate study questions for any geographic topic</p>
                            <textarea id="question-input" placeholder="Enter a topic for question generation..." class="ai-input"></textarea>
                            <button onclick="generateQuestions()" class="ai-action-btn">
                                📝 Generate Questions
                            </button>
                            <div id="question-result" class="ai-result"></div>
                        </div>

                        <div class="ai-tool-card">
                            <h4>🎓 Subject Connections</h4>
                            <p>Find connections between geography and other subjects</p>
                            <textarea id="connection-input" placeholder="Enter a subject area (Math, Science, History, ELA)..." class="ai-input"></textarea>
                            <button onclick="createConnection()" class="ai-action-btn">
                                🔗 Create Connection
                            </button>
                            <div id="connection-result" class="ai-result"></div>
                        </div>
                    </div>

                    <!-- PHASE 2 PLACEHOLDERS -->
                    <div class="lesson-info phase-2-placeholder">
                        <h3>🎨 Advanced AI Features <span class="coming-soon">Coming Soon</span></h3>
                        <div class="placeholder-card">
                            <h4>📸 Image Generation</h4>
                            <p>AI-generated images to visualize geographic concepts</p>
                            <button class="placeholder-btn" disabled>🔒 Phase 2 Feature</button>
                        </div>
                        <div class="placeholder-card">
                            <h4>🎭 Interactive Storytelling</h4>
                            <p>AI creates engaging narratives about geographic regions</p>
                            <button class="placeholder-btn" disabled>🔒 Phase 2 Feature</button>
                        </div>
                    </div>
                </div>

                <!-- ENHANCED MAPS TAB -->
                <div id="maps-tab" class="tab-content">
                    <div class="lesson-info">
                        <h3>🗺️ Enhanced Curriculum Maps</h3>
                        <p style="margin-bottom: 15px; color: #666;">Interactive educational mapping system with lesson-specific skills and activities.</p>
                        
                        <div id="map-lesson-info" style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                            <strong>Current Lesson:</strong> <span id="map-current-lesson">Select a lesson to view relevant geographic content</span>
                            <div id="lesson-objectives" style="margin-top: 8px; font-size: 13px; color: #555;"></div>
                        </div>
                        
                        <!-- Map Skills Panel -->
                        <div id="map-skills-panel" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: none;">
                            <h4 style="margin: 0 0 10px 0; color: #495057; font-size: 16px;">📚 Map Reading Skills for This Lesson</h4>
                            <div id="lesson-skills-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;"></div>
                        </div>
                        
                        <!-- Geographic Focus Panel -->
                        <div id="geographic-focus-panel" style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: none;">
                            <h4 style="margin: 0 0 10px 0; color: #856404; font-size: 16px;">🎯 Geographic Focus Areas</h4>
                            <div id="focus-areas-list" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                        </div>
                        
                        <!-- Interactive Map Activities -->
                        <div id="map-activities-panel" style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: none;">
                            <h4 style="margin: 0 0 10px 0; color: #0c5460; font-size: 16px;">🎮 Interactive Map Activities</h4>
                            <div id="lesson-activities-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;"></div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                            <button id="focusLessonRegion" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">📍 Focus on Lesson Region</button>
                            <button id="showLessonData" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">📊 Show Lesson Data</button>
                            <button id="loadLessonActivities" style="background: #fd7e14; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">🎯 Load Activities</button>
                            <button id="resetMapView" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">🌍 Global View</button>
                        </div>
                    </div>
                    
                    <div class="enhanced-map-container" style="height: 600px; border-radius: 12px; overflow: hidden; position: relative; background: #f8f9fa; border: 2px solid #dee2e6;">
                        <div id="enhanced-map" style="width: 100%; height: 100%;"></div>
                        
                        <!-- Fullscreen Toggle Button -->
                        <button id="map-fullscreen-toggle" class="map-fullscreen-toggle" title="Toggle Fullscreen">
                            <span id="fullscreen-icon">🔍</span> <span id="fullscreen-text">Fullscreen</span>
                        </button>
                        
                        <!-- Controls Toggle Button -->
                        <button id="map-controls-toggle" class="map-control-toggle" title="Toggle Map Controls">
                            <span id="controls-icon">⚙️</span> <span id="controls-text">Controls</span>
                        </button>
                        
                        <div id="map-overlay" class="map-overlay visible" style="position: absolute; top: 60px; right: 15px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000; min-width: 280px; max-height: 80vh; overflow-y: auto;">
                            <h4 style="margin-bottom: 10px; color: #2c3e50; font-size: 1em;">📍 Educational Map Layers</h4>
                            
                            <!-- Base Map Styles -->
                            <div class="style-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 15px;">
                                <button class="map-style-btn active" data-style="streets-v12" style="padding: 6px 10px; border: 2px solid #ddd; border-radius: 6px; background: #4CAF50; color: white; cursor: pointer; font-size: 11px;">Streets</button>
                                <button class="map-style-btn" data-style="satellite-streets-v12" style="padding: 6px 10px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-size: 11px;">Satellite</button>
                                <button class="map-style-btn" data-style="outdoors-v12" style="padding: 6px 10px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-size: 11px;">Terrain</button>
                                <button class="map-style-btn" data-style="light-v11" style="padding: 6px 10px; border: 2px solid #ddd; border-radius: 6px; background: white; cursor: pointer; font-size: 11px;">Historical</button>
                            </div>
                            
                            <!-- Physical Geography -->
                            <div class="layer-category" style="border-top: 1px solid #eee; padding-top: 10px; margin-bottom: 12px;">
                                <h5 style="margin-bottom: 8px; color: #2c3e50; font-size: 12px; cursor: pointer;" onclick="toggleCategory('physical')">
                                    🌍 Physical Geography <span id="physical-arrow">▼</span>
                                </h5>
                                <div id="physical-layers" style="margin-left: 8px;">
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapEarthquakeToggle" style="width: 14px; height: 14px;">
                                        <label for="mapEarthquakeToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🔴 Live Earthquakes (USGS)</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapVolcanoToggle" style="width: 14px; height: 14px;">
                                        <label for="mapVolcanoToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🌋 Active Volcanoes</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapOceanCurrentsToggle" style="width: 14px; height: 14px;">
                                        <label for="mapOceanCurrentsToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🌊 Ocean Currents</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapPlateToggle" style="width: 14px; height: 14px;">
                                        <label for="mapPlateToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">⚡ Tectonic Plates</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Political Geography -->
                            <div class="layer-category" style="border-top: 1px solid #eee; padding-top: 10px; margin-bottom: 12px;">
                                <h5 style="margin-bottom: 8px; color: #2c3e50; font-size: 12px; cursor: pointer;" onclick="toggleCategory('political')">
                                    🏛️ Political Geography <span id="political-arrow">▼</span>
                                </h5>
                                <div id="political-layers" style="margin-left: 8px;">
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapNatoToggle" style="width: 14px; height: 14px;">
                                        <label for="mapNatoToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🛡️ NATO Members</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapEuToggle" style="width: 14px; height: 14px;">
                                        <label for="mapEuToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🇪🇺 European Union</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapG7Toggle" style="width: 14px; height: 14px;">
                                        <label for="mapG7Toggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">💰 G7 Countries</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapConflictToggle" style="width: 14px; height: 14px;">
                                        <label for="mapConflictToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">⚔️ Current Conflicts</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Economic Geography -->
                            <div class="layer-category" style="border-top: 1px solid #eee; padding-top: 10px; margin-bottom: 12px;">
                                <h5 style="margin-bottom: 8px; color: #2c3e50; font-size: 12px; cursor: pointer;" onclick="toggleCategory('economic')">
                                    💰 Economic Geography <span id="economic-arrow">▼</span>
                                </h5>
                                <div id="economic-layers" style="margin-left: 8px;">
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapTradeToggle" style="width: 14px; height: 14px;">
                                        <label for="mapTradeToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🚢 Major Trade Routes</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapOilToggle" style="width: 14px; height: 14px;">
                                        <label for="mapOilToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🛢️ Oil & Gas Fields</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapCurrencyToggle" style="width: 14px; height: 14px;">
                                        <label for="mapCurrencyToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">💱 Currency Zones</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapGdpToggle" style="width: 14px; height: 14px;">
                                        <label for="mapGdpToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">📊 GDP per Capita</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Historical Geography -->
                            <div class="layer-category" style="border-top: 1px solid #eee; padding-top: 10px; margin-bottom: 12px;">
                                <h5 style="margin-bottom: 8px; color: #2c3e50; font-size: 12px; cursor: pointer;" onclick="toggleCategory('historical')">
                                    📜 Historical Geography <span id="historical-arrow">▼</span>
                                </h5>
                                <div id="historical-layers" style="margin-left: 8px;">
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapSilkRoadToggle" style="width: 14px; height: 14px;">
                                        <label for="mapSilkRoadToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🐪 Silk Road Routes</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapColonialToggle" style="width: 14px; height: 14px;">
                                        <label for="mapColonialToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🏴‍☠️ Colonial Empires</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapAncientToggle" style="width: 14px; height: 14px;">
                                        <label for="mapAncientToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🏛️ Ancient Civilizations</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapColdWarToggle" style="width: 14px; height: 14px;">
                                        <label for="mapColdWarToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">❄️ Cold War Divisions</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Cultural Geography -->
                            <div class="layer-category" style="border-top: 1px solid #eee; padding-top: 10px; margin-bottom: 12px;">
                                <h5 style="margin-bottom: 8px; color: #2c3e50; font-size: 12px; cursor: pointer;" onclick="toggleCategory('cultural')">
                                    🌐 Cultural Geography <span id="cultural-arrow">▼</span>
                                </h5>
                                <div id="cultural-layers" style="margin-left: 8px;">
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapLanguageToggle" style="width: 14px; height: 14px;">
                                        <label for="mapLanguageToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🗣️ Language Families</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapReligionToggle" style="width: 14px; height: 14px;">
                                        <label for="mapReligionToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">✨ Major Religions</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapHeritageToggle" style="width: 14px; height: 14px;">
                                        <label for="mapHeritageToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🏛️ UNESCO Heritage</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapMigrationToggle" style="width: 14px; height: 14px;">
                                        <label for="mapMigrationToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🚶 Migration Patterns</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Urban & Population -->
                            <div class="layer-category" style="border-top: 1px solid #eee; padding-top: 10px; margin-bottom: 12px;">
                                <h5 style="margin-bottom: 8px; color: #2c3e50; font-size: 12px; cursor: pointer;" onclick="toggleCategory('urban')">
                                    🏙️ Urban Geography <span id="urban-arrow">▼</span>
                                </h5>
                                <div id="urban-layers" style="margin-left: 8px;">
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapCitiesToggle" style="width: 14px; height: 14px;">
                                        <label for="mapCitiesToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🌆 Major Cities</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapMegacitiesToggle" style="width: 14px; height: 14px;">
                                        <label for="mapMegacitiesToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🏙️ Megacities (10M+)</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapPopDensityToggle" style="width: 14px; height: 14px;">
                                        <label for="mapPopDensityToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">👥 Population Density</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapTimeZoneToggle" style="width: 14px; height: 14px;">
                                        <label for="mapTimeZoneToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🕒 Time Zones</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Environmental -->
                            <div class="layer-category" style="border-top: 1px solid #eee; padding-top: 10px; margin-bottom: 12px;">
                                <h5 style="margin-bottom: 8px; color: #2c3e50; font-size: 12px; cursor: pointer;" onclick="toggleCategory('environmental')">
                                    🌿 Environmental <span id="environmental-arrow">▼</span>
                                </h5>
                                <div id="environmental-layers" style="margin-left: 8px;">
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapClimateToggle" style="width: 14px; height: 14px;">
                                        <label for="mapClimateToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🌡️ Climate Zones</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapDeforestationToggle" style="width: 14px; height: 14px;">
                                        <label for="mapDeforestationToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🌳 Deforestation</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapBiodiversityToggle" style="width: 14px; height: 14px;">
                                        <label for="mapBiodiversityToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🦋 Biodiversity Hotspots</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
                                        <input type="checkbox" id="mapCarbonToggle" style="width: 14px; height: 14px;">
                                        <label for="mapCarbonToggle" style="cursor: pointer; font-size: 11px; color: #2c3e50;">🏭 Carbon Emissions</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="map-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 2000; display: none;">
                            <div style="width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #4CAF50; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                            <div style="font-size: 14px; color: #2c3e50;">Loading map data...</div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.9); padding: 10px 15px; text-align: center; font-size: 13px; color: #2c3e50; border-radius: 0 0 12px 12px; border: 2px solid #dee2e6; border-top: none;">
                        <span id="map-status">Enhanced Maps ready - Select a lesson to see relevant geographic content</span>
                    </div>
                </div>

                <!-- PHASE 1: CONNECTIONS TAB - BASIC IMPLEMENTATION -->
                <div id="connections-tab" class="tab-content">
                    <div class="lesson-info">
                        <h3>🔗 Cross-Lesson Connections</h3>
                        <div id="lesson-connections-container">
                            <div class="connection-card">
                                <h4>📚 Previous Lessons</h4>
                                <div id="previous-lessons">Loading connections...</div>
                            </div>
                            <div class="connection-card">
                                <h4>🔜 Upcoming Topics</h4>
                                <div id="upcoming-lessons">Loading connections...</div>
                            </div>
                        </div>
                    </div>

                    <div class="lesson-info">
                        <h3>� Cross-Curricular Links</h3>
                        <div class="cross-curricular-grid">
                            <div class="subject-connection-card">
                                <span class="subject-icon">📚</span>
                                <h4>English Language Arts</h4>
                                <div id="ela-connections">Loading ELA connections...</div>
                            </div>
                            <div class="subject-connection-card">
                                <span class="subject-icon">🔬</span>
                                <h4>Science</h4>
                                <div id="science-connections">Loading science connections...</div>
                            </div>
                        </div>
                    </div>

                    <!-- PHASE 2 PLACEHOLDERS -->
                    <div class="lesson-info phase-2-placeholder">
                        <h3>🍳 Cultural Experiences <span class="coming-soon">Coming Soon</span></h3>
                        <div class="placeholder-card">
                            <h4>🥘 Regional Recipes</h4>
                            <p>Authentic recipes from the geographic regions being studied</p>
                            <button class="placeholder-btn" disabled>🔒 Phase 2 Feature</button>
                        </div>
                    </div>

                    <div class="lesson-info phase-2-placeholder">
                        <h3>📰 Current Events <span class="coming-soon">Coming Soon</span></h3>
                        <div class="placeholder-card">
                            <h4>🌍 Live Geographic News</h4>
                            <p>Curated current events related to lesson topics</p>
                            <button class="placeholder-btn" disabled>🔒 Phase 2 Feature</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div id="lesson-content">
                    <div class="loading">
                        <h2>👋 Welcome to Geography Lesson Companion</h2>
                        <p>Select a module and lesson from the navigation above to begin exploring detailed curriculum content.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cross-Curricular Integration Section -->
        <div class="cross-curricular-section" id="cross-curricular-section" style="display: none;">
            <h2 class="cross-curricular-title">
                <span class="icon">🔗</span>
                Cross-Curricular Connections
            </h2>
            
            <div class="subject-tabs">
                <button class="subject-tab active" onclick="showSubjectContent('ela')">
                    📚 English Language Arts (7th Grade)
                </button>
                <button class="subject-tab" onclick="showSubjectContent('science')">
                    🔬 Science Integration
                </button>
            </div>
            
            <div id="ela-content" class="subject-content active">
                <div class="cross-curricular-grid">
                    <div class="activity-card">
                        <h3>📖 Reading Comprehension</h3>
                        <div id="ela-reading-content" class="activity-content">
                            <p class="loading-message">Loading ELA reading content...</p>
                        </div>
                    </div>
                    
                    <div class="activity-card">
                        <h3>✍️ Writing Prompts</h3>
                        <div id="ela-writing-content" class="activity-content">
                            <p class="loading-message">Loading writing prompts...</p>
                        </div>
                    </div>
                    
                    <div class="activity-card">
                        <h3>📝 Vocabulary Practice</h3>
                        <div id="ela-vocabulary-content" class="activity-content">
                            <p class="loading-message">Loading vocabulary exercises...</p>
                        </div>
                    </div>
                    
                    <div class="activity-card">
                        <h3>💭 Critical Thinking</h3>
                        <div id="ela-critical-content" class="activity-content">
                            <p class="loading-message">Loading discussion questions...</p>
                        </div>
                    </div>
                </div>
                
                <div class="print-section">
                    <button onclick="printELALesson()" class="print-button">
                        🖨️ Print Complete ELA Lesson
                    </button>
                </div>
            </div>
            
            <div id="science-content" class="subject-content">
                <div class="cross-curricular-grid">
                    <div class="activity-card">
                        <h3>🌍 Earth Science Connections</h3>
                        <div id="science-earth-content" class="activity-content">
                            <p class="loading-message">Loading earth science content...</p>
                        </div>
                    </div>
                    
                    <div class="activity-card">
                        <h3>🌡️ Scientific Concepts</h3>
                        <div id="science-concepts-content" class="activity-content">
                            <p class="loading-message">Loading scientific concepts...</p>
                        </div>
                    </div>
                    
                    <div class="activity-card">
                        <h3>🔬 Lab Activities</h3>
                        <div id="science-lab-content" class="activity-content">
                            <p class="loading-message">Loading lab activities...</p>
                        </div>
                    </div>
                    
                    <div class="activity-card">
                        <h3>📊 Data Analysis</h3>
                        <div id="science-data-content" class="activity-content">
                            <p class="loading-message">Loading data exercises...</p>
                        </div>
                    </div>
                </div>
                
                <div class="print-section">
                    <button onclick="printScienceLesson()" class="print-button">
                        🖨️ Print Complete Science Lesson
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentLessonDay = 1;
        let modules = [];
        let allLessons = [];
        
        // Calendar system variables
        let currentCalendarStart = new Date();
        let lessonAssignments = JSON.parse(localStorage.getItem('lessonAssignments') || '{}');
        let completedLessons = JSON.parse(localStorage.getItem('completedLessons') || '{}');
        let lastAction = null; // Track last action for undo functionality
        
        // Official Copper River School District Calendar 2025-2026 (from PDF)
        const schoolCalendar = {
            schoolYear: '2025-2026',
            schoolOpens: new Date('2025-08-18'),
            lastDay: new Date('2026-05-21'),
            
            // First 2 weeks are orientation (no direct curriculum)
            curriculumStart: new Date('2025-09-02'), // After Labor Day
            curriculumEnd: new Date('2026-05-16'),   // Before graduation activities
            
            // Official holidays from PDF
            holidays: [
                '2025-09-01', // Labor Day
                '2025-10-12', '2025-10-13', '2025-10-14', '2025-10-15', // Fall Break
                '2025-10-21', // Parent/Teacher Conferences
                '2025-11-27', '2025-11-28', // Thanksgiving Break
                '2025-12-22', '2025-12-23', '2025-12-24', '2025-12-25', '2025-12-26',
                '2025-12-27', '2025-12-28', '2025-12-29', '2025-12-30', '2025-12-31',
                '2026-01-01', '2026-01-02', // Winter Break (Dec 22 - Jan 2)
                '2026-01-12', // Parent/Teacher Conferences
                '2026-03-09', '2026-03-10', '2026-03-11', '2026-03-12', '2026-03-13', // Spring Break
                '2026-04-01', // Parent/Teacher Conferences
                '2026-05-12', // Slana Graduation
                '2026-05-13', // Upstream Learning Graduation
                '2026-05-14', // Kenny Lake Graduation
                '2026-05-15'  // Glennallen Graduation
            ],
            
            // Early Release days from PDF
            earlyRelease: [
                '2025-08-17', // Early release before school opens
                '2025-10-17', // October early release
                '2025-12-19', // Before winter break
                '2026-02-13', // February early release
                '2026-05-16'  // Before last day
            ]
        };
        
        // Quarter system for simulation day planning (aligned with actual school calendar)
        const quarters = {
            q1: { start: new Date('2025-09-02'), end: new Date('2025-10-11') }, // Before Fall Break
            q2: { start: new Date('2025-10-16'), end: new Date('2025-12-19') }, // After Fall Break to Winter Break
            q3: { start: new Date('2026-01-06'), end: new Date('2026-03-07') }, // After Winter Break to Spring Break
            q4: { start: new Date('2026-03-17'), end: new Date('2026-05-09') }  // After Spring Break, before graduation activities
        };
        
        // Get current quarter for simulation planning
        function getCurrentQuarter(date = new Date()) {
            for (const [quarter, dates] of Object.entries(quarters)) {
                if (date >= dates.start && date <= dates.end) {
                    return quarter;
                }
            }
            return null;
        }
        
        // Check if a date is a school day (for calendar display)
        function isSchoolDay(date) {
            const dateStr = date.toISOString().split('T')[0];
            const dayOfWeek = date.getDay();
            
            // Not weekend
            if (dayOfWeek === 0 || dayOfWeek === 6) return false;
            
            // Not a holiday
            if (schoolCalendar.holidays.includes(dateStr)) return false;
            
            // Within school year (from school opens to last day)
            if (date < schoolCalendar.schoolOpens || date > schoolCalendar.lastDay) return false;
            
            return true;
        }
        
        // Check if a date is available for curriculum lessons (not orientation)
        function isLessonDay(date) {
            const dateStr = date.toISOString().split('T')[0];
            const dayOfWeek = date.getDay();
            
            // Not weekend
            if (dayOfWeek === 0 || dayOfWeek === 6) return false;
            
            // Not a holiday
            if (schoolCalendar.holidays.includes(dateStr)) return false;
            
            // Within curriculum period (after orientation)
            if (date < schoolCalendar.curriculumStart || date > schoolCalendar.curriculumEnd) return false;
            
            return true;
        }
        
        // Initialize calendar to current date or start of school year
        function initializeCalendar() {
            const today = new Date();
            const schoolStart = schoolCalendar.curriculumStart;
            
            // If we're before August 2025, start at school beginning
            // If we're in the school year, start at current week
            if (today < new Date('2025-08-01')) {
                currentCalendarStart = getWeekStart(schoolStart);
            } else if (today >= schoolStart && today <= schoolCalendar.curriculumEnd) {
                currentCalendarStart = getWeekStart(today);
            } else {
                // After school year or before, default to school start
                currentCalendarStart = getWeekStart(schoolStart);
            }
            
            generateCalendar();
        }
        
        // Get the Monday of a given week
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Sunday
            d.setDate(diff);
            return d;
        }
        
        // Move calendar by specified number of days
        function moveCalendar(days) {
            currentCalendarStart.setDate(currentCalendarStart.getDate() + days);
            generateCalendar();
        }
        
        // Generate the 2-week calendar grid
        function generateCalendar() {
            const grid = document.getElementById('calendar-grid');
            const dateRange = document.getElementById('calendar-date-range');
            
            grid.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                header.style.fontWeight = 'bold';
                header.style.textAlign = 'center';
                header.style.padding = '10px';
                header.style.background = '#f8f9fa';
                grid.appendChild(header);
            });
            
            // Generate 14 days starting from currentCalendarStart
            const endDate = new Date(currentCalendarStart);
            endDate.setDate(endDate.getDate() + 13);
            
            // Update date range display
            dateRange.textContent = `${currentCalendarStart.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
            
            const current = new Date(currentCalendarStart);
            for (let i = 0; i < 14; i++) {
                const dayElement = createCalendarDay(current);
                grid.appendChild(dayElement);
                current.setDate(current.getDate() + 1);
            }
            
            // Update assignment status
            updateAssignmentStatus();
        }
        
        // Push lesson back by one school day
        function pushLessonBack(dateStr) {
            const assignment = lessonAssignments[dateStr];
            if (!assignment) return;
            
            const confirmed = confirm(`Move "${assignment.title}" to the next available day?\n\nThis action can be undone.`);
            if (!confirmed) return;
            
            const currentDate = new Date(dateStr);
            let nextDate = new Date(currentDate);
            nextDate.setDate(nextDate.getDate() + 1);
            
            // Find next available lesson day
            let attempts = 0;
            while (attempts < 30) { // Max 30 days ahead
                const nextDateStr = nextDate.toISOString().split('T')[0];
                
                if (isLessonDay(nextDate) && !lessonAssignments[nextDateStr]) {
                    // Store action for undo
                    lastAction = {
                        type: 'move',
                        fromDate: dateStr,
                        toDate: nextDateStr,
                        assignment: assignment,
                        hadCompletion: completedLessons[dateStr] || false
                    };
                    
                    // Move assignment
                    delete lessonAssignments[dateStr];
                    lessonAssignments[nextDateStr] = assignment;
                    
                    // Move completion status if exists
                    if (completedLessons[dateStr]) {
                        delete completedLessons[dateStr];
                        completedLessons[nextDateStr] = true;
                    }
                    
                    localStorage.setItem('lessonAssignments', JSON.stringify(lessonAssignments));
                    localStorage.setItem('completedLessons', JSON.stringify(completedLessons));
                    generateCalendar();
                    
                    const formattedDate = nextDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    showUndoNotification(`Moved "${assignment.title}" to ${formattedDate}`);
                    return;
                }
                
                nextDate.setDate(nextDate.getDate() + 1);
                attempts++;
            }
            
            alert('❌ No available days found within 30 days to move lesson');
        }
        
        // Remove lesson assignment
        function removeLessonAssignment(dateStr) {
            const assignment = lessonAssignments[dateStr];
            if (!assignment) return;
            
            const confirmed = confirm(`Remove "${assignment.title}" from this date?\n\nThis will free up the lesson to be reassigned later.\nThis action can be undone.`);
            if (!confirmed) return;
            
            // Store action for undo
            lastAction = {
                type: 'remove',
                date: dateStr,
                assignment: assignment,
                hadCompletion: completedLessons[dateStr] || false
            };
            
            delete lessonAssignments[dateStr];
            if (completedLessons[dateStr]) {
                delete completedLessons[dateStr];
            }
            
            localStorage.setItem('lessonAssignments', JSON.stringify(lessonAssignments));
            localStorage.setItem('completedLessons', JSON.stringify(completedLessons));
            generateCalendar();
            
            showUndoNotification(`Removed "${assignment.title}" from schedule`);
        }
        
        // Create a single calendar day element
        function createCalendarDay(date) {
            const dateStr = date.toISOString().split('T')[0];
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            
            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = date.getDate();
            
            const dayContent = document.createElement('div');
            dayContent.className = 'day-content';
            
            // Determine day type and styling
            if (!isSchoolDay(date)) {
                dayElement.classList.add('holiday');
                dayContent.textContent = 'No School';
            } else if (!isLessonDay(date)) {
                // School day but not lesson day (orientation period)
                dayElement.classList.add('orientation');
                dayContent.textContent = 'Orientation';
            } else if (lessonAssignments[dateStr]) {
                const assignment = lessonAssignments[dateStr];
                if (completedLessons[dateStr]) {
                    dayElement.classList.add('completed');
                    
                    // Add checkbox
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'lesson-checkbox';
                    checkbox.checked = true;
                    checkbox.onchange = () => toggleLessonCompletion(dateStr);
                    dayElement.appendChild(checkbox);
                } else {
                    dayElement.classList.add('assigned');
                    
                    // Add checkbox
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'lesson-checkbox';
                    checkbox.onchange = () => toggleLessonCompletion(dateStr);
                    dayElement.appendChild(checkbox);
                }
                
                const lessonTitle = document.createElement('div');
                lessonTitle.className = 'lesson-title';
                lessonTitle.textContent = assignment.title;
                dayContent.appendChild(lessonTitle);
                
                // Add management buttons for assigned lessons
                const managementDiv = document.createElement('div');
                managementDiv.className = 'lesson-management';
                managementDiv.style.cssText = `
                    display: flex;
                    gap: 2px;
                    margin-top: 4px;
                    font-size: 0.6rem;
                `;
                
                // Load lesson button
                const loadBtn = document.createElement('button');
                loadBtn.textContent = '📖';
                loadBtn.title = 'Load Lesson';
                loadBtn.style.cssText = `
                    background: #007bff;
                    color: white;
                    border: none;
                    border-radius: 3px;
                    padding: 2px 4px;
                    cursor: pointer;
                    font-size: 0.6rem;
                `;
                loadBtn.onclick = (e) => {
                    e.stopPropagation();
                    selectLessonFromCalendar(assignment.moduleNumber, assignment.lessonNumber);
                };
                
                // Push back button
                const pushBtn = document.createElement('button');
                pushBtn.textContent = '⏭️';
                pushBtn.title = 'Push Back 1 Day';
                pushBtn.style.cssText = `
                    background: #ffc107;
                    color: #212529;
                    border: none;
                    border-radius: 3px;
                    padding: 2px 4px;
                    cursor: pointer;
                    font-size: 0.6rem;
                `;
                pushBtn.onclick = (e) => {
                    e.stopPropagation();
                    pushLessonBack(dateStr);
                };
                
                // Remove button
                const removeBtn = document.createElement('button');
                removeBtn.textContent = '❌';
                removeBtn.title = 'Remove Assignment';
                removeBtn.style.cssText = `
                    background: #dc3545;
                    color: white;
                    border: none;
                    border-radius: 3px;
                    padding: 2px 4px;
                    cursor: pointer;
                    font-size: 0.6rem;
                `;
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeLessonAssignment(dateStr);
                };
                
                managementDiv.appendChild(loadBtn);
                managementDiv.appendChild(pushBtn);
                managementDiv.appendChild(removeBtn);
                dayContent.appendChild(managementDiv);
            } else if (isLessonDay(date)) {
                dayElement.classList.add('available');
                dayContent.textContent = 'Available';
                // Remove click functionality - manage through auto-assign tools
            } else {
                // School day but not available for lessons (e.g., orientation)
                dayContent.textContent = date < schoolCalendar.curriculumStart ? 'Orientation' : 'School Day';
            }
            
            // Weekend styling
            if (date.getDay() === 0 || date.getDay() === 6) {
                dayElement.classList.add('weekend');
            }
            
            dayElement.appendChild(dayNumber);
            dayElement.appendChild(dayContent);
            
            return dayElement;
        }
        
        // Toggle lesson completion
        function toggleLessonCompletion(dateStr) {
            if (completedLessons[dateStr]) {
                delete completedLessons[dateStr];
            } else {
                completedLessons[dateStr] = true;
                // Auto-assign next lesson to next available day
                assignNextLessonToNextDay();
            }
            
            localStorage.setItem('completedLessons', JSON.stringify(completedLessons));
            generateCalendar();
        }
        
        // Assign next lesson to next available day
        function assignNextLessonToNextDay() {
            // Find next unassigned lesson
            const nextLesson = findNextUnassignedLesson();
            if (!nextLesson) return;
            
            // Find next available school day
            const nextAvailableDay = findNextAvailableDay();
            if (!nextAvailableDay) return;
            
            // Assign lesson
            lessonAssignments[nextAvailableDay] = nextLesson;
            localStorage.setItem('lessonAssignments', JSON.stringify(lessonAssignments));
        }
        
        // Get the next lesson that should be assigned (in sequence)
        function getNextSequentialLesson() {
            const assignedLessons = Object.values(lessonAssignments);
            let expectedModuleNumber = 1;
            let expectedLessonNumber = 1;
            
            // Find the next lesson in sequence
            for (const module of modules) {
                const lessonCount = module.totalLessons || module.lessonCount || 0;
                for (let i = 1; i <= lessonCount; i++) {
                    const isAssigned = assignedLessons.some(assigned => 
                        assigned.moduleNumber === module.moduleNumber && assigned.lessonNumber === i
                    );
                    
                    if (!isAssigned) {
                        return {
                            moduleNumber: module.moduleNumber,
                            lessonNumber: i,
                            title: `M${module.moduleNumber}L${i}: ${module.title}`,
                            sequenceNumber: this.getSequenceNumber(module.moduleNumber, i)
                        };
                    }
                }
            }
            return null;
        }
        
        // Get sequence number for a lesson (for ordering)
        function getSequenceNumber(moduleNumber, lessonNumber) {
            let sequence = 0;
            for (const module of modules) {
                if (module.moduleNumber < moduleNumber) {
                    sequence += module.totalLessons || module.lessonCount || 0;
                } else if (module.moduleNumber === moduleNumber) {
                    sequence += lessonNumber;
                    break;
                }
            }
            return sequence;
        }
        
        // Check if a lesson can be assigned (is it the next in sequence?)
        function canAssignLesson(targetModuleNumber, targetLessonNumber) {
            const nextLesson = getNextSequentialLesson();
            if (!nextLesson) return false;
            
            return nextLesson.moduleNumber === targetModuleNumber && 
                   nextLesson.lessonNumber === targetLessonNumber;
        }
        
        // Find next lesson that hasn't been assigned (updated to use sequential logic)
        function findNextUnassignedLesson() {
            return getNextSequentialLesson();
        }
        
        // Find next available school day for lessons (OPTIMIZED)
        function findNextAvailableDay() {
            const today = new Date();
            const current = new Date(Math.max(today, schoolCalendar.curriculumStart));
            
            // Limit search to 60 days instead of 365 for better performance
            for (let i = 0; i < 60; i++) { 
                const dateStr = current.toISOString().split('T')[0];
                
                if (isLessonDay(current) && !lessonAssignments[dateStr]) {
                    return dateStr;
                }
                current.setDate(current.getDate() + 1);
            }
            return null;
        }
        
        // Assign a specific lesson to a date (with sequence protection)
        function assignNextLesson(dateStr) {
            const date = new Date(dateStr);
            
            // Only allow assignment to lesson days
            if (!isLessonDay(date)) {
                alert('Lessons can only be assigned to curriculum days!');
                return;
            }
            
            const nextLesson = findNextUnassignedLesson();
            if (!nextLesson) {
                console.log('No next lesson found. Modules count:', modules.length);
                if (modules.length === 0) {
                    alert('Modules are still loading. Please wait and try again.');
                } else {
                    alert('All lessons have been assigned!');
                }
                return;
            }
            
            // Check if there are any existing assignments for this date
            if (lessonAssignments[dateStr]) {
                const existing = lessonAssignments[dateStr];
                const confirmed = confirm(
                    `This date already has "${existing.title}" assigned.\n\n` +
                    `Do you want to replace it with "${nextLesson.title}"?`
                );
                if (!confirmed) return;
            }
            
            // Confirm assignment
            const formatted = new Date(dateStr).toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const confirmed = confirm(
                `Assign "${nextLesson.title}" to ${formatted}?\n\n` +
                `This will be lesson #${nextLesson.sequenceNumber || 'Unknown'} in the sequence.`
            );
            
            if (!confirmed) return;
            
            lessonAssignments[dateStr] = nextLesson;
            localStorage.setItem('lessonAssignments', JSON.stringify(lessonAssignments));
            generateCalendar();
            
            // Show success message with undo option
            showUndoNotification(dateStr, nextLesson);
        }
        
        // Show undo notification - flexible function to handle different call patterns
        function showUndoNotification(messageOrDateStr, lesson = null) {
            // Remove any existing notification
            const existing = document.getElementById('undo-notification');
            if (existing) existing.remove();
            
            let message;
            let undoFunction;
            
            // Handle both old style (dateStr, lesson) and new style (message) calls
            if (lesson) {
                // Old style call for lesson assignments
                const date = new Date(messageOrDateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                message = `Assigned "${lesson.title}" to ${date}`;
                undoFunction = `undoAssignment('${messageOrDateStr}')`;
            } else {
                // New style call with custom message
                message = messageOrDateStr;
                undoFunction = 'undoLastAction()';
            }
            
            // Create notification
            const notification = document.createElement('div');
            notification.id = 'undo-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                font-weight: 600;
                max-width: 400px;
                display: flex;
                align-items: center;
                gap: 15px;
            `;
            
            notification.innerHTML = `
                <span>✅ ${message}</span>
                <button onclick="${undoFunction}" style="
                    background: white;
                    color: #28a745;
                    border: none;
                    padding: 5px 10px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: 600;
                    margin-right: 10px;
                ">Undo</button>
                <button onclick="document.getElementById('undo-notification').remove(); lastAction = null;" style="
                    background: transparent;
                    color: white;
                    border: 1px solid white;
                    padding: 5px 10px;
                    border-radius: 4px;
                    cursor: pointer;
                ">Dismiss</button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 15 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                    if (!lesson) lastAction = null; // Clear lastAction for new style calls
                }
            }, 15000);
        }
        
        // Undo last action (new system)
        function undoLastAction() {
            if (!lastAction) {
                alert('No action to undo');
                return;
            }
            
            try {
                switch (lastAction.type) {
                    case 'move':
                        // Move lesson back to original date
                        delete lessonAssignments[lastAction.toDate];
                        lessonAssignments[lastAction.fromDate] = lastAction.assignment;
                        
                        // Restore completion status
                        delete completedLessons[lastAction.toDate];
                        if (lastAction.hadCompletion) {
                            completedLessons[lastAction.fromDate] = true;
                        }
                        break;
                        
                    case 'remove':
                        // Restore removed lesson
                        lessonAssignments[lastAction.date] = lastAction.assignment;
                        if (lastAction.hadCompletion) {
                            completedLessons[lastAction.date] = true;
                        }
                        break;
                        
                    case 'assign':
                        // Remove auto-assigned lesson
                        delete lessonAssignments[lastAction.date];
                        delete completedLessons[lastAction.date];
                        break;
                        
                    default:
                        alert('Cannot undo this type of action');
                        return;
                }
                
                // Save changes and update display
                localStorage.setItem('lessonAssignments', JSON.stringify(lessonAssignments));
                localStorage.setItem('completedLessons', JSON.stringify(completedLessons));
                generateCalendar();
                
                // Remove notification and clear action
                const notification = document.getElementById('undo-notification');
                if (notification) notification.remove();
                lastAction = null;
                
                alert('✅ Action undone successfully!');
                
            } catch (error) {
                console.error('Error undoing action:', error);
                alert('❌ Error undoing action. Please refresh the page.');
            }
        }
        
        // Undo assignment (legacy system for auto-assign)
        function undoAssignment(dateStr) {
            if (lessonAssignments[dateStr]) {
                const lesson = lessonAssignments[dateStr];
                delete lessonAssignments[dateStr];
                localStorage.setItem('lessonAssignments', JSON.stringify(lessonAssignments));
                generateCalendar();
                
                // Remove notification
                const notification = document.getElementById('undo-notification');
                if (notification) notification.remove();
                
                // Show confirmation
                const date = new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                alert(`✅ Removed "${lesson.title}" from ${date}`);
            }
        }
        
        // Auto-assign next N lessons to available days
        function autoAssignLessons(count = 10) {
            const confirmed = confirm(
                `Auto-assign the next ${count} lessons in sequence?\n\n` +
                `This will assign lessons to the next available school days.`
            );
            
            if (!confirmed) return;
            
            let assigned = 0;
            const maxAttempts = 100; // Prevent infinite loop
            let attempts = 0;
            
            while (assigned < count && attempts < maxAttempts) {
                attempts++;
                
                const nextLesson = findNextUnassignedLesson();
                if (!nextLesson) break;
                
                const nextDay = findNextAvailableDay();
                if (!nextDay) break;
                
                lessonAssignments[nextDay] = nextLesson;
                assigned++;
            }
            
            if (assigned > 0) {
                localStorage.setItem('lessonAssignments', JSON.stringify(lessonAssignments));
                generateCalendar();
                updateAssignmentStatus();
                alert(`✅ Assigned ${assigned} lessons automatically!`);
            } else {
                alert('No lessons available to assign.');
            }
        }
        
        // Clear all assignments
        function clearAllAssignments() {
            const assignedCount = Object.keys(lessonAssignments).length;
            if (assignedCount === 0) {
                alert('No assignments to clear.');
                return;
            }
            
            const confirmed = confirm(
                `⚠️ This will remove ALL ${assignedCount} lesson assignments!\n\n` +
                `Are you sure? This action cannot be undone.`
            );
            
            if (!confirmed) return;
            
            lessonAssignments = {};
            completedLessons = {};
            localStorage.setItem('lessonAssignments', JSON.stringify(lessonAssignments));
            localStorage.setItem('completedLessons', JSON.stringify(completedLessons));
            generateCalendar();
            updateAssignmentStatus();
            alert('✅ All assignments cleared.');
        }
        
        // Update assignment status display
        function updateAssignmentStatus() {
            const statusElement = document.getElementById('assignment-status');
            if (!statusElement) return;
            
            const assignedCount = Object.keys(lessonAssignments).length;
            const completedCount = Object.keys(completedLessons).length;
            const totalLessons = modules.reduce((sum, module) => sum + (module.totalLessons || 0), 0);
            
            statusElement.textContent = `📊 ${assignedCount} assigned | ${completedCount} completed | ${totalLessons} total`;
        }
        
        // Select lesson from calendar click
        function selectLessonFromCalendar(moduleNumber, lessonNumber) {
            // Set the module dropdown
            document.getElementById('moduleSelect').value = moduleNumber;
            
            // Load lessons for the module and then select the specific lesson
            loadLessonsForModule(moduleNumber).then(() => {
                // Find the lesson with matching module and lesson numbers
                const targetLesson = allLessons.find(lesson => 
                    lesson.module && 
                    lesson.module.moduleNumber === parseInt(moduleNumber) && 
                    lesson.lessonNumber === parseInt(lessonNumber)
                );
                
                if (targetLesson) {
                    document.getElementById('lessonSelect').value = targetLesson._id;
                    loadLesson();
                }
            }).catch(error => {
                console.error('Error loading lesson from calendar:', error);
                alert('Could not load the selected lesson. Please try selecting it manually from the dropdowns.');
            });
        }

        // Load modules on page load
        async function loadModules() {
            try {
                console.log('Loading modules...');
                const response = await fetch('/api/modules');
                modules = await response.json();
                console.log('Modules loaded:', modules.length, modules);
                
                const moduleSelect = document.getElementById('moduleSelect');
                moduleSelect.innerHTML = '<option value="">Select a module...</option>';
                
                modules.forEach(module => {
                    const option = document.createElement('option');
                    option.value = module.moduleNumber;
                    option.textContent = `Module ${module.moduleNumber}: ${module.title}`;
                    moduleSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading modules:', error);
                document.getElementById('moduleSelect').innerHTML = '<option value="">Error loading modules</option>';
            }
        }

        // Load lessons for selected module
        async function loadLessonsForModule(moduleNumber) {
            try {
                console.log('Loading lessons for module:', moduleNumber);
                const response = await fetch(`/api/lessons`);
                allLessons = await response.json();
                console.log('All lessons loaded:', allLessons.length);
                
                // Filter lessons for this module
                const moduleLessons = allLessons.filter(lesson => lesson.module && lesson.module.moduleNumber === parseInt(moduleNumber));
                console.log('Filtered lessons for module', moduleNumber, ':', moduleLessons.length);
                
                const lessonSelect = document.getElementById('lessonSelect');
                lessonSelect.innerHTML = '<option value="">Select a lesson...</option>';
                
                // Sort lessons by lesson number
                moduleLessons.sort((a, b) => a.lessonNumber - b.lessonNumber);
                
                moduleLessons.forEach(lesson => {
                    const option = document.createElement('option');
                    option.value = lesson._id;
                    option.textContent = `Lesson ${lesson.lessonNumber}: ${lesson.title}`;
                    lessonSelect.appendChild(option);
                });
                
                console.log('Lesson dropdown updated with', moduleLessons.length, 'lessons');
                return Promise.resolve();
            } catch (error) {
                console.error('Error loading lessons:', error);
                document.getElementById('lessonSelect').innerHTML = '<option value="">Error loading lessons</option>';
                return Promise.reject(error);
            }
        }

        // Module selection handler
        document.getElementById('moduleSelect').addEventListener('change', function() {
            const moduleNumber = this.value;
            console.log('Module changed to:', moduleNumber);
            if (moduleNumber) {
                loadLessonsForModule(moduleNumber);
            } else {
                const lessonSelect = document.getElementById('lessonSelect');
                lessonSelect.innerHTML = '<option value="">Select module first</option>';
                console.log('Module selection cleared, lesson dropdown reset');
            }
        });

        // Load specific lesson
        async function loadLesson() {
            const lessonId = document.getElementById('lessonSelect').value;
            console.log('Loading lesson with ID:', lessonId);
            if (!lessonId) {
                alert('Please select a lesson first');
                return;
            }

            try {
                // Find the lesson in our local array
                const lesson = allLessons.find(l => l._id === lessonId);
                console.log('Found lesson:', lesson ? lesson.title : 'not found');
                if (!lesson) {
                    throw new Error('Lesson not found');
                }

                // Use the lesson data directly instead of fetching by day number
                const lessonData = {
                    schoolDay: lesson.lessonNumber,
                    moduleNumber: lesson.module.moduleNumber,
                    moduleTitle: lesson.module.title,
                    lessonNumber: lesson.lessonNumber,
                    lessonTitle: lesson.title,
                    pdfFile: lesson.module.pdfFileName || `module_${lesson.module.moduleNumber}.pdf`,
                    lesson: lesson
                };
                
                console.log('Displaying lesson data:', lessonData);
                displayLesson(lessonData);
                
                // Set current lesson day for navigation
                currentLessonDay = lesson.lessonNumber;
                updateNavigationButtons();
                
            } catch (error) {
                console.error('Error loading lesson:', error);
                document.getElementById('lesson-content').innerHTML = 
                    `<div class="error">Error loading lesson: ${error.message}</div>`;
            }
        }

        // Display lesson content
        function displayLesson(lessonData) {
            const lesson = lessonData.lesson;
            
            // Update lesson overview
            document.getElementById('time-estimate').textContent = lesson.estimatedTime || '45 minutes';
            document.getElementById('module-title').textContent = lessonData.moduleTitle || 'Unknown Module';
            document.getElementById('lesson-title').textContent = lesson.title || 'Unknown Lesson';

            // Update objectives (check both possible structures)
            const objectives = lesson.teacherContent?.objectives || lesson.objectives || [];
            updateList('objectives-list', objectives, 'No objectives available');

            // Update materials (check both possible structures)
            const materials = lesson.teacherContent?.materials || lesson.materials || [];
            updateList('materials-list', materials, 'No materials listed');

            // Update procedures (check both possible structures)
            const procedures = lesson.teacherContent?.procedures || lesson.procedures || [];
            updateList('procedures-list', procedures, 'No procedures available');

            // Update assessments (check both possible structures)
            const assessments = lesson.teacherContent?.assessments || lesson.assessments || [];
            updateList('assessments-list', assessments, 'No assessments listed');

            // Update activities (check both possible structures)
            const activities = lesson.studentContent?.activities || lesson.activities || [];
            updateList('activities-list', activities, 'No activities listed');

            // Update vocabulary (check both possible structures)
            const vocabulary = lesson.teacherContent?.vocabulary || lesson.vocabulary || [];
            updateVocabulary(vocabulary);

            // Display main lesson content (check multiple possible structures)
            let studentContent = null;
            if (lesson.studentReading?.content) {
                studentContent = { content: lesson.studentReading.content };
            } else if (lesson.studentContent?.readings && lesson.studentContent.readings.length > 0) {
                studentContent = { content: lesson.studentContent.readings[0] };
            } else if (lesson.rawText) {
                studentContent = { content: lesson.rawText };
            }
            
            displayLessonReading(studentContent);
            
            // Generate cross-curricular content and show the section
            generateCrossCurricularContent(lesson);
            document.getElementById('cross-curricular-section').style.display = 'block';
        }

        // Update list helper function
        function updateList(elementId, items, emptyMessage) {
            const list = document.getElementById(elementId);
            if (items.length === 0) {
                list.innerHTML = `<li style="color: #6c757d; font-style: italic;">${emptyMessage}</li>`;
                return;
            }

            list.innerHTML = items.map(item => `<li>${item}</li>`).join('');
        }

        // Update vocabulary with special formatting
        function updateVocabulary(vocabulary) {
            const list = document.getElementById('vocabulary-cards');
            if (vocabulary.length === 0) {
                list.innerHTML = '<div style="color: #6c757d; font-style: italic;">No vocabulary terms available</div>';
                return;
            }

            list.innerHTML = vocabulary.map(item => {
                if (typeof item === 'object' && item.term && item.definition) {
                    return `<div class="vocab-card">
                                <div class="vocab-term">${item.term}</div>
                                <div class="vocab-definition">${item.definition}</div>
                            </div>`;
                } else if (typeof item === 'string') {
                    // Handle string format like "term: definition"
                    const parts = item.split(':');
                    if (parts.length >= 2) {
                        const term = parts[0].trim();
                        const definition = parts.slice(1).join(':').trim();
                        return `<div class="vocab-card">
                                    <div class="vocab-term">${term}</div>
                                    <div class="vocab-definition">${definition}</div>
                                </div>`;
                    } else {
                        return `<div class="vocab-card">
                                    <div class="vocab-term">${item}</div>
                                </div>`;
                    }
                } else {
                    return `<div class="vocab-card">
                                <div class="vocab-term">${item}</div>
                            </div>`;
                }
            }).join('');
        }

        // Display the main lesson reading content from MD files
        function displayLessonReading(studentReading) {
            const contentDiv = document.getElementById('lesson-content');
            
            if (!studentReading || !studentReading.content) {
                contentDiv.innerHTML = '<div class="error">No lesson content available</div>';
                return;
            }

            // Convert markdown content to HTML
            const htmlContent = convertMarkdownToHTML(studentReading.content);
            
            // Create enhanced content with supplementary materials
            const enhancedContent = `
                <div class="lesson-reading">
                    <div class="lesson-content-wrapper">
                        ${htmlContent}
                    </div>
                    
                    <div class="supplementary-content">
                        <div class="content-section">
                            <h3>🔍 Key Terms & Concepts</h3>
                            <div class="key-terms-grid">
                                <div class="term-card">
                                    <strong>Geographic Theme:</strong> Location, Place, Movement, Region, Human-Environment Interaction
                                </div>
                                <div class="term-card">
                                    <strong>Spatial Thinking:</strong> Understanding patterns and relationships across space
                                </div>
                                <div class="term-card">
                                    <strong>Cultural Landscape:</strong> The visible human imprint on the environment
                                </div>
                            </div>
                        </div>
                        
                        <div class="content-section">
                            <h3>🌐 Cross-Curricular Connections</h3>
                            <div class="connections-grid">
                                <div class="connection-card">
                                    <span class="subject-icon">📚</span>
                                    <strong>English Language Arts:</strong> Analyze geographic narratives and cultural texts
                                </div>
                                <div class="connection-card">
                                    <span class="subject-icon">🔬</span>
                                    <strong>Science:</strong> Explore climate patterns, ecosystems, and environmental science
                                </div>
                                <div class="connection-card">
                                    <span class="subject-icon">📊</span>
                                    <strong>Mathematics:</strong> Use statistics, graphs, and data analysis for geographic research
                                </div>
                                <div class="connection-card">
                                    <span class="subject-icon">🎨</span>
                                    <strong>Arts:</strong> Study cultural art forms and architectural styles from different regions
                                </div>
                            </div>
                        </div>
                        
                        <div class="content-section">
                            <h3>💡 Extension Activities</h3>
                            <div class="activities-list">
                                <div class="activity-item">
                                    <span class="activity-icon">🎯</span>
                                    <div>
                                        <strong>Geographic Investigation:</strong> Research a current global issue and analyze its geographic causes and effects
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <span class="activity-icon">🗺️</span>
                                    <div>
                                        <strong>Digital Mapping:</strong> Create interactive maps using online GIS tools to visualize geographic data
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <span class="activity-icon">📱</span>
                                    <div>
                                        <strong>Virtual Field Trip:</strong> Explore geographic locations through virtual reality and street view technology
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <span class="activity-icon">🎪</span>
                                    <div>
                                        <strong>Cultural Exchange:</strong> Connect with students from other regions to share geographic perspectives
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="content-section">
                            <h3>📚 Additional Resources</h3>
                            <div class="resources-grid">
                                <div class="resource-card">
                                    <h4>🌍 National Geographic Education</h4>
                                    <p>Interactive maps, videos, and lesson plans for geographic exploration</p>
                                </div>
                                <div class="resource-card">
                                    <h4>🗺️ Google Earth Education</h4>
                                    <p>Satellite imagery and virtual tours for immersive geographic learning</p>
                                </div>
                                <div class="resource-card">
                                    <h4>📊 World Bank Data</h4>
                                    <p>Economic and demographic data for comparative geographic analysis</p>
                                </div>
                                <div class="resource-card">
                                    <h4>🌡️ Climate.gov</h4>
                                    <p>Climate data and educational resources for environmental geography</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="content-section reflection-section">
                            <h3>🤔 Reflection Questions</h3>
                            <div class="reflection-questions">
                                <div class="question-item">
                                    <p><strong>Think Globally:</strong> How does this lesson's content connect to current world events?</p>
                                </div>
                                <div class="question-item">
                                    <p><strong>Act Locally:</strong> How do the geographic concepts in this lesson apply to your own community?</p>
                                </div>
                                <div class="question-item">
                                    <p><strong>Future Connections:</strong> How might understanding this geography help you in your future career or studies?</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = enhancedContent;
        }

        // Simple markdown to HTML converter
        function convertMarkdownToHTML(markdown) {
            let html = markdown;
            
            // Convert headers
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            
            // Convert bold text
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Convert bullet points
            html = html.replace(/^- (.*$)/gim, '<li>$1</li>');
            
            // Wrap consecutive list items in ul tags
            html = html.replace(/(<li>.*<\/li>)/gs, function(match) {
                return '<ul>' + match + '</ul>';
            });
            
            // Convert line breaks to paragraphs
            html = html.split('\n\n').map(paragraph => {
                paragraph = paragraph.trim();
                if (paragraph && !paragraph.startsWith('<h') && !paragraph.startsWith('<ul') && !paragraph.startsWith('<li')) {
                    return `<p>${paragraph}</p>`;
                }
                return paragraph;
            }).join('\n');

            // Add special styling for key sections
            html = html.replace(/<h2>The Big Idea<\/h2>\s*<p>(.*?)<\/p>/gi, 
                '<h2>The Big Idea</h2><div class="big-idea">$1</div>');
            
            html = html.replace(/<h2>Main Ideas<\/h2>(.*?)(?=<h2>|$)/gis, 
                '<h2>Main Ideas</h2><div class="main-ideas">$1</div>');
            
            html = html.replace(/<h2>Key Terms and Places<\/h2>(.*?)(?=<h2>|$)/gis, 
                '<h2>Key Terms and Places</h2><div class="key-terms">$1</div>');
            
            html = html.replace(/<h2>Assessment<\/h2>(.*?)(?=<h2>|$)/gis, 
                '<h2>Assessment</h2><div class="assessment">$1</div>');
            
            return html;
        }

        // Tab switching with enhanced error handling
        function showTab(tabName) {
            console.log('showTab called with:', tabName);
            
            try {
                // Hide all tabs
                const allTabs = document.querySelectorAll('.tab-content');
                console.log('Found', allTabs.length, 'tab contents');
                allTabs.forEach(tab => {
                    tab.classList.remove('active');
                    console.log('Hiding tab:', tab.id);
                });
                
                // Remove active class from all buttons
                const allButtons = document.querySelectorAll('.tab-button');
                console.log('Found', allButtons.length, 'tab buttons');
                allButtons.forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Show selected tab
                const targetTab = document.getElementById(tabName + '-tab');
                console.log('Looking for tab:', tabName + '-tab');
                if (targetTab) {
                    targetTab.classList.add('active');
                    console.log('Successfully showing tab:', tabName + '-tab');
                } else {
                    console.error('Tab not found:', tabName + '-tab');
                    console.log('Available tabs:', Array.from(document.querySelectorAll('[id$="-tab"]')).map(t => t.id));
                }
                
                // Find and activate the corresponding button
                const buttons = document.querySelectorAll('.tab-button');
                let buttonActivated = false;
                buttons.forEach(btn => {
                    const buttonText = btn.textContent.toLowerCase();
                    console.log('Checking button:', buttonText, 'for tab:', tabName);
                    if ((tabName === 'teacher' && buttonText.includes('teacher')) ||
                        (tabName === 'vocabulary' && buttonText.includes('vocabulary')) ||
                        (tabName === 'maps' && buttonText.includes('maps')) ||
                        (tabName === 'ai-tools' && buttonText.includes('ai tools')) ||
                        (tabName === 'connections' && buttonText.includes('connections'))) {
                        btn.classList.add('active');
                        buttonActivated = true;
                        console.log('Activated button:', btn.textContent);
                    }
                });
                
                if (!buttonActivated) {
                    console.error('No button was activated for tab:', tabName);
                }
                
                // Initialize Enhanced Maps when Maps tab is shown
                if (tabName === 'maps') {
                    setTimeout(() => initializeEnhancedMaps(), 100);
                }
                
            } catch (error) {
                console.error('Error in showTab function:', error);
            }
        }

        // Enhanced Maps Integration
        let enhancedMap = null;
        let mapLoadedLayers = new Set();
        let currentMapLesson = null;

        function initializeEnhancedMaps() {
            if (enhancedMap) return; // Already initialized
            
            if (!window.L) {
                console.error('Leaflet not loaded');
                updateMapStatus('Error: Leaflet library not loaded');
                initializeFallbackMap();
                return;
            }
            
            updateMapStatus('Initializing Enhanced Maps with Leaflet...');
            
            try {
                // Completely bypass Leaflet icons with simple CSS-based markers
                delete L.Icon.Default.prototype._getIconUrl;
                L.Icon.Default.mergeOptions({
                    iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="25" height="41" viewBox="0 0 25 41">
                            <path fill="#3388ff" stroke="#fff" stroke-width="2" d="M12.5 0C5.6 0 0 5.6 0 12.5c0 8.3 12.5 28.5 12.5 28.5s12.5-20.2 12.5-28.5C25 5.6 19.4 0 12.5 0z"/>
                            <circle fill="#fff" cx="12.5" cy="12.5" r="6"/>
                        </svg>
                    `),
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowUrl: '',
                    shadowSize: [0, 0]
                });
                
                // Initialize Leaflet map
                enhancedMap = L.map('enhanced-map', {
                    center: [20, 0], // Global view
                    zoom: 2,
                    worldCopyJump: true,
                    maxBounds: [[-90, -180], [90, 180]]
                });

                // Add default tile layer (OpenStreetMap - no API key needed!)
                const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(enhancedMap);

                // Store base layers for style switching with better tile sources
                const baseLayers = {
                    'Streets': osmLayer,
                    'Satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: '© Esri',
                        maxZoom: 17
                    }),
                    'Terrain': L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenTopoMap contributors',
                        maxZoom: 17
                    }),
                    'Light': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                        attribution: '© OpenStreetMap contributors © CARTO',
                        subdomains: 'abcd',
                        maxZoom: 19
                    })
                };

                // Add layer control for style switching
                L.control.layers(baseLayers).addTo(enhancedMap);

                // Map style controls - update the existing button handlers
                document.querySelectorAll('.map-style-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        try {
                            // Update active button
                            document.querySelectorAll('.map-style-btn').forEach(b => {
                                b.classList.remove('active');
                                b.style.background = 'white';
                                b.style.color = 'black';
                            });
                            btn.classList.add('active');
                            btn.style.background = '#4CAF50';
                            btn.style.color = 'white';
                            
                            // Change map layer based on button
                            const style = btn.dataset.style;
                            enhancedMap.eachLayer(layer => {
                                if (layer._url && layer._url.includes('tile')) {
                                    enhancedMap.removeLayer(layer);
                                }
                            });
                            
                            let newLayer;
                            switch(style) {
                                case 'satellite-streets-v12':
                                    newLayer = baseLayers['Satellite'];
                                    break;
                                case 'outdoors-v12':
                                    newLayer = baseLayers['Terrain'];
                                    break;
                                case 'light-v11':
                                    newLayer = baseLayers['Light'];
                                    break;
                                default:
                                    newLayer = baseLayers['Streets'];
                            }
                            newLayer.addTo(enhancedMap);
                            updateMapStatus(`Switched to ${btn.textContent} view`);
                        } catch (error) {
                            console.error('Error switching map style:', error);
                            updateMapStatus('Error switching map style - using current view');
                        }
                    });
                });

                // Feature toggles with real implementations
                document.getElementById('mapEarthquakeToggle').addEventListener('change', function() {
                    try {
                        if (this.checked) {
                            loadEarthquakeData();
                        } else {
                            removeMapLayer('earthquakes');
                        }
                    } catch (error) {
                        console.error('Error toggling earthquake data:', error);
                        updateMapStatus('Error toggling earthquake data');
                    }
                });

                document.getElementById('mapCitiesToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadCitiesData();
                    } else {
                        removeMapLayer('cities');
                    }
                });

                document.getElementById('mapClimateToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadClimateData();
                    } else {
                        removeMapLayer('climate');
                    }
                });

                document.getElementById('mapTerrainToggle').addEventListener('change', function() {
                    if (this.checked) {
                        enable3DTerrain();
                    } else {
                        disable3DTerrain();
                    }
                });

                // NEW EDUCATIONAL LAYER TOGGLES

                // Physical Geography Layers
                document.getElementById('mapVolcanoToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadVolcanoData();
                    } else {
                        removeMapLayer('volcano');
                    }
                });

                document.getElementById('mapOceanCurrentsToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadOceanCurrentsData();
                    } else {
                        removeMapLayer('oceancurrents');
                    }
                });

                document.getElementById('mapPlateToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadTectonicPlatesData();
                    } else {
                        removeMapLayer('plates');
                    }
                });

                // Political Geography Layers
                document.getElementById('mapNatoToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadNatoData();
                    } else {
                        removeMapLayer('nato');
                    }
                });

                document.getElementById('mapEuToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadEuData();
                    } else {
                        removeMapLayer('eu');
                    }
                });

                document.getElementById('mapG7Toggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadG7Data();
                    } else {
                        removeMapLayer('g7');
                    }
                });

                document.getElementById('mapConflictToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadConflictData();
                    } else {
                        removeMapLayer('conflict');
                    }
                });

                // Economic Geography Layers
                document.getElementById('mapTradeToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadTradeData();
                    } else {
                        removeMapLayer('trade');
                    }
                });

                document.getElementById('mapOilToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadOilData();
                    } else {
                        removeMapLayer('oil');
                    }
                });

                document.getElementById('mapCurrencyToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadCurrencyData();
                    } else {
                        removeMapLayer('currency');
                    }
                });

                document.getElementById('mapGdpToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadGdpData();
                    } else {
                        removeMapLayer('gdp');
                    }
                });

                // Historical Geography Layers
                document.getElementById('mapSilkRoadToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadSilkRoadData();
                    } else {
                        removeMapLayer('silkroad');
                    }
                });

                document.getElementById('mapColonialToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadColonialData();
                    } else {
                        removeMapLayer('colonial');
                    }
                });

                document.getElementById('mapAncientToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadAncientData();
                    } else {
                        removeMapLayer('ancient');
                    }
                });

                document.getElementById('mapColdWarToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadColdWarData();
                    } else {
                        removeMapLayer('coldwar');
                    }
                });

                // Cultural Geography Layers
                document.getElementById('mapLanguageToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadLanguageData();
                    } else {
                        removeMapLayer('language');
                    }
                });

                document.getElementById('mapReligionToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadReligionData();
                    } else {
                        removeMapLayer('religion');
                    }
                });

                document.getElementById('mapHeritageToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadHeritageData();
                    } else {
                        removeMapLayer('heritage');
                    }
                });

                document.getElementById('mapMigrationToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadMigrationData();
                    } else {
                        removeMapLayer('migration');
                    }
                });

                // Urban Geography Layers
                document.getElementById('mapMegacitiesToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadMegacitiesData();
                    } else {
                        removeMapLayer('megacities');
                    }
                });

                document.getElementById('mapPopDensityToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadPopDensityData();
                    } else {
                        removeMapLayer('popdensity');
                    }
                });

                document.getElementById('mapTimeZoneToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadTimeZoneData();
                    } else {
                        removeMapLayer('timezone');
                    }
                });

                // Environmental Layers
                document.getElementById('mapDeforestationToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadDeforestationData();
                    } else {
                        removeMapLayer('deforestation');
                    }
                });

                document.getElementById('mapBiodiversityToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadBiodiversityData();
                    } else {
                        removeMapLayer('biodiversity');
                    }
                });

                document.getElementById('mapCarbonToggle').addEventListener('change', function() {
                    if (this.checked) {
                        loadCarbonData();
                    } else {
                        removeMapLayer('carbon');
                    }
                });

                // Lesson control buttons
                document.getElementById('focusLessonRegion').addEventListener('click', focusOnLessonRegion);
                document.getElementById('showLessonData').addEventListener('click', showLessonData);
                document.getElementById('resetMapView').addEventListener('click', resetEnhancedMapView);

                // Initialize new toggle controls
                initializeMapControls();

                // Map is ready
                enhancedMap.whenReady(() => {
                    updateMapStatus('Enhanced Maps ready - Educational mapping system loaded');
                    console.log('Leaflet Enhanced Maps initialized successfully');
                    
                    // Sync with current lesson if one is loaded
                    syncMapWithCurrentLesson();
                });

            } catch (error) {
                console.error('Error initializing Enhanced Maps:', error);
                updateMapStatus('Error initializing map: ' + error.message);
                initializeFallbackMap();
            }
        }

        // Initialize Map Control Toggles
        function initializeMapControls() {
            let controlsVisible = true;
            let isFullscreen = false;
            
            // Controls toggle functionality
            const controlsToggle = document.getElementById('map-controls-toggle');
            const mapOverlay = document.getElementById('map-overlay');
            const controlsIcon = document.getElementById('controls-icon');
            const controlsText = document.getElementById('controls-text');
            
            controlsToggle.addEventListener('click', () => {
                controlsVisible = !controlsVisible;
                
                if (controlsVisible) {
                    mapOverlay.classList.remove('hidden');
                    mapOverlay.classList.add('visible');
                    controlsIcon.textContent = '⚙️';
                    controlsText.textContent = 'Controls';
                    controlsToggle.title = 'Hide Map Controls';
                } else {
                    mapOverlay.classList.remove('visible');
                    mapOverlay.classList.add('hidden');
                    controlsIcon.textContent = '👁️';
                    controlsText.textContent = 'Show';
                    controlsToggle.title = 'Show Map Controls';
                }
            });
            
            // Fullscreen toggle functionality
            const fullscreenToggle = document.getElementById('map-fullscreen-toggle');
            const mapContainer = document.querySelector('.enhanced-map-container');
            const fullscreenIcon = document.getElementById('fullscreen-icon');
            const fullscreenText = document.getElementById('fullscreen-text');
            
            fullscreenToggle.addEventListener('click', () => {
                isFullscreen = !isFullscreen;
                
                if (isFullscreen) {
                    // Enter fullscreen
                    mapContainer.classList.add('map-fullscreen');
                    fullscreenIcon.textContent = '🔍';
                    fullscreenText.textContent = 'Exit Fullscreen';
                    fullscreenToggle.title = 'Exit Fullscreen';
                    
                    // Hide browser scroll bars
                    document.body.style.overflow = 'hidden';
                    
                    // Invalidate map size after transition
                    setTimeout(() => {
                        if (enhancedMap) {
                            enhancedMap.invalidateSize();
                        }
                    }, 100);
                    
                } else {
                    // Exit fullscreen
                    mapContainer.classList.remove('map-fullscreen');
                    fullscreenIcon.textContent = '🔍';
                    fullscreenText.textContent = 'Fullscreen';
                    fullscreenToggle.title = 'Enter Fullscreen';
                    
                    // Restore browser scroll bars
                    document.body.style.overflow = 'auto';
                    
                    // Invalidate map size after transition
                    setTimeout(() => {
                        if (enhancedMap) {
                            enhancedMap.invalidateSize();
                        }
                    }, 100);
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Only work when maps tab is active
                if (document.getElementById('maps-tab').style.display !== 'block') return;
                
                if (e.key === 'Escape' && isFullscreen) {
                    // Exit fullscreen with Escape key
                    fullscreenToggle.click();
                } else if (e.key === 'F11') {
                    // Prevent browser fullscreen and use our fullscreen instead
                    e.preventDefault();
                    fullscreenToggle.click();
                } else if (e.ctrlKey && e.key === 'h') {
                    // Ctrl+H to toggle controls
                    e.preventDefault();
                    controlsToggle.click();
                }
            });
        }

        function syncMapWithCurrentLesson() {
            if (!currentLesson) {
                updateMapLessonInfo('Select a lesson to view relevant geographic content');
                hideLessonMapPanels();
                return;
            }
            
            currentMapLesson = currentLesson;
            const lessonTitle = currentLesson.title || 'Unknown Lesson';
            const moduleTitle = currentLesson.module ? currentLesson.module.title : 'Unknown Module';
            
            updateMapLessonInfo(`${moduleTitle} - ${lessonTitle}`);
            
            // Load lesson-specific content
            loadLessonMapSkills();
            loadLessonGeographicFocus();
            loadLessonMapActivities();
            
            // Check if we're using fallback mode
            if (!enhancedMap && document.getElementById('fallback-lesson-info')) {
                updateFallbackLessonInfo();
                updateMapStatus(`Lesson context updated: ${lessonTitle}`);
                return;
            }
            
            updateMapStatus(`Synced with: ${lessonTitle} - Enhanced content loaded`);
            
            // Auto-focus on relevant region based on lesson content
            focusOnLessonRegion();
        }

        function hideLessonMapPanels() {
            document.getElementById('map-skills-panel').style.display = 'none';
            document.getElementById('geographic-focus-panel').style.display = 'none';
            document.getElementById('map-activities-panel').style.display = 'none';
            document.getElementById('lesson-objectives').innerHTML = '';
        }

        function loadLessonMapSkills() {
            if (!currentMapLesson) return;
            
            const skillsPanel = document.getElementById('map-skills-panel');
            const skillsList = document.getElementById('lesson-skills-list');
            const objectivesDiv = document.getElementById('lesson-objectives');
            
            // Extract lesson content for analysis
            const content = (currentMapLesson.content || '').toLowerCase();
            const title = (currentMapLesson.title || '').toLowerCase();
            const searchText = content + ' ' + title;
            
            // Define map skills based on lesson content
            const mapSkills = [];
            const objectives = [];
            
            // Basic geographic skills
            if (searchText.includes('location') || searchText.includes('place') || searchText.includes('coordinate')) {
                mapSkills.push({
                    icon: '📍',
                    title: 'Location Skills',
                    description: 'Identify absolute and relative locations using coordinates, landmarks, and geographic references'
                });
                objectives.push('Practice identifying locations using various geographic references');
            }
            
            if (searchText.includes('region') || searchText.includes('boundary') || searchText.includes('border')) {
                mapSkills.push({
                    icon: '🗺️',
                    title: 'Regional Analysis',
                    description: 'Analyze regional boundaries, characteristics, and relationships between areas'
                });
                objectives.push('Compare and contrast different regional characteristics');
            }
            
            if (searchText.includes('climate') || searchText.includes('weather') || searchText.includes('temperature')) {
                mapSkills.push({
                    icon: '🌡️',
                    title: 'Climate Mapping',
                    description: 'Interpret climate data, weather patterns, and temperature distributions'
                });
                objectives.push('Analyze climate patterns and their geographic influences');
            }
            
            if (searchText.includes('population') || searchText.includes('city') || searchText.includes('urban')) {
                mapSkills.push({
                    icon: '🏙️',
                    title: 'Population Analysis',
                    description: 'Study population density, urban patterns, and demographic distributions'
                });
                objectives.push('Examine population patterns and urban development');
            }
            
            if (searchText.includes('culture') || searchText.includes('language') || searchText.includes('religion')) {
                mapSkills.push({
                    icon: '🌐',
                    title: 'Cultural Geography',
                    description: 'Map cultural distributions, language families, and religious patterns'
                });
                objectives.push('Explore cultural landscapes and their geographic expressions');
            }
            
            if (searchText.includes('trade') || searchText.includes('economic') || searchText.includes('resource')) {
                mapSkills.push({
                    icon: '💰',
                    title: 'Economic Geography',
                    description: 'Analyze trade routes, resource distributions, and economic patterns'
                });
                objectives.push('Investigate economic activities and resource management');
            }
            
            if (searchText.includes('mountain') || searchText.includes('river') || searchText.includes('physical') || searchText.includes('landform')) {
                mapSkills.push({
                    icon: '⛰️',
                    title: 'Physical Features',
                    description: 'Identify and analyze mountains, rivers, and other physical geographic features'
                });
                objectives.push('Study physical geography and landform relationships');
            }
            
            if (searchText.includes('scale') || searchText.includes('distance') || searchText.includes('measurement')) {
                mapSkills.push({
                    icon: '📏',
                    title: 'Scale & Distance',
                    description: 'Use map scales to calculate distances and understand spatial relationships'
                });
                objectives.push('Practice measuring distances and understanding map scales');
            }
            
            // Default skills if none detected
            if (mapSkills.length === 0) {
                mapSkills.push(
                    {
                        icon: '🧭',
                        title: 'Map Navigation',
                        description: 'Practice basic map reading and navigation skills'
                    },
                    {
                        icon: '🌍',
                        title: 'Global Awareness',
                        description: 'Develop understanding of global geographic relationships'
                    }
                );
                objectives.push('Develop fundamental geographic awareness and map literacy');
            }
            
            // Render skills
            skillsList.innerHTML = mapSkills.map((skill, index) => `
                <div class="skill-card-cool" style="
                    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); 
                    border: 2px solid #28a745; 
                    border-radius: 10px; 
                    padding: 15px; 
                    text-align: center;
                    position: relative;
                    overflow: hidden;
                    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                    animation: skillReveal 0.8s ease-out ${index * 0.15}s both;
                    cursor: pointer;
                " onmouseover="this.style.transform='translateY(-5px) rotate(1deg)'; this.style.boxShadow='0 10px 30px rgba(40,167,69,0.3)'" 
                   onmouseout="this.style.transform=''; this.style.boxShadow=''">
                    <div style="font-size: 28px; margin-bottom: 8px; animation: skillIconFloat 3s ease-in-out infinite; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));">${skill.icon}</div>
                    <div style="font-weight: bold; font-size: 14px; margin-bottom: 8px; color: #28a745; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">${skill.title}</div>
                    <div style="font-size: 12px; color: #6c757d; line-height: 1.4;">${skill.description}</div>
                    <div class="skill-glow" style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: linear-gradient(45deg, transparent, rgba(40,167,69,0.1), transparent);
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    "></div>
                </div>
            `).join('');
            
            // Show objectives
            objectivesDiv.innerHTML = `<strong>Learning Objectives:</strong> ${objectives.join('; ')}`;
            
            skillsPanel.style.display = 'block';
        }

        function loadLessonGeographicFocus() {
            if (!currentMapLesson) return;
            
            const focusPanel = document.getElementById('geographic-focus-panel');
            const focusList = document.getElementById('focus-areas-list');
            
            const content = (currentMapLesson.content || '').toLowerCase();
            const title = (currentMapLesson.title || '').toLowerCase();
            const searchText = content + ' ' + title;
            
            const focusAreas = [];
            
            // Geographic regions
            const regions = {
                'north america': { name: 'North America', color: '#28a745' },
                'south america': { name: 'South America', color: '#17a2b8' },
                'europe': { name: 'Europe', color: '#6f42c1' },
                'africa': { name: 'Africa', color: '#fd7e14' },
                'asia': { name: 'Asia', color: '#e83e8c' },
                'oceania': { name: 'Oceania', color: '#20c997' },
                'arctic': { name: 'Arctic', color: '#6c757d' },
                'antarctica': { name: 'Antarctica', color: '#495057' },
                'middle east': { name: 'Middle East', color: '#dc3545' },
                'mediterranean': { name: 'Mediterranean', color: '#007bff' }
            };
            
            Object.keys(regions).forEach(keyword => {
                if (searchText.includes(keyword)) {
                    focusAreas.push(regions[keyword]);
                }
            });
            
            // Geographic concepts
            const concepts = {
                'climate': { name: 'Climate Patterns', color: '#28a745' },
                'population': { name: 'Population Density', color: '#17a2b8' },
                'culture': { name: 'Cultural Landscapes', color: '#6f42c1' },
                'economic': { name: 'Economic Systems', color: '#fd7e14' },
                'physical': { name: 'Physical Geography', color: '#e83e8c' },
                'political': { name: 'Political Geography', color: '#dc3545' },
                'urban': { name: 'Urban Geography', color: '#007bff' },
                'rural': { name: 'Rural Landscapes', color: '#20c997' }
            };
            
            Object.keys(concepts).forEach(keyword => {
                if (searchText.includes(keyword)) {
                    focusAreas.push(concepts[keyword]);
                }
            });
            
            if (focusAreas.length > 0) {
                focusList.innerHTML = focusAreas.map(area => `
                    <span style="background: ${area.color}; color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">
                        ${area.name}
                    </span>
                `).join('');
                focusPanel.style.display = 'block';
            } else {
                focusPanel.style.display = 'none';
            }
        }

        function loadLessonMapActivities() {
            if (!currentMapLesson) return;
            
            console.log('🗺️ Loading Map Activities for:', currentMapLesson.title);
            console.log('📊 Current Lesson Data:', currentMapLesson);
            
            const activitiesPanel = document.getElementById('map-activities-panel');
            const activitiesList = document.getElementById('lesson-activities-list');
            
            // Extract comprehensive lesson data for intelligent analysis
            const content = (currentMapLesson.content || currentMapLesson.studentReading?.fullContent || '').toLowerCase();
            const title = (currentMapLesson.title || '').toLowerCase();
            const moduleTitle = (currentMapLesson.moduleTitle || currentMapLesson.module?.title || '').toLowerCase();
            const vocabulary = currentMapLesson.vocabulary || [];
            const objectives = currentMapLesson.objectives || [];
            
            console.log('🔍 Analysis Data:');
            console.log('  Content length:', content.length);
            console.log('  Title:', title);
            console.log('  Module Title:', moduleTitle);
            console.log('  Vocabulary count:', vocabulary.length);
            console.log('  Objectives count:', objectives.length);
            
            // Create comprehensive search text for analysis
            const searchText = [content, title, moduleTitle, 
                               objectives.join(' '), 
                               vocabulary.map(v => typeof v === 'string' ? v : v.term).join(' ')].join(' ').toLowerCase();
            
            // Intelligent activity generation based on lesson content analysis
            const activities = generateIntelligentActivities(searchText, title, moduleTitle, currentMapLesson);
            
            // Always ensure at least one activity
            if (activities.length === 0) {
                activities.push({
                    icon: '🎯',
                    title: 'Geographic Context Explorer',
                    description: 'Discover the geographic connections in this lesson',
                    action: 'startContextExplorationActivity'
                });
            }
            
            activitiesList.innerHTML = activities.map((activity, index) => `
                <div class="activity-card-cool" style="
                    background: white; 
                    border: 1px solid #bee5eb; 
                    border-radius: 8px; 
                    padding: 15px;
                    position: relative;
                    overflow: hidden;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    animation: cardReveal 0.6s ease-out ${index * 0.1}s both;
                    cursor: pointer;
                " onmouseover="this.style.transform='translateY(-3px) scale(1.02)'; this.style.boxShadow='0 8px 25px rgba(23,162,184,0.3)'" 
                   onmouseout="this.style.transform=''; this.style.boxShadow=''">
                    
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <span style="font-size: 1.8rem;">${activity.icon}</span>
                        <h4 style="margin: 0; color: #17a2b8; font-weight: 600;">${activity.title}</h4>
                    </div>
                    
                    <p style="margin: 0 0 12px 0; color: #495057; line-height: 1.4;">${activity.description}</p>
                    
                    <button onclick="${activity.action}()" style="
                        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); 
                        color: white; 
                        border: none; 
                        padding: 8px 16px; 
                        border-radius: 20px; 
                        font-size: 12px; 
                        font-weight: 600;
                        cursor: pointer;
                        position: relative;
                        overflow: hidden;
                        transition: all 0.3s ease;
                        z-index: 2;
                        box-shadow: 0 2px 10px rgba(23,162,184,0.3);
                    "
                    onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(23,162,184,0.5)'"
                    onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 10px rgba(23,162,184,0.3)'">
                        ⚡ Start Activity
                    </button>
                </div>
            `).join('');
            
            activitiesPanel.style.display = 'block';
        }

        // INTELLIGENT ACTIVITY GENERATION SYSTEM
        function generateIntelligentActivities(searchText, title, moduleTitle, lessonData) {
            console.log('🧠 Intelligent Activity Generation Debug:');
            console.log('📝 Search Text:', searchText.substring(0, 200) + '...');
            console.log('📚 Title:', title);
            console.log('📖 Module Title:', moduleTitle);
            console.log('🔍 Lesson Data Keys:', Object.keys(lessonData || {}));
            
            const activities = [];
            
            // ECONOMICS LESSONS - Creative Geographic Connections
            if (moduleTitle.includes('economic') || searchText.includes('economic') || searchText.includes('trade') || searchText.includes('money')) {
                
                // Global Trade Routes Activity
                if (searchText.includes('trade') || searchText.includes('global') || searchText.includes('import') || searchText.includes('export')) {
                    activities.push({
                        icon: '🌐',
                        title: 'Global Trade Routes Explorer',
                        description: 'Discover how geography shapes global economic connections and trade patterns',
                        action: 'startTradeRoutesActivity'
                    });
                }
                
                // Economic Geography Mapping
                if (searchText.includes('development') || searchText.includes('resources') || searchText.includes('production')) {
                    activities.push({
                        icon: '💰',
                        title: 'Economic Geography Mapper',
                        description: 'Map economic activities and development levels across different regions',
                        action: 'startEconomicMappingActivity'
                    });
                }
                
                // Supply Chain Geography
                if (searchText.includes('supply') || searchText.includes('demand') || searchText.includes('factors of production')) {
                    activities.push({
                        icon: '🔗',
                        title: 'Supply Chain Geography',
                        description: 'Trace the geographic journey of goods from production to consumption',
                        action: 'startSupplyChainActivity'
                    });
                }
            }
            
            // PHYSICAL GEOGRAPHY LESSONS
            if (searchText.includes('physical') || searchText.includes('climate') || searchText.includes('river') || 
                searchText.includes('mountain') || searchText.includes('desert') || searchText.includes('ocean')) {
                
                activities.push({
                    icon: '🌍',
                    title: 'Physical Features Explorer',
                    description: 'Identify and analyze physical geographic features related to this lesson',
                    action: 'startPhysicalFeaturesActivity'
                });
                
                if (searchText.includes('climate') || searchText.includes('weather') || searchText.includes('temperature')) {
                    activities.push({
                        icon: '🌡️',
                        title: 'Climate Pattern Analysis',
                        description: 'Explore climate data and weather patterns in your lesson region',
                        action: 'startClimateActivity'
                    });
                }
            }
            
            // CULTURAL/HISTORICAL LESSONS - Geographic Context
            if (searchText.includes('dynasty') || searchText.includes('empire') || searchText.includes('culture') || 
                searchText.includes('civilization') || searchText.includes('people')) {
                
                activities.push({
                    icon: '🏛️',
                    title: 'Cultural Geography Explorer',
                    description: 'Discover how geography influenced the culture and history in this lesson',
                    action: 'startCulturalGeographyActivity'
                });
                
                if (searchText.includes('empire') || searchText.includes('dynasty') || searchText.includes('expansion')) {
                    activities.push({
                        icon: '🗺️',
                        title: 'Historical Geography Mapper',
                        description: 'Map the geographic extent and influence of historical civilizations',
                        action: 'startHistoricalMappingActivity'
                    });
                }
            }
            
            // REGIONAL STUDIES
            if (searchText.includes('africa') || searchText.includes('asia') || searchText.includes('europe') || 
                searchText.includes('america') || searchText.includes('region')) {
                
                activities.push({
                    icon: '📍',
                    title: 'Regional Focus Explorer',
                    description: 'Explore the specific geographic region featured in this lesson',
                    action: 'startRegionalFocusActivity'
                });
                
                activities.push({
                    icon: '⚖️',
                    title: 'Regional Comparison Tool',
                    description: 'Compare your lesson region with other areas of the world',
                    action: 'startComparisonActivity'
                });
            }
            
            // LOCATION-BASED ACTIVITIES
            if (searchText.includes('location') || searchText.includes('coordinate') || searchText.includes('city') || 
                searchText.includes('capital') || searchText.includes('country')) {
                
                activities.push({
                    icon: '🎯',
                    title: 'Location Detective',
                    description: 'Practice identifying locations and coordinates mentioned in your lesson',
                    action: 'startLocationActivity'
                });
            }
            
            // POPULATION AND URBAN STUDIES
            if (searchText.includes('population') || searchText.includes('urban') || searchText.includes('city') || 
                searchText.includes('settlement') || searchText.includes('demographic')) {
                
                activities.push({
                    icon: '👥',
                    title: 'Population Pattern Explorer',
                    description: 'Analyze population distribution and urban development patterns',
                    action: 'startPopulationActivity'
                });
            }
            
            // ENVIRONMENTAL AND RESOURCE STUDIES
            if (searchText.includes('environment') || searchText.includes('resource') || searchText.includes('natural') || 
                searchText.includes('forest') || searchText.includes('water') || searchText.includes('energy')) {
                
                activities.push({
                    icon: '🌱',
                    title: 'Environmental Geography',
                    description: 'Explore environmental issues and natural resources in your lesson area',
                    action: 'startEnvironmentalActivity'
                });
            }
            
            console.log('✨ Generated Activities:', activities.length, activities.map(a => a.title));
            return activities;
        }

        function focusOnLessonRegion() {
            if (!enhancedMap || !currentMapLesson) {
                updateMapStatus('No lesson selected for region focus');
                return;
            }
            
            const lessonContent = (currentMapLesson.content || '').toLowerCase();
            const lessonTitle = (currentMapLesson.title || '').toLowerCase();
            const moduleTitle = (currentMapLesson.module?.title || '').toLowerCase();
            const searchText = lessonContent + ' ' + lessonTitle + ' ' + moduleTitle;
            
            // Define enhanced region mappings based on lesson content
            const regionMappings = {
                // North America - More specific
                'canada': { center: [60, -106], zoom: 4, name: 'Canada' },
                'canadian': { center: [60, -106], zoom: 4, name: 'Canada' },
                'manitoba': { center: [56, -98], zoom: 6, name: 'Manitoba, Canada' },
                'winnipeg': { center: [49.8951, -97.1384], zoom: 8, name: 'Winnipeg, Manitoba' },
                'ontario': { center: [50, -86], zoom: 5, name: 'Ontario, Canada' },
                'quebec': { center: [52, -72], zoom: 5, name: 'Quebec, Canada' },
                'british columbia': { center: [54, -126], zoom: 5, name: 'British Columbia, Canada' },
                'alberta': { center: [54, -116], zoom: 5, name: 'Alberta, Canada' },
                'saskatchewan': { center: [54, -106], zoom: 6, name: 'Saskatchewan, Canada' },
                'nova scotia': { center: [45, -63], zoom: 7, name: 'Nova Scotia, Canada' },
                'newfoundland': { center: [49, -56], zoom: 6, name: 'Newfoundland, Canada' },
                'yukon': { center: [64, -135], zoom: 5, name: 'Yukon Territory, Canada' },
                'northwest territories': { center: [64, -116], zoom: 4, name: 'Northwest Territories, Canada' },
                'nunavut': { center: [68, -90], zoom: 4, name: 'Nunavut, Canada' },
                
                // United States
                'united states': { center: [40, -100], zoom: 4, name: 'United States' },
                'usa': { center: [40, -100], zoom: 4, name: 'United States' },
                'america': { center: [40, -100], zoom: 4, name: 'United States' },
                'mexico': { center: [23, -102], zoom: 5, name: 'Mexico' },
                
                // Broader regions
                'north america': { center: [50, -100], zoom: 3, name: 'North America' },
                'south america': { center: [-15, -60], zoom: 3, name: 'South America' },
                'europe': { center: [50, 10], zoom: 4, name: 'Europe' },
                'africa': { center: [0, 20], zoom: 3, name: 'Africa' },
                'asia': { center: [30, 100], zoom: 3, name: 'Asia' },
                'oceania': { center: [-25, 140], zoom: 4, name: 'Oceania' },
                'australia': { center: [-25, 133], zoom: 4, name: 'Australia' },
                'antarctica': { center: [-85, 0], zoom: 3, name: 'Antarctica' },
                
                // Specific countries
                'brazil': { center: [-10, -55], zoom: 4, name: 'Brazil' },
                'china': { center: [35, 104], zoom: 4, name: 'China' },
                'india': { center: [20, 78], zoom: 4, name: 'India' },
                'russia': { center: [61, 105], zoom: 3, name: 'Russia' },
                'middle east': { center: [29, 47], zoom: 4, name: 'Middle East' },
                'byzantine': { center: [39, 35], zoom: 6, name: 'Byzantine Empire' },
                'mediterranean': { center: [35, 20], zoom: 5, name: 'Mediterranean' },
                'arctic': { center: [75, -100], zoom: 3, name: 'Arctic' },
                'pacific': { center: [0, -155], zoom: 3, name: 'Pacific Ocean' },
                'atlantic': { center: [0, -30], zoom: 3, name: 'Atlantic Ocean' }
            };
            
            // Find matching region (prioritize more specific matches)
            let targetRegion = null;
            let bestMatch = '';
            
            for (const [keyword, region] of Object.entries(regionMappings)) {
                if (searchText.includes(keyword)) {
                    // Prefer longer, more specific matches
                    if (keyword.length > bestMatch.length) {
                        targetRegion = region;
                        bestMatch = keyword;
                    }
                }
            }
            
            if (targetRegion) {
                enhancedMap.setView(targetRegion.center, targetRegion.zoom);
                updateMapStatus(`🎯 Focused on ${targetRegion.name} for current lesson`);
                
                // Set terrain view for better geographic visualization
                setTimeout(() => {
                    const terrainToggle = document.getElementById('mapTerrainToggle');
                    if (terrainToggle && !terrainToggle.checked) {
                        terrainToggle.checked = true;
                        enable3DTerrain();
                    }
                }, 500);
                
                // Store the lesson region for activities
                window.currentLessonRegion = {
                    keyword: bestMatch,
                    region: targetRegion,
                    searchText: searchText
                };
                
            } else {
                // Default to global view
                resetEnhancedMapView();
                updateMapStatus('No specific region detected - showing global view');
                window.currentLessonRegion = null;
            }
        }

        function showLessonData() {
            if (!enhancedMap || !currentMapLesson) {
                updateMapStatus('No lesson selected for data display');
                return;
            }
            
            // Analyze lesson content to determine relevant data layers
            const content = (currentMapLesson.content || '').toLowerCase();
            const title = (currentMapLesson.title || '').toLowerCase();
            const searchText = content + ' ' + title;
            
            const earthquakeToggle = document.getElementById('mapEarthquakeToggle');
            const citiesToggle = document.getElementById('mapCitiesToggle');
            const climateToggle = document.getElementById('mapClimateToggle');
            
            let layersLoaded = [];
            
            // Smart layer selection based on lesson content
            if (searchText.includes('earthquake') || searchText.includes('tectonic') || searchText.includes('volcano') || searchText.includes('natural disaster')) {
                earthquakeToggle.checked = true;
                loadEarthquakeData();
                layersLoaded.push('earthquake data');
            }
            
            if (searchText.includes('city') || searchText.includes('urban') || searchText.includes('population') || searchText.includes('settlement')) {
                citiesToggle.checked = true;
                loadCitiesData();
                layersLoaded.push('major cities');
            }
            
            if (searchText.includes('climate') || searchText.includes('weather') || searchText.includes('temperature') || searchText.includes('precipitation')) {
                climateToggle.checked = true;
                loadClimateData();
                layersLoaded.push('climate zones');
            }
            
            // Default to cities if no specific content detected
            if (layersLoaded.length === 0) {
                citiesToggle.checked = true;
                loadCitiesData();
                layersLoaded.push('major cities');
            }
            
            updateMapStatus(`Loaded relevant data layers: ${layersLoaded.join(', ')}`);
        }

        function resetEnhancedMapView() {
            if (!enhancedMap) return;
            
            enhancedMap.setView([20, 0], 2);
            
            // Reset all toggles
            document.querySelectorAll('#maps-tab input[type="checkbox"]').forEach(input => {
                input.checked = false;
            });
            
            // Remove all layers
            removeAllMapLayers();
            
            updateMapStatus('View reset to global perspective');
        }

        function loadEarthquakeData() {
            updateMapStatus('Loading recent earthquake data from USGS...');
            
            // Try to load real USGS earthquake data first
            fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/significant_week.geojson')
                .then(response => response.json())
                .then(data => {
                    createEarthquakeLayer(data, 'significant');
                })
                .catch(error => {
                    console.log('Significant earthquakes not available, trying all M4.5+ earthquakes...');
                    // Try M4.5+ earthquakes from past week if significant ones fail
                    fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/4.5_week.geojson')
                        .then(response => response.json())
                        .then(data => {
                            createEarthquakeLayer(data, 'magnitude_4.5+');
                        })
                        .catch(error => {
                            console.error('Error loading earthquake data:', error);
                            updateMapStatus('Error loading live earthquake data - using educational demo data');
                            loadEducationalEarthquakeData();
                        });
                });
        }

        function createEarthquakeLayer(data, dataType) {
            const earthquakeLayer = L.geoJSON(data, {
                pointToLayer: function(feature, latlng) {
                    const magnitude = feature.properties.mag;
                    const depth = feature.geometry.coordinates[2];
                    
                    // Size based on magnitude
                    const radius = Math.max(magnitude * 2.5, 4);
                    
                    // Color based on magnitude and depth
                    let fillColor = '#ffff00'; // Default yellow
                    if (magnitude >= 7) fillColor = '#8B0000'; // Dark red for major
                    else if (magnitude >= 6) fillColor = '#ff0000'; // Red for strong
                    else if (magnitude >= 5) fillColor = '#ff6600'; // Orange for moderate
                    else if (magnitude >= 4) fillColor = '#ffcc00'; // Yellow-orange for light
                    
                    // Adjust opacity based on depth (deeper = more transparent)
                    const opacity = depth > 100 ? 0.6 : depth > 50 ? 0.7 : 0.9;
                    
                    return L.circleMarker(latlng, {
                        radius: radius,
                        fillColor: fillColor,
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: opacity
                    });
                },
                onEachFeature: function(feature, layer) {
                    const props = feature.properties;
                    const magnitude = props.mag;
                    const depth = feature.geometry.coordinates[2];
                    const time = new Date(props.time);
                    
                    // Educational magnitude scale info
                    let magnitudeInfo = '';
                    if (magnitude >= 7) magnitudeInfo = 'Major earthquake - can cause serious damage';
                    else if (magnitude >= 6) magnitudeInfo = 'Strong earthquake - can be destructive';
                    else if (magnitude >= 5) magnitudeInfo = 'Moderate earthquake - can cause damage';
                    else if (magnitude >= 4) magnitudeInfo = 'Light earthquake - often felt by people';
                    else magnitudeInfo = 'Minor earthquake - usually not felt';
                    
                    layer.bindPopup(`
                        <h4>🌍 Earthquake Information</h4>
                        <p><strong>Magnitude:</strong> ${magnitude} (${magnitudeInfo})</p>
                        <p><strong>Location:</strong> ${props.place}</p>
                        <p><strong>Date/Time:</strong> ${time.toLocaleString()}</p>
                        <p><strong>Depth:</strong> ${depth.toFixed(1)} km ${depth > 70 ? '(Deep)' : depth > 35 ? '(Intermediate)' : '(Shallow)'}</p>
                        <p><strong>Coordinates:</strong> ${feature.geometry.coordinates[1].toFixed(3)}°, ${feature.geometry.coordinates[0].toFixed(3)}°</p>
                        <hr style="margin: 8px 0;">
                        <p style="font-size: 0.9em; color: #666;">
                            💡 <strong>Educational Note:</strong> ${magnitudeInfo.toLowerCase()}. 
                            ${depth > 70 ? 'Deep earthquakes cause less surface damage.' : 'Shallow earthquakes can be more destructive.'}
                        </p>
                        <p style="font-size: 0.85em; color: #888;">Data: USGS Earthquake Hazards Program</p>
                    `);
                }
            });
            
            // Store layer for removal later
            enhancedMap.earthquakeLayer = earthquakeLayer;
            earthquakeLayer.addTo(enhancedMap);
            mapLoadedLayers.add('earthquakes');
            updateMapStatus(`Loaded ${data.features.length} recent earthquakes (${dataType}) from USGS`);
        }

        function loadEducationalEarthquakeData() {
            // Educational demo earthquakes showing major tectonic plate boundaries
            const educationalQuakes = [
                // Pacific Ring of Fire
                { lat: 35.6762, lng: 139.6503, mag: 6.1, place: "Near Tokyo, Japan - Pacific Plate", depth: 45, info: "Part of the Pacific Ring of Fire" },
                { lat: 37.7749, lng: -122.4194, mag: 5.2, place: "San Francisco Bay Area, CA - San Andreas Fault", depth: 12, info: "Transform plate boundary" },
                { lat: -33.8688, lng: 151.2093, mag: 4.8, place: "Near Sydney, Australia - Australian Plate", depth: 25, info: "Intraplate earthquake" },
                { lat: 19.4326, lng: -155.5, mag: 5.5, place: "Hawaii - Volcanic Activity", depth: 8, info: "Volcanic hotspot earthquake" },
                
                // Mid-Atlantic Ridge
                { lat: 64.1466, lng: -21.9426, mag: 4.2, place: "Iceland - Mid-Atlantic Ridge", depth: 15, info: "Divergent plate boundary" },
                
                // Mediterranean
                { lat: 38.7223, lng: 27.1426, mag: 5.8, place: "Western Turkey - Anatolian Fault", depth: 18, info: "Complex tectonic setting" },
                { lat: 37.9755, lng: 23.7348, mag: 4.9, place: "Athens, Greece - Aegean Sea Plate", depth: 35, info: "Convergent boundary effects" },
                
                // Himalayas
                { lat: 28.2380, lng: 83.9956, mag: 6.3, place: "Nepal Himalayas - Indian Plate collision", depth: 55, info: "Continental collision zone" },
                
                // Andes Mountains
                { lat: -12.0464, lng: -77.0428, mag: 5.9, place: "Near Lima, Peru - Nazca Plate subduction", depth: 65, info: "Oceanic-continental convergence" },
                { lat: -33.4489, lng: -70.6693, mag: 6.7, place: "Santiago, Chile - Nazca Plate", depth: 85, info: "Deep subduction zone" }
            ];
            
            const earthquakeLayer = L.layerGroup();
            educationalQuakes.forEach(quake => {
                const radius = Math.max(quake.mag * 2.5, 4);
                let fillColor = '#ffff00';
                if (quake.mag >= 6.5) fillColor = '#8B0000';
                else if (quake.mag >= 6) fillColor = '#ff0000';
                else if (quake.mag >= 5.5) fillColor = '#ff6600';
                else if (quake.mag >= 5) fillColor = '#ffcc00';
                
                const marker = L.circleMarker([quake.lat, quake.lng], {
                    radius: radius,
                    fillColor: fillColor,
                    color: '#000',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                marker.bindPopup(`
                    <h4>🌍 Educational Earthquake Example</h4>
                    <p><strong>Magnitude:</strong> ${quake.mag}</p>
                    <p><strong>Location:</strong> ${quake.place}</p>
                    <p><strong>Depth:</strong> ${quake.depth} km</p>
                    <p><strong>Tectonic Setting:</strong> ${quake.info}</p>
                    <hr style="margin: 8px 0;">
                    <p style="font-size: 0.9em; color: #666;">
                        💡 <strong>Why here?</strong> This location demonstrates important tectonic processes in geography education.
                    </p>
                `);
                
                earthquakeLayer.addLayer(marker);
            });
            
            enhancedMap.earthquakeLayer = earthquakeLayer;
            earthquakeLayer.addTo(enhancedMap);
            mapLoadedLayers.add('earthquakes');
            updateMapStatus(`Loaded ${educationalQuakes.length} educational earthquake examples showing tectonic boundaries`);
        }

        function loadCitiesData() {
            updateMapStatus('Loading major world cities...');
            
            // Comprehensive world cities data for educational purposes
            const majorCities = [
                // Asia
                { name: "Tokyo", country: "Japan", lat: 35.6762, lng: 139.6503, pop: "37.4M", continent: "Asia" },
                { name: "Delhi", country: "India", lat: 28.7041, lng: 77.1025, pop: "30.3M", continent: "Asia" },
                { name: "Shanghai", country: "China", lat: 31.2304, lng: 121.4737, pop: "27.1M", continent: "Asia" },
                { name: "Mumbai", country: "India", lat: 19.0760, lng: 72.8777, pop: "20.4M", continent: "Asia" },
                { name: "Beijing", country: "China", lat: 39.9042, lng: 116.4074, pop: "20.4M", continent: "Asia" },
                { name: "Dhaka", country: "Bangladesh", lat: 23.8103, lng: 90.4125, pop: "20.3M", continent: "Asia" },
                { name: "Osaka", country: "Japan", lat: 34.6937, lng: 135.5023, pop: "19.3M", continent: "Asia" },
                { name: "Karachi", country: "Pakistan", lat: 24.8607, lng: 67.0011, pop: "15.4M", continent: "Asia" },
                { name: "Istanbul", country: "Turkey", lat: 41.0082, lng: 28.9784, pop: "15.2M", continent: "Asia/Europe" },
                { name: "Chongqing", country: "China", lat: 29.5630, lng: 106.5516, pop: "15.0M", continent: "Asia" },
                
                // Americas
                { name: "São Paulo", country: "Brazil", lat: -23.5505, lng: -46.6333, pop: "22.0M", continent: "South America" },
                { name: "Mexico City", country: "Mexico", lat: 19.4326, lng: -99.1332, pop: "21.8M", continent: "North America" },
                { name: "Buenos Aires", country: "Argentina", lat: -34.6118, lng: -58.3960, pop: "15.0M", continent: "South America" },
                { name: "Rio de Janeiro", country: "Brazil", lat: -22.9068, lng: -43.1729, pop: "13.3M", continent: "South America" },
                { name: "New York", country: "USA", lat: 40.7128, lng: -74.0060, pop: "8.3M", continent: "North America" },
                { name: "Los Angeles", country: "USA", lat: 34.0522, lng: -118.2437, pop: "4.0M", continent: "North America" },
                { name: "Lima", country: "Peru", lat: -12.0464, lng: -77.0428, pop: "10.7M", continent: "South America" },
                { name: "Bogotá", country: "Colombia", lat: 4.7110, lng: -74.0721, pop: "10.6M", continent: "South America" },
                
                // Africa
                { name: "Cairo", country: "Egypt", lat: 30.0444, lng: 31.2357, pop: "20.9M", continent: "Africa" },
                { name: "Lagos", country: "Nigeria", lat: 6.5244, lng: 3.3792, pop: "14.9M", continent: "Africa" },
                { name: "Kinshasa", country: "DR Congo", lat: -4.4419, lng: 15.2663, pop: "14.3M", continent: "Africa" },
                { name: "Johannesburg", country: "South Africa", lat: -26.2041, lng: 28.0473, pop: "9.6M", continent: "Africa" },
                { name: "Luanda", country: "Angola", lat: -8.8390, lng: 13.2894, pop: "8.3M", continent: "Africa" },
                { name: "Dar es Salaam", country: "Tanzania", lat: -6.7924, lng: 39.2083, pop: "6.7M", continent: "Africa" },
                
                // Europe
                { name: "Moscow", country: "Russia", lat: 55.7558, lng: 37.6176, pop: "12.5M", continent: "Europe" },
                { name: "London", country: "UK", lat: 51.5074, lng: -0.1278, pop: "9.0M", continent: "Europe" },
                { name: "Paris", country: "France", lat: 48.8566, lng: 2.3522, pop: "10.9M", continent: "Europe" },
                { name: "Madrid", country: "Spain", lat: 40.4168, lng: -3.7038, pop: "6.6M", continent: "Europe" },
                { name: "Barcelona", country: "Spain", lat: 41.3851, lng: 2.1734, pop: "5.6M", continent: "Europe" },
                { name: "Berlin", country: "Germany", lat: 52.5200, lng: 13.4050, pop: "3.7M", continent: "Europe" },
                
                // Oceania
                { name: "Sydney", country: "Australia", lat: -33.8688, lng: 151.2093, pop: "5.3M", continent: "Oceania" },
                { name: "Melbourne", country: "Australia", lat: -37.8136, lng: 144.9631, pop: "5.0M", continent: "Oceania" }
            ];
            
            const citiesLayer = L.layerGroup();
            
            // Create continent-based color coding
            const continentColors = {
                'Asia': '#ff6b6b',
                'Europe': '#4ecdc4', 
                'Africa': '#45b7d1',
                'North America': '#96ceb4',
                'South America': '#ffeaa7',
                'Oceania': '#dda0dd',
                'Asia/Europe': '#fd79a8'
            };
            
            majorCities.forEach(city => {
                const popSize = parseFloat(city.pop) * 1000000; // Convert to actual number
                let markerSize = 8;
                if (popSize > 20000000) markerSize = 16;
                else if (popSize > 15000000) markerSize = 14;
                else if (popSize > 10000000) markerSize = 12;
                else if (popSize > 5000000) markerSize = 10;
                
                const marker = L.circleMarker([city.lat, city.lng], {
                    radius: markerSize,
                    fillColor: continentColors[city.continent] || '#95a5a6',
                    color: '#2c3e50',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                marker.bindPopup(`
                    <h4>🏙️ ${city.name}</h4>
                    <p><strong>Country:</strong> ${city.country}</p>
                    <p><strong>Continent:</strong> ${city.continent}</p>
                    <p><strong>Population:</strong> ${city.pop}</p>
                    <p><strong>Coordinates:</strong> ${city.lat.toFixed(2)}°, ${city.lng.toFixed(2)}°</p>
                    <p style="font-size: 0.9em; color: #666;">💡 Population shown by marker size</p>
                `);
                
                citiesLayer.addLayer(marker);
            });
            
            enhancedMap.citiesLayer = citiesLayer;
            citiesLayer.addTo(enhancedMap);
            mapLoadedLayers.add('cities');
            updateMapStatus(`Loaded ${majorCities.length} major world cities with continent color coding`);
        }

        function loadClimateData() {
            updateMapStatus('Loading Köppen climate classification zones...');
            
            // Köppen Climate Classification - Educational version with major climate zones
            const climateZones = [
                // Tropical climates (A)
                {
                    name: "Tropical Rainforest (Af)",
                    bounds: [[-10, -80], [10, -50]], // Amazon Basin
                    color: '#228B22',
                    description: "Hot and wet year-round, dense rainforests"
                },
                {
                    name: "Tropical Rainforest (Af)", 
                    bounds: [[-5, 10], [5, 30]], // Central Africa
                    color: '#228B22',
                    description: "Hot and wet year-round, dense rainforests"
                },
                {
                    name: "Tropical Rainforest (Af)",
                    bounds: [[-10, 95], [10, 155]], // Southeast Asia
                    color: '#228B22', 
                    description: "Hot and wet year-round, dense rainforests"
                },
                
                // Arid climates (B)
                {
                    name: "Hot Desert (BWh)",
                    bounds: [[15, -25], [35, 55]], // Sahara & Arabian Peninsula
                    color: '#FFD700',
                    description: "Very hot and dry, minimal precipitation"
                },
                {
                    name: "Hot Desert (BWh)",
                    bounds: [[20, -125], [35, -105]], // Southwestern USA/Mexico
                    color: '#FFD700',
                    description: "Very hot and dry, minimal precipitation"
                },
                {
                    name: "Cold Desert (BWk)",
                    bounds: [[35, 75], [50, 105]], // Central Asia
                    color: '#DEB887',
                    description: "Cold winters, hot summers, very dry"
                },
                
                // Temperate climates (C)
                {
                    name: "Mediterranean (Csa/Csb)",
                    bounds: [[30, -10], [45, 45]], // Mediterranean Basin
                    color: '#9ACD32',
                    description: "Warm dry summers, mild wet winters"
                },
                {
                    name: "Mediterranean (Csb)",
                    bounds: [[32, -125], [42, -115]], // California
                    color: '#9ACD32',
                    description: "Warm dry summers, mild wet winters"
                },
                {
                    name: "Humid Subtropical (Cfa)",
                    bounds: [[25, -100], [40, -75]], // Southeastern USA
                    color: '#90EE90',
                    description: "Hot humid summers, mild winters"
                },
                {
                    name: "Humid Subtropical (Cfa)",
                    bounds: [[25, 100], [40, 140]], // Eastern China/Japan
                    color: '#90EE90',
                    description: "Hot humid summers, mild winters"
                },
                {
                    name: "Oceanic (Cfb)",
                    bounds: [[45, -10], [60, 30]], // Western Europe
                    color: '#98FB98',
                    description: "Mild temperatures, year-round precipitation"
                },
                
                // Continental climates (D)
                {
                    name: "Humid Continental (Dfb)",
                    bounds: [[45, -100], [60, -60]], // Great Lakes region
                    color: '#20B2AA',
                    description: "Cold snowy winters, warm summers"
                },
                {
                    name: "Humid Continental (Dfb)",
                    bounds: [[50, 20], [65, 140]], // Northern Europe/Asia
                    color: '#20B2AA',
                    description: "Cold snowy winters, warm summers"
                },
                {
                    name: "Subarctic (Dfc)",
                    bounds: [[60, -160], [70, 170]], // Northern Canada/Siberia
                    color: '#4682B4',
                    description: "Very cold winters, short cool summers"
                },
                
                // Polar climates (E)
                {
                    name: "Tundra (ET)",
                    bounds: [[66, -170], [80, 180]], // Arctic tundra
                    color: '#E6E6FA',
                    description: "Permafrost, very cold, short growing season"
                },
                {
                    name: "Ice Cap (EF)",
                    bounds: [[80, -180], [90, 180]], // Arctic ice cap
                    color: '#F0F8FF',
                    description: "Permanent ice cover, extremely cold"
                },
                {
                    name: "Ice Cap (EF)",
                    bounds: [[-90, -180], [-60, 180]], // Antarctica
                    color: '#F0F8FF',
                    description: "Permanent ice cover, extremely cold"
                }
            ];
            
            const climateLayer = L.layerGroup();
            
            climateZones.forEach(zone => {
                const rectangle = L.rectangle(zone.bounds, {
                    color: zone.color,
                    weight: 1,
                    fillColor: zone.color,
                    fillOpacity: 0.4,
                    opacity: 0.8
                });
                
                rectangle.bindPopup(`
                    <h4>🌡️ ${zone.name}</h4>
                    <p><strong>Characteristics:</strong> ${zone.description}</p>
                    <p style="font-size: 0.9em; color: #666;">
                        💡 Click other zones to compare climate types worldwide
                    </p>
                `);
                
                climateLayer.addLayer(rectangle);
            });
            
            enhancedMap.climateLayer = climateLayer;
            climateLayer.addTo(enhancedMap);
            mapLoadedLayers.add('climate');
            updateMapStatus(`Loaded Köppen climate classification with ${climateZones.length} major climate zones`);
        }

        function enable3DTerrain() {
            if (!enhancedMap) return;
            
            updateMapStatus('Note: 3D terrain requires specialized mapping - switching to terrain tile layer');
            
            // Use terrain tile layer instead of 3D
            const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenTopoMap contributors'
            });
            
            // Remove current base layer and add terrain
            enhancedMap.eachLayer(layer => {
                if (layer._url && layer._url.includes('tile')) {
                    enhancedMap.removeLayer(layer);
                }
            });
            
            terrainLayer.addTo(enhancedMap);
            enhancedMap.terrainLayer = terrainLayer;
            mapLoadedLayers.add('terrain');
            updateMapStatus('Terrain view enabled');
        }

        function disable3DTerrain() {
            if (!enhancedMap) return;
            
            // Switch back to default OpenStreetMap
            if (enhancedMap.terrainLayer) {
                enhancedMap.removeLayer(enhancedMap.terrainLayer);
                delete enhancedMap.terrainLayer;
            }
            
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(enhancedMap);
            
            mapLoadedLayers.delete('terrain');
            updateMapStatus('Switched back to street view');
        }

        function removeMapLayer(layerName) {
            const layerMap = {
                'earthquakes': 'earthquakeLayer',
                'cities': 'citiesLayer', 
                'climate': 'climateLayer'
            };
            
            const layerProperty = layerMap[layerName];
            if (enhancedMap[layerProperty]) {
                enhancedMap.removeLayer(enhancedMap[layerProperty]);
                delete enhancedMap[layerProperty];
            }
            
            mapLoadedLayers.delete(layerName);
            updateMapStatus(`${layerName} layer removed`);
        }

        function removeAllMapLayers() {
            removeMapLayer('earthquakes');
            removeMapLayer('cities');
            removeMapLayer('climate');
            disable3DTerrain();
            mapLoadedLayers.clear();
        }

        // Category toggle functionality for educational layers
        function toggleCategory(categoryName) {
            const layersDiv = document.getElementById(categoryName + '-layers');
            const arrow = document.getElementById(categoryName + '-arrow');
            
            if (layersDiv.style.display === 'none') {
                layersDiv.style.display = 'block';
                arrow.textContent = '▼';
            } else {
                layersDiv.style.display = 'none';
                arrow.textContent = '▶';
            }
        }

        // Enhanced educational data layers
        
        // NATO Member Countries Layer
        function loadNatoData() {
            if (!enhancedMap) return;
            
            const natoCountries = [
                {name: "United States", lat: 39.8283, lng: -98.5795, joined: "1949"},
                {name: "Canada", lat: 56.1304, lng: -106.3468, joined: "1949"},
                {name: "United Kingdom", lat: 55.3781, lng: -3.4360, joined: "1949"},
                {name: "France", lat: 46.2276, lng: 2.2137, joined: "1949"},
                {name: "Germany", lat: 51.1657, lng: 10.4515, joined: "1955"},
                {name: "Turkey", lat: 38.9637, lng: 35.2433, joined: "1952"},
                {name: "Poland", lat: 51.9194, lng: 19.1451, joined: "1999"},
                {name: "Spain", lat: 40.4637, lng: -3.7492, joined: "1982"},
                {name: "Italy", lat: 41.8719, lng: 12.5674, joined: "1949"},
                {name: "Norway", lat: 60.4720, lng: 8.4689, joined: "1949"},
                {name: "Netherlands", lat: 52.1326, lng: 5.2913, joined: "1949"},
                {name: "Belgium", lat: 50.5039, lng: 4.4699, joined: "1949"},
                {name: "Denmark", lat: 56.2639, lng: 9.5018, joined: "1949"},
                {name: "Portugal", lat: 39.3999, lng: -8.2245, joined: "1949"},
                {name: "Greece", lat: 39.0742, lng: 21.8243, joined: "1952"},
                {name: "Czech Republic", lat: 49.8175, lng: 15.4730, joined: "1999"},
                {name: "Hungary", lat: 47.1625, lng: 19.5033, joined: "1999"},
                {name: "Estonia", lat: 58.5953, lng: 25.0136, joined: "2004"},
                {name: "Latvia", lat: 56.8796, lng: 24.6032, joined: "2004"},
                {name: "Lithuania", lat: 55.1694, lng: 23.8813, joined: "2004"},
                {name: "Slovakia", lat: 48.6690, lng: 19.6990, joined: "2004"},
                {name: "Slovenia", lat: 46.1512, lng: 14.9955, joined: "2004"},
                {name: "Bulgaria", lat: 42.7339, lng: 25.4858, joined: "2004"},
                {name: "Romania", lat: 45.9432, lng: 24.9668, joined: "2004"},
                {name: "Albania", lat: 41.1533, lng: 20.1683, joined: "2009"},
                {name: "Croatia", lat: 45.1000, lng: 15.2000, joined: "2009"},
                {name: "Montenegro", lat: 42.7087, lng: 19.3744, joined: "2017"},
                {name: "North Macedonia", lat: 41.6086, lng: 21.7453, joined: "2020"},
                {name: "Finland", lat: 61.9241, lng: 25.7482, joined: "2023"},
                {name: "Sweden", lat: 60.1282, lng: 18.6435, joined: "2024"}
            ];
            
            const natoMarkers = L.layerGroup();
            
            natoCountries.forEach(country => {
                const marker = L.circleMarker([country.lat, country.lng], {
                    radius: 8,
                    fillColor: '#004d98',
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup(`
                    <strong>🛡️ NATO Member</strong><br>
                    <strong>${country.name}</strong><br>
                    Joined: ${country.joined}<br>
                    <em>Article 5: Collective Defense</em>
                `);
                natoMarkers.addLayer(marker);
            });
            
            enhancedMap.natoLayer = natoMarkers;
            natoMarkers.addTo(enhancedMap);
            mapLoadedLayers.add('nato');
            updateMapStatus('NATO members loaded');
        }

        // Historical Silk Road Routes Layer
        function loadSilkRoadData() {
            if (!enhancedMap) return;
            
            // Major Silk Road cities
            const silkRoadCities = [
                {name: "Constantinople", lat: 41.0082, lng: 28.9784, description: "Gateway between Europe and Asia"},
                {name: "Damascus", lat: 33.5138, lng: 36.2765, description: "Ancient trading hub"},
                {name: "Baghdad", lat: 33.3152, lng: 44.3661, description: "Abbasid Caliphate center"},
                {name: "Isfahan", lat: 32.6547, lng: 51.6681, description: "Persian Empire trading post"},
                {name: "Samarkand", lat: 39.6270, lng: 66.9750, description: "Crossroads of cultures"},
                {name: "Kashgar", lat: 39.4704, lng: 75.9896, description: "Oasis city, cultural exchange"},
                {name: "Dunhuang", lat: 40.1424, lng: 94.6624, description: "Buddhist art center"},
                {name: "Xi'an", lat: 34.3416, lng: 108.9398, description: "Eastern terminus, Tang Dynasty capital"},
                {name: "Venice", lat: 45.4408, lng: 12.3155, description: "Marco Polo's hometown"},
                {name: "Trebizond", lat: 41.0015, lng: 39.7178, description: "Black Sea trading port"}
            ];
            
            // Trade routes (simplified paths)
            const routes = [
                [[45.4408, 12.3155], [41.0082, 28.9784], [33.5138, 36.2765], [33.3152, 44.3661], [32.6547, 51.6681], [39.6270, 66.9750], [39.4704, 75.9896], [40.1424, 94.6624], [34.3416, 108.9398]]
            ];
            
            const silkRoadLayer = L.layerGroup();
            
            // Add cities
            silkRoadCities.forEach(city => {
                const marker = L.circleMarker([city.lat, city.lng], {
                    radius: 10,
                    fillColor: '#d4af37',
                    color: '#8b4513',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup(`
                    <strong>🐪 Silk Road City</strong><br>
                    <strong>${city.name}</strong><br>
                    ${city.description}<br>
                    <em>Historical trading center</em>
                `);
                silkRoadLayer.addLayer(marker);
            });
            
            // Add routes
            routes.forEach(route => {
                const polyline = L.polyline(route, {
                    color: '#8b4513',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '10, 5'
                }).bindPopup('🐪 Historical Silk Road Trade Route');
                silkRoadLayer.addLayer(polyline);
            });
            
            enhancedMap.silkRoadLayer = silkRoadLayer;
            silkRoadLayer.addTo(enhancedMap);
            mapLoadedLayers.add('silkroad');
            updateMapStatus('Silk Road routes loaded');
        }

        // Major Trade Routes Layer (Modern)
        function loadTradeData() {
            if (!enhancedMap) return;
            
            const majorPorts = [
                {name: "Shanghai", lat: 31.2304, lng: 121.4737, cargo: "47.3M TEU", country: "China"},
                {name: "Singapore", lat: 1.2966, lng: 103.7764, cargo: "37.5M TEU", country: "Singapore"},
                {name: "Ningbo-Zhoushan", lat: 29.8683, lng: 121.5440, cargo: "33.4M TEU", country: "China"},
                {name: "Shenzhen", lat: 22.5431, lng: 114.0579, cargo: "28.8M TEU", country: "China"},
                {name: "Guangzhou", lat: 23.1291, lng: 113.2644, cargo: "25.2M TEU", country: "China"},
                {name: "Busan", lat: 35.1796, lng: 129.0756, cargo: "22.9M TEU", country: "South Korea"},
                {name: "Hong Kong", lat: 22.3193, lng: 114.1694, cargo: "17.8M TEU", country: "Hong Kong"},
                {name: "Los Angeles", lat: 33.7701, lng: -118.1937, cargo: "10.7M TEU", country: "USA"},
                {name: "Long Beach", lat: 33.7701, lng: -118.1937, cargo: "8.1M TEU", country: "USA"},
                {name: "Rotterdam", lat: 51.9225, lng: 4.4792, cargo: "15.3M TEU", country: "Netherlands"}
            ];
            
            const tradeLayer = L.layerGroup();
            
            majorPorts.forEach(port => {
                const marker = L.circleMarker([port.lat, port.lng], {
                    radius: 12,
                    fillColor: '#1e88e5',
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup(`
                    <strong>🚢 Major Port</strong><br>
                    <strong>${port.name}</strong><br>
                    Country: ${port.country}<br>
                    Annual Cargo: ${port.cargo}<br>
                    <em>Global shipping hub</em>
                `);
                tradeLayer.addLayer(marker);
            });
            
            enhancedMap.tradeLayer = tradeLayer;
            tradeLayer.addTo(enhancedMap);
            mapLoadedLayers.add('trade');
            updateMapStatus('Major trade routes loaded');
        }

        // G7 Countries Layer
        function loadG7Data() {
            if (!enhancedMap) return;
            
            const g7Countries = [
                {name: "United States", lat: 39.8283, lng: -98.5795, gdp: "$26.9T", capital: "Washington D.C."},
                {name: "China", lat: 35.8617, lng: 104.1954, gdp: "$17.7T", capital: "Beijing"},
                {name: "Japan", lat: 36.2048, lng: 138.2529, gdp: "$4.2T", capital: "Tokyo"},
                {name: "Germany", lat: 51.1657, lng: 10.4515, gdp: "$4.3T", capital: "Berlin"},
                {name: "India", lat: 20.5937, lng: 78.9629, gdp: "$3.9T", capital: "New Delhi"},
                {name: "United Kingdom", lat: 55.3781, lng: -3.4360, gdp: "$3.1T", capital: "London"},
                {name: "France", lat: 46.2276, lng: 2.2137, gdp: "$2.9T", capital: "Paris"},
                {name: "Italy", lat: 41.8719, lng: 12.5674, gdp: "$2.1T", capital: "Rome"},
                {name: "Canada", lat: 56.1304, lng: -106.3468, gdp: "$2.1T", capital: "Ottawa"}
            ];
            
            const g7Layer = L.layerGroup();
            
            g7Countries.forEach(country => {
                const marker = L.circleMarker([country.lat, country.lng], {
                    radius: 15,
                    fillColor: '#ff9800',
                    color: '#ffffff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup(`
                    <strong>💰 G7 Economy</strong><br>
                    <strong>${country.name}</strong><br>
                    Capital: ${country.capital}<br>
                    GDP: ${country.gdp}<br>
                    <em>Major world economy</em>
                `);
                g7Layer.addLayer(marker);
            });
            
            enhancedMap.g7Layer = g7Layer;
            g7Layer.addTo(enhancedMap);
            mapLoadedLayers.add('g7');
            updateMapStatus('G7 countries loaded');
        }

        // Megacities Layer (10M+ population)
        function loadMegacitiesData() {
            if (!enhancedMap) return;
            
            const megacities = [
                {name: "Tokyo", lat: 35.6762, lng: 139.6503, pop: "37.4M", country: "Japan"},
                {name: "Delhi", lat: 28.7041, lng: 77.1025, pop: "32.9M", country: "India"},
                {name: "Shanghai", lat: 31.2304, lng: 121.4737, pop: "28.5M", country: "China"},
                {name: "Dhaka", lat: 23.8103, lng: 90.4125, pop: "22.5M", country: "Bangladesh"},
                {name: "São Paulo", lat: -23.5505, lng: -46.6333, pop: "22.6M", country: "Brazil"},
                {name: "Cairo", lat: 30.0444, lng: 31.2357, pop: "21.3M", country: "Egypt"},
                {name: "Mexico City", lat: 19.4326, lng: -99.1332, pop: "22.0M", country: "Mexico"},
                {name: "Beijing", lat: 39.9042, lng: 116.4074, pop: "21.7M", country: "China"},
                {name: "Mumbai", lat: 19.0760, lng: 72.8777, pop: "20.7M", country: "India"},
                {name: "Osaka", lat: 34.6937, lng: 135.5023, pop: "18.9M", country: "Japan"},
                {name: "New York", lat: 40.7128, lng: -74.0060, pop: "18.8M", country: "USA"},
                {name: "Karachi", lat: 24.8607, lng: 67.0011, pop: "16.8M", country: "Pakistan"},
                {name: "Chongqing", lat: 29.4316, lng: 106.9123, pop: "16.4M", country: "China"},
                {name: "Istanbul", lat: 41.0082, lng: 28.9784, pop: "15.8M", country: "Turkey"},
                {name: "Buenos Aires", lat: -34.6118, lng: -58.3960, pop: "15.4M", country: "Argentina"},
                {name: "Kolkata", lat: 22.5726, lng: 88.3639, pop: "15.1M", country: "India"},
                {name: "Lagos", lat: 6.5244, lng: 3.3792, pop: "15.4M", country: "Nigeria"},
                {name: "Manila", lat: 14.5995, lng: 120.9842, pop: "14.2M", country: "Philippines"},
                {name: "Rio de Janeiro", lat: -22.9068, lng: -43.1729, pop: "13.7M", country: "Brazil"},
                {name: "Guangzhou", lat: 23.1291, lng: 113.2644, pop: "13.5M", country: "China"}
            ];
            
            const megacitiesLayer = L.layerGroup();
            
            megacities.forEach(city => {
                const marker = L.circleMarker([city.lat, city.lng], {
                    radius: 18,
                    fillColor: '#e91e63',
                    color: '#ffffff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.7
                }).bindPopup(`
                    <strong>🏙️ Megacity</strong><br>
                    <strong>${city.name}</strong><br>
                    Country: ${city.country}<br>
                    Population: ${city.pop}<br>
                    <em>Urban agglomeration 10M+</em>
                `);
                megacitiesLayer.addLayer(marker);
            });
            
            enhancedMap.megacitiesLayer = megacitiesLayer;
            megacitiesLayer.addTo(enhancedMap);
            mapLoadedLayers.add('megacities');
            updateMapStatus('Megacities loaded');
        }

        // UNESCO World Heritage Sites Layer
        function loadHeritageData() {
            if (!enhancedMap) return;
            
            const heritageSites = [
                {name: "Great Wall of China", lat: 40.4319, lng: 116.5704, type: "Cultural", country: "China"},
                {name: "Machu Picchu", lat: -13.1631, lng: -72.5450, type: "Mixed", country: "Peru"},
                {name: "Pyramids of Giza", lat: 29.9792, lng: 31.1342, type: "Cultural", country: "Egypt"},
                {name: "Taj Mahal", lat: 27.1751, lng: 78.0421, type: "Cultural", country: "India"},
                {name: "Stonehenge", lat: 51.1789, lng: -1.8262, type: "Cultural", country: "UK"},
                {name: "Angkor Wat", lat: 13.4125, lng: 103.8670, type: "Cultural", country: "Cambodia"},
                {name: "Yellowstone", lat: 44.4280, lng: -110.5885, type: "Natural", country: "USA"},
                {name: "Galápagos Islands", lat: -0.9538, lng: -91.0238, type: "Natural", country: "Ecuador"},
                {name: "Serengeti", lat: -2.3333, lng: 34.8333, type: "Natural", country: "Tanzania"},
                {name: "Grand Canyon", lat: 36.1069, lng: -112.1129, type: "Natural", country: "USA"},
                {name: "Petra", lat: 30.3285, lng: 35.4444, type: "Cultural", country: "Jordan"},
                {name: "Chichen Itza", lat: 20.6843, lng: -88.5678, type: "Cultural", country: "Mexico"},
                {name: "Easter Island", lat: -27.1127, lng: -109.3497, type: "Cultural", country: "Chile"},
                {name: "Venice", lat: 45.4408, lng: 12.3155, type: "Cultural", country: "Italy"},
                {name: "Amazon Rainforest", lat: -3.4653, lng: -62.2159, type: "Natural", country: "Brazil"},
                {name: "Mount Fuji", lat: 35.3606, lng: 138.7274, type: "Cultural", country: "Japan"},
                {name: "Acropolis of Athens", lat: 37.9715, lng: 23.7268, type: "Cultural", country: "Greece"},
                {name: "Mesa Verde", lat: 37.2308, lng: -108.4618, type: "Cultural", country: "USA"},
                {name: "Iguazu Falls", lat: -25.6953, lng: -54.4367, type: "Natural", country: "Argentina/Brazil"},
                {name: "Sagrada Familia", lat: 41.4036, lng: 2.1744, type: "Cultural", country: "Spain"}
            ];
            
            const heritageLayer = L.layerGroup();
            
            heritageSites.forEach(site => {
                const color = site.type === 'Cultural' ? '#9c27b0' : site.type === 'Natural' ? '#4caf50' : '#ff9800';
                const icon = site.type === 'Cultural' ? '🏛️' : site.type === 'Natural' ? '🌿' : '🌍';
                
                const marker = L.circleMarker([site.lat, site.lng], {
                    radius: 10,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup(`
                    <strong>${icon} UNESCO Heritage</strong><br>
                    <strong>${site.name}</strong><br>
                    Country: ${site.country}<br>
                    Type: ${site.type}<br>
                    <em>World Heritage Site</em>
                `);
                heritageLayer.addLayer(marker);
            });
            
            enhancedMap.heritageLayer = heritageLayer;
            heritageLayer.addTo(enhancedMap);
            mapLoadedLayers.add('heritage');
            updateMapStatus('UNESCO Heritage sites loaded');
        }

        // Additional Educational Layers

        // European Union Layer
        function loadEuData() {
            if (!enhancedMap) return;
            
            const euCountries = [
                {name: "Germany", lat: 51.1657, lng: 10.4515, joined: "1957", capital: "Berlin"},
                {name: "France", lat: 46.2276, lng: 2.2137, joined: "1957", capital: "Paris"},
                {name: "Italy", lat: 41.8719, lng: 12.5674, joined: "1957", capital: "Rome"},
                {name: "Netherlands", lat: 52.1326, lng: 5.2913, joined: "1957", capital: "Amsterdam"},
                {name: "Belgium", lat: 50.5039, lng: 4.4699, joined: "1957", capital: "Brussels"},
                {name: "Luxembourg", lat: 49.8153, lng: 6.1296, joined: "1957", capital: "Luxembourg"},
                {name: "Denmark", lat: 56.2639, lng: 9.5018, joined: "1973", capital: "Copenhagen"},
                {name: "Ireland", lat: 53.1424, lng: -7.6921, joined: "1973", capital: "Dublin"},
                {name: "United Kingdom", lat: 55.3781, lng: -3.4360, joined: "1973 (left 2020)", capital: "London"},
                {name: "Greece", lat: 39.0742, lng: 21.8243, joined: "1981", capital: "Athens"},
                {name: "Spain", lat: 40.4637, lng: -3.7492, joined: "1986", capital: "Madrid"},
                {name: "Portugal", lat: 39.3999, lng: -8.2245, joined: "1986", capital: "Lisbon"},
                {name: "Austria", lat: 47.5162, lng: 14.5501, joined: "1995", capital: "Vienna"},
                {name: "Finland", lat: 61.9241, lng: 25.7482, joined: "1995", capital: "Helsinki"},
                {name: "Sweden", lat: 60.1282, lng: 18.6435, joined: "1995", capital: "Stockholm"},
                {name: "Cyprus", lat: 35.1264, lng: 33.4299, joined: "2004", capital: "Nicosia"},
                {name: "Czech Republic", lat: 49.8175, lng: 15.4730, joined: "2004", capital: "Prague"},
                {name: "Estonia", lat: 58.5953, lng: 25.0136, joined: "2004", capital: "Tallinn"},
                {name: "Hungary", lat: 47.1625, lng: 19.5033, joined: "2004", capital: "Budapest"},
                {name: "Latvia", lat: 56.8796, lng: 24.6032, joined: "2004", capital: "Riga"},
                {name: "Lithuania", lat: 55.1694, lng: 23.8813, joined: "2004", capital: "Vilnius"},
                {name: "Malta", lat: 35.9375, lng: 14.3754, joined: "2004", capital: "Valletta"},
                {name: "Poland", lat: 51.9194, lng: 19.1451, joined: "2004", capital: "Warsaw"},
                {name: "Slovakia", lat: 48.6690, lng: 19.6990, joined: "2004", capital: "Bratislava"},
                {name: "Slovenia", lat: 46.1512, lng: 14.9955, joined: "2004", capital: "Ljubljana"},
                {name: "Bulgaria", lat: 42.7339, lng: 25.4858, joined: "2007", capital: "Sofia"},
                {name: "Romania", lat: 45.9432, lng: 24.9668, joined: "2007", capital: "Bucharest"},
                {name: "Croatia", lat: 45.1000, lng: 15.2000, joined: "2013", capital: "Zagreb"}
            ];
            
            const euLayer = L.layerGroup();
            
            euCountries.forEach(country => {
                const isFormerMember = country.joined.includes('left');
                const color = isFormerMember ? '#ff5722' : '#2196f3';
                
                const marker = L.circleMarker([country.lat, country.lng], {
                    radius: 10,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup(`
                    <strong>🇪🇺 EU ${isFormerMember ? 'Former Member' : 'Member'}</strong><br>
                    <strong>${country.name}</strong><br>
                    Capital: ${country.capital}<br>
                    ${isFormerMember ? 'Left' : 'Joined'}: ${country.joined}<br>
                    <em>European integration</em>
                `);
                euLayer.addLayer(marker);
            });
            
            enhancedMap.euLayer = euLayer;
            euLayer.addTo(enhancedMap);
            mapLoadedLayers.add('eu');
            updateMapStatus('European Union members loaded');
        }

        // Major Oil & Gas Fields Layer
        function loadOilData() {
            if (!enhancedMap) return;
            
            const oilFields = [
                {name: "Ghawar Field", lat: 25.5, lng: 49.0, country: "Saudi Arabia", type: "Oil", reserves: "75-83 billion barrels"},
                {name: "Burgan Field", lat: 29.1, lng: 48.1, country: "Kuwait", type: "Oil", reserves: "66-72 billion barrels"},
                {name: "Safaniya Field", lat: 27.7, lng: 48.7, country: "Saudi Arabia", type: "Oil", reserves: "36 billion barrels"},
                {name: "Rumaila Field", lat: 30.9, lng: 47.8, country: "Iraq", type: "Oil", reserves: "17.8 billion barrels"},
                {name: "West Qurna Field", lat: 31.0, lng: 47.3, country: "Iraq", type: "Oil", reserves: "43 billion barrels"},
                {name: "Prudhoe Bay", lat: 70.3, lng: -148.7, country: "USA", type: "Oil", reserves: "25 billion barrels"},
                {name: "Cantarell Field", lat: 22.3, lng: -92.3, country: "Mexico", type: "Oil", reserves: "35 billion barrels"},
                {name: "North Field", lat: 25.8, lng: 51.2, country: "Qatar", type: "Gas", reserves: "900 trillion cubic feet"},
                {name: "South Pars", lat: 27.3, lng: 52.5, country: "Iran", type: "Gas", reserves: "500 trillion cubic feet"},
                {name: "Urengoy", lat: 65.8, lng: 78.3, country: "Russia", type: "Gas", reserves: "222 trillion cubic feet"},
                {name: "Yamburg", lat: 70.4, lng: 68.8, country: "Russia", type: "Gas", reserves: "182 trillion cubic feet"},
                {name: "Hassi R'Mel", lat: 32.1, lng: 3.3, country: "Algeria", type: "Gas", reserves: "85 trillion cubic feet"},
                {name: "Groningen", lat: 53.3, lng: 6.7, country: "Netherlands", type: "Gas", reserves: "60 trillion cubic feet"},
                {name: "Marcellus Shale", lat: 40.2, lng: -78.5, country: "USA", type: "Shale Gas", reserves: "141 trillion cubic feet"},
                {name: "Bakken Formation", lat: 47.9, lng: -103.0, country: "USA", type: "Shale Oil", reserves: "7.4 billion barrels"}
            ];
            
            const oilLayer = L.layerGroup();
            
            oilFields.forEach(field => {
                const color = field.type.includes('Oil') ? '#ff5722' : '#2196f3';
                const icon = field.type.includes('Oil') ? '🛢️' : '🔥';
                
                const marker = L.circleMarker([field.lat, field.lng], {
                    radius: 12,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup(`
                    <strong>${icon} ${field.type} Field</strong><br>
                    <strong>${field.name}</strong><br>
                    Country: ${field.country}<br>
                    Reserves: ${field.reserves}<br>
                    <em>Energy resource</em>
                `);
                oilLayer.addLayer(marker);
            });
            
            enhancedMap.oilLayer = oilLayer;
            oilLayer.addTo(enhancedMap);
            mapLoadedLayers.add('oil');
            updateMapStatus('Oil & gas fields loaded');
        }

        // Active Volcanoes Layer
        function loadVolcanoData() {
            if (!enhancedMap) return;
            
            const volcanoes = [
                {name: "Mount Vesuvius", lat: 40.8214, lng: 14.4265, country: "Italy", type: "Stratovolcano", status: "Active"},
                {name: "Mount Etna", lat: 37.7510, lng: 14.9934, country: "Italy", type: "Stratovolcano", status: "Active"},
                {name: "Krakatoa", lat: -6.1021, lng: 105.4230, country: "Indonesia", type: "Caldera", status: "Active"},
                {name: "Mount Fuji", lat: 35.3606, lng: 138.7274, country: "Japan", type: "Stratovolcano", status: "Dormant"},
                {name: "Kilauea", lat: 19.4069, lng: -155.2834, country: "USA", type: "Shield", status: "Active"},
                {name: "Mauna Loa", lat: 19.4750, lng: -155.6080, country: "USA", type: "Shield", status: "Active"},
                {name: "Stromboli", lat: 38.7893, lng: 15.2134, country: "Italy", type: "Stratovolcano", status: "Active"},
                {name: "Popocatépetl", lat: 19.0218, lng: -98.6278, country: "Mexico", type: "Stratovolcano", status: "Active"},
                {name: "Mount St. Helens", lat: 46.1912, lng: -122.1944, country: "USA", type: "Stratovolcano", status: "Active"},
                {name: "Yellowstone", lat: 44.4280, lng: -110.5885, country: "USA", type: "Supervolcano", status: "Active"},
                {name: "Eyjafjallajökull", lat: 63.6313, lng: -19.6210, country: "Iceland", type: "Stratovolcano", status: "Active"},
                {name: "Mount Erebus", lat: -77.5308, lng: 167.1717, country: "Antarctica", type: "Stratovolcano", status: "Active"},
                {name: "Cotopaxi", lat: -0.6777, lng: -78.4367, country: "Ecuador", type: "Stratovolcano", status: "Active"},
                {name: "Mount Rainier", lat: 46.8523, lng: -121.7603, country: "USA", type: "Stratovolcano", status: "Active"},
                {name: "Sakurajima", lat: 31.5804, lng: 130.6581, country: "Japan", type: "Stratovolcano", status: "Active"}
            ];
            
            const volcanoLayer = L.layerGroup();
            
            volcanoes.forEach(volcano => {
                const color = volcano.status === 'Active' ? '#ff4444' : volcano.status === 'Dormant' ? '#ff9800' : '#666666';
                
                const marker = L.circleMarker([volcano.lat, volcano.lng], {
                    radius: 10,
                    fillColor: color,
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup(`
                    <strong>🌋 Volcano</strong><br>
                    <strong>${volcano.name}</strong><br>
                    Country: ${volcano.country}<br>
                    Type: ${volcano.type}<br>
                    Status: ${volcano.status}<br>
                    <em>Volcanic activity</em>
                `);
                volcanoLayer.addLayer(marker);
            });
            
            enhancedMap.volcanoLayer = volcanoLayer;
            volcanoLayer.addTo(enhancedMap);
            mapLoadedLayers.add('volcano');
            updateMapStatus('Active volcanoes loaded');
        }

        // Ancient Civilizations Layer
        function loadAncientData() {
            if (!enhancedMap) return;
            
            const civilizations = [
                {name: "Mesopotamia", lat: 33.0, lng: 44.0, period: "3500-539 BCE", achievement: "First cities, writing"},
                {name: "Ancient Egypt", lat: 26.0, lng: 30.0, period: "3100-30 BCE", achievement: "Pyramids, hieroglyphs"},
                {name: "Indus Valley", lat: 27.0, lng: 68.0, period: "3300-1300 BCE", achievement: "Urban planning, drainage"},
                {name: "Ancient China", lat: 35.0, lng: 105.0, period: "2070 BCE-220 CE", achievement: "Great Wall, inventions"},
                {name: "Maya Civilization", lat: 17.0, lng: -89.0, period: "2000 BCE-1500 CE", achievement: "Calendar, astronomy"},
                {name: "Ancient Greece", lat: 39.0, lng: 22.0, period: "800-146 BCE", achievement: "Democracy, philosophy"},
                {name: "Roman Empire", lat: 41.9, lng: 12.5, period: "27 BCE-476 CE", achievement: "Law, engineering"},
                {name: "Aztec Empire", lat: 19.4, lng: -99.1, period: "1345-1521 CE", achievement: "Tenochtitlan, calendar"},
                {name: "Inca Empire", lat: -13.5, lng: -71.0, period: "1438-1572 CE", achievement: "Machu Picchu, roads"},
                {name: "Persian Empire", lat: 32.0, lng: 53.0, period: "550-331 BCE", achievement: "Royal Road, tolerance"},
                {name: "Olmec", lat: 18.0, lng: -94.0, period: "1500-400 BCE", achievement: "Colossal heads, rubber"},
                {name: "Phoenicia", lat: 33.8, lng: 35.5, period: "1200-300 BCE", achievement: "Alphabet, trade"},
                {name: "Angkor", lat: 13.4, lng: 103.9, period: "802-1431 CE", achievement: "Angkor Wat, irrigation"},
                {name: "Great Zimbabwe", lat: -20.3, lng: 30.9, period: "1220-1450 CE", achievement: "Stone structures, trade"},
                {name: "Easter Island", lat: -27.1, lng: -109.3, period: "1250-1500 CE", achievement: "Moai statues"}
            ];
            
            const ancientLayer = L.layerGroup();
            
            civilizations.forEach(civ => {
                const marker = L.circleMarker([civ.lat, civ.lng], {
                    radius: 12,
                    fillColor: '#8e24aa',
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup(`
                    <strong>🏛️ Ancient Civilization</strong><br>
                    <strong>${civ.name}</strong><br>
                    Period: ${civ.period}<br>
                    Achievement: ${civ.achievement}<br>
                    <em>Historical significance</em>
                `);
                ancientLayer.addLayer(marker);
            });
            
            enhancedMap.ancientLayer = ancientLayer;
            ancientLayer.addTo(enhancedMap);
            mapLoadedLayers.add('ancient');
            updateMapStatus('Ancient civilizations loaded');
        }

        // Current Conflicts Layer
        function loadConflictData() {
            if (!enhancedMap) return;
            
            const conflicts = [
                {name: "Ukraine-Russia Conflict", lat: 49.0, lng: 32.0, since: "2014/2022", type: "Territorial dispute"},
                {name: "Syrian Civil War", lat: 35.0, lng: 38.0, since: "2011", type: "Civil war"},
                {name: "Yemen Civil War", lat: 15.0, lng: 48.0, since: "2014", type: "Civil war"},
                {name: "Israel-Palestine", lat: 31.5, lng: 35.0, since: "1948", type: "Territorial dispute"},
                {name: "Kashmir Dispute", lat: 34.0, lng: 76.0, since: "1947", type: "Territorial dispute"},
                {name: "Myanmar Crisis", lat: 22.0, lng: 96.0, since: "2021", type: "Political crisis"},
                {name: "Ethiopia Tigray", lat: 14.0, lng: 38.0, since: "2020", type: "Internal conflict"},
                {name: "South China Sea", lat: 16.0, lng: 114.0, since: "Ongoing", type: "Maritime dispute"},
                {name: "Mali Conflict", lat: 17.0, lng: -4.0, since: "2012", type: "Insurgency"},
                {name: "Afghanistan Crisis", lat: 33.0, lng: 65.0, since: "2021", type: "Political crisis"}
            ];
            
            const conflictLayer = L.layerGroup();
            
            conflicts.forEach(conflict => {
                const marker = L.circleMarker([conflict.lat, conflict.lng], {
                    radius: 10,
                    fillColor: '#d32f2f',
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.7
                }).bindPopup(`
                    <strong>⚔️ Current Conflict</strong><br>
                    <strong>${conflict.name}</strong><br>
                    Since: ${conflict.since}<br>
                    Type: ${conflict.type}<br>
                    <em>Ongoing geopolitical issue</em>
                `);
                conflictLayer.addLayer(marker);
            });
            
            enhancedMap.conflictLayer = conflictLayer;
            conflictLayer.addTo(enhancedMap);
            mapLoadedLayers.add('conflict');
            updateMapStatus('Current conflicts loaded');
        }

        // Time Zones Layer
        function loadTimeZoneData() {
            if (!enhancedMap) return;
            
            const timeZones = [
                {city: "Los Angeles", lat: 34.0522, lng: -118.2437, utc: "UTC-8", zone: "PST"},
                {city: "Denver", lat: 39.7392, lng: -104.9903, utc: "UTC-7", zone: "MST"},
                {city: "Chicago", lat: 41.8781, lng: -87.6298, utc: "UTC-6", zone: "CST"},
                {city: "New York", lat: 40.7128, lng: -74.0060, utc: "UTC-5", zone: "EST"},
                {city: "London", lat: 51.5074, lng: -0.1278, utc: "UTC+0", zone: "GMT"},
                {city: "Paris", lat: 48.8566, lng: 2.3522, utc: "UTC+1", zone: "CET"},
                {city: "Cairo", lat: 30.0444, lng: 31.2357, utc: "UTC+2", zone: "EET"},
                {city: "Moscow", lat: 55.7558, lng: 37.6176, utc: "UTC+3", zone: "MSK"},
                {city: "Dubai", lat: 25.2048, lng: 55.2708, utc: "UTC+4", zone: "GST"},
                {city: "Mumbai", lat: 19.0760, lng: 72.8777, utc: "UTC+5:30", zone: "IST"},
                {city: "Bangkok", lat: 13.7563, lng: 100.5018, utc: "UTC+7", zone: "ICT"},
                {city: "Beijing", lat: 39.9042, lng: 116.4074, utc: "UTC+8", zone: "CST"},
                {city: "Tokyo", lat: 35.6762, lng: 139.6503, utc: "UTC+9", zone: "JST"},
                {city: "Sydney", lat: -33.8688, lng: 151.2093, utc: "UTC+10", zone: "AEST"},
                {city: "Auckland", lat: -36.8485, lng: 174.7633, utc: "UTC+12", zone: "NZST"}
            ];
            
            const timezoneLayer = L.layerGroup();
            
            timeZones.forEach(tz => {
                const now = new Date();
                const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000);
                const offset = parseFloat(tz.utc.replace('UTC', '').replace('+', ''));
                const localTime = new Date(utcTime + (offset * 3600000));
                
                const marker = L.circleMarker([tz.lat, tz.lng], {
                    radius: 8,
                    fillColor: '#607d8b',
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup(`
                    <strong>🕒 Time Zone</strong><br>
                    <strong>${tz.city}</strong><br>
                    Zone: ${tz.zone} (${tz.utc})<br>
                    Local Time: ${localTime.toLocaleTimeString()}<br>
                    <em>World time reference</em>
                `);
                timezoneLayer.addLayer(marker);
            });
            
            enhancedMap.timezoneLayer = timezoneLayer;
            timezoneLayer.addTo(enhancedMap);
            mapLoadedLayers.add('timezone');
            updateMapStatus('Time zones loaded');
        }

        // Placeholder functions for remaining layers (to prevent errors)
        function loadOceanCurrentsData() { updateMapStatus('Ocean currents data coming soon'); }
        function loadTectonicPlatesData() { updateMapStatus('Tectonic plates data coming soon'); }
        function loadCurrencyData() { updateMapStatus('Currency zones data coming soon'); }
        function loadGdpData() { updateMapStatus('GDP data coming soon'); }
        function loadColonialData() { updateMapStatus('Colonial empires data coming soon'); }
        function loadColdWarData() { updateMapStatus('Cold War data coming soon'); }
        function loadLanguageData() { updateMapStatus('Language families data coming soon'); }
        function loadReligionData() { updateMapStatus('Religious distributions data coming soon'); }
        function loadMigrationData() { updateMapStatus('Migration patterns data coming soon'); }
        function loadPopDensityData() { updateMapStatus('Population density data coming soon'); }
        function loadDeforestationData() { updateMapStatus('Deforestation data coming soon'); }
        function loadBiodiversityData() { updateMapStatus('Biodiversity hotspots data coming soon'); }
        function loadCarbonData() { updateMapStatus('Carbon emissions data coming soon'); }

        // Fallback map implementation with comprehensive error handling
        function initializeFallbackMap() {
            const mapContainer = document.getElementById('enhanced-map');
            if (!mapContainer) return;

            // Clear existing content and create educational fallback
            mapContainer.innerHTML = `
                <div style="
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    height: 100%;
                    background: linear-gradient(135deg, #e3f2fd 0%, #f5f5f5 100%);
                    border-radius: 8px;
                    text-align: center;
                    padding: 40px;
                    min-height: 400px;
                ">
                    <div style="font-size: 3rem; margin-bottom: 20px;">🗺️</div>
                    <h3 style="color: #2c5aa0; margin-bottom: 15px; font-size: 1.4rem;">Educational Geography Center</h3>
                    <p style="color: #666; margin-bottom: 20px; max-width: 400px; line-height: 1.5;">
                        Interactive mapping is temporarily unavailable. This space provides geographic context 
                        and lesson synchronization for your selected curriculum content.
                    </p>
                    <div id="fallback-lesson-info" style="
                        background: white;
                        padding: 20px;
                        border-radius: 8px;
                        border-left: 4px solid #007bff;
                        max-width: 500px;
                        text-align: left;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    ">
                        <h4 style="color: #2c5aa0; margin: 0 0 10px 0;">Current Lesson Context</h4>
                        <p id="fallback-lesson-text" style="margin: 0; color: #495057;">Select a lesson to view relevant geographic information and learning objectives.</p>
                    </div>
                    <div style="margin-top: 20px;">
                        <button onclick="location.reload()" style="
                            background: #28a745;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: 600;
                        ">🔄 Retry Connection</button>
                    </div>
                </div>
            `;
            
            // Update lesson info if lesson is already loaded
            if (window.currentLesson) {
                updateFallbackLessonInfo();
            }
        }

        // Update fallback lesson information
        function updateFallbackLessonInfo() {
            const fallbackTextElement = document.getElementById('fallback-lesson-text');
            if (fallbackTextElement && window.currentLesson) {
                const lessonTitle = currentLesson.title || 'Current Lesson';
                const moduleTitle = currentLesson.module ? currentLesson.module.title : 'Geography Module';
                fallbackTextElement.innerHTML = `
                    <strong>📚 ${moduleTitle}</strong><br>
                    <em>${lessonTitle}</em><br><br>
                    This lesson focuses on important geographic concepts and regional studies. 
                    Refer to your lesson content for detailed geographic information and activities.
                `;
            }
        }

        function updateMapStatus(message) {
            const statusElement = document.getElementById('map-status');
            if (statusElement) {
                statusElement.textContent = message;
            }
            console.log('Map Status:', message);
        }

        function updateMapLessonInfo(message) {
            const infoElement = document.getElementById('map-current-lesson');
            if (infoElement) {
                infoElement.textContent = message;
            }
        }

        // Interactive Map Activity Functions
        function startLocationActivity() {
            if (!enhancedMap || !currentMapLesson) {
                alert('Please select a lesson first to start location activities.');
                return;
            }
            
            updateMapStatus('🎯 Location Activity: Click on the map to identify coordinates');
            
            // Create activity instructions overlay
            const activityModal = createActivityModal(
                '📍 Location Hunt Activity',
                `
                <div style="margin-bottom: 15px;">
                    <h4>Your Mission:</h4>
                    <p>Practice identifying locations on the map related to your current lesson.</p>
                    
                    <div id="location-challenge" style="background: #e7f3ff; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <strong>Challenge:</strong> <span id="location-task">Click anywhere on the map to begin!</span>
                    </div>
                    
                    <div id="coordinate-display" style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 10px 0; display: none;">
                        <strong>Coordinates:</strong> <span id="clicked-coordinates"></span><br>
                        <strong>Region:</strong> <span id="clicked-region"></span>
                    </div>
                </div>
                `,
                [
                    { text: 'New Challenge', action: 'generateLocationChallenge()' },
                    { text: 'Close Activity', action: 'closeActivityModal()' }
                ]
            );
            
            // Add click handler to map
            enhancedMap.currentActivity = 'location';
            enhancedMap.on('click', handleLocationClick);
            
            generateLocationChallenge();
        }

        function startComparisonActivity() {
            if (!enhancedMap || !currentMapLesson) {
                alert('Please select a lesson first to start comparison activities.');
                return;
            }
            
            updateMapStatus('⚖️ Regional Comparison: Compare different areas on the map');
            
            const activityModal = createActivityModal(
                '⚖️ Regional Comparison Activity',
                `
                <div style="margin-bottom: 15px;">
                    <h4>Compare Geographic Regions:</h4>
                    <p>Select two different regions on the map to compare their characteristics.</p>
                    
                    <div id="comparison-selected" style="background: #e7f3ff; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <strong>Selected Regions:</strong>
                        <div id="region-list">Click on two different areas to begin comparison</div>
                    </div>
                    
                    <div id="comparison-results" style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 10px 0; display: none;">
                        <h5>Comparison Results:</h5>
                        <div id="comparison-data"></div>
                    </div>
                </div>
                `,
                [
                    { text: 'Reset Selection', action: 'resetComparison()' },
                    { text: 'Close Activity', action: 'closeActivityModal()' }
                ]
            );
            
            enhancedMap.currentActivity = 'comparison';
            enhancedMap.selectedRegions = [];
            enhancedMap.on('click', handleComparisonClick);
        }

        function startClimateActivity() {
            if (!enhancedMap || !currentMapLesson) {
                alert('Please select a lesson first to start climate activities.');
                return;
            }
            
            updateMapStatus('🌡️ Climate Analysis: Click on the map to discover climate zones and weather patterns');
            
            // Clear any existing climate markers
            if (enhancedMap.climateMarkers) {
                enhancedMap.climateMarkers.forEach(marker => enhancedMap.removeLayer(marker));
            }
            enhancedMap.climateMarkers = [];
            
            // Set up interactive climate mode
            enhancedMap.currentActivity = 'climate';
            enhancedMap.on('click', handleClimateClick);
            
            // Enable climate layer if not already on
            document.getElementById('mapClimateToggle').checked = true;
            loadClimateData();
            
            createActivityModal(
                '🌡️ Interactive Climate Zone Explorer',
                `
                <div style="margin-bottom: 15px;">
                    <h4>🎯 Your Mission:</h4>
                    <p><strong>Click anywhere on the map</strong> to discover climate zones and understand weather patterns!</p>
                    
                    <div id="climate-discovery-panel" style="background: #fff3cd; padding: 12px; border-radius: 6px; margin: 10px 0; min-height: 80px;">
                        <h5>🌡️ Climate Zone Discovery:</h5>
                        <p id="climate-info">Click on the map to explore tropical, temperate, polar, and arid climate zones!</p>
                        <div id="climate-details" style="display: none; margin-top: 10px; padding: 8px; background: white; border-radius: 4px; border-left: 4px solid #ffc107;"></div>
                    </div>
                    
                    <div style="background: #d1ecf1; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <h5>🌍 Climate Explorer Tools:</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                            <button onclick="showTropicalZones()" style="padding: 6px; border: none; background: #dc3545; color: white; border-radius: 4px; cursor: pointer;">🌴 Tropical</button>
                            <button onclick="showTemperateZones()" style="padding: 6px; border: none; background: #28a745; color: white; border-radius: 4px; cursor: pointer;">🌤️ Temperate</button>
                            <button onclick="showAridZones()" style="padding: 6px; border: none; background: #fd7e14; color: white; border-radius: 4px; cursor: pointer;">🏜️ Arid/Desert</button>
                            <button onclick="showPolarZones()" style="padding: 6px; border: none; background: #6f42c1; color: white; border-radius: 4px; cursor: pointer;">❄️ Polar/Tundra</button>
                        </div>
                    </div>
                    
                    <div id="climate-checklist" style="background: #e7f3ff; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <h6>✅ Climate Zone Checklist:</h6>
                        <div style="font-size: 12px;">
                            <label><input type="checkbox" id="found-tropical"> Found a tropical climate</label><br>
                            <label><input type="checkbox" id="found-temperate"> Found a temperate climate</label><br>
                            <label><input type="checkbox" id="found-arid"> Found an arid/desert climate</label><br>
                            <label><input type="checkbox" id="found-polar"> Found a polar/cold climate</label><br>
                            <label><input type="checkbox" id="found-mountain"> Found a mountain climate</label>
                        </div>
                    </div>
                    
                    <div id="climate-score" style="text-align: center; font-weight: bold; color: #2c5aa0;">
                        Climate Zones Discovered: <span id="climate-count">0</span>/5
                    </div>
                </div>
                `,
                [
                    { text: '🌡️ Reset Explorer', action: 'resetClimateExplorer()' },
                    { text: '🗺️ Show All Zones', action: 'showAllClimateZones()' },
                    { text: 'Close Activity', action: 'closeClimateActivity()' }
                ]
            );
        }

        function handleClimateClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // Add a climate discovery marker
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'climate-marker',
                    html: '🌡️',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(enhancedMap);
            
            enhancedMap.climateMarkers.push(marker);
            
            // Analyze the climate at this location
            analyzeClimateZone(lat, lng, marker);
            
            // Update discovery count
            updateClimateCount();
        }

        function analyzeClimateZone(lat, lng, marker) {
            const climateInfo = document.getElementById('climate-info');
            const climateDetails = document.getElementById('climate-details');
            
            // Get lesson region context if available
            const lessonRegion = window.currentLessonRegion;
            const isCanadaLesson = lessonRegion && (lessonRegion.keyword.includes('canada') || lessonRegion.keyword.includes('canadian'));
            
            let climateType = '';
            let climateName = '';
            let temperature = '';
            let precipitation = '';
            let seasonality = '';
            let educationalInfo = '';
            let checkboxToCheck = '';
            
            // CANADA-SPECIFIC CLIMATE ANALYSIS
            if (isCanadaLesson && lat >= 41 && lat <= 83 && lng >= -141 && lng <= -52) {
                // Arctic Climate (Northern Canada)
                if (lat >= 70) {
                    climateType = 'Arctic Climate';
                    climateName = 'Canadian Arctic Zone';
                    temperature = 'Extremely cold (-40°F to 40°F / -40°C to 4°C)';
                    precipitation = 'Very low, mostly snow (less than 10 inches/year)';
                    seasonality = 'Continuous daylight in summer, darkness in winter';
                    educationalInfo = 'Canada\'s Arctic experiences the most extreme climate conditions. Permafrost underlies most of the region, and indigenous communities have adapted traditional lifestyles to these harsh conditions. Climate change is rapidly affecting this region.';
                    checkboxToCheck = 'found-polar';
                }
                // Subarctic/Boreal Climate
                else if (lat >= 50 && lat <= 70) {
                    climateType = 'Subarctic Climate';
                    climateName = 'Canadian Boreal/Taiga Zone';
                    temperature = 'Cold winters (-40°F), warm summers (70°F / -40°C to 21°C)';
                    precipitation = 'Moderate (15-20 inches/year), mostly snow in winter';
                    seasonality = 'Very cold, long winters; short, warm summers';
                    educationalInfo = 'The Canadian subarctic supports the vast boreal forest. This climate enables Canada\'s forestry industry and provides habitat for wildlife like moose, caribou, and bears. Indigenous communities practice traditional hunting and trapping.';
                    checkboxToCheck = 'found-temperate';
                }
                // Prairie Continental Climate
                else if (lat >= 49 && lat <= 60 && lng >= -115 && lng <= -95) {
                    climateType = 'Continental Prairie Climate';
                    climateName = 'Canadian Prairie Zone';
                    temperature = 'Cold winters (-15°F), hot summers (80°F / -26°C to 27°C)';
                    precipitation = 'Low to moderate (12-20 inches/year), summer peaks';
                    seasonality = 'Extreme temperature range, chinook winds in winter';
                    educationalInfo = 'Canada\'s prairie climate creates ideal conditions for wheat farming. The region experiences dramatic temperature swings and is known for chinook winds that can rapidly warm winter temperatures. This climate zone makes Canada a major grain exporter.';
                    checkboxToCheck = 'found-arid';
                }
                // Great Lakes Continental Climate
                else if (lat >= 42 && lat <= 49 && lng >= -95 && lng <= -74) {
                    climateType = 'Continental Climate';
                    climateName = 'Great Lakes Moderated Zone';
                    temperature = 'Cold winters (20°F), warm summers (75°F / -7°C to 24°C)';
                    precipitation = 'Moderate to high (30-40 inches/year), lake-effect snow';
                    seasonality = 'Four distinct seasons, moderated by Great Lakes';
                    educationalInfo = 'Southern Ontario\'s climate is moderated by the Great Lakes, creating Canada\'s most densely populated region. Lake-effect snow is common in winter, while the lakes moderate temperature extremes, supporting agriculture and major cities like Toronto.';
                    checkboxToCheck = 'found-temperate';
                }
                // Pacific Maritime Climate (British Columbia Coast)
                else if (lng >= -130 && lng <= -120 && lat >= 48 && lat <= 60) {
                    climateType = 'Maritime Climate';
                    climateName = 'Pacific Coastal Zone';
                    temperature = 'Mild winters (40°F), cool summers (70°F / 4°C to 21°C)';
                    precipitation = 'Very high (60-120 inches/year), wet winters';
                    seasonality = 'Wet, mild winters; dry, pleasant summers';
                    educationalInfo = 'British Columbia\'s coast has Canada\'s mildest climate due to Pacific Ocean influence. High precipitation supports temperate rainforests. This climate attracts population to Vancouver and Victoria and enables year-round outdoor activities.';
                    checkboxToCheck = 'found-tropical'; // Using tropical for high precipitation maritime
                }
                // Atlantic Maritime Climate
                else if (lng >= -70 && lng <= -52) {
                    climateType = 'Atlantic Maritime Climate';
                    climateName = 'Atlantic Canada Zone';
                    temperature = 'Cool winters (25°F), moderate summers (70°F / -4°C to 21°C)';
                    precipitation = 'High (40-60 inches/year), fog common';
                    seasonality = 'Maritime influence moderates temperatures';
                    educationalInfo = 'Atlantic Canada\'s climate is influenced by ocean currents, including the warm Gulf Stream and cold Labrador Current. This creates frequent fog, moderate temperatures, and supports the traditional fishing industry that shaped Maritime culture.';
                    checkboxToCheck = 'found-temperate';
                }
                // Mountain Climate (Canadian Rockies)
                else if (lng >= -140 && lng <= -110 && lat >= 49) {
                    climateType = 'Mountain Climate';
                    climateName = 'Canadian Rocky Mountain Zone';
                    temperature = 'Varies dramatically with elevation and aspect';
                    precipitation = 'High in mountains (40-80 inches/year), rain shadow effects';
                    seasonality = 'Alpine conditions, heavy snow at elevation';
                    educationalInfo = 'The Canadian Rockies create diverse microclimates with elevation changes. Chinook winds bring rapid warming, while orographic precipitation creates lush mountain valleys. This climate supports both agriculture in valleys and alpine ecosystems at elevation.';
                    checkboxToCheck = 'found-mountain';
                }
                // Default Canadian climate
                else {
                    climateType = 'Canadian Continental Climate';
                    climateName = 'Canadian Interior Zone';
                    temperature = 'Cold winters, warm summers (typical Canadian range)';
                    precipitation = 'Moderate, seasonal variation';
                    seasonality = 'Distinct four seasons with long winters';
                    educationalInfo = 'This represents Canada\'s typical continental climate with cold winters, warm summers, and seasonal precipitation patterns that define the Canadian experience.';
                    checkboxToCheck = 'found-temperate';
                }
            }
            // GENERAL GLOBAL CLIMATE ANALYSIS
            else {
                // Tropical zone
                if (Math.abs(lat) <= 23.5) {
                    climateType = 'Tropical Climate';
                    climateName = 'Tropical Zone';
                    temperature = 'Hot year-round (80-90°F / 26-32°C)';
                    precipitation = 'High rainfall, often with wet/dry seasons';
                    seasonality = 'Little temperature variation, distinct wet/dry seasons';
                    educationalInfo = 'Tropical climates occur near the equator where the sun\'s rays are most direct. High temperatures and humidity support rainforests and diverse ecosystems.';
                    checkboxToCheck = 'found-tropical';
                } else if (Math.abs(lat) >= 66.5) {
                    // Polar zone
                    climateType = 'Polar Climate';
                    climateName = 'Polar/Arctic Zone';
                    temperature = 'Very cold (below 50°F / 10°C in warmest month)';
                    precipitation = 'Low precipitation, mostly snow';
                    seasonality = 'Extreme seasonal variation in daylight';
                    educationalInfo = 'Polar climates have extremely cold temperatures and limited vegetation. Permafrost and ice sheets dominate these regions near the poles.';
                    checkboxToCheck = 'found-polar';
                } else if ((lat >= 20 && lat <= 35) || (lat <= -20 && lat >= -35)) {
                    // Check for arid regions
                    if ((lng >= -120 && lng <= -100) || (lng >= -15 && lng <= 50) || (lng >= 110 && lng <= 140)) {
                        climateType = 'Arid Climate';
                        climateName = 'Desert/Semi-Arid Zone';
                        temperature = 'Hot days, cool nights (varies by season)';
                        precipitation = 'Very low rainfall (less than 10-20 inches/year)';
                        seasonality = 'Extreme daily temperature variation';
                        educationalInfo = 'Arid climates form in areas with high pressure systems or rain shadows. Low humidity and sparse vegetation characterize these regions.';
                        checkboxToCheck = 'found-arid';
                    }
                }
                
                // Default to temperate if not caught above
                if (!climateType) {
                    climateType = 'Temperate Climate';
                    climateName = 'Temperate Zone';
                    temperature = 'Moderate (50-80°F / 10-26°C in summer)';
                    precipitation = 'Moderate, distributed throughout year';
                    seasonality = 'Four distinct seasons';
                    educationalInfo = 'Temperate climates have moderate temperatures and distinct seasons. Most major agricultural regions and cities are located in temperate zones.';
                    checkboxToCheck = 'found-temperate';
                }
            }
            
            // Update the UI
            climateInfo.innerHTML = `
                <strong>📍 Location:</strong> ${lat.toFixed(2)}°N, ${Math.abs(lng).toFixed(2)}°${lng >= 0 ? 'E' : 'W'}<br>
                <strong>🌡️ Climate Type:</strong> ${climateType}<br>
                <strong>🌍 Zone Name:</strong> ${climateName}
                ${isCanadaLesson ? '<br><strong>🍁 Canada Lesson Context:</strong> Canadian climate analysis' : ''}
            `;
            
            climateDetails.style.display = 'block';
            climateDetails.innerHTML = `
                <strong>🌡️ Temperature:</strong> ${temperature}<br>
                <strong>🌧️ Precipitation:</strong> ${precipitation}<br>
                <strong>📅 Seasonality:</strong> ${seasonality}<br><br>
                <strong>📚 Climate Education:</strong><br>
                ${educationalInfo}
                ${isCanadaLesson ? '<br><br><strong>🍁 Canadian Impact:</strong> This climate zone significantly influences Canadian society, economy, and daily life patterns.' : ''}
            `;
            
            // Check off the appropriate discovery checkbox
            if (checkboxToCheck) {
                const checkbox = document.getElementById(checkboxToCheck);
                if (checkbox && !checkbox.checked) {
                    checkbox.checked = true;
                    showClimateDiscovery(climateType);
                }
            }
            
            // Add popup to marker
            marker.bindPopup(`
                <strong>${climateType}</strong><br>
                ${climateName}<br>
                <em>Lat: ${lat.toFixed(2)}, Lng: ${lng.toFixed(2)}</em>
                ${isCanadaLesson ? '<br>🍁 <em>Canada Climate Focus</em>' : ''}
            `).openPopup();
        }

        function showClimateDiscovery(climateType) {
            const celebration = document.createElement('div');
            celebration.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ffc107, #fd7e14);
                color: white;
                padding: 10px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
                z-index: 10000;
                font-weight: bold;
                animation: slideInOut 3s ease-in-out;
            `;
            celebration.innerHTML = `🌡️ Climate Discovered: ${climateType}!`;
            
            document.body.appendChild(celebration);
            setTimeout(() => celebration.remove(), 3000);
        }

        function updateClimateCount() {
            const checkboxes = ['found-tropical', 'found-temperate', 'found-arid', 'found-polar', 'found-mountain'];
            const checkedCount = checkboxes.filter(id => document.getElementById(id)?.checked).length;
            const countElement = document.getElementById('climate-count');
            if (countElement) {
                countElement.textContent = checkedCount;
                if (checkedCount === 5) {
                    countElement.parentElement.innerHTML += ' <span style="color: #28a745;">🏆 Climate Expert!</span>';
                }
            }
        }

        function resetClimateExplorer() {
            // Clear all markers
            if (enhancedMap.climateMarkers) {
                enhancedMap.climateMarkers.forEach(marker => enhancedMap.removeLayer(marker));
                enhancedMap.climateMarkers = [];
            }
            
            // Reset checkboxes
            const checkboxes = ['found-tropical', 'found-temperate', 'found-arid', 'found-polar', 'found-mountain'];
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = false;
            });
            
            // Reset info panel
            const climateInfo = document.getElementById('climate-info');
            const climateDetails = document.getElementById('climate-details');
            if (climateInfo) climateInfo.textContent = 'Click on the map to explore tropical, temperate, polar, and arid climate zones!';
            if (climateDetails) climateDetails.style.display = 'none';
            
            updateClimateCount();
            updateMapStatus('🌡️ Climate Explorer Reset - Start discovering!');
        }

        function showAllClimateZones() {
            // Add example climate zone markers
            const climateExamples = [
                { lat: 0, lng: 0, type: '🌴', name: 'Tropical' },
                { lat: 40, lng: -100, type: '🌤️', name: 'Temperate' },
                { lat: 25, lng: -110, type: '🏜️', name: 'Arid' },
                { lat: 70, lng: 0, type: '❄️', name: 'Polar' },
                { lat: 45, lng: -110, type: '🏔️', name: 'Mountain' }
            ];
            
            climateExamples.forEach(climate => {
                const marker = L.marker([climate.lat, climate.lng], {
                    icon: L.divIcon({
                        className: 'climate-zone-marker',
                        html: climate.type,
                        iconSize: [25, 25],
                        iconAnchor: [12, 12]
                    })
                }).addTo(enhancedMap);
                
                marker.bindPopup(`<strong>${climate.name} Climate Zone</strong><br>Example location`);
                enhancedMap.climateMarkers.push(marker);
            });
            
            updateMapStatus('🌍 All climate zones displayed');
        }

        function closeClimateActivity() {
            // Remove event listener
            enhancedMap.off('click', handleClimateClick);
            enhancedMap.currentActivity = null;
            
            // Clear markers
            if (enhancedMap.climateMarkers) {
                enhancedMap.climateMarkers.forEach(marker => enhancedMap.removeLayer(marker));
                enhancedMap.climateMarkers = [];
            }
            
            closeActivityModal();
            updateMapStatus('🌡️ Climate activity closed');
        }

        // Helper functions for climate zone exploration
        function showTropicalZones() {
            enhancedMap.setView([0, -60], 4); // Amazon region
            updateMapStatus('🌴 Focusing on tropical climate zones...');
        }

        function showTemperateZones() {
            enhancedMap.setView([40, -100], 4); // North American plains
            updateMapStatus('🌤️ Focusing on temperate climate zones...');
        }

        function showAridZones() {
            enhancedMap.setView([25, -110], 5); // Southwest US desert
            updateMapStatus('🏜️ Focusing on arid climate zones...');
        }

        function showPolarZones() {
            enhancedMap.setView([70, 0], 3); // Arctic region
            updateMapStatus('❄️ Focusing on polar climate zones...');
        }

        function startPopulationActivity() {
            if (!enhancedMap || !currentMapLesson) {
                alert('Please select a lesson first to start population activities.');
                return;
            }
            
            updateMapStatus('👥 Population Study: Analyze population patterns');
            
            // Enable cities layer if not already on
            document.getElementById('mapCitiesToggle').checked = true;
            loadCitiesData();
            
            createActivityModal(
                '👥 Population Mapping Activity',
                `
                <div style="margin-bottom: 15px;">
                    <h4>Study Population Patterns:</h4>
                    <p>Examine how human populations are distributed around the world and understand the factors that influence settlement patterns.</p>
                    
                    <div style="background: #d4edda; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <strong>Exploration Questions:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>Which continents have the highest concentration of major cities?</li>
                            <li>How do physical features like mountains and rivers affect where people live?</li>
                            <li>What patterns do you notice in coastal vs. inland populations?</li>
                            <li>How does climate influence population distribution?</li>
                        </ul>
                    </div>
                    
                    <div id="population-insights" style="background: #f8d7da; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <strong>Population Geography Facts:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                            <li>Over half the world's population lives within 60 km of the ocean</li>
                            <li>Asia contains about 60% of the world's population</li>
                            <li>Population density varies greatly between urban and rural areas</li>
                            <li>Geographic factors like water access strongly influence settlement</li>
                        </ul>
                    </div>
                </div>
                `,
                [
                    { text: 'Close Activity', action: 'closeActivityModal()' }
                ]
            );
        }

        function startDistanceActivity() {
            if (!enhancedMap || !currentMapLesson) {
                alert('Please select a lesson first to start distance activities.');
                return;
            }
            
            updateMapStatus('📏 Distance Measurement: Practice calculating distances');
            
            createActivityModal(
                '📏 Distance Calculator Activity',
                `
                <div style="margin-bottom: 15px;">
                    <h4>Measure Distances on the Map:</h4>
                    <p>Learn to use map scales and calculate real-world distances between locations.</p>
                    
                    <div style="background: #e2e3e5; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <strong>Instructions:</strong>
                        <ol style="margin: 5px 0; padding-left: 20px;">
                            <li>Right-click and drag on the map to measure distances</li>
                            <li>The distance will be displayed in both kilometers and miles</li>
                            <li>Try measuring distances between major cities</li>
                            <li>Compare your measurements with real-world travel distances</li>
                        </ol>
                    </div>
                    
                    <div id="distance-challenges" style="background: #fff3cd; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <strong>Distance Challenges:</strong>
                        <div id="distance-challenge-list">
                            <p>• Measure the distance from New York to London</p>
                            <p>• Find the distance across the Pacific Ocean</p>
                            <p>• Calculate the length of the Amazon River</p>
                            <p>• Measure the width of the African continent</p>
                        </div>
                    </div>
                </div>
                `,
                [
                    { text: 'New Challenge', action: 'generateDistanceChallenge()' },
                    { text: 'Close Activity', action: 'closeActivityModal()' }
                ]
            );
            
            // Add distance measurement tool to map
            enableDistanceMeasurement();
        }

        function startExplorationActivity() {
            if (!enhancedMap || !currentMapLesson) {
                alert('Please select a lesson first to start exploration activities.');
                return;
            }
            
            updateMapStatus('🎯 Geographic Exploration: Discover your lesson region');
            
            // Focus on lesson region
            focusOnLessonRegion();
            
            createActivityModal(
                '🎯 Geographic Exploration Activity',
                `
                <div style="margin-bottom: 15px;">
                    <h4>Explore Your Lesson Region:</h4>
                    <p>Take a guided exploration of the geographic area related to your current lesson.</p>
                    
                    <div style="background: #d1ecf1; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <strong>Exploration Checklist:</strong>
                        <div id="exploration-checklist">
                            <label><input type="checkbox"> Identify major physical features</label><br>
                            <label><input type="checkbox"> Locate important cities and capitals</label><br>
                            <label><input type="checkbox"> Observe climate patterns</label><br>
                            <label><input type="checkbox"> Note political boundaries</label><br>
                            <label><input type="checkbox"> Consider human-environment interactions</label>
                        </div>
                    </div>
                    
                    <div id="exploration-questions" style="background: #e7f3ff; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <strong>Guiding Questions:</strong>
                        <div id="question-rotation">
                            <p id="current-question">What physical features do you notice in this region?</p>
                            <button onclick="rotateExplorationQuestion()" style="background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px;">
                                Next Question
                            </button>
                        </div>
                    </div>
                </div>
                `,
                [
                    { text: 'Load Data Layers', action: 'showLessonData()' },
                    { text: 'Close Activity', action: 'closeActivityModal()' }
                ]
            );
        }

        // Activity Helper Functions
        function createActivityModal(title, content, buttons) {
            // Remove existing modal if present
            const existingModal = document.getElementById('activity-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'activity-modal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 2px solid #007bff;
                border-radius: 10px;
                padding: 20px;
                z-index: 10000;
                max-width: 500px;
                max-height: 70vh;
                overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            const buttonHTML = buttons.map(btn => 
                `<button onclick="${btn.action}" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 0 5px; cursor: pointer;">
                    ${btn.text}
                </button>`
            ).join('');
            
            modal.innerHTML = `
                <h3 style="margin: 0 0 15px 0; color: #007bff;">${title}</h3>
                ${content}
                <div style="text-align: center; margin-top: 15px; border-top: 1px solid #dee2e6; padding-top: 15px;">
                    ${buttonHTML}
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add backdrop
            const backdrop = document.createElement('div');
            backdrop.id = 'activity-backdrop';
            backdrop.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 9999;
            `;
            backdrop.onclick = closeActivityModal;
            document.body.appendChild(backdrop);
            
            return modal;
        }

        function closeActivityModal() {
            const modal = document.getElementById('activity-modal');
            const backdrop = document.getElementById('activity-backdrop');
            
            if (modal) modal.remove();
            if (backdrop) backdrop.remove();
            
            // Clean up map event handlers
            if (enhancedMap && enhancedMap.currentActivity) {
                enhancedMap.off('click', handleLocationClick);
                enhancedMap.off('click', handleComparisonClick);
                delete enhancedMap.currentActivity;
                updateMapStatus('Activity completed - Map ready for exploration');
            }
        }

        function handleLocationClick(e) {
            const lat = e.latlng.lat.toFixed(4);
            const lng = e.latlng.lng.toFixed(4);
            
            document.getElementById('clicked-coordinates').textContent = `${lat}°, ${lng}°`;
            document.getElementById('clicked-region').textContent = getRegionName(lat, lng);
            document.getElementById('coordinate-display').style.display = 'block';
            
            // Add a temporary marker
            if (enhancedMap.activityMarker) {
                enhancedMap.removeLayer(enhancedMap.activityMarker);
            }
            
            enhancedMap.activityMarker = L.marker([lat, lng])
                .addTo(enhancedMap)
                .bindPopup(`📍 Location: ${lat}°, ${lng}°<br>Region: ${getRegionName(lat, lng)}`)
                .openPopup();
        }

        function generateLocationChallenge() {
            const challenges = [
                "Find the coordinates of your current lesson's main geographic region",
                "Locate a major city mentioned in your lesson",
                "Identify the coordinates of an important physical feature from your lesson",
                "Find the approximate center of the continent you're studying",
                "Locate the capital city of a country from your lesson"
            ];
            
            const randomChallenge = challenges[Math.floor(Math.random() * challenges.length)];
            document.getElementById('location-task').textContent = randomChallenge;
        }

        function getRegionName(lat, lng) {
            // Simple region identification based on coordinates
            if (lat > 66.5) return "Arctic";
            if (lat < -66.5) return "Antarctic";
            
            if (lng >= -180 && lng < -30) {
                if (lat > 15) return "North America";
                if (lat < -15) return "South America";
                return "Central America/Caribbean";
            }
            if (lng >= -30 && lng < 60) {
                if (lat > 35) return "Europe";
                if (lat > -35) return "Africa";
                return "Southern Africa";
            }
            if (lng >= 60 && lng < 180) {
                if (lat > 10) return "Asia";
                if (lat > -10) return "Southeast Asia";
                return "Oceania";
            }
            
            return "Ocean";
        }

        // Additional Activity Helper Functions
        function handleComparisonClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            const regionName = getRegionName(lat, lng);
            
            if (!enhancedMap.selectedRegions) {
                enhancedMap.selectedRegions = [];
            }
            
            if (enhancedMap.selectedRegions.length < 2) {
                enhancedMap.selectedRegions.push({
                    name: regionName,
                    coordinates: [lat, lng],
                    marker: L.marker([lat, lng]).addTo(enhancedMap)
                });
                
                updateRegionList();
                
                if (enhancedMap.selectedRegions.length === 2) {
                    showComparisonResults();
                }
            }
        }

        function updateRegionList() {
            const regionList = document.getElementById('region-list');
            if (enhancedMap.selectedRegions.length === 0) {
                regionList.innerHTML = 'Click on two different areas to begin comparison';
            } else {
                regionList.innerHTML = enhancedMap.selectedRegions.map((region, index) => 
                    `${index + 1}. ${region.name} (${region.coordinates[0].toFixed(2)}°, ${region.coordinates[1].toFixed(2)}°)`
                ).join('<br>');
            }
        }

        function showComparisonResults() {
            const region1 = enhancedMap.selectedRegions[0];
            const region2 = enhancedMap.selectedRegions[1];
            
            const comparisonData = document.getElementById('comparison-data');
            comparisonData.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <h6>${region1.name}</h6>
                        <p>Coordinates: ${region1.coordinates[0].toFixed(2)}°, ${region1.coordinates[1].toFixed(2)}°</p>
                        <p>Hemisphere: ${getHemisphere(region1.coordinates[0], region1.coordinates[1])}</p>
                        <p>Climate Zone: ${getClimateZone(region1.coordinates[0])}</p>
                    </div>
                    <div>
                        <h6>${region2.name}</h6>
                        <p>Coordinates: ${region2.coordinates[0].toFixed(2)}°, ${region2.coordinates[1].toFixed(2)}°</p>
                        <p>Hemisphere: ${getHemisphere(region2.coordinates[0], region2.coordinates[1])}</p>
                        <p>Climate Zone: ${getClimateZone(region2.coordinates[0])}</p>
                    </div>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                    <strong>Distance between regions:</strong> ${calculateDistance(region1.coordinates, region2.coordinates).toFixed(0)} km
                </div>
            `;
            
            document.getElementById('comparison-results').style.display = 'block';
        }

        function resetComparison() {
            if (enhancedMap.selectedRegions) {
                enhancedMap.selectedRegions.forEach(region => {
                    enhancedMap.removeLayer(region.marker);
                });
                enhancedMap.selectedRegions = [];
            }
            updateRegionList();
            document.getElementById('comparison-results').style.display = 'none';
        }

        function getHemisphere(lat, lng) {
            const ns = lat >= 0 ? 'Northern' : 'Southern';
            const ew = lng >= 0 ? 'Eastern' : 'Western';
            return `${ns} & ${ew}`;
        }

        function getClimateZone(lat) {
            const absLat = Math.abs(lat);
            if (absLat >= 66.5) return 'Polar';
            if (absLat >= 40) return 'Temperate';
            if (absLat >= 23.5) return 'Subtropical';
            return 'Tropical';
        }

        function calculateDistance(coord1, coord2) {
            const R = 6371; // Earth's radius in km
            const dLat = (coord2[0] - coord1[0]) * Math.PI / 180;
            const dLng = (coord2[1] - coord1[1]) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(coord1[0] * Math.PI / 180) * Math.cos(coord2[0] * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function enableDistanceMeasurement() {
            // Simple distance measurement - in a real implementation, you'd use a Leaflet plugin
            updateMapStatus('Distance measurement enabled - Right-click and drag to measure');
        }

        function generateDistanceChallenge() {
            const challenges = [
                "Measure the distance from Tokyo to Sydney",
                "Calculate the width of the Atlantic Ocean",
                "Find the distance along the equator",
                "Measure from the North Pole to the South Pole",
                "Calculate the distance across your lesson's region"
            ];
            
            const randomChallenge = challenges[Math.floor(Math.random() * challenges.length)];
            const challengeList = document.getElementById('distance-challenge-list');
            challengeList.innerHTML = `<p style="color: #007bff; font-weight: bold;">• ${randomChallenge}</p>`;
        }

        // ==========================================
        // INTELLIGENT ACTIVITY FUNCTIONS
        // ==========================================

        function startTradeRoutesActivity() {
            if (!enhancedMap || !currentMapLesson) {
                alert('Please select a lesson first to start trade route activities.');
                return;
            }
            
            updateMapStatus('🌐 Trade Routes Explorer: Mapping global economic connections');
            
            createActivityModal(
                '🌐 Global Trade Routes Explorer',
                `
                <div style="margin-bottom: 15px;">
                    <h4>Discover Economic Geography:</h4>
                    <p>Explore how geographic features influence global trade patterns and economic relationships.</p>
                    
                    <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin: 10px 0;">
                        <h5>🎯 Your Mission:</h5>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                            <li>Identify major shipping routes and trade corridors</li>
                            <li>Analyze how geography affects transportation costs</li>
                            <li>Explore economic connections between distant regions</li>
                            <li>Understand how trade shapes cultural exchange</li>
                        </ul>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <h5>🌍 Trade Route Facts:</h5>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                            <li>90% of global trade travels by sea</li>
                            <li>The Suez Canal handles 12% of world trade</li>
                            <li>Trade routes often follow geographic features like rivers and mountain passes</li>
                            <li>Economic geography explains why some regions are wealthier than others</li>
                        </ul>
                    </div>
                </div>
                `,
                [
                    { text: 'Show Trade Data', action: 'showLessonData()' },
                    { text: 'Close Activity', action: 'closeActivityModal()' }
                ]
            );
        }

        function startEconomicMappingActivity() {
            if (!enhancedMap || !currentMapLesson) {
                alert('Please select a lesson first to start economic mapping.');
                return;
            }
            
            updateMapStatus('📊 Economic Geography: Analyzing spatial economic patterns');
            
            createActivityModal(
                '📊 Economic Geography Mapper',
                `
                <div style="margin-bottom: 15px;">
                    <h4>Map Economic Patterns:</h4>
                    <p>Understand how economic activities are distributed across space and why certain regions develop differently.</p>
                    
                    <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin: 10px 0;">
                        <h5>🎯 Exploration Areas:</h5>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                            <li>Industrial regions and manufacturing centers</li>
                            <li>Agricultural zones and resource extraction areas</li>
                            <li>Service economies and financial centers</li>
                            <li>Development patterns and economic inequality</li>
                        </ul>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <h5>💡 Economic Geography Insights:</h5>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                            <li>Geographic location affects economic development</li>
                            <li>Natural resources influence regional specialization</li>
                            <li>Transportation networks shape economic patterns</li>
                            <li>Climate and terrain impact agricultural productivity</li>
                        </ul>
                    </div>
                </div>
                `,
                [
                    { text: 'Load Economic Data', action: 'showLessonData()' },
                    { text: 'Close Activity', action: 'closeActivityModal()' }
                ]
            );
        }

        function startSupplyChainActivity() {
            if (!enhancedMap || !currentMapLesson) {
                alert('Please select a lesson first to start supply chain mapping.');
                return;
            }
            
            updateMapStatus('🚚 Supply Chain Geography: Tracing global connections');
            
            createActivityModal(
                '🚚 Supply Chain Geography',
                `
                <div style="margin-bottom: 15px;">
                    <h4>Follow Global Supply Chains:</h4>
                    <p>Discover how products travel around the world and how geography affects global supply networks.</p>
                    
                    <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin: 10px 0;">
                        <h5>🎯 Supply Chain Elements:</h5>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                            <li>Raw material extraction and processing locations</li>
                            <li>Manufacturing centers and assembly points</li>
                            <li>Distribution networks and logistics hubs</li>
                            <li>Consumer markets and retail destinations</li>
                        </ul>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <h5>🌐 Global Supply Chain Facts:</h5>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                            <li>A typical smartphone contains materials from 6+ continents</li>
                            <li>Ocean shipping carries 90% of international trade</li>
                            <li>Geographic barriers add cost and complexity to supply chains</li>
                            <li>Political geography affects trade relationships</li>
                        </ul>
                    </div>
                </div>
                `,
                [
                    { text: 'Trace a Product', action: 'generateLocationChallenge()' },
                    { text: 'Close Activity', action: 'closeActivityModal()' }
                ]
            );
        }

        function startCulturalGeographyActivity() {
            if (!enhancedMap || !currentMapLesson) {
                alert('Please select a lesson first to start cultural geography exploration.');
                return;
            }
            
            updateMapStatus('🏛️ Cultural Geography: Exploring human-environment connections');
            
            createActivityModal(
                '🏛️ Cultural Geography Explorer',
                `
                <div style="margin-bottom: 15px;">
                    <h4>Discover Cultural Landscapes:</h4>
                    <p>Explore how geography influences culture, and how human cultures shape the landscape.</p>
                    
                    <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin: 10px 0;">
                        <h5>🎯 Cultural Geography Themes:</h5>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                            <li>How environment shapes cultural practices</li>
                            <li>Settlement patterns and architectural styles</li>
                            <li>Religious and cultural site locations</li>
                            <li>Language distribution and geographic barriers</li>
                        </ul>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <h5>🌍 Cultural-Geographic Connections:</h5>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                            <li>Mountain barriers create distinct cultural regions</li>
                            <li>Rivers serve as cultural highways and boundaries</li>
                            <li>Climate influences food, clothing, and housing</li>
                            <li>Natural resources shape economic and social systems</li>
                        </ul>
                    </div>
                </div>
                `,
                [
                    { text: 'Explore Cultural Sites', action: 'focusOnLessonRegion()' },
                    { text: 'Close Activity', action: 'closeActivityModal()' }
                ]
            );
        }

        function startHistoricalMappingActivity() {
            if (!enhancedMap || !currentMapLesson) {
                alert('Please select a lesson first to start historical mapping.');
                return;
            }
            
            updateMapStatus('🗺️ Historical Geography: Mapping civilizations through time');
            
            createActivityModal(
                '🗺️ Historical Geography Mapper',
                `
                <div style="margin-bottom: 15px;">
                    <h4>Map Historical Civilizations:</h4>
                    <p>Discover how geography influenced the rise, expansion, and development of historical empires and civilizations.</p>
                    
                    <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin: 10px 0;">
                        <h5>🎯 Historical Geography Focus:</h5>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                            <li>Geographic factors in empire expansion</li>
                            <li>Natural boundaries and defensive positions</li>
                            <li>Trade routes and economic centers</li>
                            <li>Environmental challenges and adaptations</li>
                        </ul>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <h5>🏛️ Geography Shapes History:</h5>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                            <li>River valleys fostered early civilizations</li>
                            <li>Mountain ranges provided natural defenses</li>
                            <li>Coastal locations enabled maritime trade</li>
                            <li>Climate changes influenced migration patterns</li>
                        </ul>
                    </div>
                </div>
                `,
                [
                    { text: 'Focus on Historical Region', action: 'focusOnLessonRegion()' },
                    { text: 'Close Activity', action: 'closeActivityModal()' }
                ]
            );
        }

        function startRegionalFocusActivity() {
            if (!enhancedMap || !currentMapLesson) {
                alert('Please select a lesson first to start regional exploration.');
                return;
            }
            
            updateMapStatus('📍 Regional Focus: Deep dive into your lesson region');
            
            // Auto-focus on the lesson region
            focusOnLessonRegion();
            
            createActivityModal(
                '📍 Regional Focus Explorer',
                `
                <div style="margin-bottom: 15px;">
                    <h4>Explore Your Lesson Region:</h4>
                    <p>Take a comprehensive look at the geographic region featured in your current lesson.</p>
                    
                    <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin: 10px 0;">
                        <h5>🎯 Regional Analysis:</h5>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                            <li>Physical geography and landforms</li>
                            <li>Climate patterns and weather systems</li>
                            <li>Human settlement and population distribution</li>
                            <li>Economic activities and resources</li>
                        </ul>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <h5>🔍 Investigation Questions:</h5>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                            <li>What makes this region unique?</li>
                            <li>How do people adapt to the environment here?</li>
                            <li>What challenges and opportunities exist?</li>
                            <li>How does this region connect to the wider world?</li>
                        </ul>
                    </div>
                </div>
                `,
                [
                    { text: 'Load Regional Data', action: 'showLessonData()' },
                    { text: 'Close Activity', action: 'closeActivityModal()' }
                ]
            );
        }

        function startPhysicalFeaturesActivity() {
            if (!enhancedMap || !currentMapLesson) {
                alert('Please select a lesson first to start physical features exploration.');
                return;
            }
            
            updateMapStatus('🌍 Physical Features: Click on the map to discover landforms and natural systems');
            
            // Clear any existing markers
            if (enhancedMap.physicalFeatureMarkers) {
                enhancedMap.physicalFeatureMarkers.forEach(marker => enhancedMap.removeLayer(marker));
            }
            enhancedMap.physicalFeatureMarkers = [];
            
            // Set up interactive physical features mode
            enhancedMap.currentActivity = 'physicalFeatures';
            enhancedMap.on('click', handlePhysicalFeatureClick);
            
            // Enable terrain view automatically for better visualization
            enable3DTerrain();
            
            // Focus on lesson region if available
            focusOnLessonRegion();
            
            createActivityModal(
                '🌍 Interactive Physical Features Explorer',
                `
                <div style="margin-bottom: 15px;">
                    <h4>🎯 Your Mission:</h4>
                    <p><strong>Click anywhere on the map</strong> to discover and learn about physical features at that location!</p>
                    
                    <div id="feature-discovery-panel" style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin: 10px 0; min-height: 80px;">
                        <h5>🌍 Physical Feature Discovery:</h5>
                        <p id="feature-info">Click on the map to explore mountains, rivers, deserts, coastlines, and other landforms!</p>
                        <div id="feature-details" style="display: none; margin-top: 10px; padding: 8px; background: white; border-radius: 4px; border-left: 4px solid #007bff;"></div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <h5>🎮 Interactive Features:</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                            <button onclick="showNearbyMountains()" style="padding: 6px; border: none; background: #28a745; color: white; border-radius: 4px; cursor: pointer;">🏔️ Find Mountains</button>
                            <button onclick="showNearbyRivers()" style="padding: 6px; border: none; background: #17a2b8; color: white; border-radius: 4px; cursor: pointer;">🌊 Find Rivers</button>
                            <button onclick="showClimateZones()" style="padding: 6px; border: none; background: #ffc107; color: white; border-radius: 4px; cursor: pointer;">🌡️ Climate Zones</button>
                            <button onclick="showTerrainFeatures()" style="padding: 6px; border: none; background: #6f42c1; color: white; border-radius: 4px; cursor: pointer;">🗻 Terrain Types</button>
                        </div>
                    </div>
                    
                    <div id="exploration-checklist" style="background: #e8f5e8; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <h6>✅ Discovery Checklist:</h6>
                        <div style="font-size: 12px;">
                            <label><input type="checkbox" id="found-mountain"> Found a mountain or highland</label><br>
                            <label><input type="checkbox" id="found-water"> Found a river, lake, or coast</label><br>
                            <label><input type="checkbox" id="found-plain"> Found a plain or lowland</label><br>
                            <label><input type="checkbox" id="found-desert"> Found a desert or arid region</label><br>
                            <label><input type="checkbox" id="found-forest"> Found a forest or vegetation zone</label>
                        </div>
                    </div>
                    
                    <div id="feature-score" style="text-align: center; font-weight: bold; color: #2c5aa0;">
                        Features Discovered: <span id="discovery-count">0</span>/5
                    </div>
                </div>
                `,
                [
                    { text: '🗺️ Reset Explorer', action: 'resetPhysicalFeatureExplorer()' },
                    { text: '📍 Show All Features', action: 'showAllRegionalFeatures()' },
                    { text: 'Close Activity', action: 'closePhysicalFeatureActivity()' }
                ]
            );
        }

        function handlePhysicalFeatureClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // Add a discovery marker
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'physical-feature-marker',
                    html: '🔍',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(enhancedMap);
            
            enhancedMap.physicalFeatureMarkers.push(marker);
            
            // Analyze the location and provide educational content
            analyzePhysicalFeature(lat, lng, marker);
            
            // Update discovery count
            updateDiscoveryCount();
        }

        function analyzePhysicalFeature(lat, lng, marker) {
            const featureInfo = document.getElementById('feature-info');
            const featureDetails = document.getElementById('feature-details');
            
            // Get lesson region context if available
            const lessonRegion = window.currentLessonRegion;
            const isCanadaLesson = lessonRegion && (lessonRegion.keyword.includes('canada') || lessonRegion.keyword.includes('canadian'));
            
            // Determine physical features based on coordinates and lesson context
            let featureType = '';
            let featureName = '';
            let educationalInfo = '';
            let checkboxToCheck = '';
            
            // CANADA-SPECIFIC ANALYSIS
            if (isCanadaLesson && lat >= 41 && lat <= 83 && lng >= -141 && lng <= -52) {
                // Canadian Shield
                if (lat >= 45 && lat <= 70 && lng >= -95 && lng <= -60) {
                    featureType = 'Canadian Shield';
                    featureName = 'Precambrian Shield Rock Formation';
                    educationalInfo = 'The Canadian Shield is ancient rock formation covering much of central and eastern Canada. Rich in minerals, it contains some of Earth\'s oldest rocks (over 2.5 billion years old) and provides valuable mining resources like gold, copper, and nickel.';
                    checkboxToCheck = 'found-mountain';
                }
                // Rocky Mountains (Western Canada)
                else if (lat >= 49 && lat <= 70 && lng >= -140 && lng <= -110) {
                    featureType = 'Canadian Rocky Mountains';
                    featureName = 'Western Mountain Range';
                    educationalInfo = 'The Canadian Rockies extend through British Columbia and Alberta, creating a dramatic landscape of peaks, glaciers, and alpine lakes. They influence weather patterns, creating rain shadows and affecting precipitation distribution across western Canada.';
                    checkboxToCheck = 'found-mountain';
                }
                // Great Lakes Region
                else if (lat >= 42 && lat <= 49 && lng >= -95 && lng <= -74) {
                    featureType = 'Great Lakes Basin';
                    featureName = 'Freshwater Lake System';
                    educationalInfo = 'The Great Lakes contain 20% of the world\'s fresh surface water and form a natural border between Canada and the United States. They provide transportation routes, fresh water, and moderate the climate in southern Ontario.';
                    checkboxToCheck = 'found-water';
                }
                // Prairie Provinces
                else if (lat >= 49 && lat <= 60 && lng >= -115 && lng <= -95) {
                    featureType = 'Canadian Prairies';
                    featureName = 'Interior Plains/Grasslands';
                    educationalInfo = 'The Canadian Prairies (Manitoba, Saskatchewan, Alberta) contain some of the world\'s most fertile agricultural land. These flat grasslands are ideal for wheat farming and cattle ranching, making Canada a major food exporter.';
                    checkboxToCheck = 'found-plain';
                }
                // Boreal Forest
                else if (lat >= 50 && lat <= 70) {
                    featureType = 'Boreal Forest (Taiga)';
                    featureName = 'Northern Coniferous Forest';
                    educationalInfo = 'Canada\'s boreal forest is the world\'s largest intact forest ecosystem, covering 75% of Canada\'s forests. It stores massive amounts of carbon, provides timber resources, and supports wildlife like caribou, moose, and bears.';
                    checkboxToCheck = 'found-forest';
                }
                // Arctic Archipelago
                else if (lat >= 70) {
                    featureType = 'Arctic Archipelago';
                    featureName = 'Northern Islands/Tundra';
                    educationalInfo = 'Canada\'s Arctic islands experience extreme cold, permafrost, and unique wildlife. Climate change is dramatically affecting this region, opening new shipping routes and affecting indigenous communities\' traditional ways of life.';
                    checkboxToCheck = 'found-desert'; // Using this for tundra/extreme climate
                }
                // Atlantic Coast
                else if (lng >= -70) {
                    featureType = 'Atlantic Maritime Region';
                    featureName = 'Coastal Maritime Geography';
                    educationalInfo = 'Canada\'s Atlantic coast features dramatic cliffs, fishing banks, and maritime climate. The Grand Banks offshore were historically rich fishing grounds, and the region\'s geography has shaped its maritime economy and culture.';
                    checkboxToCheck = 'found-water';
                }
                // Default for other Canadian regions
                else {
                    featureType = 'Canadian Geographic Region';
                    featureName = 'Diverse Canadian Landscape';
                    educationalInfo = 'Canada\'s vast territory encompasses incredible geographic diversity, from arctic tundra to temperate rainforests. This location represents the transition between different Canadian geographic regions.';
                }
            }
            // GENERAL GLOBAL ANALYSIS (when not in Canada lesson or outside Canada)
            else {
                // Mountain ranges detection
                if ((lat >= 25 && lat <= 50 && lng >= -125 && lng <= -100) || // Rocky Mountains
                    (lat >= 35 && lat <= 65 && lng >= -15 && lng <= 50) ||    // Alps/Himalayas region
                    (lat >= -30 && lat <= 10 && lng >= -80 && lng <= -30)) {   // Andes
                    featureType = 'Mountain Range';
                    featureName = 'Highland/Mountain Region';
                    educationalInfo = 'Mountains form through tectonic plate collision and create barriers to weather patterns, influence precipitation, and affect human settlement patterns.';
                    checkboxToCheck = 'found-mountain';
                }
                // Water bodies detection
                else if (Math.abs(lat) < 10 || lng < -140 || lng > 140 || 
                         (lat >= 40 && lat <= 50 && lng >= -100 && lng <= -70)) { // Great Lakes region
                    featureType = 'Water Feature';
                    featureName = 'River/Lake/Coastal Region';
                    educationalInfo = 'Water features provide fresh water resources, transportation routes, fertile soil for agriculture, and often serve as natural boundaries between regions.';
                    checkboxToCheck = 'found-water';
                }
                // Desert regions
                else if ((lat >= 15 && lat <= 35 && lng >= -120 && lng <= -100) || // SW US Desert
                         (lat >= 15 && lat <= 35 && lng >= -15 && lng <= 40) ||     // Sahara
                         (lat >= -35 && lat <= -15 && lng >= 110 && lng <= 140)) {  // Australian Desert
                    featureType = 'Desert Region';
                    featureName = 'Arid/Semi-Arid Zone';
                    educationalInfo = 'Deserts are characterized by low precipitation, extreme temperatures, and specialized ecosystems. They often form due to rain shadows or high-pressure systems.';
                    checkboxToCheck = 'found-desert';
                }
                // Plains and agricultural regions
                else if ((lat >= 30 && lat <= 50 && lng >= -110 && lng <= -90) || // Great Plains
                         (lat >= 45 && lat <= 60 && lng >= 20 && lng <= 60)) {     // European Plains
                    featureType = 'Plains/Agricultural Region';
                    featureName = 'Lowland/Prairie';
                    educationalInfo = 'Plains provide ideal conditions for agriculture with flat terrain, fertile soil, and moderate precipitation. They often support high population densities.';
                    checkboxToCheck = 'found-plain';
                }
                // Forest regions
                else if ((lat >= 45 && lat <= 70) || // Northern forests
                         (lat >= -10 && lat <= 10)) { // Tropical forests
                    featureType = 'Forest Region';
                    featureName = 'Forested/Vegetation Zone';
                    educationalInfo = 'Forests provide timber resources, regulate climate, prevent erosion, and support biodiversity. Different types form based on climate conditions.';
                    checkboxToCheck = 'found-forest';
                }
                // Default for other regions
                else {
                    featureType = 'Mixed Terrain';
                    featureName = 'Geographic Region';
                    educationalInfo = 'This area represents a transition zone between different physical features, demonstrating how geography creates diverse landscapes.';
                }
            }
            
            // Update the UI
            featureInfo.innerHTML = `
                <strong>📍 Location:</strong> ${lat.toFixed(2)}°N, ${Math.abs(lng).toFixed(2)}°${lng >= 0 ? 'E' : 'W'}<br>
                <strong>🌍 Feature Type:</strong> ${featureType}<br>
                <strong>🏔️ Feature Name:</strong> ${featureName}
                ${isCanadaLesson ? '<br><strong>🍁 Canada Lesson Context:</strong> Analyzed specifically for Canadian geography' : ''}
            `;
            
            featureDetails.style.display = 'block';
            featureDetails.innerHTML = `
                <strong>📚 Educational Insight:</strong><br>
                ${educationalInfo}
                <br><br>
                <strong>🎯 Geographic Significance:</strong><br>
                This type of physical feature influences local climate, human settlement patterns, economic activities, and cultural development in the region.
                ${isCanadaLesson ? '<br><br><strong>🍁 Canadian Connection:</strong> This feature is particularly important in understanding Canada\'s geography and its impact on Canadian society and economy.' : ''}
            `;
            
            // Check off the appropriate discovery checkbox
            if (checkboxToCheck) {
                const checkbox = document.getElementById(checkboxToCheck);
                if (checkbox && !checkbox.checked) {
                    checkbox.checked = true;
                    showDiscoveryAnimation(featureType);
                }
            }
            
            // Add popup to marker
            marker.bindPopup(`
                <strong>${featureType}</strong><br>
                ${featureName}<br>
                <em>Lat: ${lat.toFixed(2)}, Lng: ${lng.toFixed(2)}</em>
                ${isCanadaLesson ? '<br>🍁 <em>Canada Lesson Focus</em>' : ''}
            `).openPopup();
        }

        function showDiscoveryAnimation(featureType) {
            // Create a temporary celebration message
            const celebration = document.createElement('div');
            celebration.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                padding: 10px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                z-index: 10000;
                font-weight: bold;
                animation: slideInOut 3s ease-in-out;
            `;
            celebration.innerHTML = `🎉 Discovered: ${featureType}!`;
            
            document.body.appendChild(celebration);
            setTimeout(() => celebration.remove(), 3000);
        }

        function updateDiscoveryCount() {
            const checkboxes = ['found-mountain', 'found-water', 'found-plain', 'found-desert', 'found-forest'];
            const checkedCount = checkboxes.filter(id => document.getElementById(id)?.checked).length;
            const countElement = document.getElementById('discovery-count');
            if (countElement) {
                countElement.textContent = checkedCount;
                if (checkedCount === 5) {
                    countElement.parentElement.innerHTML += ' <span style="color: #28a745;">🏆 Explorer Master!</span>';
                }
            }
        }

        function resetPhysicalFeatureExplorer() {
            // Clear all markers
            if (enhancedMap.physicalFeatureMarkers) {
                enhancedMap.physicalFeatureMarkers.forEach(marker => enhancedMap.removeLayer(marker));
                enhancedMap.physicalFeatureMarkers = [];
            }
            
            // Reset checkboxes
            const checkboxes = ['found-mountain', 'found-water', 'found-plain', 'found-desert', 'found-forest'];
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = false;
            });
            
            // Reset info panel
            const featureInfo = document.getElementById('feature-info');
            const featureDetails = document.getElementById('feature-details');
            if (featureInfo) featureInfo.textContent = 'Click on the map to explore mountains, rivers, deserts, coastlines, and other landforms!';
            if (featureDetails) featureDetails.style.display = 'none';
            
            updateDiscoveryCount();
            updateMapStatus('🌍 Physical Features Explorer Reset - Start discovering!');
        }

        function showAllRegionalFeatures() {
            // Add some example regional features based on current map view
            const bounds = enhancedMap.getBounds();
            const center = enhancedMap.getCenter();
            
            // Add a few educational markers in the current view
            const features = [
                { lat: center.lat + 2, lng: center.lng - 3, type: '🏔️ Mountain', name: 'Highland Region' },
                { lat: center.lat - 1, lng: center.lng + 2, type: '🌊 River', name: 'Water System' },
                { lat: center.lat + 1, lng: center.lng + 1, type: '🌾 Plains', name: 'Agricultural Area' },
                { lat: center.lat - 2, lng: center.lng - 1, type: '🌲 Forest', name: 'Vegetation Zone' }
            ];
            
            features.forEach(feature => {
                const marker = L.marker([feature.lat, feature.lng], {
                    icon: L.divIcon({
                        className: 'regional-feature-marker',
                        html: feature.type,
                        iconSize: [25, 25],
                        iconAnchor: [12, 12]
                    })
                }).addTo(enhancedMap);
                
                marker.bindPopup(`<strong>${feature.name}</strong><br>Example ${feature.type.substring(2)}`);
                enhancedMap.physicalFeatureMarkers.push(marker);
            });
            
            updateMapStatus('🗺️ Regional physical features displayed');
        }

        function closePhysicalFeatureActivity() {
            // Remove event listener
            enhancedMap.off('click', handlePhysicalFeatureClick);
            enhancedMap.currentActivity = null;
            
            // Clear markers
            if (enhancedMap.physicalFeatureMarkers) {
                enhancedMap.physicalFeatureMarkers.forEach(marker => enhancedMap.removeLayer(marker));
                enhancedMap.physicalFeatureMarkers = [];
            }
            
            closeActivityModal();
            updateMapStatus('🌍 Physical Features activity closed');
        }

        // Helper functions for the interactive buttons
        function showNearbyMountains() {
            updateMapStatus('🏔️ Highlighting mountain and highland regions...');
            // Focus on a mountainous region
            enhancedMap.setView([40, -105], 6); // Rocky Mountains example
        }

        function showNearbyRivers() {
            updateMapStatus('🌊 Highlighting river systems and water features...');
            // This could be enhanced to show actual river data
        }

        function showClimateZones() {
            updateMapStatus('🌡️ Displaying climate zone information...');
            // Enable climate layer if available
        }

        function showTerrainFeatures() {
            updateMapStatus('🗻 Enhanced terrain view activated');
            enable3DTerrain();
        }

        function startEnvironmentalActivity() {
            if (!enhancedMap || !currentMapLesson) {
                alert('Please select a lesson first to start environmental exploration.');
                return;
            }
            
            updateMapStatus('🌱 Environmental Geography: Exploring human-environment interactions');
            
            createActivityModal(
                '🌱 Environmental Geography',
                `
                <div style="margin-bottom: 15px;">
                    <h4>Explore Environmental Issues:</h4>
                    <p>Investigate how humans interact with the environment and the geographic patterns of environmental challenges.</p>
                    
                    <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin: 10px 0;">
                        <h5>🎯 Environmental Themes:</h5>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                            <li>Natural resource distribution and use</li>
                            <li>Environmental challenges and solutions</li>
                            <li>Sustainability and conservation efforts</li>
                            <li>Climate change impacts by region</li>
                        </ul>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <h5>🌍 Environmental Geography Facts:</h5>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                            <li>Geographic location affects environmental vulnerability</li>
                            <li>Human activities create regional environmental patterns</li>
                            <li>Resource availability influences development strategies</li>
                            <li>Environmental issues often cross political boundaries</li>
                        </ul>
                    </div>
                </div>
                `,
                [
                    { text: 'Show Environmental Data', action: 'showLessonData()' },
                    { text: 'Close Activity', action: 'closeActivityModal()' }
                ]
            );
        }

        function startContextExplorationActivity() {
            if (!enhancedMap || !currentMapLesson) {
                alert('Please select a lesson first to start context exploration.');
                return;
            }
            
            updateMapStatus('🎯 Context Explorer: Discovering geographic connections in your lesson');
            
            createActivityModal(
                '🎯 Geographic Context Explorer',
                `
                <div style="margin-bottom: 15px;">
                    <h4>Discover Geographic Connections:</h4>
                    <p>Explore how geography relates to and enhances understanding of your current lesson content.</p>
                    
                    <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin: 10px 0;">
                        <h5>🎯 Geographic Context Areas:</h5>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                            <li>Spatial patterns and relationships</li>
                            <li>Location and place significance</li>
                            <li>Human-environment interactions</li>
                            <li>Regional characteristics and connections</li>
                        </ul>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <h5>🌍 Geographic Thinking:</h5>
                        <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                            <li>Where do events and processes occur?</li>
                            <li>Why do they occur where they do?</li>
                            <li>How are different places connected?</li>
                            <li>What are the geographic implications?</li>
                        </ul>
                    </div>
                </div>
                `,
                [
                    { text: 'Focus on Lesson Area', action: 'focusOnLessonRegion()' },
                    { text: 'Close Activity', action: 'closeActivityModal()' }
                ]
            );
        }

        function rotateExplorationQuestion() {
            const questions = [
                "What physical features do you notice in this region?",
                "How might the climate affect people living here?",
                "What natural resources might be available in this area?",
                "How do you think people travel and trade in this region?",
                "What challenges might people face living here?",
                "How has human activity changed this landscape?",
                "What makes this region unique compared to others?"
            ];
            
            const currentQuestion = document.getElementById('current-question');
            const randomQuestion = questions[Math.floor(Math.random() * questions.length)];
            currentQuestion.textContent = randomQuestion;
        }

        // Enhanced button event handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Enhanced map button handlers
            const loadActivitiesBtn = document.getElementById('loadLessonActivities');
            if (loadActivitiesBtn) {
                loadActivitiesBtn.onclick = function() {
                    if (!currentMapLesson) {
                        // Cool error animation
                        this.style.transform = 'scale(0.95)';
                        this.style.background = '#dc3545';
                        this.innerHTML = '❌ Select Lesson First!';
                        setTimeout(() => {
                            this.style.transform = 'scale(1)';
                            this.style.background = '#fd7e14';
                            this.innerHTML = '🎯 Load Activities';
                        }, 1500);
                        return;
                    }
                    
                    // COOL LOADING SEQUENCE! 🚀
                    startCoolLoadingSequence(this);
                };
            }
        });

        function startCoolLoadingSequence(button) {
            // Phase 1: Button transformation
            button.style.transition = 'all 0.3s ease';
            button.style.transform = 'scale(1.1)';
            button.style.background = 'linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7)';
            button.style.backgroundSize = '300% 300%';
            button.style.animation = 'gradientShift 0.5s ease-in-out';
            button.innerHTML = '🚀 Preparing Activities...';
            button.disabled = true;
            
            // Create particle effects around the button
            createParticleExplosion(button);
            
            // Phase 2: Countdown sequence
            let countdown = 3;
            const countdownInterval = setInterval(() => {
                if (countdown > 0) {
                    button.innerHTML = `⚡ Loading... ${countdown}`;
                    countdown--;
                } else {
                    clearInterval(countdownInterval);
                    
                    // Phase 3: Success animation
                    button.style.transform = 'scale(1)';
                    button.style.background = 'linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%)';
                    button.style.animation = 'successPulse 0.6s ease-out';
                    button.innerHTML = '✨ Activities Loaded!';
                    
                    // Phase 4: Reveal activities with cool animations
                    revealActivitiesWithCoolEffects();
                    
                    // Phase 5: Reset button after delay
                    setTimeout(() => {
                        button.style.background = '#fd7e14';
                        button.style.animation = '';
                        button.innerHTML = '🎯 Load Activities';
                        button.disabled = false;
                        updateMapStatus('🎉 Activities ready! Choose one to begin your geographic adventure!');
                    }, 2000);
                }
            }, 800);
        }

        function createParticleExplosion(button) {
            const rect = button.getBoundingClientRect();
            const particles = ['⭐', '✨', '🌟', '💫', '🎯', '🗺️', '🌍', '📍'];
            
            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.style.cssText = `
                    position: fixed;
                    left: ${rect.left + rect.width/2}px;
                    top: ${rect.top + rect.height/2}px;
                    font-size: 20px;
                    pointer-events: none;
                    z-index: 10000;
                    animation: particleExplosion 1.5s ease-out forwards;
                `;
                particle.textContent = particles[Math.floor(Math.random() * particles.length)];
                
                // Random direction for explosion
                const angle = (i / 12) * 360;
                particle.style.setProperty('--angle', `${angle}deg`);
                
                document.body.appendChild(particle);
                
                // Remove after animation
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 1500);
            }
        }

        function revealActivitiesWithCoolEffects() {
            // Load the activities first
            loadLessonMapActivities();
            
            // Get all the panels
            const skillsPanel = document.getElementById('map-skills-panel');
            const focusPanel = document.getElementById('geographic-focus-panel');
            const activitiesPanel = document.getElementById('map-activities-panel');
            
            // Hide all panels initially for the reveal
            [skillsPanel, focusPanel, activitiesPanel].forEach(panel => {
                if (panel) {
                    panel.style.opacity = '0';
                    panel.style.transform = 'translateY(20px)';
                    panel.style.transition = 'all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
                }
            });
            
            // Staggered reveal with bounce effects
            setTimeout(() => {
                if (skillsPanel && skillsPanel.style.display !== 'none') {
                    skillsPanel.style.opacity = '1';
                    skillsPanel.style.transform = 'translateY(0)';
                    addGlowEffect(skillsPanel, '#28a745');
                }
            }, 200);
            
            setTimeout(() => {
                if (focusPanel && focusPanel.style.display !== 'none') {
                    focusPanel.style.opacity = '1';
                    focusPanel.style.transform = 'translateY(0)';
                    addGlowEffect(focusPanel, '#ffc107');
                }
            }, 400);
            
            setTimeout(() => {
                if (activitiesPanel && activitiesPanel.style.display !== 'none') {
                    activitiesPanel.style.opacity = '1';
                    activitiesPanel.style.transform = 'translateY(0)';
                    addGlowEffect(activitiesPanel, '#17a2b8');
                    
                    // Add sparkle effects to activity cards
                    const activityCards = activitiesPanel.querySelectorAll('[style*="background: white"]');
                    activityCards.forEach((card, index) => {
                        setTimeout(() => {
                            addSparkleToCard(card);
                        }, index * 200);
                    });
                }
            }, 600);
        }

        function addGlowEffect(element, color) {
            element.style.boxShadow = `0 0 20px ${color}40, 0 0 40px ${color}20`;
            setTimeout(() => {
                element.style.boxShadow = '';
            }, 2000);
        }

        function addSparkleToCard(card) {
            card.style.transform = 'scale(1.02)';
            card.style.transition = 'all 0.3s ease';
            card.style.boxShadow = '0 8px 25px rgba(0,123,255,0.3)';
            
            // Add floating sparkles
            const sparkles = ['✨', '⭐', '🌟'];
            for (let i = 0; i < 3; i++) {
                const sparkle = document.createElement('span');
                sparkle.textContent = sparkles[i];
                sparkle.style.cssText = `
                    position: absolute;
                    font-size: 16px;
                    pointer-events: none;
                    animation: floatSparkle 2s ease-out forwards;
                    z-index: 1000;
                `;
                
                const rect = card.getBoundingClientRect();
                sparkle.style.left = `${rect.left + Math.random() * rect.width}px`;
                sparkle.style.top = `${rect.top + Math.random() * rect.height}px`;
                
                document.body.appendChild(sparkle);
                
                setTimeout(() => {
                    if (sparkle.parentNode) {
                        sparkle.parentNode.removeChild(sparkle);
                    }
                }, 2000);
            }
            
            setTimeout(() => {
                card.style.transform = '';
                card.style.boxShadow = '';
            }, 1000);
        }

        function createButtonRipple(event) {
            const button = event.target;
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;
            
            const ripple = document.createElement('span');
            ripple.className = 'button-ripple';
            ripple.style.cssText = `
                width: ${size}px;
                height: ${size}px;
                left: ${x}px;
                top: ${y}px;
            `;
            
            button.style.position = 'relative';
            button.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        }

        // Navigation functions
        function previousLesson() {
            const moduleSelect = document.getElementById('moduleSelect');
            const currentModuleNumber = parseInt(moduleSelect.value);
            if (!currentModuleNumber) return;
            
            const currentModuleLessons = allLessons.filter(lesson => 
                lesson.module && lesson.module.moduleNumber === currentModuleNumber
            ).sort((a, b) => a.lessonNumber - b.lessonNumber);
            
            const currentIndex = currentModuleLessons.findIndex(lesson => lesson.lessonNumber === currentLessonDay);
            if (currentIndex > 0) {
                const prevLesson = currentModuleLessons[currentIndex - 1];
                loadLessonById(prevLesson._id);
            }
        }

        function nextLesson() {
            const moduleSelect = document.getElementById('moduleSelect');
            const currentModuleNumber = parseInt(moduleSelect.value);
            if (!currentModuleNumber) return;
            
            const currentModuleLessons = allLessons.filter(lesson => 
                lesson.module && lesson.module.moduleNumber === currentModuleNumber
            ).sort((a, b) => a.lessonNumber - b.lessonNumber);
            
            const currentIndex = currentModuleLessons.findIndex(lesson => lesson.lessonNumber === currentLessonDay);
            if (currentIndex < currentModuleLessons.length - 1) {
                const nextLesson = currentModuleLessons[currentIndex + 1];
                loadLessonById(nextLesson._id);
            }
        }

        async function loadLessonById(lessonId) {
            try {
                // Find the lesson in our local array
                const lesson = allLessons.find(l => l._id === lessonId);
                if (!lesson) {
                    throw new Error('Lesson not found');
                }

                // Update the lesson selector to match
                document.getElementById('lessonSelect').value = lessonId;

                // Use the lesson data directly
                const lessonData = {
                    schoolDay: lesson.lessonNumber,
                    moduleNumber: lesson.module.moduleNumber,
                    moduleTitle: lesson.module.title,
                    lessonNumber: lesson.lessonNumber,
                    lessonTitle: lesson.title,
                    pdfFile: lesson.module.pdfFileName || `module_${lesson.module.moduleNumber}.pdf`,
                    lesson: lesson
                };
                
                displayLesson(lessonData);
                currentLessonDay = lesson.lessonNumber;
                updateNavigationButtons();
                
            } catch (error) {
                console.error('Error loading lesson:', error);
                document.getElementById('lesson-content').innerHTML = 
                    `<div class="error">Error loading lesson: ${error.message}</div>`;
            }
        }

        function updateNavigationButtons() {
            const moduleSelect = document.getElementById('moduleSelect');
            const currentModuleNumber = parseInt(moduleSelect.value);
            
            if (!currentModuleNumber) {
                document.getElementById('prevBtn').disabled = true;
                document.getElementById('nextBtn').disabled = true;
                return;
            }
            
            const currentModuleLessons = allLessons.filter(lesson => 
                lesson.module && lesson.module.moduleNumber === currentModuleNumber
            ).sort((a, b) => a.lessonNumber - b.lessonNumber);
            
            const currentIndex = currentModuleLessons.findIndex(lesson => lesson.lessonNumber === currentLessonDay);
            
            document.getElementById('prevBtn').disabled = currentIndex <= 0;
            document.getElementById('nextBtn').disabled = currentIndex >= currentModuleLessons.length - 1;
        }

        // Initialize the page
        // Initialize the application
        loadModules();
        initializeCalendar();

        // Load first lesson by default after modules are loaded
        setTimeout(() => {
            if (allLessons.length > 0) {
                const firstLesson = allLessons.find(lesson => 
                    lesson.module && lesson.module.moduleNumber === 1 && lesson.lessonNumber === 1
                );
                if (firstLesson) {
                    // Set the selectors to Module 1, Lesson 1
                    document.getElementById('moduleSelect').value = 1;
                    loadLessonsForModule(1);
                    setTimeout(() => {
                        document.getElementById('lessonSelect').value = firstLesson._id;
                        loadLesson();
                    }, 500);
                }
            }
        }, 1000);
        
        // Navigation functions for Previous/Next buttons
        function previousLesson() {
            const moduleSelect = document.getElementById('moduleSelect');
            const currentModuleNumber = parseInt(moduleSelect.value);
            if (!currentModuleNumber) return;
            
            const currentModuleLessons = allLessons.filter(lesson => 
                lesson.module && lesson.module.moduleNumber === currentModuleNumber
            ).sort((a, b) => a.lessonNumber - b.lessonNumber);
            
            const currentIndex = currentModuleLessons.findIndex(lesson => lesson.lessonNumber === currentLessonDay);
            
            if (currentIndex > 0) {
                const prevLesson = currentModuleLessons[currentIndex - 1];
                document.getElementById('lessonSelect').value = prevLesson._id;
                loadLesson();
            }
        }
        
        function nextLesson() {
            const moduleSelect = document.getElementById('moduleSelect');
            const currentModuleNumber = parseInt(moduleSelect.value);
            if (!currentModuleNumber) return;
            
            const currentModuleLessons = allLessons.filter(lesson => 
                lesson.module && lesson.module.moduleNumber === currentModuleNumber
            ).sort((a, b) => a.lessonNumber - b.lessonNumber);
            
            const currentIndex = currentModuleLessons.findIndex(lesson => lesson.lessonNumber === currentLessonDay);
            
            if (currentIndex < currentModuleLessons.length - 1) {
                const nextLesson = currentModuleLessons[currentIndex + 1];
                document.getElementById('lessonSelect').value = nextLesson._id;
                loadLesson();
            }
        }

        // Cross-Curricular Functions
        let currentLesson = null;

        // Function to switch between subject tabs
        function showSubjectContent(subject) {
            console.log('Switching to subject:', subject); // Debug log
            
            // Remove active class from all tabs and content
            document.querySelectorAll('.subject-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.subject-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            if (subject === 'ela') {
                const elaTab = document.querySelector('.subject-tab:nth-child(1)');
                const elaContent = document.getElementById('ela-content');
                if (elaTab) elaTab.classList.add('active');
                if (elaContent) elaContent.classList.add('active');
                console.log('ELA tab activated'); // Debug log
            } else if (subject === 'science') {
                const scienceTab = document.querySelector('.subject-tab:nth-child(2)');
                const scienceContent = document.getElementById('science-content');
                if (scienceTab) scienceTab.classList.add('active');
                if (scienceContent) scienceContent.classList.add('active');
                console.log('Science tab activated'); // Debug log
            }
        }

        // Function to generate cross-curricular content based on current lesson
        function generateCrossCurricularContent(lesson) {
            currentLesson = lesson;
            
            // Sync Enhanced Maps with the new lesson
            if (enhancedMap && lesson) {
                syncMapWithCurrentLesson();
            }
            
            generateELAContent(lesson);
            generateScienceContent(lesson);
        }

        // Function to generate ELA content based on current lesson
        function generateELAContent(lesson) {
            if (!lesson) return;
            
            const vocabulary = lesson.teacherContent?.vocabulary || lesson.vocabulary || [];
            const lessonTitle = lesson.title || '';
            
            // Extract key concepts for more sophisticated lesson planning
            const lessonContent = lesson.studentReading?.content || lesson.studentContent?.rawText || '';
            const isPhysicalGeography = lessonContent.toLowerCase().includes('climate') || lessonContent.toLowerCase().includes('weather') || lessonContent.toLowerCase().includes('landform');
            const isHumanGeography = lessonContent.toLowerCase().includes('culture') || lessonContent.toLowerCase().includes('population') || lessonContent.toLowerCase().includes('city');
            const isRegionalStudy = lessonTitle.toLowerCase().includes('africa') || lessonTitle.toLowerCase().includes('asia') || lessonTitle.toLowerCase().includes('europe');
            
            // Generate comprehensive reading comprehension with scaffolded questions
            const readingContent = `
                <h4>📖 Close Reading Lesson Plan (45 minutes)</h4>
                
                <div class="lesson-objective">
                    <strong>Learning Target:</strong> Students will analyze geographic text using close reading strategies and demonstrate comprehension through written responses.
                </div>
                
                <h5>Pre-Reading (10 minutes)</h5>
                <div class="activity-section">
                    <p><strong>Teacher Do:</strong> Lead vocabulary preview and activate prior knowledge</p>
                    <ol>
                        <li><strong>Vocabulary Preview:</strong> Display and pronounce key terms. Have students create quick sketches or gestures for each term.</li>
                        <li><strong>Text Walk:</strong> Preview headings, bold terms, and any visual elements in the lesson.</li>
                        <li><strong>Purpose Setting:</strong> "Today we'll read about ${lessonTitle} and analyze how geographic factors influence human life."</li>
                    </ol>
                </div>
                
                <h5>First Reading - Gist (15 minutes)</h5>
                <div class="activity-section">
                    <p><strong>Student Task:</strong> Read silently for general understanding</p>
                    <ul>
                        <li>Mark words you don't know with a "?"</li>
                        <li>Circle geographic locations mentioned</li>
                        <li>After reading, discuss with a partner: "What is this text mostly about?"</li>
                    </ul>
                    <p><strong>Exit Ticket:</strong> In one sentence, what is the main idea of this lesson?</p>
                </div>
                
                <h5>Second Reading - Text-Dependent Questions (15 minutes)</h5>
                <div class="activity-section">
                    <p><strong>Teacher-Led Analysis:</strong> Guide students through these questions</p>
                    <ol>
                        <li><strong>Literal:</strong> What specific geographic features are mentioned in the text?</li>
                        <li><strong>Inferential:</strong> How do these geographic features affect the way people live? Use evidence from the text.</li>
                        <li><strong>Analytical:</strong> Why did the author choose to organize the information this way?</li>
                        <li><strong>Synthesis:</strong> How does this connect to other regions we've studied?</li>
                    </ol>
                </div>
                
                <h5>Post-Reading - Response (5 minutes)</h5>
                <div class="activity-section">
                    <p><strong>Written Response:</strong> Choose one strategy</p>
                    <ul>
                        <li><strong>Quick Write:</strong> Explain one cause-and-effect relationship from the text</li>
                        <li><strong>Text Evidence:</strong> Find three details that support the main idea</li>
                        <li><strong>Connection:</strong> Compare this region to where you live</li>
                    </ul>
                </div>
                
                <h4>📊 Assessment Rubric</h4>
                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                    <tr style="background: #f0f0f0;">
                        <th style="border: 1px solid #ccc; padding: 8px;">Skill</th>
                        <th style="border: 1px solid #ccc; padding: 8px;">Developing</th>
                        <th style="border: 1px solid #ccc; padding: 8px;">Proficient</th>
                        <th style="border: 1px solid #ccc; padding: 8px;">Advanced</th>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 8px;"><strong>Text Evidence</strong></td>
                        <td style="border: 1px solid #ccc; padding: 8px;">Uses minimal evidence</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">Uses relevant evidence</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">Uses strong, specific evidence</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 8px;"><strong>Vocabulary</strong></td>
                        <td style="border: 1px solid #ccc; padding: 8px;">Basic understanding</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">Accurate use in context</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">Sophisticated application</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 8px;"><strong>Analysis</strong></td>
                        <td style="border: 1px solid #ccc; padding: 8px;">Literal responses</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">Makes connections</td>
                        <td style="border: 1px solid #ccc; padding: 8px;">Deep analysis with insights</td>
                    </tr>
                </table>
            `;
            document.getElementById('ela-reading-content').innerHTML = readingContent;
            
            // Generate comprehensive writing workshop lesson
            const writingContent = `
                <h4>✍️ Writing Workshop: Geographic Analysis Essay (45 minutes)</h4>
                
                <div class="lesson-objective">
                    <strong>Learning Target:</strong> Students will write a well-organized explanatory essay analyzing geographic impact using text evidence and domain-specific vocabulary.
                </div>
                
                <h5>Writing Prompt (Common Core Aligned)</h5>
                <div class="prompt-box" style="background: #e8f4fd; padding: 15px; border-left: 4px solid #2196f3; margin: 10px 0;">
                    <p><strong>Task:</strong> After reading about ${lessonTitle}, write an explanatory essay that analyzes how geographic factors influence human activities in this region. Use specific evidence from the text and include relevant geographic vocabulary.</p>
                    
                    <p><strong>Audience:</strong> A student from another school who hasn't studied this region</p>
                    <p><strong>Purpose:</strong> To explain and analyze geographic relationships</p>
                </div>
                
                <h5>Pre-Writing - Planning (10 minutes)</h5>
                <div class="activity-section">
                    <p><strong>Step 1: Evidence Collection</strong></p>
                    <ul>
                        <li>Reread the lesson and highlight 3-4 specific examples of geographic influence</li>
                        <li>For each example, note: What geographic factor? → What human activity?</li>
                    </ul>
                    
                    <p><strong>Step 2: Thesis Development</strong></p>
                    <p><em>Sentence Frame:</em> "The geography of ${lessonTitle.includes('and') ? 'this region' : lessonTitle} significantly impacts human activities through _______, _______, and _______."</p>
                    
                    <p><strong>Step 3: Essay Outline</strong></p>
                    <ul>
                        <li><strong>Introduction:</strong> Hook + Background + Thesis</li>
                        <li><strong>Body Paragraph 1:</strong> Geographic Factor #1 + Evidence + Analysis</li>
                        <li><strong>Body Paragraph 2:</strong> Geographic Factor #2 + Evidence + Analysis</li>
                        <li><strong>Conclusion:</strong> Synthesis + Broader Implications</li>
                    </ul>
                </div>
                
                <h5>Drafting (25 minutes)</h5>
                <div class="activity-section">
                    <p><strong>Introduction Strategies:</strong></p>
                    <ul>
                        <li><strong>Hook Options:</strong> Surprising fact, thought-provoking question, vivid description</li>
                        <li><strong>Background:</strong> 2-3 sentences introducing the region and its significance</li>
                        <li><strong>Thesis:</strong> Clear statement of your main argument</li>
                    </ul>
                    
                    <p><strong>Body Paragraph Structure (PEAL):</strong></p>
                    <ul>
                        <li><strong>P</strong>oint: Topic sentence stating the geographic factor</li>
                        <li><strong>E</strong>vidence: Specific details from the text</li>
                        <li><strong>A</strong>nalysis: Explain HOW/WHY this evidence supports your point</li>
                        <li><strong>L</strong>ink: Connect to thesis and transition to next idea</li>
                    </ul>
                    
                    <p><strong>Academic Language Starters:</strong></p>
                    <ul>
                        <li>"According to the text..." / "The lesson explains that..."</li>
                        <li>"This demonstrates..." / "As a result of..."</li>
                        <li>"Furthermore..." / "Additionally..." / "In contrast..."</li>
                        <li>"This evidence reveals..." / "The significance of this is..."</li>
                    </ul>
                </div>
                
                <h5>Revision Focus (10 minutes)</h5>
                <div class="activity-section">
                    <p><strong>Peer Review Checklist:</strong></p>
                    <ul>
                        <li>□ Clear thesis statement that directly answers the prompt</li>
                        <li>□ Each body paragraph focuses on one geographic factor</li>
                        <li>□ Specific evidence from the text in each paragraph</li>
                        <li>□ Analysis explains the connection between geography and human activity</li>
                        <li>□ Uses at least 5 vocabulary terms correctly</li>
                        <li>□ Conclusion synthesizes main points without just repeating</li>
                    </ul>
                </div>
                
                <h4>📝 Student Writing Scaffold</h4>
                <div style="background: #f9f9f9; padding: 15px; border: 1px solid #ddd; margin: 10px 0;">
                    <p><strong>Introduction Template (Remove after planning):</strong></p>
                    <p><em>Hook sentence about geography's power._________. ${lessonTitle} is a region where _________. The geography of this area significantly impacts human activities through _______, _______, and _______.</em></p>
                    
                    <p><strong>Body Paragraph Template:</strong></p>
                    <p><em>One way geography influences human activity in ${lessonTitle} is through _______. According to the text, "_______" (specific quote or evidence). This shows that _______. As a result, people in this region must _______. The significance of this geographic factor is _______.</em></p>
                </div>
                
                <h4>🎯 Writing Standards Addressed</h4>
                <ul>
                    <li><strong>CCSS.ELA-LITERACY.WHST.6-8.2</strong>: Write explanatory texts to examine and convey complex ideas</li>
                    <li><strong>CCSS.ELA-LITERACY.WHST.6-8.1</strong>: Write arguments using valid reasoning and evidence</li>
                    <li><strong>CCSS.ELA-LITERACY.RST.6-8.7</strong>: Integrate quantitative or technical information</li>
                </ul>
            `;
            document.getElementById('ela-writing-content').innerHTML = writingContent;
            
            // Generate sophisticated vocabulary instruction
            let vocabContent = `
                <h4>🔤 Academic Vocabulary Development (25 minutes)</h4>
                
                <div class="lesson-objective">
                    <strong>Learning Target:</strong> Students will understand and use academic vocabulary from the lesson through multiple modalities and context analysis.
                </div>
                
                <h5>Tier 2 & 3 Vocabulary Focus (8-10 Key Terms)</h5>
                <div class="vocab-section">
                    <p><strong>Word Selection Strategy:</strong> Words essential for understanding geographic concepts AND useful across subjects</p>
                    
                    <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <h6>📚 Vocabulary Learning Cycle</h6>
                        
                        <p><strong>Phase 1: Word Discovery (8 minutes)</strong></p>
                        <ol>
                            <li><strong>Context Hunting:</strong> Students locate each vocabulary word in the lesson text</li>
                            <li><strong>Initial Hypothesis:</strong> Write what you think the word means based on context clues</li>
                            <li><strong>Word Parts Analysis:</strong> Break down prefixes, roots, suffixes if applicable</li>
                        </ol>
                        
                        <p><strong>Phase 2: Deep Understanding (12 minutes)</strong></p>
                        <ol>
                            <li><strong>Precise Definition:</strong> Learn the academic definition with geographic application</li>
                            <li><strong>Visual Association:</strong> Connect each word to an image, map, or diagram from the lesson</li>
                            <li><strong>Example Web:</strong> Generate 3 examples: from lesson, from real world, from personal experience</li>
                        </ol>
                        
                        <p><strong>Phase 3: Active Application (5 minutes)</strong></p>
                        <ol>
                            <li><strong>Synonym/Antonym Bridge:</strong> Connect to words students already know</li>
                            <li><strong>Academic Sentence Creation:</strong> Use each word in a sentence about today's lesson</li>
                            <li><strong>Cross-Curricular Connection:</strong> Identify where this word might appear in other subjects</li>
                        </ol>
                    </div>
                </div>
                
                <h5>📋 Vocabulary Analysis Template</h5>
                <div style="background: #fafafa; padding: 15px; border: 1px solid #ddd; margin: 10px 0;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="background: #e3f2fd;">
                            <th style="padding: 8px; border: 1px solid #ddd;">Word</th>
                            <th style="padding: 8px; border: 1px solid #ddd;">Context Clues</th>
                            <th style="padding: 8px; border: 1px solid #ddd;">Definition</th>
                            <th style="padding: 8px; border: 1px solid #ddd;">Visual/Example</th>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Example:</strong><br/>Topography</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">"...the topography includes mountains and valleys..."</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">The arrangement of natural and artificial features of an area</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">Mountain range diagram from lesson</td>
                        </tr>
                    </table>
                </div>
            `;
            
            if (vocabulary.length > 0) {
                const vocabTerms = vocabulary.slice(0, 10).map(term => {
                    if (typeof term === 'object' && term.term) {
                        return term.term;
                    } else if (typeof term === 'string') {
                        return term.split(':')[0].trim();
                    }
                    return term;
                });
                
                vocabContent += `
                    <h5>🎯 Today's Focus Vocabulary</h5>
                    <div style="background: #e8f5e8; padding: 15px; border-left: 4px solid #4caf50; margin: 10px 0;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            ${vocabTerms.map(term => `
                                <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                                    <strong>${term}</strong><br/>
                                    <small>Context: ________________</small><br/>
                                    <small>Definition: ________________</small><br/>
                                    <small>My Example: ________________</small>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            vocabContent += `
                <h5>🎯 Vocabulary Learning Strategies</h5>
                <div class="activity-section">
                    <p><strong>Memory Techniques:</strong></p>
                    <ul>
                        <li><strong>Geographic Anchoring:</strong> Connect abstract terms to specific places from the lesson</li>
                        <li><strong>Root Word Building:</strong> "Geography" = geo (earth) + graphy (writing) = writing about Earth</li>
                        <li><strong>Action Associations:</strong> Connect vocabulary to specific actions or processes</li>
                        <li><strong>Compare & Contrast:</strong> How is this term similar to/different from related words?</li>
                    </ul>
                    
                    <p><strong>Practice Applications:</strong></p>
                    <ul>
                        <li><strong>Academic Conversation:</strong> Explain lesson concept to partner using all vocabulary words</li>
                        <li><strong>Question Generation:</strong> Write geographic questions using vocabulary terms</li>
                        <li><strong>Real-World Connections:</strong> Find examples of each concept in local geography</li>
                    </ul>
                </div>
                
                <h5>📊 Vocabulary Assessment Strategies</h5>
                <div style="background: #e8f5e8; padding: 15px; border-left: 4px solid #4caf50; margin: 10px 0;">
                    <p><strong>Formative Assessment Options:</strong></p>
                    <ul>
                        <li><strong>Context Application:</strong> Use vocabulary word correctly in new geographic context</li>
                        <li><strong>Explanation Tasks:</strong> Explain how vocabulary word relates to lesson's main idea</li>
                        <li><strong>Visual Matching:</strong> Connect vocabulary terms to appropriate maps/images</li>
                        <li><strong>Analogies:</strong> "Migration is to movement as _____ is to _____"</li>
                    </ul>
                    
                    <p><strong>Exit Ticket Vocabulary Check:</strong></p>
                    <p><em>"Choose 3 vocabulary words from today's lesson. For each word: 1) Write the definition, 2) Give an example from the lesson, 3) Explain how it connects to the main geographic concept we studied."</em></p>
                </div>
                
                <h4>🎯 Language Standards Addressed</h4>
                <ul>
                    <li><strong>CCSS.ELA-LITERACY.L.7.4</strong>: Determine meaning of unknown words using context clues</li>
                    <li><strong>CCSS.ELA-LITERACY.L.7.6</strong>: Acquire and use grade-appropriate academic vocabulary</li>
                    <li><strong>CCSS.ELA-LITERACY.RST.6-8.4</strong>: Determine meaning of technical terms and phrases</li>
                </ul>
            `;
            document.getElementById('ela-vocabulary-content').innerHTML = vocabContent;
            
            // Generate Critical Thinking Questions
            const criticalContent = `
                <h4>Discussion & Analysis Questions</h4>
                <ol>
                    <li>How might the geography described in this lesson affect the culture and lifestyle of people in this region?</li>
                    <li>Compare and contrast this region with where you live. What are three similarities and three differences?</li>
                    <li>What predictions can you make about future changes in this region based on the geographic factors discussed?</li>
                    <li>How do the geographic features influence economic activities and trade in this area?</li>
                    <li>What role does this region play in global geography and world events?</li>
                    <li>How might climate change affect the geography and people of this region?</li>
                </ol>
                <h4>Socratic Seminar Topics</h4>
                <ul>
                    <li>The role of geography in shaping human civilization</li>
                    <li>Environmental challenges and solutions in the region</li>
                    <li>How geography influences political boundaries and conflicts</li>
                    <li>The relationship between natural resources and economic development</li>
                </ul>
                <h4>Creative Thinking Exercises</h4>
                <ul>
                    <li>Design an ideal city for this geographic region</li>
                    <li>Create a travel brochure highlighting geographic features</li>
                    <li>Write a news report about a geographic event in the region</li>
                </ul>
            `;
            document.getElementById('ela-critical-content').innerHTML = criticalContent;
        }

        // Function to generate comprehensive, pedagogically-sound Science content
        function generateScienceContent(lesson) {
            console.log('Generating science content for lesson:', lesson ? lesson.title : 'null'); // Debug log
            if (!lesson) return;
            
            const lessonTitle = lesson.title || '';
            const vocabulary = lesson.teacherContent?.vocabulary || lesson.vocabulary || [];
            console.log('Lesson title:', lessonTitle, 'Vocabulary count:', vocabulary.length); // Debug log
            
            // Generate comprehensive Earth Science investigation lesson
            const earthScienceContent = `
                <h4>🌍 Earth Science Investigation: Geographic Systems (50 minutes)</h4>
                
                <div class="lesson-objective">
                    <strong>Learning Target:</strong> Students will analyze Earth's systems and investigate how geosphere, hydrosphere, atmosphere, and biosphere interact to shape the geography of ${lessonTitle}.
                </div>
                
                <h5>🔬 5E Model Science Lesson Structure</h5>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h6>ENGAGE (8 minutes) - Phenomenon Introduction</h6>
                    <p><strong>Driving Question:</strong> "How do Earth's systems work together to create the unique geographic features we see in ${lessonTitle}?"</p>
                    
                    <p><strong>Hook Activity - Geographic Mystery:</strong></p>
                    <ul>
                        <li>Show satellite image or topographic map of the region WITHOUT labels</li>
                        <li>Students make observations using "I see... I think... I wonder..." protocol</li>
                        <li>Record initial hypotheses about what Earth systems created these features</li>
                        <li>Introduce the investigation focus: <em>"Today we're going to be Earth system detectives!"</em></li>
                    </ul>
                </div>
                
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h6>EXPLORE (15 minutes) - System Investigation Stations</h6>
                    <p><strong>Rotating Investigation Stations (3-4 minutes each):</strong></p>
                    
                    <p><strong>Station 1: Geosphere Evidence</strong></p>
                    <ul>
                        <li>Analyze rock samples/images from the region</li>
                        <li>Use hardness tests and observation tools</li>
                        <li>Question: "What do these rocks tell us about the region's geological history?"</li>
                    </ul>
                    
                    <p><strong>Station 2: Hydrosphere Investigation</strong></p>
                    <ul>
                        <li>Examine water cycle data, precipitation maps, river systems</li>
                        <li>Test water samples for pH and dissolved minerals (simulation)</li>
                        <li>Question: "How does water shape and change this landscape?"</li>
                    </ul>
                    
                    <p><strong>Station 3: Atmosphere Analysis</strong></p>
                    <ul>
                        <li>Study climate graphs, pressure systems, wind patterns</li>
                        <li>Use weather instruments to measure local conditions</li>
                        <li>Question: "How do atmospheric conditions influence life in this region?"</li>
                    </ul>
                    
                    <p><strong>Station 4: Biosphere Exploration</strong></p>
                    <ul>
                        <li>Examine ecosystem photos, food webs, adaptation examples</li>
                        <li>Analyze biodiversity data and species distributions</li>
                        <li>Question: "How do living things adapt to geographic conditions here?"</li>
                    </ul>
                </div>
                
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h6>EXPLAIN (12 minutes) - System Interactions Modeling</h6>
                    
                    <p><strong>Collaborative Sense-Making:</strong></p>
                    <ol>
                        <li><strong>Evidence Synthesis:</strong> Teams share findings from each station</li>
                        <li><strong>System Interaction Map:</strong> Create visual model showing how the 4 Earth systems connect</li>
                        <li><strong>Scientific Vocabulary Integration:</strong> Use precise terminology to describe interactions</li>
                        <li><strong>Mechanism Identification:</strong> Explain HOW each system influences the others</li>
                    </ol>
                    
                    <p><strong>Key Vocabulary in Context:</strong></p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 10px 0;">
                        <div style="background: white; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <strong>Geosphere:</strong> Rocky outer layer including landforms, minerals, soil
                        </div>
                        <div style="background: white; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <strong>Hydrosphere:</strong> All water on Earth including oceans, rivers, groundwater
                        </div>
                        <div style="background: white; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <strong>Atmosphere:</strong> Layer of gases surrounding Earth, including weather systems
                        </div>
                        <div style="background: white; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <strong>Biosphere:</strong> All living things and areas where life exists on Earth
                        </div>
                    </div>
                </div>
                
                <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h6>ELABORATE (10 minutes) - Real-World Application</h6>
                    
                    <p><strong>Design Challenge:</strong> "Environmental Impact Assessment"</p>
                    <p><em>Scenario:</em> A new development is planned in ${lessonTitle}. As environmental scientists, evaluate potential impacts on each Earth system.</p>
                    
                    <p><strong>Requirements:</strong></p>
                    <ul>
                        <li>Predict effects on all 4 Earth systems</li>
                        <li>Use evidence from today's investigation</li>
                        <li>Propose 2 solutions to minimize negative impacts</li>
                        <li>Present findings using scientific reasoning</li>
                    </ul>
                </div>
                
                <div style="background: #fce4ec; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h6>EVALUATE (5 minutes) - Assessment & Reflection</h6>
                    
                    <p><strong>Exit Ticket - 3-2-1 Science Reflection:</strong></p>
                    <ul>
                        <li><strong>3</strong> pieces of evidence showing Earth system interactions in ${lessonTitle}</li>
                        <li><strong>2</strong> scientific vocabulary words you can now explain to someone else</li>
                        <li><strong>1</strong> question you still have about how these systems work together</li>
                    </ul>
                    
                    <p><strong>Performance Assessment:</strong> Students draw and label a diagram showing how all 4 Earth systems interact in the studied region, with arrows and explanations.</p>
                </div>
                
                <h5>🎯 NGSS Standards Addressed</h5>
                <ul>
                    <li><strong>MS-ESS2-1:</strong> Develop a model to describe the cycling of Earth's materials</li>
                    <li><strong>MS-ESS2-2:</strong> Analyze and interpret data on the interactions among Earth's systems</li>
                    <li><strong>MS-ESS3-2:</strong> Analyze data to determine scale of human impact on environment</li>
                </ul>
            `;
            document.getElementById('science-earth-content').innerHTML = earthScienceContent;
            
            
            // Generate Scientific Practices Investigation
            const conceptsContent = `
                <h4>🔬 Scientific Practices: Geographic Data Analysis (45 minutes)</h4>
                
                <div class="lesson-objective">
                    <strong>Learning Target:</strong> Students will apply scientific practices to analyze, interpret, and communicate geographic data using evidence-based reasoning.
                </div>
                
                <h5>Scientific Practice Focus: Analyzing & Interpreting Data</h5>
                
                <div style="background: #e1f5fe; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h6>📊 Data Investigation Protocol</h6>
                    
                    <p><strong>Phase 1: Data Collection & Organization (12 minutes)</strong></p>
                    <div class="activity-section">
                        <p><strong>Geographic Data Sets for ${lessonTitle}:</strong></p>
                        <ul>
                            <li><strong>Climate Data:</strong> Temperature and precipitation graphs (10-year averages)</li>
                            <li><strong>Topographic Data:</strong> Elevation profiles and slope calculations</li>
                            <li><strong>Population Data:</strong> Density maps and demographic information</li>
                            <li><strong>Economic Data:</strong> Land use patterns and resource distribution</li>
                        </ul>
                        
                        <p><strong>Data Organization Skills:</strong></p>
                        <ol>
                            <li>Create data tables with appropriate headers and units</li>
                            <li>Identify patterns, trends, and outliers in data sets</li>
                            <li>Calculate measures of central tendency (mean, median, mode)</li>
                            <li>Determine data ranges and variability</li>
                        </ol>
                    </div>
                    
                    <p><strong>Phase 2: Graph Construction & Analysis (18 minutes)</strong></p>
                    <div class="activity-section">
                        <p><strong>Graphing Requirements (Choose 2):</strong></p>
                        <ul>
                            <li><strong>Climate Graph:</strong> Double-bar graph showing temperature and precipitation by month</li>
                            <li><strong>Population Pyramid:</strong> Age and gender distribution for the region</li>
                            <li><strong>Scatter Plot:</strong> Correlation between elevation and temperature</li>
                            <li><strong>Line Graph:</strong> Population or economic changes over time</li>
                        </ul>
                        
                        <p><strong>Graph Analysis Framework:</strong></p>
                        <ol>
                            <li><strong>Describe:</strong> What does the graph show? (Variables, trends, patterns)</li>
                            <li><strong>Analyze:</strong> What relationships do you observe? (Correlations, cause-effect)</li>
                            <li><strong>Interpret:</strong> What do these patterns tell us about ${lessonTitle}?</li>
                            <li><strong>Evaluate:</strong> How reliable is this data? What are limitations?</li>
                        </ol>
                    </div>
                    
                    <p><strong>Phase 3: Evidence-Based Conclusions (15 minutes)</strong></p>
                    <div class="activity-section">
                        <p><strong>Scientific Reasoning Framework:</strong></p>
                        <ul>
                            <li><strong>Claim:</strong> Make a statement about geographic patterns in the region</li>
                            <li><strong>Evidence:</strong> Use specific data from graphs and tables to support claim</li>
                            <li><strong>Reasoning:</strong> Explain HOW the evidence supports the claim using scientific principles</li>
                        </ul>
                        
                        <p><strong>Sample Scientific Argument Structure:</strong></p>
                        <div style="background: #f5f5f5; padding: 10px; border-left: 3px solid #2196f3; margin: 10px 0;">
                            <p><em>"Based on our analysis of climate data, I claim that _______ [geographic pattern]. The evidence supporting this claim includes _______ [specific data]. This evidence supports my claim because _______ [scientific reasoning connecting evidence to claim]."</em></p>
                        </div>
                    </div>
                </div>
                
                <h5>🧪 Hands-On Geographic Modeling</h5>
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <p><strong>Choice-Based Investigation Labs:</strong></p>
                    
                    <p><strong>Option A: Topographic Model Challenge</strong></p>
                    <ul>
                        <li><strong>Materials:</strong> Modeling clay, contour maps, rulers, water</li>
                        <li><strong>Procedure:</strong> Build 3D model from 2D contour map of the region</li>
                        <li><strong>Variables:</strong> Test how slope affects water flow and erosion</li>
                        <li><strong>Data Collection:</strong> Measure flow rates, erosion patterns, deposition areas</li>
                    </ul>
                    
                    <p><strong>Option B: Climate Simulation</strong></p>
                    <ul>
                        <li><strong>Materials:</strong> Heat lamps, thermometers, ice, colored water, clear containers</li>
                        <li><strong>Procedure:</strong> Model how latitude and elevation affect temperature</li>
                        <li><strong>Variables:</strong> Test distance from heat source (latitude) and elevation</li>
                        <li><strong>Data Collection:</strong> Record temperature changes over time and space</li>
                    </ul>
                    
                    <p><strong>Option C: Watershed Investigation</strong></p>
                    <ul>
                        <li><strong>Materials:</strong> Sandbox, spray bottles, food coloring, collection containers</li>
                        <li><strong>Procedure:</strong> Model how geography affects water drainage patterns</li>
                        <li><strong>Variables:</strong> Test different landform configurations</li>
                        <li><strong>Data Collection:</strong> Measure water volume, flow direction, contamination spread</li>
                    </ul>
                </div>
                
                <h5>📝 Scientific Communication</h5>
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <p><strong>Lab Report Structure (Scientific Writing):</strong></p>
                    <ol>
                        <li><strong>Question:</strong> What geographic relationship were you investigating?</li>
                        <li><strong>Hypothesis:</strong> What did you predict would happen and why?</li>
                        <li><strong>Variables:</strong> What did you change (independent) and measure (dependent)?</li>
                        <li><strong>Procedure:</strong> Step-by-step method that others could replicate</li>
                        <li><strong>Results:</strong> Data tables and graphs with observations (NO interpretation here)</li>
                        <li><strong>Analysis:</strong> What patterns did you observe? How do results compare to hypothesis?</li>
                        <li><strong>Conclusion:</strong> What did you learn about geographic systems? What questions remain?</li>
                    </ol>
                    
                    <p><strong>Peer Review Protocol:</strong></p>
                    <ul>
                        <li>Are claims supported by sufficient evidence?</li>
                        <li>Is the reasoning scientifically accurate?</li>
                        <li>Are graphs and data tables labeled correctly?</li>
                        <li>Would another scientist be able to replicate this investigation?</li>
                    </ul>
                </div>
                
                <h4>🎯 Science & Engineering Practices (NGSS)</h4>
                <ul>
                    <li><strong>Practice 1:</strong> Asking Questions and Defining Problems</li>
                    <li><strong>Practice 4:</strong> Analyzing and Interpreting Data</li>
                    <li><strong>Practice 5:</strong> Using Mathematics and Computational Thinking</li>
                    <li><strong>Practice 7:</strong> Engaging in Argument from Evidence</li>
                    <li><strong>Practice 8:</strong> Obtaining, Evaluating, and Communicating Information</li>
                </ul>
            `;
            document.getElementById('science-concepts-content').innerHTML = conceptsContent;
            
            
            // Generate Engineering Design & Technology Integration
            const labContent = `
                <h4>🛠️ Engineering Design: Geographic Solutions (50 minutes)</h4>
                
                <div class="lesson-objective">
                    <strong>Learning Target:</strong> Students will use the engineering design process to develop solutions for geographic challenges in ${lessonTitle}.
                </div>
                
                <h5>Engineering Design Challenge</h5>
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h6>🎯 Real-World Problem Scenarios (Choose One)</h6>
                    
                    <p><strong>Scenario A: Sustainable Settlement Design</strong></p>
                    <div style="background: white; padding: 10px; border-left: 3px solid #4caf50; margin: 10px 0;">
                        <p><strong>Problem:</strong> Design a sustainable community that works with the geographic features of ${lessonTitle}</p>
                        <p><strong>Constraints:</strong> Must accommodate 1,000 people, minimize environmental impact, use local resources</p>
                        <p><strong>Criteria:</strong> Efficient land use, renewable energy, water management, transportation</p>
                    </div>
                    
                    <p><strong>Scenario B: Natural Disaster Preparedness</strong></p>
                    <div style="background: white; padding: 10px; border-left: 3px solid #ff9800; margin: 10px 0;">
                        <p><strong>Problem:</strong> Develop an early warning and response system for geographic hazards in the region</p>
                        <p><strong>Constraints:</strong> Limited budget, must work in remote areas, must be reliable</p>
                        <p><strong>Criteria:</strong> Fast communication, accurate detection, community accessibility</p>
                    </div>
                    
                    <p><strong>Scenario C: Resource Management System</strong></p>
                    <div style="background: white; padding: 10px; border-left: 3px solid #2196f3; margin: 10px 0;">
                        <p><strong>Problem:</strong> Create a system to sustainably manage water or mineral resources</p>
                        <p><strong>Constraints:</strong> Must balance economic needs with environmental protection</p>
                        <p><strong>Criteria:</strong> Long-term sustainability, community benefit, environmental protection</p>
                    </div>
                </div>
                
                <h5>📐 Engineering Design Process</h5>
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <p><strong>Step 1: Ask & Research (8 minutes)</strong></p>
                    <ul>
                        <li>Define the problem using specific geographic context from ${lessonTitle}</li>
                        <li>Research existing solutions to similar problems in other regions</li>
                        <li>Identify stakeholders (who would be affected by your solution?)</li>
                        <li>List constraints and criteria for success</li>
                    </ul>
                    
                    <p><strong>Step 2: Imagine & Plan (12 minutes)</strong></p>
                    <ul>
                        <li>Brainstorm multiple solution approaches (minimum 3 ideas)</li>
                        <li>Consider how geographic features will influence your design</li>
                        <li>Select best solution using criteria-based decision matrix</li>
                        <li>Create detailed design plan with labeled diagrams</li>
                    </ul>
                    
                    <p><strong>Step 3: Create & Build (20 minutes)</strong></p>
                    <ul>
                        <li>Build prototype using available materials (cardboard, clay, recyclables)</li>
                        <li>Test prototype against design criteria</li>
                        <li>Document design decisions and modifications during building</li>
                        <li>Take photos/videos of testing process</li>
                    </ul>
                    
                    <p><strong>Step 4: Improve & Communicate (10 minutes)</strong></p>
                    <ul>
                        <li>Analyze test results - what worked? What didn't?</li>
                        <li>Redesign based on evidence from testing</li>
                        <li>Prepare presentation explaining solution and design process</li>
                        <li>Connect solution back to geographic principles from lesson</li>
                    </ul>
                </div>
                
                <h5>🔧 Available Engineering Materials</h5>
                <div style="background: #f5f5f5; padding: 15px; border: 1px solid #ddd; margin: 10px 0;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <h6>Construction Materials:</h6>
                            <ul>
                                <li>Cardboard sheets and tubes</li>
                                <li>Modeling clay and foam</li>
                                <li>Wooden craft sticks</li>
                                <li>Plastic bottles and containers</li>
                            </ul>
                        </div>
                        <div>
                            <h6>Testing Materials:</h6>
                            <ul>
                                <li>Water and spray bottles</li>
                                <li>Sand and soil samples</li>
                                <li>Weights and measuring tools</li>
                                <li>Timers and data collection sheets</li>
                            </ul>
                        </div>
                        <div>
                            <h6>Technology Tools:</h6>
                            <ul>
                                <li>Digital cameras/tablets</li>
                                <li>Simple circuit materials (LEDs, batteries)</li>
                                <li>Graph paper and design software</li>
                                <li>Scale rulers and protractors</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <h5>📊 Engineering Documentation</h5>
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <p><strong>Engineering Notebook Requirements:</strong></p>
                    <ol>
                        <li><strong>Problem Definition:</strong> Clear statement connecting to ${lessonTitle} geography</li>
                        <li><strong>Research Notes:</strong> Examples of similar solutions from other regions</li>
                        <li><strong>Design Sketches:</strong> Multiple ideas with labels and dimensions</li>
                        <li><strong>Materials List:</strong> Everything used in prototype with quantities</li>
                        <li><strong>Testing Data:</strong> Measurements and observations during trials</li>
                        <li><strong>Improvements:</strong> What would you change in version 2.0?</li>
                        <li><strong>Real-World Application:</strong> How could this solution actually be implemented?</li>
                    </ol>
                </div>
                
                <h4>🎯 Engineering Standards (NGSS) Addressed</h4>
                <ul>
                    <li><strong>MS-ETS1-1:</strong> Define criteria and constraints of a design problem</li>
                    <li><strong>MS-ETS1-2:</strong> Evaluate competing design solutions</li>
                    <li><strong>MS-ETS1-3:</strong> Analyze data from tests to determine optimal design features</li>
                    <li><strong>MS-ETS1-4:</strong> Develop a model to generate data for iterative testing</li>
                </ul>
            `;
            document.getElementById('science-lab-content').innerHTML = labContent;
            
            
            // Generate Advanced Assessment & Technology Integration
            const dataContent = `
                <h4>📊 Scientific Assessment & Technology Integration (40 minutes)</h4>
                
                <div class="lesson-objective">
                    <strong>Learning Target:</strong> Students will demonstrate scientific literacy by evaluating geographic data, using digital tools, and communicating findings through multiple modalities.
                </div>
                
                <h5>🖥️ Digital Geography Investigation</h5>
                <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <h6>Technology-Enhanced Data Analysis</h6>
                    
                    <p><strong>Digital Tool Options (Choose 2):</strong></p>
                    
                    <div style="background: white; padding: 10px; border: 1px solid #ddd; margin: 10px 0;">
                        <h6>🌐 Google Earth Pro Investigation</h6>
                        <ul>
                            <li><strong>Task:</strong> Use historical imagery to track changes in ${lessonTitle} over 20 years</li>
                            <li><strong>Data Collection:</strong> Measure land use changes, urban growth, environmental impacts</li>
                            <li><strong>Analysis:</strong> Calculate rates of change, identify patterns and causes</li>
                            <li><strong>Product:</strong> Annotated tour with before/after comparisons</li>
                        </ul>
                    </div>
                    
                    <div style="background: white; padding: 10px; border: 1px solid #ddd; margin: 10px 0;">
                        <h6>📈 Climate Data Explorer (NOAA)</h6>
                        <ul>
                            <li><strong>Task:</strong> Analyze 30-year climate trends for the region</li>
                            <li><strong>Data Collection:</strong> Download temperature, precipitation, extreme weather data</li>
                            <li><strong>Analysis:</strong> Create graphs, calculate averages, identify trends</li>
                            <li><strong>Product:</strong> Digital presentation with data visualizations</li>
                        </ul>
                    </div>
                    
                    <div style="background: white; padding: 10px; border: 1px solid #ddd; margin: 10px 0;">
                        <h6>🛰️ NASA Worldview Satellite Analysis</h6>
                        <ul>
                            <li><strong>Task:</strong> Track seasonal changes, natural disasters, or human activities</li>
                            <li><strong>Data Collection:</strong> Compare satellite images across different time periods</li>
                            <li><strong>Analysis:</strong> Identify changes, measure impacts, explain causes</li>
                            <li><strong>Product:</strong> Time-lapse story with scientific explanations</li>
                        </ul>
                    </div>
                </div>
                
                <h5>🧮 Mathematical Modeling & Computational Thinking</h5>
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <p><strong>Geographic Calculations & Problem Solving:</strong></p>
                    
                    <h6>Population Density Analysis</h6>
                    <ul>
                        <li><strong>Formula:</strong> Population Density = Total Population ÷ Land Area</li>
                        <li><strong>Application:</strong> Calculate and compare population density for different regions within ${lessonTitle}</li>
                        <li><strong>Extensions:</strong> Predict future population based on growth rates, analyze carrying capacity</li>
                    </ul>
                    
                    <h6>Climate Change Projections</h6>
                    <ul>
                        <li><strong>Data Analysis:</strong> Use linear regression to project temperature trends</li>
                        <li><strong>Modeling:</strong> Create simple climate models using spreadsheet functions</li>
                        <li><strong>Uncertainty:</strong> Discuss confidence intervals and limitations of predictions</li>
                    </ul>
                    
                    <h6>Resource Sustainability Calculations</h6>
                    <ul>
                        <li><strong>Rate Problems:</strong> Calculate depletion rates for natural resources</li>
                        <li><strong>Proportional Reasoning:</strong> Scale local data to regional or global levels</li>
                        <li><strong>Systems Thinking:</strong> Model feedback loops in human-environment interactions</li>
                    </ul>
                </div>
                
                <h5>🎯 Performance-Based Assessment Menu</h5>
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <p><strong>Choose ONE assessment to demonstrate your understanding:</strong></p>
                    
                    <div style="background: white; padding: 10px; border: 1px solid #ddd; margin: 10px 0;">
                        <h6>🎬 Scientific Documentary (Video)</h6>
                        <p><strong>Requirements:</strong> 3-5 minute video explaining geographic systems in ${lessonTitle}</p>
                        <ul>
                            <li>Include data visualizations and evidence</li>
                            <li>Use scientific vocabulary accurately</li>
                            <li>Address a real-world geographic question</li>
                            <li>Cite credible sources</li>
                        </ul>
                    </div>
                    
                    <div style="background: white; padding: 10px; border: 1px solid #ddd; margin: 10px 0;">
                        <h6>📱 Interactive Digital Map</h6>
                        <p><strong>Requirements:</strong> Create annotated map using Google My Maps or similar tool</p>
                        <ul>
                            <li>Include multiple data layers (climate, population, resources)</li>
                            <li>Provide detailed descriptions with scientific explanations</li>
                            <li>Include photos, graphs, and multimedia elements</li>
                            <li>Design for a specific audience (tourists, researchers, students)</li>
                        </ul>
                    </div>
                    
                    <div style="background: white; padding: 10px; border: 1px solid #ddd; margin: 10px 0;">
                        <h6>📊 Scientific Research Poster</h6>
                        <p><strong>Requirements:</strong> Professional poster presenting original data analysis</p>
                        <ul>
                            <li>Clear research question and hypothesis</li>
                            <li>Methods section describing data sources and analysis</li>
                            <li>Results with graphs and statistical analysis</li>
                            <li>Discussion connecting findings to broader geographic principles</li>
                        </ul>
                    </div>
                    
                    <div style="background: white; padding: 10px; border: 1px solid #ddd; margin: 10px 0;">
                        <h6>💬 Expert Panel Discussion</h6>
                        <p><strong>Requirements:</strong> Participate in moderated discussion as geographic expert</p>
                        <ul>
                            <li>Prepare expert testimony based on evidence</li>
                            <li>Respond to questions from "community members" (classmates)</li>
                            <li>Defend recommendations using scientific reasoning</li>
                            <li>Address counterarguments respectfully and factually</li>
                        </ul>
                    </div>
                </div>
                
                <h5>📝 Rubric for Scientific Communication</h5>
                <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <tr style="background: #e1bee7;">
                            <th style="padding: 8px; border: 1px solid #9c27b0;">Criteria</th>
                            <th style="padding: 8px; border: 1px solid #9c27b0;">Exemplary (4)</th>
                            <th style="padding: 8px; border: 1px solid #9c27b0;">Proficient (3)</th>
                            <th style="padding: 8px; border: 1px solid #9c27b0;">Developing (2)</th>
                        </tr>
                        <tr>
                            <td style="padding: 5px; border: 1px solid #9c27b0;"><strong>Data Analysis</strong></td>
                            <td style="padding: 5px; border: 1px solid #9c27b0;">Identifies complex patterns, calculates statistics, draws sophisticated connections</td>
                            <td style="padding: 5px; border: 1px solid #9c27b0;">Identifies obvious patterns, basic calculations, makes connections</td>
                            <td style="padding: 5px; border: 1px solid #9c27b0;">Lists data with minimal pattern recognition</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px; border: 1px solid #9c27b0;"><strong>Scientific Reasoning</strong></td>
                            <td style="padding: 5px; border: 1px solid #9c27b0;">Uses evidence to support claims with sophisticated reasoning</td>
                            <td style="padding: 5px; border: 1px solid #9c27b0;">Supports most claims with appropriate evidence</td>
                            <td style="padding: 5px; border: 1px solid #9c27b0;">Makes claims with limited or inappropriate evidence</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px; border: 1px solid #9c27b0;"><strong>Communication</strong></td>
                            <td style="padding: 5px; border: 1px solid #9c27b0;">Clear, engaging presentation using precise scientific vocabulary</td>
                            <td style="padding: 5px; border: 1px solid #9c27b0;">Clear communication with appropriate vocabulary</td>
                            <td style="padding: 5px; border: 1px solid #9c27b0;">Communication unclear or vocabulary imprecise</td>
                        </tr>
                    </table>
                </div>
                
                <h4>🎯 Assessment Standards Addressed</h4>
                <ul>
                    <li><strong>NGSS MS-ESS3-3:</strong> Apply scientific principles to design methods for monitoring environmental factors</li>
                    <li><strong>CCSS.MATH.CONTENT.6.RP.A.3:</strong> Use ratio and rate reasoning to solve real-world problems</li>
                    <li><strong>CCSS.ELA-LITERACY.RST.6-8.7:</strong> Integrate quantitative information expressed in text with visual displays</li>
                    <li><strong>ISTE Standards:</strong> Digital citizenship, knowledge constructor, innovative designer</li>
                </ul>
            `;
            document.getElementById('science-data-content').innerHTML = dataContent;
        }

        // Print functions for complete lessons
        function printELALesson() {
            // Create a clean print version
            const printWindow = window.open('', '_blank');
            const lessonTitle = currentLesson ? currentLesson.title : 'Geography Lesson';
            
            // Get ELA content
            const elaContent = document.getElementById('ela-content').innerHTML;
            
            // Create print HTML
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>ELA Lesson: ${lessonTitle}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 40px;
                            line-height: 1.6;
                            color: #333;
                        }
                        .print-title {
                            font-size: 24px;
                            font-weight: bold;
                            margin-bottom: 20px;
                            text-align: center;
                            border-bottom: 3px solid #333;
                            padding-bottom: 15px;
                        }
                        .cross-curricular-grid {
                            display: block !important;
                        }
                        .activity-card {
                            border: 1px solid #ccc;
                            margin-bottom: 25px;
                            padding: 20px;
                            page-break-inside: avoid;
                        }
                        .activity-card h3 {
                            font-size: 18px;
                            margin-bottom: 15px;
                            color: #333;
                            border-bottom: 1px solid #ddd;
                            padding-bottom: 8px;
                        }
                        .activity-content h4 {
                            font-size: 16px;
                            margin: 15px 0 8px 0;
                            color: #333;
                        }
                        .activity-content ul, .activity-content ol {
                            margin: 10px 0;
                            padding-left: 25px;
                        }
                        .activity-content li {
                            margin-bottom: 8px;
                            line-height: 1.5;
                        }
                        .activity-content p {
                            margin: 12px 0;
                        }
                        .activity-content strong {
                            font-weight: bold;
                        }
                        .print-section, .loading-message {
                            display: none !important;
                        }
                        @page {
                            margin: 1in;
                        }
                    </style>
                </head>
                <body>
                    <div class="print-title">📚 English Language Arts Lesson<br>${lessonTitle}</div>
                    ${elaContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Wait for content to load, then print
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        function printScienceLesson() {
            // Create a clean print version
            const printWindow = window.open('', '_blank');
            const lessonTitle = currentLesson ? currentLesson.title : 'Geography Lesson';
            
            // Get Science content
            const scienceContent = document.getElementById('science-content').innerHTML;
            
            // Create print HTML
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Science Lesson: ${lessonTitle}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 40px;
                            line-height: 1.6;
                            color: #333;
                        }
                        .print-title {
                            font-size: 24px;
                            font-weight: bold;
                            margin-bottom: 20px;
                            text-align: center;
                            border-bottom: 3px solid #333;
                            padding-bottom: 15px;
                        }
                        .cross-curricular-grid {
                            display: block !important;
                        }
                        .activity-card {
                            border: 1px solid #ccc;
                            margin-bottom: 25px;
                            padding: 20px;
                            page-break-inside: avoid;
                        }
                        .activity-card h3 {
                            font-size: 18px;
                            margin-bottom: 15px;
                            color: #333;
                            border-bottom: 1px solid #ddd;
                            padding-bottom: 8px;
                        }
                        .activity-content h4 {
                            font-size: 16px;
                            margin: 15px 0 8px 0;
                            color: #333;
                        }
                        .activity-content ul, .activity-content ol {
                            margin: 10px 0;
                            padding-left: 25px;
                        }
                        .activity-content li {
                            margin-bottom: 8px;
                            line-height: 1.5;
                        }
                        .activity-content p {
                            margin: 12px 0;
                        }
                        .activity-content strong {
                            font-weight: bold;
                        }
                        .print-section, .loading-message {
                            display: none !important;
                        }
                        @page {
                            margin: 1in;
                        }
                    </style>
                </head>
                <body>
                    <div class="print-title">🔬 Science Integration Lesson<br>${lessonTitle}</div>
                    ${scienceContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Wait for content to load, then print
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        // Print Substitute Teacher Guide - Complete lesson with student reading and teacher notes
        function printSubstituteGuide() {
            if (!currentLesson) {
                alert('Please select a lesson first');
                return;
            }

            // Create a clean print version for substitute teachers
            const printWindow = window.open('', '_blank');
            const lessonTitle = currentLesson.title || 'Geography Lesson';
            const moduleTitle = document.getElementById('module-title').textContent || 'Unknown Module';
            const timeEstimate = document.getElementById('time-estimate').textContent || '45 minutes';
            
            // Get lesson content elements
            const objectives = Array.from(document.querySelectorAll('#objectives-list li'))
                .filter(li => !li.classList.contains('loading'))
                .map(li => li.textContent).join('</li><li>');
            
            const materials = Array.from(document.querySelectorAll('#materials-list li'))
                .filter(li => !li.classList.contains('loading'))
                .map(li => li.textContent).join('</li><li>');
            
            const procedures = Array.from(document.querySelectorAll('#procedures-list li'))
                .filter(li => !li.classList.contains('loading'))
                .map(li => li.textContent).join('</li><li>');
            
            const assessments = Array.from(document.querySelectorAll('#assessments-list li'))
                .filter(li => !li.classList.contains('loading'))
                .map(li => li.textContent).join('</li><li>');
            
            const activities = Array.from(document.querySelectorAll('#activities-list li'))
                .filter(li => !li.classList.contains('loading'))
                .map(li => li.textContent).join('</li><li>');
            
            const vocabulary = Array.from(document.querySelectorAll('#vocabulary-list li'))
                .filter(li => !li.classList.contains('loading'))
                .map(li => li.innerHTML).join('</li><li>');
            
            // Get student reading content
            const studentContent = document.getElementById('lesson-content').innerHTML || '<p>No lesson content available</p>';
            
            // Create comprehensive substitute guide HTML
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Substitute Guide: ${lessonTitle}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 30px;
                            line-height: 1.6;
                            color: #333;
                            font-size: 12px;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 3px solid #333;
                            padding-bottom: 20px;
                            margin-bottom: 25px;
                        }
                        .lesson-title {
                            font-size: 24px;
                            font-weight: bold;
                            margin-bottom: 8px;
                        }
                        .module-info {
                            font-size: 16px;
                            color: #666;
                            margin-bottom: 5px;
                        }
                        .time-info {
                            font-size: 14px;
                            background: #f0f0f0;
                            padding: 8px 16px;
                            border-radius: 20px;
                            display: inline-block;
                            margin-top: 10px;
                        }
                        .substitute-alert {
                            background: #ffeb3b;
                            border: 2px solid #ff9800;
                            padding: 15px;
                            margin: 20px 0;
                            border-radius: 8px;
                            font-weight: bold;
                            text-align: center;
                        }
                        .section {
                            margin: 25px 0;
                            page-break-inside: avoid;
                        }
                        .section-title {
                            font-size: 16px;
                            font-weight: bold;
                            color: #2c5aa0;
                            margin-bottom: 10px;
                            padding-bottom: 5px;
                            border-bottom: 2px solid #e0e0e0;
                        }
                        .quick-reference {
                            background: #f8f9fa;
                            border-left: 4px solid #2c5aa0;
                            padding: 15px;
                            margin: 15px 0;
                        }
                        .objectives-box {
                            background: #e8f5e8;
                            border: 1px solid #4caf50;
                            padding: 15px;
                            border-radius: 8px;
                            margin: 15px 0;
                        }
                        .student-reading {
                            background: white;
                            border: 2px solid #2c5aa0;
                            padding: 20px;
                            margin: 20px 0;
                            border-radius: 8px;
                        }
                        .student-reading h1, .student-reading h2, .student-reading h3 {
                            color: #2c5aa0;
                            margin-top: 20px;
                            margin-bottom: 10px;
                        }
                        .student-reading h1 { font-size: 20px; }
                        .student-reading h2 { font-size: 18px; }
                        .student-reading h3 { font-size: 16px; }
                        .student-reading p {
                            margin: 12px 0;
                            line-height: 1.7;
                        }
                        .student-reading ul, .student-reading ol {
                            margin: 12px 0;
                            padding-left: 25px;
                        }
                        .student-reading li {
                            margin: 6px 0;
                        }
                        .student-reading strong {
                            font-weight: bold;
                            color: #2c5aa0;
                        }
                        .teacher-notes {
                            background: #fff3cd;
                            border: 2px solid #ffc107;
                            padding: 15px;
                            margin: 15px 0;
                            border-radius: 8px;
                        }
                        .teacher-notes h4 {
                            margin-top: 0;
                            color: #856404;
                        }
                        ul, ol {
                            margin: 10px 0;
                            padding-left: 25px;
                        }
                        li {
                            margin: 6px 0;
                            line-height: 1.5;
                        }
                        .vocab-term {
                            background: #f0f8ff;
                            padding: 8px;
                            margin: 5px 0;
                            border-left: 3px solid #2c5aa0;
                            border-radius: 4px;
                        }
                        .emergency-info {
                            position: fixed;
                            bottom: 20px;
                            right: 20px;
                            background: #dc3545;
                            color: white;
                            padding: 10px;
                            border-radius: 8px;
                            font-size: 11px;
                            max-width: 200px;
                        }
                        @page {
                            margin: 0.75in;
                            @top-center {
                                content: "Substitute Guide: ${lessonTitle}";
                                font-size: 10px;
                                color: #666;
                            }
                            @bottom-center {
                                content: "Page " counter(page) " - ${moduleTitle}";
                                font-size: 10px;
                                color: #666;
                            }
                        }
                        .page-break {
                            page-break-before: always;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="lesson-title">📚 SUBSTITUTE TEACHER GUIDE</div>
                        <div class="lesson-title">${lessonTitle}</div>
                        <div class="module-info">${moduleTitle}</div>
                        <div class="time-info">⏱️ Estimated Time: ${timeEstimate}</div>
                    </div>
                    
                    <div class="substitute-alert">
                        🚨 SUBSTITUTE TEACHER: This guide contains everything you need to teach this lesson successfully! 🚨
                    </div>
                    
                    <div class="quick-reference">
                        <h3>📋 QUICK REFERENCE</h3>
                        <p><strong>What to do:</strong> Read through this entire guide first, then follow the step-by-step procedures below.</p>
                        <p><strong>Student Task:</strong> Students will read the lesson content and complete activities as directed.</p>
                        <p><strong>Your Role:</strong> Guide students through the reading, facilitate discussions, and ensure learning objectives are met.</p>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">🎯 LEARNING OBJECTIVES</div>
                        <div class="objectives-box">
                            <p><strong>By the end of this lesson, students will be able to:</strong></p>
                            <ul><li>${objectives || 'Complete the assigned reading and demonstrate understanding of key concepts'}</li></ul>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">📚 MATERIALS NEEDED</div>
                        <ul><li>${materials || 'This printed guide, student reading materials'}</li></ul>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">📖 KEY VOCABULARY</div>
                        <p><strong>Review these terms with students:</strong></p>
                        <div class="vocab-terms">
                            ${vocabulary ? '<ul><li class="vocab-term">' + vocabulary + '</li></ul>' : '<p>Key terms will be highlighted in the reading.</p>'}
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">🔧 STEP-BY-STEP PROCEDURES</div>
                        <div class="teacher-notes">
                            <h4>📝 Teacher Instructions:</h4>
                            <ol>
                                <li><strong>Introduction (5 minutes):</strong> Briefly introduce the lesson topic and review key vocabulary</li>
                                <li><strong>Reading Time (20-25 minutes):</strong> Have students read the lesson content below (they can read silently or take turns reading aloud)</li>
                                <li><strong>Discussion (10-15 minutes):</strong> Ask students questions about what they read using the assessment questions provided</li>
                                <li><strong>Wrap-up (5 minutes):</strong> Review main concepts and assign any follow-up work</li>
                            </ol>
                            ${procedures ? '<p><strong>Additional Procedures:</strong></p><ul><li>' + procedures + '</li></ul>' : ''}
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">🎯 STUDENT ACTIVITIES</div>
                        <ul><li>${activities || 'Read lesson content, participate in discussion, complete any assigned questions'}</li></ul>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">📝 ASSESSMENT & DISCUSSION QUESTIONS</div>
                        <div class="teacher-notes">
                            <h4>Use these questions to check student understanding:</h4>
                            <ul>
                                <li>What is the main idea of today's lesson?</li>
                                <li>Can you explain [key vocabulary term] in your own words?</li>
                                <li>How does this topic connect to what we've learned before?</li>
                                <li>What questions do you still have about this topic?</li>
                                ${assessments ? '<li>' + assessments + '</li>' : ''}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="page-break"></div>
                    
                    <div class="section">
                        <div class="section-title">📖 STUDENT READING MATERIAL</div>
                        <div class="teacher-notes">
                            <h4>📋 Instructions for Students:</h4>
                            <p>Read the following lesson content carefully. Pay attention to bolded terms and main ideas. Be prepared to discuss what you've learned.</p>
                        </div>
                        <div class="student-reading">
                            ${studentContent}
                        </div>
                    </div>
                    
                    <div class="emergency-info">
                        <strong>Need Help?</strong><br>
                        Contact main office<br>
                        or neighboring teacher
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Wait for content to load, then print
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }
        
        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load stored data
            lessonAssignments = JSON.parse(localStorage.getItem('lessonAssignments') || '{}');
            completedLessons = JSON.parse(localStorage.getItem('completedLessons') || '{}');
            
            // Initialize calendar and load modules
            initializeCalendar();
            loadModules();
            
            // Load vocabulary terms for enhanced sidebar
            loadVocabularyTerms();
        });

        // =================================
        // VOCABULARY SYSTEM - PHASE 1
        // =================================

        // Geographic vocabulary for Q1 Geographic Detective Academy
        const vocabularyTerms = [
            {
                term: "Physical Geography",
                definition: "The study of Earth's natural features like mountains, rivers, climate, and ecosystems."
            },
            {
                term: "Human Geography", 
                definition: "The study of how people, cultures, and societies interact with and shape their environment."
            },
            {
                term: "Cartography",
                definition: "The art and science of making maps and charts to represent geographic information."
            },
            {
                term: "Cultural Landscape",
                definition: "Areas where human activities have modified the natural environment over time."
            },
            {
                term: "Economic Geography",
                definition: "The study of how economic activities are distributed across space and how location affects economic processes."
            },
            {
                term: "Topography",
                definition: "The detailed mapping of surface features of land, including elevation and terrain."
            },
            {
                term: "Geographic Information Systems (GIS)",
                definition: "Technology used to capture, store, analyze, and display geographic and spatial data."
            },
            {
                term: "Trade Routes",
                definition: "Paths or networks used for commercial transport of goods between different regions or countries."
            },
            {
                term: "Cultural Heritage",
                definition: "Traditions, customs, monuments, and artifacts that are passed down through generations."
            },
            {
                term: "Environmental Impact",
                definition: "The effect that human activities have on the natural world and ecosystems."
            }
        ];

        function loadVocabularyTerms() {
            const container = document.getElementById('vocabulary-cards');
            if (!container) return;

            container.innerHTML = vocabularyTerms.map(item => `
                <div class="vocab-card" onclick="selectVocabTerm('${item.term}')">
                    <div class="vocab-term">${item.term}</div>
                    <div class="vocab-definition">${item.definition}</div>
                </div>
            `).join('');
        }

        function selectVocabTerm(term) {
            // Visual feedback for selection
            document.querySelectorAll('.vocab-card').forEach(card => {
                card.style.backgroundColor = '';
            });
            
            event.target.closest('.vocab-card').style.backgroundColor = '#e3f2fd';
            
            // Could integrate with AI lookup or other features
            console.log(`Selected vocabulary term: ${term}`);
        }

        // =================================
        // BLOOKET INTEGRATION - PHASE 1
        // =================================

        function launchBlooketGame(gameType) {
            console.log('Launching Blooket game:', gameType);
            
            // Create a more engaging in-app experience
            const gameModal = createGameModal(gameType);
            document.body.appendChild(gameModal);
            
            // Optional: Open actual Blooket if URLs are available
            const gameUrls = {
                'vocabulary': 'https://dashboard.blooket.com/set/676a8f5e2e5a9b7f8c123456', // Example ID
                'terms': 'https://dashboard.blooket.com/set/676a8f5e2e5a9b7f8c123457',
                'detective-challenge': 'https://dashboard.blooket.com/set/676a8f5e2e5a9b7f8c123458'
            };

            // For now, let's create an engaging in-app game experience
            if (gameType === 'vocabulary') {
                startVocabularyGame();
            } else if (gameType === 'terms') {
                startTermsQuiz();
            } else {
                alert('This Blooket game will be available soon! Game sets are being prepared for this content.');
            }
        }
        
        function createGameModal(gameType) {
            const modal = document.createElement('div');
            modal.className = 'game-modal';
            modal.innerHTML = `
                <div class="game-modal-content">
                    <h2>🎮 ${gameType === 'vocabulary' ? 'Vocabulary Challenge' : 'Geographic Terms Quiz'}</h2>
                    <p>Get ready for an exciting geography challenge!</p>
                    <div class="game-buttons">
                        <button onclick="startInAppGame('${gameType}')" class="game-start-btn">
                            🚀 Start Game
                        </button>
                        <button onclick="closeGameModal()" class="game-close-btn">
                            ❌ Close
                        </button>
                    </div>
                </div>
            `;
            
            // Add styles
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            return modal;
        }
        
        function closeGameModal() {
            const modal = document.querySelector('.game-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        function startInAppGame(gameType) {
            closeGameModal();
            if (gameType === 'vocabulary') {
                startVocabularyGame();
            } else {
                startTermsQuiz();
            }
        }
        
        function startVocabularyGame() {
            // Simple vocabulary matching game
            alert('🎮 Vocabulary Game Loading! Match the terms with their definitions. (This will be a full interactive game in the next update!)');
        }
        
        function startTermsQuiz() {
            // Simple terms quiz
            alert('🎯 Terms Quiz Loading! Test your knowledge of geographic terms. (This will be a full quiz interface in the next update!)');
        }

        // =================================
        // AI TOOLS INTEGRATION - PHASE 1
        // =================================

        // Simple AI Definition Lookup
        async function lookupDefinition() {
            const input = document.getElementById('lookup-input');
            const display = document.getElementById('definition-display');
            const term = input.value.trim();

            if (!term) {
                alert('Please enter a term to look up.');
                return;
            }

            // Show loading state
            display.innerHTML = '<div style="text-align: center; color: #6c757d;">🔍 Looking up definition...</div>';
            display.classList.add('show');

            try {
                // Call the real AI API
                const response = await fetch('/api/ai/define', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ term: term })
                });

                const data = await response.json();

                if (response.ok) {
                    display.innerHTML = `
                        <h5 style="color: #6f42c1; margin: 0 0 10px 0;">${data.term}</h5>
                        <p style="margin: 0; line-height: 1.5;">${data.definition}</p>
                        <small style="color: #6c757d; font-style: italic;">Source: ${data.source}</small>
                    `;
                } else {
                    // Fallback if API fails
                    const fallback = data.fallback || generateMockDefinition(term);
                    display.innerHTML = `
                        <h5 style="color: #6f42c1; margin: 0 0 10px 0;">${term}</h5>
                        <p style="margin: 0; line-height: 1.5;">${fallback}</p>
                        <small style="color: #dc3545; font-style: italic;">⚠️ Using fallback definition - AI service unavailable</small>
                    `;
                }
            } catch (error) {
                console.error('Definition lookup error:', error);
                // Fallback to mock definition
                const fallback = generateMockDefinition(term);
                display.innerHTML = `
                    <h5 style="color: #6f42c1; margin: 0 0 10px 0;">${term}</h5>
                    <p style="margin: 0; line-height: 1.5;">${fallback}</p>
                    <small style="color: #dc3545; font-style: italic;">⚠️ Using fallback definition - network error</small>
                `;
            }
        }

        function generateMockDefinition(term) {
            // Basic geographic term definitions
            const definitions = {
                'elevation': 'The height of a location above sea level, typically measured in feet or meters.',
                'climate': 'The long-term weather patterns in a particular region over many years.',
                'longitude': 'Geographic coordinate that specifies the east-west position of a point on Earth.',
                'latitude': 'Geographic coordinate that specifies the north-south position of a point on Earth.',
                'ecosystem': 'A community of living organisms interacting with their physical environment.',
                'watershed': 'An area of land that drains water, sediment, and dissolved materials to a common outlet.'
            };

            return definitions[term.toLowerCase()] || 
                   `${term} is a geographic concept that relates to the study of Earth's features, human activities, and their interactions. This term is commonly used in geographic analysis and spatial thinking.`;
        }

        // Advanced AI Tools
        async function explainConcept() {
            const input = document.getElementById('concept-input');
            const result = document.getElementById('concept-result');
            const concept = input.value.trim();

            if (!concept) {
                alert('Please enter a concept to explain.');
                return;
            }

            result.innerHTML = '<div style="text-align: center; color: #6c757d;">🤖 Generating explanation...</div>';
            result.classList.add('show');

            try {
                // Call the real AI API
                const response = await fetch('/api/ai/explain', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ concept: concept })
                });

                const data = await response.json();

                if (response.ok) {
                    result.innerHTML = `
                        <h5 style="color: #4dabf7;">Concept Explanation: ${data.concept}</h5>
                        <p style="line-height: 1.6;">${data.explanation}</p>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 10px;">
                            <strong>💡 Teaching Tip:</strong> This explanation was generated by AI to help students understand geographic concepts.
                        </div>
                        <small style="color: #6c757d; font-style: italic;">Source: ${data.source}</small>
                    `;
                } else {
                    // Fallback
                    result.innerHTML = `
                        <h5 style="color: #4dabf7;">Concept Explanation: ${concept}</h5>
                        <p>This is where an AI-powered explanation would appear, breaking down complex geographic concepts into student-friendly language with examples and connections to the current lesson.</p>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 10px;">
                            <strong>💡 Teaching Tip:</strong> Consider using visual aids or real-world examples to reinforce this concept.
                        </div>
                        <small style="color: #dc3545; font-style: italic;">⚠️ AI service unavailable - using fallback content</small>
                    `;
                }
            } catch (error) {
                console.error('Concept explanation error:', error);
                // Fallback response
                result.innerHTML = `
                    <h5 style="color: #4dabf7;">Concept Explanation: ${concept}</h5>
                    <p>This is where an AI-powered explanation would appear, breaking down complex geographic concepts into student-friendly language with examples and connections to the current lesson.</p>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 10px;">
                        <strong>💡 Teaching Tip:</strong> Consider using visual aids or real-world examples to reinforce this concept.
                    </div>
                    <small style="color: #dc3545; font-style: italic;">⚠️ Network error - using fallback content</small>
                `;
            }
        }

        async function generateQuestions() {
            const input = document.getElementById('question-input');
            const result = document.getElementById('question-result');
            const topic = input.value.trim();

            if (!topic) {
                alert('Please enter a topic for question generation.');
                return;
            }

            result.innerHTML = '<div style="text-align: center; color: #6c757d;">📝 Generating questions...</div>';
            result.classList.add('show');

            await new Promise(resolve => setTimeout(resolve, 2000));
            
            result.innerHTML = `
                <h5 style="color: #4dabf7;">Study Questions: ${topic}</h5>
                <ol style="padding-left: 20px;">
                    <li>What are the key characteristics of ${topic}?</li>
                    <li>How does ${topic} impact human activities?</li>
                    <li>Can you identify examples of ${topic} in your local area?</li>
                    <li>What tools would a geographer use to study ${topic}?</li>
                    <li>How might ${topic} change over time due to human or natural factors?</li>
                </ol>
                <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-top: 10px;">
                    <strong>🎯 Assessment Idea:</strong> Use these questions for exit tickets or discussion starters.
                </div>
            `;
        }

        async function createConnection() {
            const input = document.getElementById('connection-input');
            const result = document.getElementById('connection-result');
            const subject = input.value.trim();

            if (!subject) {
                alert('Please enter a subject area for cross-curricular connections.');
                return;
            }

            result.innerHTML = '<div style="text-align: center; color: #6c757d;">🔗 Finding connections...</div>';
            result.classList.add('show');

            await new Promise(resolve => setTimeout(resolve, 1500));
            
            result.innerHTML = `
                <h5 style="color: #4dabf7;">Geography ↔ ${subject} Connections</h5>
                <div style="background: #fff; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px;">
                    <p><strong>Direct Connections:</strong> Geographic concepts that naturally align with ${subject} curriculum.</p>
                    <p><strong>Project Ideas:</strong> Collaborative activities that combine geographic thinking with ${subject} skills.</p>
                    <p><strong>Assessment Opportunities:</strong> Ways to evaluate student understanding across both subjects.</p>
                </div>
            `;
        }

        async function findConnections() {
            const result = document.getElementById('connections-result');
            
            // Get current lesson topic if available
            const lessonTitle = document.getElementById('lesson-title')?.textContent || 'geography topics';
            
            result.innerHTML = '<div style="text-align: center; color: #6c757d;">🌍 Finding cross-curricular connections...</div>';
            result.classList.add('show');

            try {
                // Call the real AI API
                const response = await fetch('/api/ai/connections', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ topic: lessonTitle })
                });

                const data = await response.json();

                if (response.ok) {
                    result.innerHTML = `
                        <h5 style="color: #4dabf7;">🔗 Cross-Curricular Connections</h5>
                        <div style="background: #f8f9fa; border-left: 4px solid #007bff; padding: 15px; margin: 10px 0;">
                            <h6 style="color: #2c5aa0; margin: 0 0 10px 0;">Topic: ${data.topic}</h6>
                            <div style="line-height: 1.6; white-space: pre-line;">${data.connections}</div>
                        </div>
                        <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-top: 15px;">
                            <strong>💡 Teaching Tip:</strong> Use these connections to make geography relevant and engaging for students!
                        </div>
                        <small style="color: #6c757d; font-style: italic;">Source: ${data.source}</small>
                    `;
                } else {
                    // Fallback to mock connections
                    showMockConnections(result, lessonTitle);
                }
            } catch (error) {
                console.error('Connections error:', error);
                // Fallback to mock connections
                showMockConnections(result, lessonTitle);
            }
        }

        function showMockConnections(result, topic) {
            // Mock current events related to geography
            const currentEvents = [
                {
                    title: "Climate Change Impact on Coastal Cities",
                    description: "Rising sea levels affecting urban planning worldwide",
                    connection: "Links to lessons on coastal geography and urban development"
                },
                {
                    title: "International Trade Routes Disruption", 
                    description: "Global supply chain challenges highlight geographic dependencies",
                    connection: "Connects to economic geography and transportation networks"
                },
                {
                    title: "Migration Patterns and Geography",
                    description: "Human movement shaped by physical and political geography",
                    connection: "Relates to population distribution and political boundaries"
                }
            ];
            
            result.innerHTML = `
                <h5 style="color: #4dabf7;">🔗 Real-World Connections</h5>
                ${currentEvents.map(event => `
                    <div style="background: #f8f9fa; border-left: 4px solid #007bff; padding: 12px; margin: 10px 0;">
                        <h6 style="color: #2c5aa0; margin: 0 0 5px 0;">${event.title}</h6>
                        <p style="margin: 0 0 8px 0; font-size: 0.9rem;">${event.description}</p>
                        <small style="color: #6c757d; font-style: italic;">${event.connection}</small>
                    </div>
                `).join('')}
                <div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-top: 15px;">
                    <strong>💡 Teaching Tip:</strong> Use these connections to make geography relevant and engaging for students!
                </div>
                <small style="color: #dc3545; font-style: italic;">⚠️ AI service unavailable - showing example connections</small>
            `;
        }

        // =================================
        // PHASE 2 PLACEHOLDER FUNCTIONS
        // =================================

        function showComingSoon(feature) {
            alert(`${feature} is coming in Phase 2! This feature will include advanced functionality for enhanced learning experiences.`);
        }

        // =================================
        // KEYBOARD SHORTCUTS
        // =================================

        document.addEventListener('keydown', function(e) {
            // Quick tab switching with Alt + number
            if (e.altKey) {
                switch(e.key) {
                    case '1': showTab('teacher'); break;
                    case '2': showTab('vocabulary'); break;
                    case '3': showTab('maps'); break;
                    case '4': showTab('ai-tools'); break;
                    case '5': showTab('connections'); break;
                }
            }
            
            // Enter key for AI inputs
            if (e.key === 'Enter' && e.target.classList.contains('lookup-input')) {
                lookupDefinition();
            }
        });

        // =================================
        // DEBUGGING AND INITIALIZATION
        // =================================
        
        // Add click event listeners directly to buttons as backup
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Setting up tab debugging');
            
            // Test if showTab function exists
            if (typeof showTab === 'function') {
                console.log('showTab function is available');
            } else {
                console.error('showTab function is NOT available');
            }
            
            // Find all tab buttons and add backup click handlers
            const tabButtons = document.querySelectorAll('.tab-button');
            console.log('Found', tabButtons.length, 'tab buttons');
            
            tabButtons.forEach((button, index) => {
                console.log(`Button ${index}:`, button.textContent, 'onclick:', button.getAttribute('onclick'));
                
                // Add backup click handler
                button.addEventListener('click', function(e) {
                    console.log('Direct click handler triggered for:', this.textContent);
                    e.preventDefault();
                    
                    // Determine tab name from button text
                    const text = this.textContent.toLowerCase();
                    let tabName = '';
                    if (text.includes('teacher')) tabName = 'teacher';
                    else if (text.includes('vocabulary')) tabName = 'vocabulary';
                    else if (text.includes('maps')) tabName = 'maps';
                    else if (text.includes('ai tools')) tabName = 'ai-tools';
                    else if (text.includes('connections')) tabName = 'connections';
                    
                    if (tabName) {
                        console.log('Calling showTab with:', tabName);
                        showTab(tabName);
                    } else {
                        console.error('Could not determine tab name for button:', this.textContent);
                    }
                });
            });
            
            // Test initial tab setup
            const allTabs = document.querySelectorAll('.tab-content');
            console.log('Found', allTabs.length, 'tab content divs:');
            allTabs.forEach(tab => {
                console.log(' -', tab.id, 'active:', tab.classList.contains('active'));
            });
        });
    </script>
</body>
</html>
